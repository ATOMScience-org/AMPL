

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pipeline.featurization &mdash; ATOM Data-Driven Modeling Pipeline 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ATOM Data-Driven Modeling Pipeline
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pipeline.featurization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pipeline.featurization</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes providing different methods of featurizing compounds and other data entities</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">deepchem</span> <span class="k">as</span> <span class="nn">dc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">deepchem.data.data_loader</span> <span class="k">import</span> <span class="n">featurize_smiles_df</span>

<span class="kn">from</span> <span class="nn">rdkit</span> <span class="k">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="k">import</span> <span class="n">AllChem</span>

<span class="n">subclassed_mordred_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EState&#39;</span><span class="p">,</span> <span class="s1">&#39;MolecularDistanceEdge&#39;</span><span class="p">]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mordred</span> <span class="k">import</span> <span class="n">Calculator</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">,</span> <span class="n">get_descriptors_from_module</span>
    <span class="kn">from</span> <span class="nn">mordred.EState</span> <span class="k">import</span> <span class="n">AtomTypeEState</span><span class="p">,</span> <span class="n">AggrType</span>
    <span class="kn">from</span> <span class="nn">mordred.MolecularDistanceEdge</span> <span class="k">import</span> <span class="n">MolecularDistanceEdge</span>
    <span class="kn">from</span> <span class="nn">mordred</span> <span class="k">import</span> <span class="n">BalabanJ</span><span class="p">,</span> <span class="n">BertzCT</span><span class="p">,</span> <span class="n">HydrogenBond</span><span class="p">,</span> <span class="n">MoeType</span><span class="p">,</span> <span class="n">RotatableBond</span><span class="p">,</span> <span class="n">SLogP</span><span class="p">,</span> <span class="n">TopoPSA</span>
    <span class="n">rdkit_desc_mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">BalabanJ</span><span class="p">,</span> <span class="n">BertzCT</span><span class="p">,</span> <span class="n">HydrogenBond</span><span class="p">,</span> <span class="n">MoeType</span><span class="p">,</span> <span class="n">RotatableBond</span><span class="p">,</span> <span class="n">SLogP</span><span class="p">,</span> <span class="n">TopoPSA</span><span class="p">]</span>
    <span class="n">mordred_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">mordred_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Make feather support conditional until feather package is installed in TTB containers.</span>
<span class="n">feather_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">feather</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">feather_supported</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="c1">## remove for distribution</span>
<span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="k">import</span> <span class="n">datastore_functions</span> <span class="k">as</span> <span class="n">dsf</span>

<span class="c1"># Make feather support conditional until feather package is installed in TTB containers.</span>
<span class="n">feather_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">feather</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">feather_supported</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="c1"># Ignore failure to import Gomez-Bombarelli autoencoder package (doesn&#39;t work in some </span>
<span class="c1"># LC environments that don&#39;t have Keras installed)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mol_vae_features</span> <span class="k">import</span> <span class="n">MoleculeVAEFeaturizer</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">collections</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="create_featurization"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.create_featurization">[docs]</a><span class="k">def</span> <span class="nf">create_featurization</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Factory method to create the appropriate type of Featurization object for params.featurizer</span>

<span class="sd">    Args:</span>
<span class="sd">        params (argparse.Namespace: Object containing the parameter list</span>

<span class="sd">    Returns:</span>
<span class="sd">        Featurization object of the correct subclass as specified by params.featurizer</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If params.featurizer not in [&#39;ecfp&#39;,&#39;graphconv&#39;,&#39;molvae&#39;,&#39;computed_descriptors&#39;,&#39;descriptors&#39;]</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: Change molvae to generic autoencoder</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ecfp&#39;</span><span class="p">,</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">,</span> <span class="s1">&#39;molvae&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DynamicFeaturization</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;descriptors&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DescriptorFeaturization</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;computed_descriptors&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ComputedDescriptorFeaturization</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown featurization type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="remove_duplicate_smiles"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.remove_duplicate_smiles">[docs]</a><span class="k">def</span> <span class="nf">remove_duplicate_smiles</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">smiles_col</span><span class="o">=</span><span class="s1">&#39;rdkit_smiles&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove any rows with duplicate SMILES strings from the given dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        dset_df (DataFrame): The dataset table.</span>

<span class="sd">        smiles_col (str): The column containing SMILES strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        filtered_dset_df (DataFrame): The dataset filtered to remove duplicate SMILES strings.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Duplicate smiles strings: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">([(</span><span class="n">item</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span>
        <span class="n">dset_df</span><span class="p">[</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">remove</span> <span class="o">=</span> <span class="n">dset_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">smiles_col</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="o">~</span><span class="n">remove</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All rows with duplicate smiles strings have been removed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dset_df</span></div>

<span class="c1"># ****************************************************************************************</span>
<span class="c1"># Module-level functions for RDKit and Mordred descriptor calculations</span>
<span class="c1"># ****************************************************************************************</span>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="get_2d_mols"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.get_2d_mols">[docs]</a><span class="k">def</span> <span class="nf">get_2d_mols</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert SMILES strings to RDKit Mol objects without explicit hydrogens or 3D coordinates</span>

<span class="sd">    Args:</span>
<span class="sd">        smiles_strs (iterable of str): List of SMILES strings to convert</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple (mols, is_valid):</span>
<span class="sd">            mols (ndarray of Mol): Mol objects for valid SMILES strings only</span>
<span class="sd">            is_valid (ndarray of bool): True for each input SMILES string that was valid according to RDKit</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Converting SMILES to RDKit Mols&#39;</span><span class="p">)</span>
    <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">smiles_strs</span><span class="p">]</span>
    <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mols</span><span class="p">)[</span><span class="n">is_valid</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mols</span><span class="p">,</span> <span class="n">is_valid</span></div>

<div class="viewcode-block" id="get_3d_mols"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.get_3d_mols">[docs]</a><span class="k">def</span> <span class="nf">get_3d_mols</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert SMILES strings to Mol objects with explicit hydrogens and 3D coordinates</span>

<span class="sd">    Args:</span>
<span class="sd">        smiles_strs (iterable of str): List of SMILES strings to convert</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple (mols, is_valid):</span>
<span class="sd">            mols (ndarray of Mol): Mol objects for valid SMILES strings only</span>
<span class="sd">            is_valid (ndarray of bool): True for each input SMILES string that was valid according to RDKit</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Converting SMILES to RDKit Mols&#39;</span><span class="p">)</span>
    <span class="n">nsmiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">)</span>
    <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nsmiles</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">smi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding hydrogens to mols&#39;</span><span class="p">)</span>
    <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computing 3D coordinates&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="c1"># This sometimes fails in the RDKit code. Give up on this molecule.</span>
                <span class="n">mols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mols</span><span class="p">)[</span><span class="n">is_valid</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mols</span><span class="p">,</span> <span class="n">is_valid</span></div>


<div class="viewcode-block" id="compute_2d_mordred_descrs"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.compute_2d_mordred_descrs">[docs]</a><span class="k">def</span> <span class="nf">compute_2d_mordred_descrs</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute 2D Mordred descriptors only</span>

<span class="sd">    Args:</span>
<span class="sd">        mols: List of RDKit mol objects for molecules to compute descriptors for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        res_df: DataFrame containing Mordred descriptors for molecules.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">get_mordred_calculator</span><span class="p">(</span><span class="n">ignore_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">pandas</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">fill_missing</span><span class="p">()</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_df</span></div>

<div class="viewcode-block" id="compute_all_mordred_descrs"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.compute_all_mordred_descrs">[docs]</a><span class="k">def</span> <span class="nf">compute_all_mordred_descrs</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="n">max_cpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute all Mordred descriptors, including 3D ones</span>

<span class="sd">    Args:</span>
<span class="sd">        mols: List of RDKit mol objects for molecules to compute descriptors for.</span>

<span class="sd">        max_cpus: Max number of cores to use for computing descriptors. None means use all available cores.</span>

<span class="sd">        quiet: If True, avoid displaying progress indicators for computations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        res_df: DataFrame containing Mordred descriptors for molecules.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">get_mordred_calculator</span><span class="p">(</span><span class="n">ignore_3D</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Mordred descriptors&quot;</span><span class="p">)</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">pandas</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">max_cpus</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Done computing Mordred descriptors&quot;</span><span class="p">)</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">fill_missing</span><span class="p">()</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_df</span></div>

<div class="viewcode-block" id="compute_mordred_descriptors_from_smiles"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.compute_mordred_descriptors_from_smiles">[docs]</a><span class="k">def</span> <span class="nf">compute_mordred_descriptors_from_smiles</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">,</span> <span class="n">max_cpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smiles_col</span><span class="o">=</span><span class="s1">&#39;rdkit_smiles&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute 2D and 3D Mordred descriptors for the given list of SMILES strings.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        smiles_strs:    A list or array of SMILES strings</span>

<span class="sd">        max_cpus:       The maximum number of cores to use for computing descriptors. The default value None means</span>
<span class="sd">                        that all available cores will be used.</span>
<span class="sd">        quiet (bool):   If True, suppress displaying a progress indicator while computing descriptors.</span>

<span class="sd">        smiles_col (str): The name of the column that will contain SMILES strings in the returned data frame.</span>
<span class="sd">        </span>
<span class="sd">    Returns: tuple</span>
<span class="sd">        desc_df (DataFrame): A table of Mordred descriptors for the input SMILES strings that were valid </span>
<span class="sd">                        (according to RDKit), together with those SMILES strings.</span>

<span class="sd">        is_valid (ndarray of bool): An array of length the same as smiles_strs, indicating which SMILES strings </span>
<span class="sd">                            were considered valid.</span>
<span class="sd">                            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mols3d</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">get_3d_mols</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">)</span>
    <span class="n">desc_df</span> <span class="o">=</span> <span class="n">compute_all_mordred_descrs</span><span class="p">(</span><span class="n">mols3d</span><span class="p">,</span> <span class="n">max_cpus</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
    <span class="n">valid_smiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">)[</span><span class="n">is_valid</span><span class="p">]</span>
    <span class="n">desc_df</span><span class="p">[</span><span class="n">smiles_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_smiles</span>
    <span class="k">return</span> <span class="n">desc_df</span><span class="p">,</span> <span class="n">is_valid</span></div>


<div class="viewcode-block" id="compute_all_rdkit_descrs"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.compute_all_rdkit_descrs">[docs]</a><span class="k">def</span> <span class="nf">compute_all_rdkit_descrs</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute all RDKit descriptors</span>

<span class="sd">    Args:</span>
<span class="sd">        mols: List of RDKit Mol objects to compute descriptors for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        res_df (DataFrame): Data frame containing computed descriptors.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">get_rdkit_calculator</span><span class="p">()</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">pandas</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_df</span></div>

<div class="viewcode-block" id="get_mordred_calculator"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.get_mordred_calculator">[docs]</a><span class="k">def</span> <span class="nf">get_mordred_calculator</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="n">subclassed_mordred_classes</span><span class="p">,</span> <span class="n">ignore_3D</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Mordred calculator with all descriptor modules registered except those whose names are in the exclude list.</span>
<span class="sd">    Register ATOM versions of the classes in those modules instead.</span>

<span class="sd">    Args:</span>
<span class="sd">        exclude (list): List of Mordred descriptor modules to exclude.</span>

<span class="sd">        ignore_3D (bool): Whether to exclude descriptors that require computing 3D structures.</span>

<span class="sd">    Returns:</span>
<span class="sd">        calc (mordred.Calculator): Object for performing Mordred descriptor calculations.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="n">ignore_3D</span><span class="o">=</span><span class="n">ignore_3D</span><span class="p">)</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mordred.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mod</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">desc_mod</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">desc_mod</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">desc_mod</span><span class="p">,</span> <span class="n">ignore_3D</span><span class="o">=</span><span class="n">ignore_3D</span><span class="p">)</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ATOMAtomTypeEState</span><span class="p">)</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ATOMMolecularDistanceEdge</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calc</span></div>


<div class="viewcode-block" id="get_rdkit_calculator"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.get_rdkit_calculator">[docs]</a><span class="k">def</span> <span class="nf">get_rdkit_calculator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Mordred calculator with only the RDKit wrapper descriptor modules registered </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="n">ignore_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">desc_mod</span> <span class="ow">in</span> <span class="n">rdkit_desc_mods</span><span class="p">:</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">desc_mod</span><span class="p">,</span> <span class="n">ignore_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calc</span></div>


<span class="c1"># ****************************************************************************************</span>
<span class="c1"># Module-level functions for MOE descriptor calculations</span>
<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="compute_all_moe_descriptors"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.compute_all_moe_descriptors">[docs]</a><span class="k">def</span> <span class="nf">compute_all_moe_descriptors</span><span class="p">(</span><span class="n">smiles_df</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run MOE to compute all 317 standard descriptors.</span>

<span class="sd">    Args:</span>
<span class="sd">        smiles_df (DataFrame): Table containing SMILES strings and compound IDs</span>

<span class="sd">        params (Namespace): Parsed model parameters, used to identify SMILES and compund ID columns.</span>

<span class="sd">    Returns:</span>
<span class="sd">        descr_df (DataFrame): Table containing the input SMILES strings and compound IDs, the &quot;washed&quot; SMILES</span>
<span class="sd">        string prepared by MOE, a sequence index, and columns for each MOE descriptor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Get MOE_PATH from params</span>
    <span class="n">moe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MOE_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;/usr/workspace/wsb/gskcraa/tools/moe2018/bin&#39;</span><span class="p">)</span>
    <span class="n">moe_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/..&#39;</span> <span class="o">%</span> <span class="n">moe_path</span><span class="p">)</span>
    <span class="c1"># Make sure we have an environment variable that points to the license server</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LM_LICENSE_FILE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LM_LICENSE_FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;7788@dixie3.llnl.gov&#39;</span>

    <span class="n">moe_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">moe_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{moePath}</span><span class="s2">/moebatch&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moePath</span><span class="o">=</span><span class="n">moe_path</span><span class="p">))</span>
    <span class="n">moe_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-mpu&quot;</span><span class="p">)</span>
    <span class="n">moe_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">moe_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-exec&quot;</span><span class="p">)</span>

    <span class="n">moe_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;db_Close db_Open[&#39;</span><span class="si">{fileMDB}</span><span class="s2">&#39;,&#39;create&#39;]; db_ImportASCII[ascii_file: &#39;</span><span class="si">{smilesFile}</span><span class="s2">&#39;,</span>
<span class="s2">    db_file: &#39;</span><span class="si">{fileMDB}</span><span class="s2">&#39;,delimiter: &#39;,&#39;, quotes: 0, names: [&#39;original_smiles&#39;,&#39;cmpd_id&#39;],types: [&#39;char&#39;,&#39;char&#39;]];</span>
<span class="s2">    run [&#39;</span><span class="si">{moeRoot}</span><span class="s2">/custom/ksm_svl/smp_WashMinimizeSMILES.svl&#39;, [&#39;</span><span class="si">{fileMDB}</span><span class="s2">&#39;, &#39;original_smiles&#39;]];</span>
<span class="s2">    run [&#39;</span><span class="si">{moeRoot}</span><span class="s2">/custom/svl/db_desc_smp5.svl&#39;,[&#39;</span><span class="si">{fileMDB}</span><span class="s2">&#39;,&#39;mol_prep&#39;, [], [codeset: &#39;All_No_MOPAC_Protein&#39;]]];</span>
<span class="s2">    dir_export_ASCIIBB [&#39;</span><span class="si">{fileMDB}</span><span class="s2">&#39;,[quotes:1,titles:1]];&quot;&quot;&quot;</span>
    
    <span class="c1">#with tempfile.TemporaryDirectory() as tmpdir:</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Write SMILES strings and compound IDs to a temp file</span>
        <span class="n">smiles_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/smiles4moe.csv&#39;</span> <span class="o">%</span> <span class="n">tmpdir</span>
        <span class="n">file_mdb</span> <span class="o">=</span> <span class="s1">&#39;smiles4moe.mdb&#39;</span>
        <span class="n">smiles_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">smiles_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote SMILES strings to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">smiles_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="n">moe_cmds</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">moe_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moeRoot</span><span class="o">=</span><span class="n">moe_root</span><span class="p">,</span> <span class="n">smilesFile</span><span class="o">=</span><span class="n">smiles_file</span><span class="p">,</span> <span class="n">fileMDB</span><span class="o">=</span><span class="n">file_mdb</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="n">moe_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moe_cmds</span><span class="p">)</span>
        <span class="n">moe_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-exit&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computing MOE descriptors&#39;</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">moe_args</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Command: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shellcmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &gt;&amp; </span><span class="si">%s</span><span class="s1">/moe_err.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">shellcmd</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;MOE descriptor calculation done&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Return status: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">retcode</span><span class="p">)</span>
            <span class="n">errbuf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/moe_err.txt&#39;</span> <span class="o">%</span> <span class="n">tmpdir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Stderr:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errbuf</span><span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/smiles4moe.txt&#39;</span> <span class="o">%</span> <span class="n">tmpdir</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;MOE descriptor calculation failed.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading descriptors from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cmpd_id&#39;</span> <span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span> <span class="s1">&#39;original_smiles&#39;</span> <span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">result_df</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to invoke MOE to compute descriptors: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span></div>


<span class="c1"># ****************************************************************************************</span>
<span class="c1"># ****************************************************************************************</span>
<span class="c1"># Featurization classes</span>
<span class="c1"># ****************************************************************************************</span>


<div class="viewcode-block" id="Featurization"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization">[docs]</a><span class="k">class</span> <span class="nc">Featurization</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for featurization code</span>

<span class="sd">    Attributes:</span>
<span class="sd">        feat_type (str): Type of featurizer, set in __init__</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a Featurization object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Contains parameters used to instantiate the featurizer.</span>
<span class="sd">        Side effects:</span>
<span class="sd">            sets self.feat_type as a Featurization attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.featurize_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.featurize_data">[docs]</a>    <span class="k">def</span> <span class="nf">featurize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform featurization on the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dset_df (DataFrame): A table of data to be featurized. At minimum, should include columns.</span>
<span class="sd">            for the compound ID and assay value; for some featurizers, must also contain a SMILES string column.</span>

<span class="sd">            model_dataset (ModelDataset): Dataset to be featurized.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Must be implemented by concrete subclasses</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.extract_prefeaturized_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.extract_prefeaturized_data">[docs]</a>    <span class="k">def</span> <span class="nf">extract_prefeaturized_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts dataset features, values, IDs and attributes from the given prefeaturized data frame.</span>
<span class="sd">        Args:</span>
<span class="sd">            merged_dset_df (DataFrame): Data frame for the dataset.</span>

<span class="sd">            model_dataset (ModelDataset): Backpointer to the ModelDataset object for the dataset to be featurized.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.get_feature_columns"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.get_feature_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of feature column names associated with this Featurization instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.get_feature_count"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.get_feature_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of feature columns associated with this Featurization instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.create_feature_transformer"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.create_feature_transformer">[docs]</a>    <span class="k">def</span> <span class="nf">create_feature_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit a scaling and centering transformation to the feature matrix of the given dataset, and return a</span>
<span class="sd">        DeepChem transformer object holding its parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (deepchem.Dataset): featurized dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            Empty list</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.get_feature_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.get_feature_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this Featurization object that are specific</span>
<span class="sd">        to the feature type.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Contains parameters used to instantiate the featurizer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.get_featurized_dset_name"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.get_featurized_dset_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_dset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a name for the featurized dataset, for use in filenames or dataset keys.</span>
<span class="sd">        Does not include any path information. May be derived from dataset_name.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_name (str): Name of the dataset</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="Featurization.get_featurized_data_subdir"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.Featurization.get_featurized_data_subdir">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_data_subdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of a subdirectory (without any leading path information) in which to store</span>
<span class="sd">        featurized data, if it goes to the filesystem.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Must be implemented by concrete subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="DynamicFeaturization"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization">[docs]</a><span class="k">class</span> <span class="nc">DynamicFeaturization</span><span class="p">(</span><span class="n">Featurization</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Featurization subclass that supports on-the-fly featurization. Can be used when it is inexpensive to</span>
<span class="sd">    compute the features. Most DeepChem featurizers are handled through this class.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            feat_type (str): Type of featurizer in [&#39;ecfp&#39;,&#39;graphconv&#39;,&#39;molvae&#39;]</span>
<span class="sd">            featurization_obj: The DeepChem or MoleculeVAEFeaturizer object as determined by feat_type and params</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a DynamicFeaturization object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Contains parameters to be used to instantiate a featurizer.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError if feat_type not in [&#39;ecfp&#39;,&#39;graphconv&#39;,&#39;molvae&#39;], featurization not supported</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following DynamicFeaturization attributes:</span>
<span class="sd">                feat_type (str): Type of featurizer in [&#39;ecfp&#39;,&#39;graphconv&#39;,&#39;molvae&#39;]</span>
<span class="sd">                featurization_obj: The DeepChem or MoleculeVAEFeaturizer object as determined by feat_type and params</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">CircularFingerprint</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">ecfp_size</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">ecfp_radius</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">ConvMolFeaturizer</span><span class="p">()</span>
        <span class="c1">#TODO: potentially make generic</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;molvae&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span> <span class="o">=</span> <span class="n">MoleculeVAEFeaturizer</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">mol_vae_model_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown featurization type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a human-readable description of this Featurization object.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (str): Describes the featurization type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;DynamicFeaturization with </span><span class="si">%s</span><span class="s2"> features&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.extract_prefeaturized_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.extract_prefeaturized_data">[docs]</a>    <span class="k">def</span> <span class="nf">extract_prefeaturized_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to extract prefeaturized data for the given dataset. For dynamic featurizers, we don&#39;t save</span>
<span class="sd">        this data, so this method always returns None.</span>
<span class="sd">        Args:</span>
<span class="sd">            merged_dset_df (DataFrame): dataset merged with the featurizers</span>

<span class="sd">            model_dataset (ModelDataset): Object containing the dataset to be featurized</span>
<span class="sd">        Returns:</span>
<span class="sd">            None, None, None, None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="c1"># TODO: Replace model_dataset in this function with params; make params.response_cols required.</span>
    <span class="c1"># TODO: MJT, make params.response_cols required?</span>
    <span class="c1"># TODO: MJT, test featurize data after refactoring out model_dataset.</span>
<div class="viewcode-block" id="DynamicFeaturization.featurize_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.featurize_data">[docs]</a>    <span class="k">def</span> <span class="nf">featurize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform featurization on the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dset_df (DataFrame): A table of data to be featurized. At minimum, should include columns</span>
<span class="sd">            for the compound ID and assay value; for some featurizers, must also contain a SMILES string column.</span>
<span class="sd">            # TODO: remove model_dataset after ensuring response_cols are set correctly.</span>

<span class="sd">            model_dataset (ModelDataset): Contains the dataset to be featurized</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (features, ids, vals, attr).</span>

<span class="sd">            features (np.array): Feature matrix.</span>

<span class="sd">            ids (pd.DataFrame): compound IDs or SMILES strings if needed for splitting.</span>

<span class="sd">            vals (np.array): array of response values.</span>

<span class="sd">            attr (pd.DataFrame): dataframe containing SMILES strings indexed by compound IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
            <span class="n">index</span><span class="o">=</span><span class="n">dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">])</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">featurize_smiles_df</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">featurizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
                                                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Featurization failed for dataset&quot;</span><span class="p">)</span>
        <span class="c1"># Some SMILES strings may not be featurizable. This filters for only valid IDs.</span>
        <span class="c1"># ksm: Changed name of &#39;valid_inds&#39; to &#39;is_valid&#39;, because it&#39;s an array of bools, not a list of indices.</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">is_valid</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">contains_responses</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">is_valid</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">))</span>

        <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="n">is_valid</span><span class="p">]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">][</span><span class="n">is_valid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">attr</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.create_feature_transformer"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.create_feature_transformer">[docs]</a>    <span class="k">def</span> <span class="nf">create_feature_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit a scaling and centering transformation to the feature matrix of the given dataset, and return a</span>
<span class="sd">        DeepChem transformer object holding its parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (deepchem.Dataset): featurized dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            Empty list since we will not be transforming the features of a DynamicFeaturization object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: Add comment describing why this is always returning an empty list</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.get_featurized_dset_name"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.get_featurized_dset_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_dset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a name for the featurized dataset, for use in filenames or dataset keys.</span>
<span class="sd">        Does not include any path information. May be derived from dataset_name.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_name (str): Name of the dataset</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: This method is not supported by the DynamicFeaturization subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;DynamicFeaturization doesn&#39;t support get_featurized_dset_name()&quot;</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.get_featurized_data_subdir"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.get_featurized_data_subdir">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_data_subdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of a subdirectory (without any leading path information) in which to store</span>
<span class="sd">        featurized data, if it goes to the filesystem.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: This method is not supported by the DynamicFeaturization subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;DynamicFeaturization doesn&#39;t support get_featurized_data_subdir()&quot;</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.get_feature_columns"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.get_feature_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of feature column names associated with this Featurization instance.</span>
<span class="sd">        For DynamicFeaturization, the column names are essentially meaningless, so these will</span>
<span class="sd">        be &quot;c0, c1, ... etc.&quot;.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list): List of column names in the format [&#39;c0&#39;,&#39;c1&#39;, ...] of the length of the features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;c</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_feature_count</span><span class="p">())]</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.get_feature_count"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.get_feature_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of feature columns associated with this Featurization instance. </span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int): The number of feature columns for the DynamicFeaturization subclass, feat_type specific</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span><span class="o">.</span><span class="n">size</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span><span class="o">.</span><span class="n">feature_length</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;molvae&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer_obj</span><span class="o">.</span><span class="n">latent_rep_size</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DynamicFeaturization.get_feature_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DynamicFeaturization.get_feature_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this Featurization object that are specific</span>
<span class="sd">        to the feature type.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Argparse Namespace object containing the parameter list</span>

<span class="sd">        Returns</span>
<span class="sd">            dict: Dictionary containing featurizer specific metadata as a subdict under the keys</span>
<span class="sd">            [&#39;ECFPSpecific&#39;,&#39;AutoencoderSpecific&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feat_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># MJT: I changed params.featurizer in this instance to self.feat_type to be syntactically consistent</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
            <span class="n">ecfp_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ecfp_radius</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">ecfp_radius</span><span class="p">,</span>
                               <span class="n">ecfp_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">ecfp_size</span><span class="p">)</span>
            <span class="n">feat_metadata</span><span class="p">[</span><span class="s1">&#39;ECFPSpecific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecfp_params</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
            <span class="c1"># No graph conv specific params at present</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s1">&#39;molvae&#39;</span><span class="p">:</span>
            <span class="c1"># TODO: If the parameter name for the model file changes to &#39;autoencoder_model_key&#39;, change it below.</span>
            <span class="n">mol_vae_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;autoencoder_model_key&#39;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">mol_vae_model_file</span><span class="p">}</span>
            <span class="n">feat_metadata</span><span class="p">[</span><span class="s1">&#39;AutoencoderSpecific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_vae_params</span>
        <span class="k">return</span> <span class="n">feat_metadata</span></div></div>

<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="PersistentFeaturization"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.PersistentFeaturization">[docs]</a><span class="k">class</span> <span class="nc">PersistentFeaturization</span><span class="p">(</span><span class="n">Featurization</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass for featurizers that support persistent storage of featurized data. Used when computing or mapping</span>
<span class="sd">    the features is CPU- or memory-intensive, e.g. descriptors. Currently DescriptorFeaturization is the only subclass,</span>
<span class="sd">    but others are planned (e.g., UMAPDescriptorFeaturization).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a PersistentFeaturization object. This is a good place to load data used by the featurizer,</span>
<span class="sd">        such as a table of descriptors.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Contains parameters to be used to instantiate a featurizer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PersistentFeaturization.extract_prefeaturized_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.PersistentFeaturization.extract_prefeaturized_data">[docs]</a>    <span class="k">def</span> <span class="nf">extract_prefeaturized_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to extract prefeaturized data for the given dataset.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            merged_dset_df (DataFrame): dataset merged with the featurizers</span>

<span class="sd">            model_dataset (ModelDataset): Object containing the dataset to be featurized</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Currently, only DescriptorFeaturization is supported, is not a generic method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Is it possible to implement this generically for all persistent featurizers?</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PersistentFeaturization.featurize_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.PersistentFeaturization.featurize_data">[docs]</a>    <span class="k">def</span> <span class="nf">featurize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform featurization on the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dset_df (DataFrame): A table of data to be featurized. At minimum, should include columns.</span>
<span class="sd">            for the compound ID and assay value; for some featurizers, must also contain a SMILES string column.</span>

<span class="sd">            model_dataset (ModelDataset): Object containing the dataset to be featurized</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (features, ids, vals, attr).</span>
<span class="sd">                features (np.array): Feature matrix.</span>
<span class="sd">                </span>
<span class="sd">                ids (pd.DataFrame): compound IDs or SMILES strings if needed for splitting.</span>
<span class="sd">                </span>
<span class="sd">                attr (pd.DataFrame): dataframe containing SMILES strings indexed by compound IDs.</span>
<span class="sd">                </span>
<span class="sd">                vals (np.array): array of response values.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Currently, only DescriptorFeaturization is supported, is not a generic method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: Add comment describing why this is not implemented</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PersistentFeaturization.create_feature_transformer"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.PersistentFeaturization.create_feature_transformer">[docs]</a>    <span class="k">def</span> <span class="nf">create_feature_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit a scaling and centering transformation to the feature matrix of the given dataset, and return a</span>
<span class="sd">        DeepChem transformer object holding its parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (deepchem.Dataset): featurized dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: Add comment describing why this is always returning an empty list</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>

<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="DescriptorFeaturization"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization">[docs]</a><span class="k">class</span> <span class="nc">DescriptorFeaturization</span><span class="p">(</span><span class="n">PersistentFeaturization</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass for featurizers that map sets of (usually) precomputed descriptors to compound IDs; the resulting merged</span>
<span class="sd">    dataset is persisted to the filesystem or datastore.</span>
<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init_:</span>
<span class="sd">        feat_type (str): Type of featurizer, set in super.(__init__)</span>
<span class="sd">        </span>
<span class="sd">        descriptor_type (str): The type of descriptor</span>
<span class="sd">        </span>
<span class="sd">        descriptor_key (str): The path to the descriptor featurization matrix if it saved to a file,</span>
<span class="sd">        or the key to the file in the Datastore</span>
<span class="sd">        </span>
<span class="sd">        descriptor_base (str/path): The base path to the descriptor featurization matrix</span>
<span class="sd">        </span>
<span class="sd">        precomp_descr_table (pd.DataFrame): initialized as an empty DataFrame, will be overridden to contain the</span>
<span class="sd">        full descriptor table</span>
<span class="sd">            </span>
<span class="sd">    Class attributes:</span>
<span class="sd">        supported_descriptor_types</span>
<span class="sd">        </span>
<span class="sd">        all_desc_col</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">supported_descriptor_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">desc_type_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">desc_type_scaled</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">desc_type_source</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ****************************************************************************************</span>
    <span class="c1"># (ksm): Made this a class method. A DescriptorFeaturization instance only supports</span>
    <span class="c1"># one descriptor_type, so making the list of supported descriptor types an instance attribute</span>
    <span class="c1"># was misleading.</span>

<div class="viewcode-block" id="DescriptorFeaturization.load_descriptor_spec"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.load_descriptor_spec">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_descriptor_spec</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">desc_spec_bucket</span><span class="p">,</span> <span class="n">desc_spec_key</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read a descriptor specification table from the datastore or the filesystem.</span>
<span class="sd">        The table is a CSV file with the following columns:</span>
<span class="sd">        descr_type:     A string specifying a descriptor source/program and a subset of descriptor columns</span>
<span class="sd">        </span>
<span class="sd">        source:         Name of the program/package that generates the descriptors</span>
<span class="sd">        scaled:         Binary indicator for whether subset of descriptor values are scaled by molecule&#39;s atom count</span>
<span class="sd">        </span>
<span class="sd">        descriptors:    A semicolon separated list of descriptor columns.</span>
<span class="sd">            </span>
<span class="sd">        The values in the table are used to set class variables desc_type_cols, desc_type_source and desc_type_scaled.</span>

<span class="sd">        Args:</span>
<span class="sd">            desc_spec_bucket : bucket where descriptor spec is located</span>

<span class="sd">            desc_spec_key: data store key, or full file path to locate descriptor spec object</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following class variables:</span>
<span class="sd">            </span>
<span class="sd">            cls.desc_type_cols -&gt; map from decriptor types to their associated descriptor column names</span>
<span class="sd">            </span>
<span class="sd">            cls.desc_type_source -&gt; map from decriptor types to the program/package that generates them</span>
<span class="sd">            </span>
<span class="sd">            cls.desc_type_scaled -&gt; map from decriptor types to boolean indicators of whether some descriptor</span>
<span class="sd">            values are scaled.</span>
<span class="sd">            </span>
<span class="sd">            cls.supported_descriptor_types  -&gt; the list of available descriptor types</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">config_client</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception when trying to connect to the datastore:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">ds_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_cols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_scaled</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_source</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If a datastore client is not detected or a datastore bucket is not specified</span>
        <span class="c1"># assume that the ds_key is a full path pointer to a file on the file system</span>
        <span class="k">if</span> <span class="n">ds_client</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">desc_spec_bucket</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  
            <span class="n">desc_spec_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">desc_spec_key</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span> 
            <span class="n">desc_spec_df</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">desc_spec_key</span><span class="p">,</span> <span class="n">desc_spec_bucket</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">desc_type</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">scaled</span><span class="p">,</span> <span class="n">descriptors</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">desc_spec_df</span><span class="o">.</span><span class="n">descr_type</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                          <span class="n">desc_spec_df</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                          <span class="n">desc_spec_df</span><span class="o">.</span><span class="n">scaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                          <span class="n">desc_spec_df</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_cols</span><span class="p">[</span><span class="n">desc_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_source</span><span class="p">[</span><span class="n">desc_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_scaled</span><span class="p">[</span><span class="n">desc_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">scaled</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">supported_descriptor_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_source</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a DescriptorFeaturization object. This is a good place to load data used by the featurizer,</span>
<span class="sd">        such as a table of descriptors.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Contains parameters to be used to instantiate a featurizer.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of DescriptorFeaturization:</span>
<span class="sd">            </span>
<span class="sd">            feat_type (str): Type of featurizer, set in __init__</span>
<span class="sd">            </span>
<span class="sd">            descriptor_type (str): The type of descriptor</span>
<span class="sd">            </span>
<span class="sd">            descriptor_key (str): The path to the precomputed descriptor table if it is saved to a file, or</span>
<span class="sd">            the key to the file in the Datastore</span>
<span class="sd">            </span>
<span class="sd">            descriptor_base (str/path): The base name of the precomputed descriptor table file, without the</span>
<span class="sd">            directory and extension</span>
<span class="sd">            </span>
<span class="sd">            precomp_descr_table (pd.DataFrame): The precomputed descriptor table itself. Initialized as an empty</span>
<span class="sd">            DataFrame, will be replaced later on first call to featurize_data().</span>
<span class="sd">            </span>
<span class="sd">            desc_id_col (str): Name of the column in precomp_descr_table containing compound IDs</span>
<span class="sd">            </span>
<span class="sd">            desc_smiles_col (str): Name of the column in precomp_descr_table, if any, containing compound SMILES</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="c1"># JEA: load mapping between descriptor types and lists of descriptors</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">supported_descriptor_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">load_descriptor_spec</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_spec_bucket</span><span class="p">,</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_spec_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supported_descriptor_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported descriptor type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_base</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="o">=</span> <span class="kc">None</span>
        

        <span class="c1"># Load an empty descriptor table. We&#39;ll load the real table later the first time we need it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a human-readable description of this Featurization object.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (str): Describes the featurization type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;DescriptorFeaturization with </span><span class="si">%s</span><span class="s2"> descriptors&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_type</span>

            
    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.extract_prefeaturized_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.extract_prefeaturized_data">[docs]</a>    <span class="k">def</span> <span class="nf">extract_prefeaturized_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to retrieve prefeaturized data for the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            merged_dset_df (pd.DataFrame): dataset merged with the featurizers</span>

<span class="sd">            model_dataset (ModelDataset): Object containing the dataset to be featurized</span>
<span class="sd">            # TODO: Remove model_dataset call once params.response_cols is properly set</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (features, ids, vals, attr).</span>
<span class="sd">            </span>
<span class="sd">            features (np.array): Feature matrix.</span>
<span class="sd">            </span>
<span class="sd">            ids (pd.DataFrame): compound IDs or SMILES strings if needed for splitting.</span>
<span class="sd">            </span>
<span class="sd">            attr (pd.DataFrame): dataframe containing SMILES strings indexed by compound IDs.</span>
<span class="sd">            </span>
<span class="sd">            vals (np.array): array of response values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_dataset</span><span class="o">.</span><span class="n">check_task_columns</span><span class="p">(</span><span class="n">merged_dset_df</span><span class="p">)</span>
        <span class="n">user_specified_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_columns</span><span class="p">()</span>
        <span class="n">featurizer_obj</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">UserDefinedFeaturizer</span><span class="p">(</span><span class="n">user_specified_features</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">get_user_specified_features</span><span class="p">(</span><span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer_obj</span><span class="p">,</span>
                                                                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span> <span class="p">:</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">attr</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.load_descriptor_table"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.load_descriptor_table">[docs]</a>    <span class="k">def</span> <span class="nf">load_descriptor_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the table of precomputed feature values for the descriptor type specified in params, from</span>
<span class="sd">        the datastore_key or path specified by params.descriptor_key and params.descriptor_bucket. Will try</span>
<span class="sd">        to load the table from the local filesystem if possible, but the table should at least have a </span>
<span class="sd">        metadata record in the datastore. The local file path is the same as descriptor_key on twintron-blue,</span>
<span class="sd">        and may be taken from the LC_path metadata property if it is set.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Parameters for the current pipeline instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Overwrites the attribute precomp_descr_table (pd.DataFrame) with the loaded descriptor table.</span>
<span class="sd">            Sets attributes desc_id_col and desc_smiles_col, if possible, based on the datastore metadata for the</span>
<span class="sd">            descriptor table. Otherwise, sets them to reasonable defaults. Note that not all descriptor tables </span>
<span class="sd">            contain SMILES strings, but one is required if the table is to be used with ComputedDescriptorFeaturization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if we have a datastore client to work with</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">config_client</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception when trying to connect to the datastore:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">ds_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">file_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span>
        <span class="k">if</span> <span class="n">ds_client</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="c1"># First get the datastore metadata for the descriptor table. Ideally this will exist even if the table</span>
            <span class="c1"># itself lives in the filesystem.</span>
            <span class="n">desc_metadata</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span><span class="p">,</span> 
                                                               <span class="n">client</span><span class="o">=</span><span class="n">ds_client</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">file_type</span> <span class="o">=</span> <span class="n">desc_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">]</span>
            <span class="n">kv_dict</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">get_key_val</span><span class="p">(</span><span class="n">desc_metadata</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="o">=</span> <span class="n">kv_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id_col&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="o">=</span> <span class="n">kv_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smiles_col&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span><span class="p">)</span>

            <span class="c1"># Some descriptor tables in datastore have a metadata property LC_path that point to where</span>
            <span class="c1"># the table can be found locally on LC systems. Use this if we&#39;re running on LC.</span>
            <span class="n">lc_path</span> <span class="o">=</span> <span class="n">kv_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LC_path&#39;</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
            <span class="c1"># Loading from the datastore is much slower than loading from disk, so check if file exists locally</span>
            <span class="c1"># and download it otherwise</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="s1">&#39;LC&#39;</span> <span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">lc_path</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading descriptor table from datastore key=</span><span class="si">%s</span><span class="s2"> bucket=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">,</span>
                                                                              <span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done reading descriptor table from datastore&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading descriptor table from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">local_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">file_type</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">)</span> <span class="p">:</span>
                <span class="c1">## DeepChem&#39;s transformer complained that the elements were not float, if I don&#39;t cast them as such here</span>
                <span class="c1">## not sure why this is happening (JEA)</span>
                <span class="n">dtype_map</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">el</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_columns</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype_map</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">local_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.feather&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">file_type</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;feather&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">feather_supported</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;feather package not installed in current environment&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">feather</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown descriptor table file format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">local_path</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done loading descriptor table from filesystem.&quot;</span><span class="p">)</span>

        <span class="c1"># If ID column not in metadata, see if descriptor table has one of the same name as the</span>
        <span class="c1"># dataset ID column, or failing that, a reasonable default.</span>
        <span class="n">id_choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span> <span class="s1">&#39;compound_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">id_col</span> <span class="ow">in</span> <span class="n">id_choices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">id_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="o">=</span> <span class="n">id_col</span>
                    <span class="k">break</span>

        <span class="c1"># If SMILES column not in metadata, see if descriptor table has one of the same name as the</span>
        <span class="c1"># dataset SMILES column, or else a reasonable default.</span>
        <span class="n">smiles_choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span> <span class="s1">&#39;rdkit_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;base_rdkit_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">smiles_col</span> <span class="ow">in</span> <span class="n">smiles_choices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">smiles_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="o">=</span> <span class="n">smiles_col</span>
                    <span class="k">break</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.featurize_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.featurize_data">[docs]</a>    <span class="k">def</span> <span class="nf">featurize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform featurization on the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dset_df (DataFrame): A table of data to be featurized. At minimum, should include columns.</span>
<span class="sd">            for the compound ID and assay value; for some featurizers, must also contain a SMILES string column.</span>

<span class="sd">            model_dataset (ModelDataset): Object containing the dataset to be featurized</span>
<span class="sd">            # TODO: Remove model_dataset call once params.response_cols is properly set</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (features, ids, vals, attr).</span>
<span class="sd">            </span>
<span class="sd">            features (np.array): Feature matrix.</span>
<span class="sd">            </span>
<span class="sd">            ids (pd.DataFrame): compound IDs or SMILES strings if needed for splitting.</span>
<span class="sd">            </span>
<span class="sd">            attr (pd.DataFrame): dataframe containing SMILES strings indexed by compound IDs.</span>
<span class="sd">            </span>
<span class="sd">            vals (np.array): array of response values</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: if features is None, feautirzation failed for the dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Overwrites the attribute precomp_descr_table (pd.DataFrame) with the appropriate descriptor table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span>
        <span class="c1"># Compound ID and SMILES columns will be labeled the same as in the input dataset, unless overridden by</span>
        <span class="c1"># properties of the precomputed descriptor table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_descriptor_table</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unable to find compound ID column in descriptor table </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">)</span>

        <span class="n">attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
            <span class="n">index</span><span class="o">=</span><span class="n">dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">])</span>
        <span class="n">dset_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span>
        <span class="c1"># Include SMILES column from dataset in columns to be merged, unless the descriptor table</span>
        <span class="c1"># already has a column of the same name</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">dset_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">contains_responses</span><span class="p">:</span>
            <span class="n">dset_cols</span> <span class="o">+=</span> <span class="n">params</span><span class="o">.</span><span class="n">response_cols</span>
        <span class="n">merged_dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">dset_cols</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span><span class="p">)</span>
        
        <span class="n">model_dataset</span><span class="o">.</span><span class="n">save_featurized_data</span><span class="p">(</span><span class="n">merged_dset_df</span><span class="p">)</span>

        <span class="n">user_specified_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_columns</span><span class="p">()</span>

        <span class="n">featurizer_obj</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">UserDefinedFeaturizer</span><span class="p">(</span><span class="n">user_specified_features</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">get_user_specified_features</span><span class="p">(</span><span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer_obj</span><span class="p">,</span>
                                                                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Featurization failed for dataset&quot;</span><span class="p">)</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">contains_responses</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">))</span>

        <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">attr</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.get_featurized_dset_name"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.get_featurized_dset_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_dset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a name for the featurized dataset, for use in filenames or dataset keys.</span>
<span class="sd">        Does not include any path information. May be derived from dataset_name.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_name (str): Name of the dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): A name for the feauturized dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;subset_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor_base</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.get_featurized_data_subdir"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.get_featurized_data_subdir">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_data_subdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of a subdirectory (without any leading path information) in which to store</span>
<span class="sd">        featurized data, if it goes to the filesystem.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): &#39;scaled_descriptors&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;scaled_descriptors&#39;</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.get_feature_columns"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.get_feature_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of feature column names associated with this Featurization instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list): List of column names of the features, pulled from DescriptorFeaturization attributes</span>

<span class="sd">        &quot;&quot;&quot;</span>
       
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">desc_type_cols</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="p">]</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.get_feature_count"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.get_feature_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of feature columns associated with this Featurization instance. </span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int): Number of feature columns associated with DescriptorFeaturization</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_feature_columns</span><span class="p">())</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.create_feature_transformer"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.create_feature_transformer">[docs]</a>    <span class="k">def</span> <span class="nf">create_feature_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit a scaling and centering transformation to the feature matrix of the given dataset, and return a</span>
<span class="sd">        DeepChem transformer object holding its parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (deepchem.Dataset): featurized dataset</span>
<span class="sd">        Returns:</span>
<span class="sd">            (list of DeepChem transformer objects): list of transformers for the feature matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transformers_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformer</span><span class="p">(</span><span class="n">transform_X</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">transformers_x</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DescriptorFeaturization.get_feature_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.DescriptorFeaturization.get_feature_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this Featurization object that are specific</span>
<span class="sd">        to the feature type.</span>
<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Argparse Namespace argument containing the parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feat_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">desc_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">descriptor_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">,</span>
                           <span class="n">descriptor_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">,</span>
                           <span class="n">descriptor_bucket</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span><span class="p">)</span>
        <span class="n">feat_metadata</span><span class="p">[</span><span class="s1">&#39;DescriptorSpecific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_params</span>
        <span class="k">return</span> <span class="n">feat_metadata</span></div></div>

<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ComputedDescriptorFeaturization"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization">[docs]</a><span class="k">class</span> <span class="nc">ComputedDescriptorFeaturization</span><span class="p">(</span><span class="n">DescriptorFeaturization</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass for featurizers that support online computation of descriptors, usually given SMILES</span>
<span class="sd">    strings or RDKit Mol objects as input rather than compound IDs. The computed descriptors may be cached</span>
<span class="sd">    and combined with tables of precomputed descriptors to speed up access. Featurized datasets may be</span>
<span class="sd">    persisted to the filesystem or datastore.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init_:</span>
<span class="sd">        </span>
<span class="sd">        feat_type (str): Type of featurizer, set in super.(__init__)</span>
<span class="sd">        </span>
<span class="sd">        descriptor_type (str): The type of descriptor</span>
<span class="sd">        </span>
<span class="sd">        descriptor_key (str): The path to the descriptor featurization matrix if it saved to a file, or the key to</span>
<span class="sd">        the file in the Datastore</span>
<span class="sd">        </span>
<span class="sd">        descriptor_base (str/path): The base path to the descriptor featurization matrix</span>
<span class="sd">        </span>
<span class="sd">        precomp_descr_table (pd.DataFrame): initialized as empty df, will be overridden to contain full descriptor table</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a ComputedDescriptorFeaturization object. </span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Contains parameters to be used to instantiate a featurizer.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of DescriptorFeaturization</span>
<span class="sd">            </span>
<span class="sd">            feat_type (str): Type of featurizer, set in __init__</span>
<span class="sd">            </span>
<span class="sd">            descriptor_type (str): The type of descriptor</span>
<span class="sd">            </span>
<span class="sd">            descriptor_key (str): The path to the descriptor featurization matrix if it saved to a file,</span>
<span class="sd">            or the key to the file in the Datastore</span>
<span class="sd">            </span>
<span class="sd">            descriptor_base (str/path): The base path to the descriptor featurization matrix</span>
<span class="sd">            </span>
<span class="sd">            precomp_descr_table (pd.DataFrame): initialized as an empty DataFrame, will be overridden to contain</span>
<span class="sd">            the full descriptor table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supported_descriptor_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Descriptor type </span><span class="si">%s</span><span class="s2"> is not in the supported descriptor_type list&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span>



    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.featurize_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.featurize_data">[docs]</a>    <span class="k">def</span> <span class="nf">featurize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform featurization on the given dataset, by computing descriptors from SMILES strings or matching them</span>
<span class="sd">        to SMILES in precomputed table.</span>

<span class="sd">        Args:</span>
<span class="sd">            dset_df (DataFrame): A table of data to be featurized. At minimum, should include columns.</span>
<span class="sd">            for the compound ID and assay value; for some featurizers, must also contain a SMILES string column.</span>

<span class="sd">            model_dataset (ModelDataset): Object containing the dataset to be featurized</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (features, ids, vals, attr).</span>
<span class="sd">            </span>
<span class="sd">            features (np.array): Feature matrix.</span>
<span class="sd">            </span>
<span class="sd">            ids (pd.DataFrame): compound IDs or SMILES strings if needed for splitting.</span>
<span class="sd">            </span>
<span class="sd">            attr (pd.DataFrame): dataframe containing SMILES strings indexed by compound IDs.</span>
<span class="sd">            </span>
<span class="sd">            vals (np.array): array of response values</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: if features is None, feautirzation failed for the dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Loads a precomputed descriptor table and sets self.precomp_descr_table to point to it, if one is</span>
<span class="sd">            specified by params.descriptor_key.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">params</span>
        <span class="n">use_precomputed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">descr_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_columns</span><span class="p">()</span>

        <span class="c1"># Try to load a precomputed descriptor table, and check that it&#39;s useful to us</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_descriptor_table</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Precomputed descriptor table </span><span class="si">%s</span><span class="s2"> lacks a SMILES column and/or an ID column.&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will compute all descriptors on the fly.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check that descriptor table provides all the columns required by the current descriptor_type.</span>
                <span class="c1"># If not, it&#39;s of no use to us.</span>
                <span class="n">absent_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">descr_cols</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">absent_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Precomputed descriptor table </span><span class="si">%s</span><span class="s2"> lacks columns needed for descriptor type </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                 <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">absent_cols</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will compute all descriptors on the fly.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Descriptor table is good. Reduce it to only the columns we need.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span><span class="p">]</span><span class="o">+</span><span class="n">descr_cols</span><span class="p">]</span>
                    <span class="n">use_precomputed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If we were unable to determine which descriptor table columns to use for the compound ID or SMILES string,</span>
        <span class="c1"># then we&#39;re computing all descriptors. Use the same column names as were specified for the input dataset</span>
        <span class="c1"># for whichever columns are missing.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">id_col</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span>

        <span class="c1"># Select columns to include from the input dataset in the featurized dataset</span>
        <span class="n">dset_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">contains_responses</span><span class="p">:</span>
            <span class="n">dset_cols</span> <span class="o">+=</span> <span class="n">params</span><span class="o">.</span><span class="n">response_cols</span>
        <span class="n">input_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">dset_cols</span><span class="p">]</span>

        <span class="c1"># Identify which SMILES strings in the dataset need to have descriptors calculated for them and</span>
        <span class="c1"># which already have them precomputed</span>
        <span class="n">dset_smiles</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">use_precomputed</span><span class="p">:</span>
            <span class="n">calc_smiles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dset_smiles</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="n">precomp_smiles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dset_smiles</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">calc_smiles</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calc_smiles</span> <span class="o">=</span> <span class="n">dset_smiles</span>
            <span class="n">precomp_smiles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Compute descriptors for the compounds that need them</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calc_smiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">calc_smiles_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">[</span><span class="n">input_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">calc_smiles</span><span class="p">)]</span>
            <span class="n">calc_desc_df</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_descriptors</span><span class="p">(</span><span class="n">calc_smiles_df</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">calc_merged_df</span> <span class="o">=</span> <span class="n">calc_smiles_df</span><span class="p">[</span><span class="n">is_valid</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">descr_cols</span><span class="p">:</span>
                <span class="n">calc_merged_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_desc_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="c1"># Get rid of any extra columns</span>
            <span class="n">calc_merged_df</span> <span class="o">=</span> <span class="n">calc_merged_df</span><span class="p">[</span><span class="n">dset_cols</span><span class="o">+</span><span class="n">descr_cols</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomp_smiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">merged_dset_df</span> <span class="o">=</span> <span class="n">calc_merged_df</span>

            <span class="c1"># Add the newly computed descriptors to the precomputed table</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">calc_desc_df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="p">,</span> <span class="n">calc_desc_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Merge descriptors from the precomputed table for the remaining compounds</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomp_smiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">precomp_smiles_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">[</span><span class="n">input_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">precomp_smiles</span><span class="p">)]</span>
            <span class="n">precomp_merged_df</span> <span class="o">=</span> <span class="n">precomp_smiles_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precomp_descr_table</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                                        <span class="n">left_on</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
                                                        <span class="n">right_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span><span class="p">,</span>
                                                        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">))</span>
            <span class="c1"># Remove duplicate SMILES matches</span>
            <span class="n">precomp_merged_df</span> <span class="o">=</span> <span class="n">precomp_merged_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">])</span>

            <span class="c1"># Get rid of any extra columns</span>
            <span class="n">precomp_merged_df</span> <span class="o">=</span> <span class="n">precomp_merged_df</span><span class="p">[</span><span class="n">dset_cols</span><span class="o">+</span><span class="n">descr_cols</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calc_smiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">merged_dset_df</span> <span class="o">=</span> <span class="n">precomp_merged_df</span>

        <span class="c1"># Combine the computed and precomputed data frames, if we had both</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precomp_smiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">calc_smiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">merged_dset_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">calc_merged_df</span><span class="p">,</span> <span class="n">precomp_merged_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO (ksm): Replace nan feature values with averages over non-missing rows, so that scaling and centering</span>
        <span class="c1"># works as it should.</span>
        <span class="c1"># Save the featurized dataset</span>
        <span class="n">model_dataset</span><span class="o">.</span><span class="n">save_featurized_data</span><span class="p">(</span><span class="n">merged_dset_df</span><span class="p">)</span>


        <span class="c1"># Use the DeepChem featurizer to construct the feature array</span>
        <span class="n">featurizer_obj</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">UserDefinedFeaturizer</span><span class="p">(</span><span class="n">descr_cols</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">get_user_specified_features</span><span class="p">(</span><span class="n">merged_dset_df</span><span class="p">,</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer_obj</span><span class="p">,</span>
                                                                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UserDefinedFeaturizer failed for dataset&quot;</span><span class="p">)</span>

        <span class="c1"># Construct the other components of a DeepChem Dataset object</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">contains_responses</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">))</span>

        <span class="c1"># Create a table of SMILES strings indexed by compound IDs</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="n">merged_dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
            <span class="n">index</span><span class="o">=</span><span class="n">merged_dset_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">attr</span></div>
        
    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.get_featurized_dset_name"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.get_featurized_dset_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_featurized_dset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a name for the featurized dataset, for use in filenames or dataset keys.</span>
<span class="sd">        Does not include any path information. May be derived from dataset_name.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_name (str): Name of the dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): A name for the feauturized dataset</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_with_</span><span class="si">%s</span><span class="s1">_descriptors.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.compute_descriptors"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.compute_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">compute_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_df</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute descriptors for the SMILES strings given in smiles_df.</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles_df: DataFrame containing SMILES strings to compute descriptors for.</span>

<span class="sd">            params (Namespace): Argparse Namespace argument containing the parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            ret_df (DataFrame): Data frame containing the compound IDs, SMILES string and descriptor columns as</span>
<span class="sd">            specified in the current parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">descr_source</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_source</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">]</span>
        <span class="n">descr_cols</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_cols</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">]</span>
        <span class="n">descr_scaled</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_scaled</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">descr_source</span> <span class="o">==</span> <span class="s1">&#39;mordred&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mordred_supported</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;mordred package needs to be installed to use Mordred descriptors&quot;</span><span class="p">)</span>
            <span class="n">desc_df</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mordred_descriptors</span><span class="p">(</span><span class="n">smiles_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">desc_df</span> <span class="o">=</span> <span class="n">desc_df</span><span class="p">[</span><span class="n">descr_cols</span><span class="p">]</span>
            <span class="c1"># Add the ID and SMILES columns to the returned data frame</span>
            <span class="n">ret_df</span> <span class="o">=</span> <span class="n">smiles_df</span><span class="p">[</span><span class="n">is_valid</span><span class="p">][[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ret_df</span> <span class="o">=</span> <span class="n">ret_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_id_col</span><span class="p">,</span>
                                        <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc_smiles_col</span><span class="p">})</span>
            <span class="n">desc_df</span> <span class="o">=</span> <span class="n">desc_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ret_df</span> <span class="o">=</span> <span class="n">ret_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">descr_source</span> <span class="o">==</span> <span class="s1">&#39;rdkit&#39;</span><span class="p">:</span>
            <span class="c1"># TODO (ksm): mordred computes a subset of RDKit descriptors, but apparently they have different</span>
            <span class="c1"># names from the ones generated directly by RDKit. Hold off on this until we have code in place</span>
            <span class="c1"># to call RDKit directly.</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;RDKit descriptor computations are not yet supported.&quot;</span><span class="p">)</span>
            <span class="c1">#desc_df, is_valid = self.compute_rdkit_descriptors(smiles_df[params.smiles_col].values)</span>

        <span class="k">elif</span> <span class="n">descr_source</span> <span class="o">==</span> <span class="s1">&#39;moe&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">system</span> <span class="o">!=</span> <span class="s1">&#39;LC&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;MOE descriptors currently can only be computed on LC systems.&quot;</span><span class="p">)</span>
            <span class="n">desc_df</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_moe_descriptors</span><span class="p">(</span><span class="n">smiles_df</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="c1"># Add scaling by a_count if descr_scaled is True</span>
            <span class="k">if</span> <span class="n">descr_scaled</span><span class="p">:</span>
                <span class="n">ret_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_moe_descriptors</span><span class="p">(</span><span class="n">desc_df</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported descriptor_type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret_df</span><span class="p">,</span> <span class="n">is_valid</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.compute_mordred_descriptors"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.compute_mordred_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">compute_mordred_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_strs</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Mordred descriptors for the given list of SMILES strings</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles_strs (iterable): SMILES strings to compute descriptors for.</span>

<span class="sd">            params (Namespace): Argparse Namespace argument containing the parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): Tuple containing:</span>

<span class="sd">                desc_df (DataFrame): Data frame containing computed descriptors</span>

<span class="sd">                is_valid (ndarray of bool): True for each input SMILES string that was valid according to RDKit</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mols3d</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">get_3d_mols</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">)</span>
        <span class="n">quiet</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">verbose</span>
        <span class="n">desc_df</span> <span class="o">=</span> <span class="n">compute_all_mordred_descrs</span><span class="p">(</span><span class="n">mols3d</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">mordred_cpus</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">desc_df</span><span class="p">,</span> <span class="n">is_valid</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.compute_rdkit_descriptors"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.compute_rdkit_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">compute_rdkit_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_strs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute RDKit descriptors for the given list of SMILES strings</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles_strs: SMILES strings to compute descriptors for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): Tuple containing:</span>

<span class="sd">                desc_df (DataFrame): Data frame containing computed descriptors</span>

<span class="sd">                is_valid (ndarray of bool): True for each input SMILES string that was valid according to RDKit</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mols2d</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">get_2d_mols</span><span class="p">(</span><span class="n">smiles_strs</span><span class="p">)</span>
        <span class="n">desc_df</span> <span class="o">=</span> <span class="n">compute_all_rdkit_descrs</span><span class="p">(</span><span class="n">mols2d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">desc_df</span><span class="p">,</span> <span class="n">is_valid</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.compute_moe_descriptors"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.compute_moe_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">compute_moe_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_df</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute MOE descriptors for the given list of SMILES strings</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles_strs (iterable): SMILES strings to compute descriptors for.</span>

<span class="sd">            params (Namespace): Argparse Namespace argument containing the parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): Tuple containing:</span>

<span class="sd">                desc_df (DataFrame): Data frame containing computed descriptors</span>

<span class="sd">                is_valid (ndarray of bool): True for each input SMILES string that was valid according to RDKit</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nsmiles</span> <span class="o">=</span> <span class="n">smiles_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">desc_df</span> <span class="o">=</span> <span class="n">compute_all_moe_descriptors</span><span class="p">(</span><span class="n">smiles_df</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="c1"># MOE ignores SMILES strings it can&#39;t parse, so we have to mark as invalid the corresponding</span>
        <span class="c1"># input compounds</span>
        <span class="n">desc_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">desc_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">desc_ids</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">smiles_df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">desc_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Check for output rows that are all missing values</span>
        <span class="c1">#descr_cols = self.get_feature_columns()</span>

        <span class="n">num_invalid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">is_valid</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">is_valid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_invalid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MOE did not compute descriptors for </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> SMILES strings&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_invalid</span><span class="p">,</span> <span class="n">nsmiles</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">desc_df</span><span class="p">,</span> <span class="n">is_valid</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ComputedDescriptorFeaturization.scale_moe_descriptors"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ComputedDescriptorFeaturization.scale_moe_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">scale_moe_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc_df</span><span class="p">,</span> <span class="n">descr_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale selected descriptors computed by MOE by dividing their values by the atom count per molecule.</span>

<span class="sd">        Args:</span>
<span class="sd">            desc_df (DataFrame): Data frame containing computed descriptors.</span>

<span class="sd">            descr_type (str): Descriptor type, used to look up expected set of descriptor columns.</span>

<span class="sd">        Returns:</span>
<span class="sd">            scaled_df (DataFrame): Data frame with scaled descriptors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">descr_cols</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">desc_type_cols</span><span class="p">[</span><span class="n">descr_type</span><span class="p">]</span>
        <span class="n">a_count</span> <span class="o">=</span> <span class="n">desc_df</span><span class="o">.</span><span class="n">a_count</span><span class="o">.</span><span class="n">values</span>
        <span class="n">unscaled_moe_desc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_per_atom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">descr_cols</span><span class="p">]</span>
        <span class="n">nondesc_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">desc_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">unscaled_moe_desc_cols</span><span class="p">))</span>
        <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">desc_df</span><span class="p">[</span><span class="n">nondesc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">scaled_col</span><span class="p">,</span> <span class="n">unscaled_col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">descr_cols</span><span class="p">,</span> <span class="n">unscaled_moe_desc_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">scaled_col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_per_atom&#39;</span><span class="p">):</span>
                <span class="n">scaled_df</span><span class="p">[</span><span class="n">scaled_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_df</span><span class="p">[</span><span class="n">unscaled_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">a_count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scaled_df</span><span class="p">[</span><span class="n">scaled_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_df</span><span class="p">[</span><span class="n">unscaled_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">scaled_df</span></div></div>


<span class="c1"># **************************************************************************************************************</span>
<span class="c1"># Subclasses of Mordred descriptor classes</span>
<span class="c1"># **************************************************************************************************************</span>

<span class="k">if</span> <span class="n">mordred_supported</span><span class="p">:</span>

<div class="viewcode-block" id="ATOMAtomTypeEState"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ATOMAtomTypeEState">[docs]</a>    <span class="k">class</span> <span class="nc">ATOMAtomTypeEState</span><span class="p">(</span><span class="n">AtomTypeEState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;EState descriptors restricted to those that can be computed for most compounds&quot;&quot;&quot;</span>
        
        <span class="n">my_es_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sCH3&#39;</span><span class="p">,</span><span class="s1">&#39;dCH2&#39;</span><span class="p">,</span><span class="s1">&#39;ssCH2&#39;</span><span class="p">,</span><span class="s1">&#39;dsCH&#39;</span><span class="p">,</span><span class="s1">&#39;aaCH&#39;</span><span class="p">,</span><span class="s1">&#39;sssCH&#39;</span><span class="p">,</span><span class="s1">&#39;tsC&#39;</span><span class="p">,</span><span class="s1">&#39;dssC&#39;</span><span class="p">,</span><span class="s1">&#39;aasC&#39;</span><span class="p">,</span><span class="s1">&#39;aaaC&#39;</span><span class="p">,</span><span class="s1">&#39;ssssC&#39;</span><span class="p">,</span><span class="s1">&#39;sNH2&#39;</span><span class="p">,</span><span class="s1">&#39;ssNH&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;aaNH&#39;</span><span class="p">,</span><span class="s1">&#39;tN&#39;</span><span class="p">,</span><span class="s1">&#39;dsN&#39;</span><span class="p">,</span><span class="s1">&#39;aaN&#39;</span><span class="p">,</span><span class="s1">&#39;sssN&#39;</span><span class="p">,</span><span class="s1">&#39;ddsN&#39;</span><span class="p">,</span><span class="s1">&#39;aasN&#39;</span><span class="p">,</span><span class="s1">&#39;sOH&#39;</span><span class="p">,</span><span class="s1">&#39;dO&#39;</span><span class="p">,</span><span class="s1">&#39;ssO&#39;</span><span class="p">,</span><span class="s1">&#39;aaO&#39;</span><span class="p">,</span><span class="s1">&#39;sF&#39;</span><span class="p">,</span><span class="s1">&#39;dS&#39;</span><span class="p">,</span><span class="s1">&#39;ssS&#39;</span><span class="p">,</span><span class="s1">&#39;aaS&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ddssS&#39;</span><span class="p">,</span><span class="s1">&#39;sCl&#39;</span><span class="p">,</span><span class="s1">&#39;sBr&#39;</span><span class="p">]</span>
    
    
<div class="viewcode-block" id="ATOMAtomTypeEState.preset"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ATOMAtomTypeEState.preset">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">cls</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">AggrType</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">AggrType</span><span class="o">.</span><span class="n">sum</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">my_es_types</span>
                <span class="p">)</span></div></div>
    
<div class="viewcode-block" id="ATOMMolecularDistanceEdge"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ATOMMolecularDistanceEdge">[docs]</a>    <span class="k">class</span> <span class="nc">ATOMMolecularDistanceEdge</span><span class="p">(</span><span class="n">MolecularDistanceEdge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MolecularDistanceEdge descriptors restricted to those that can be computed for most compounds</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ATOMMolecularDistanceEdge.preset"><a class="viewcode-back" href="../../pipeline.html#pipeline.featurization.ATOMMolecularDistanceEdge.preset">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ATOM DDM Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>