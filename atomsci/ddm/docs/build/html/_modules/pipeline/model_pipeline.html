<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.model_pipeline &mdash; ATOM Data-Driven Modeling Pipeline 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ATOM Data-Driven Modeling Pipeline
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/running_ampl.html">Running AMPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_ampl_usage.html">Advanced AMPL Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_testing.html">Advanced Testing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">atomsci</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pipeline.model_pipeline</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.model_pipeline</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains class ModelPipeline, which loads in a dataset, splits it, trains a model, and generates predictions and output</span>
<span class="sd">metrics for that model. Works for a variety of featurizers, splitters and other parameters on a generic dataset</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">deepchem</span> <span class="k">as</span> <span class="nn">dc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">atomsci.ddm.utils</span> <span class="kn">import</span> <span class="n">datastore_functions</span> <span class="k">as</span> <span class="n">dsf</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.utils.model_version_utils</span> <span class="k">as</span> <span class="nn">mu</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.utils.file_utils</span> <span class="k">as</span> <span class="nn">futils</span>

<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_datasets</span> <span class="k">as</span> <span class="n">model_datasets</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_wrapper</span> <span class="k">as</span> <span class="n">model_wrapper</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">featurization</span> <span class="k">as</span> <span class="n">feat</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">parameter_parser</span> <span class="k">as</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_tracker</span> <span class="k">as</span> <span class="n">trkr</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">transformations</span> <span class="k">as</span> <span class="n">trans</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># ---------------------------------------------</span>
<div class="viewcode-block" id="calc_AD_kmean_dist"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.calc_AD_kmean_dist">[docs]</a><span class="k">def</span> <span class="nf">calc_AD_kmean_dist</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">pred_dset</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">train_dset_pair_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate the probability of the prediction dataset fall in the the domain of traning set. Use Euclidean distance of the K nearest neighbours.</span>
<span class="sd">    train_dset and pred_dset should be in 2D numpy array format where each row is a compound.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">train_dset_pair_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># calculate the pairwise distance of training set</span>
        <span class="n">train_dset_pair_distance</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>
    <span class="n">train_kmean_dis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dset_pair_distance</span><span class="p">)):</span>
        <span class="n">kn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">train_dset_pair_distance</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_dset_pair_distance</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">kn_idx</span><span class="p">[:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">train_kmean_dis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dis</span><span class="p">)</span>
    <span class="n">train_dset_distribution</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_kmean_dis</span><span class="p">)</span>
    <span class="c1"># pairwise distance between train and pred set</span>
    <span class="n">pred_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_dset</span><span class="p">)</span>
    <span class="n">train_pred_dis</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">pred_dset</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>
    <span class="n">pred_kmean_dis_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">):</span>
        <span class="n">pred_km_dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">train_pred_dis</span><span class="p">[</span><span class="n">i</span><span class="p">])[:</span><span class="n">k</span><span class="p">])</span>
        <span class="n">train_dset_std</span> <span class="o">=</span> <span class="n">train_dset_distribution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">train_dset_distribution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-6</span>
        <span class="n">pred_kmean_dis_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="p">(</span><span class="n">pred_km_dis</span> <span class="o">-</span> <span class="n">train_dset_distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">train_dset_std</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pred_kmean_dis_score</span></div>

<span class="c1"># ---------------------------------------------</span>
<div class="viewcode-block" id="calc_AD_kmean_local_density"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.calc_AD_kmean_local_density">[docs]</a><span class="k">def</span> <span class="nf">calc_AD_kmean_local_density</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">pred_dset</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">train_dset_pair_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the AD of pred data by comparing the distance betweenthe unseen object and its k nearest neighbors in the training set to the distance between these k nearest neighbors and their k nearest neighbors in the training set. Return the distance ratio. Greater than 1 means the pred data is far from the domain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">train_dset_pair_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># calculate the pair-wise distance of training set</span>
        <span class="n">train_dset_pair_distance</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>
    <span class="c1"># pairwise distance between train and pred set</span>
    <span class="n">pred_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_dset</span><span class="p">)</span>
    <span class="n">train_pred_dis</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">pred_dset</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>
    <span class="n">pred_kmean_dis_local_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">):</span>
        <span class="c1"># find the index of k nearest neighbour of each prediction data</span>
        <span class="n">kn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">train_pred_dis</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">pred_km_dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_pred_dis</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">kn_idx</span><span class="p">[:</span><span class="n">k</span><span class="p">]])</span>
        <span class="c1"># find the neighbours of each neighbour and calculate the distance</span>
        <span class="n">neighbor_dis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nei_ix</span> <span class="ow">in</span> <span class="n">kn_idx</span><span class="p">[:</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">nei_kn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">train_dset_pair_distance</span><span class="p">[</span><span class="n">nei_ix</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">neighbor_dis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_dset_pair_distance</span><span class="p">[</span><span class="n">nei_ix</span><span class="p">][</span><span class="n">nei_kn_idx</span><span class="p">[:</span><span class="n">k</span><span class="p">]]))</span>
        <span class="n">ave_nei_dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">neighbor_dis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ave_nei_dis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ave_nei_dis</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">pred_kmean_dis_local_density</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_km_dis</span> <span class="o">/</span> <span class="n">ave_nei_dis</span>
    <span class="k">return</span> <span class="n">pred_kmean_dis_local_density</span></div>

<span class="c1"># ---------------------------------------------</span>
<div class="viewcode-block" id="build_tarball_name"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.build_tarball_name">[docs]</a><span class="k">def</span> <span class="nf">build_tarball_name</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">,</span> <span class="n">result_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; format for building model tarball names</span>
<span class="sd">    Creates the file name for a model tarball from dataset key and model_uuid</span>
<span class="sd">    with optional result_dir.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_name (str): The dataset_name used to train this model</span>
<span class="sd">        model_uuid (str): The model_uuid assigned to this model</span>
<span class="sd">        result_dir (str): Optional directory for this model</span>

<span class="sd">    Returns:</span>
<span class="sd">        The path or filename of the tarball for this model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_tarball_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result_dir</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_model_</span><span class="si">{}</span><span class="s2">.tar.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model_tarball_path</span></div>

<span class="c1"># ---------------------------------------------</span>
<div class="viewcode-block" id="build_dataset_name"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.build_dataset_name">[docs]</a><span class="k">def</span> <span class="nf">build_dataset_name</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns dataset_name when given dataset_key</span>
<span class="sd">    Returns the dataset_name when given a dataset_key. Assumes that the dataset_name is a path</span>
<span class="sd">    and ends with an extension</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_key (str): A dataset_key</span>

<span class="sd">    Returns:</span>
<span class="sd">        The dataset_name which is the base name stripped of extensions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>

<span class="c1"># ******************************************************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline">[docs]</a><span class="k">class</span> <span class="nc">ModelPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__:</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            run_mode (str): A flag determine the mode of model pipeline (eg. training or prediction)</span>

<span class="sd">            params.dataset_name (argparse.Namespace): The dataset_name parameter of the dataset</span>

<span class="sd">            ds_client (ac.DatastoreClient): the datastore api token to interact with the datastore</span>

<span class="sd">            perf_dict (dict): The performance dictionary</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            mlmt_client: The mlmt service client</span>

<span class="sd">            metric_type (str): Defines the type of metric (e.g. roc_auc_score, r2_score)</span>

<span class="sd">        set in train_model or run_predictions:</span>
<span class="sd">            run_mode (str): The mode to run the pipeline, set to training</span>

<span class="sd">            featurziation (Featurization object): The featurization argument or the featurizatioin created from the</span>
<span class="sd">            input parameters</span>

<span class="sd">            model_wrapper (ModelWrapper objct): A model wrapper created from the parameters and featurization object.</span>

<span class="sd">        set in create_model_metadata:</span>
<span class="sd">            model_metadata (dict): The model metadata dictionary that stores the model metrics and metadata</span>

<span class="sd">        Set in load_featurize_data</span>
<span class="sd">            data (ModelDataset object): A data object that featurizes and splits the dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">ds_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mlmt_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes ModelPipeline object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            ds_client: datastore client.</span>

<span class="sd">            mlmt_client: model tracker client.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following ModelPipeline attributes:</span>
<span class="sd">                params (argparse.Namespace): The argparse.Namespace parameter object</span>

<span class="sd">                log (log): The logger</span>

<span class="sd">                run_mode (str): A flag determine the mode of model pipeline (eg. training or prediction)</span>

<span class="sd">                params.dataset_name (argparse.Namespace): The dataset_name parameter of the dataset</span>

<span class="sd">                ds_client (ac.DatastoreClient): the datastore api token to interact with the datastore</span>

<span class="sd">                perf_dict (dict): The performance dictionary</span>

<span class="sd">                output_dir (str): The parent path of the model directory.</span>

<span class="sd">                mlmt_client: The mlmt service</span>

<span class="sd">                metric_type (str): Defines the type of metric (e.g. roc_auc_score, r2_score)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span>  <span class="c1"># default, can be overridden later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Default dataset_name parameter from dataset_key</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">build_dataset_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ds_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">config_client</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="o">=</span> <span class="n">ds_client</span>
        <span class="c1"># Check consistency of task parameters</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">response_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_model_tasks parameter is inconsistent with response_cols&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">perf_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;mean-r2_score&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;r2_score&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;mean-roc_auc_score&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;roc_auc_score&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                                  <span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">),</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_tarball_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_tarball_path</span> <span class="o">=</span> <span class="n">build_tarball_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">)</span>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline.load_featurize_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.load_featurize_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_featurize_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the dataset from the datastore or the file system and featurizes it. If we are training</span>
<span class="sd">        a new model, split the dataset into training, validation and test sets.</span>

<span class="sd">        The data is also split into training, validation, and test sets and saved to the filesystem or datastore.</span>

<span class="sd">        Assumes a ModelWrapper object has already been created.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace): Optional set of parameters to be used for featurization; by default this function</span>
<span class="sd">            uses the parameters used when the pipeline was created.</span>
<span class="sd">            </span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of the ModelPipeline</span>
<span class="sd">                data (ModelDataset object): A data object that featurizes and splits the dataset</span>
<span class="sd">                    data.dataset(dc.DiskDataset): The transformed, featurized, and split dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_model_dataset</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">previously_split</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_presplit_dataset</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">save_split_dataset</span><span class="p">()</span>
        <span class="c1"># We now create transformers after splitting, to allow for the case where the transformer</span>
        <span class="c1"># is fitted to the training data only. The transformers are then applied to the training,</span>
        <span class="c1"># validation and test sets separately.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">split_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">create_transformers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">):</span>
                <span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">transform_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">transform_dataset</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">transform_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span><span class="p">)</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline.create_model_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.create_model_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">create_model_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a data structure describing the current model, to be saved in the model zoo.</span>
<span class="sd">        This should include everything necessary to reproduce a model run.</span>

<span class="sd">        Side effect:</span>
<span class="sd">            Sets self.model_metadata (dictionary): A dictionary of the model metadata required to recreate the model.</span>
<span class="sd">            Also contains metadata about the generating dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
            <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">get_keyval</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;dataset_hash&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_hash</span><span class="o">=</span><span class="kc">None</span>

        <span class="n">train_dset_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">datastore</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">,</span>
            <span class="n">dataset_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span>
            <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
            <span class="n">dataset_oid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset_oid</span><span class="p">,</span>
            <span class="n">dataset_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_hash</span><span class="p">,</span>
            <span class="n">id_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span>
            <span class="n">smiles_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
            <span class="n">response_cols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">,</span>
            <span class="n">feature_transform_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">feature_transform_type</span><span class="p">,</span>
            <span class="n">response_transform_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_transform_type</span><span class="p">,</span>
            <span class="n">external_export_parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">result_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">),</span>
            <span class="n">dataset_metadata</span><span class="o">=</span><span class="n">dataset_metadata</span>
        <span class="p">)</span>

        <span class="n">model_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">model_bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_bucket</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
            <span class="n">featurizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">,</span>
            <span class="n">prediction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
            <span class="n">model_choice_score_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_choice_score_type</span><span class="p">,</span>
            <span class="n">num_model_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
            <span class="n">transformers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span>
            <span class="n">transformer_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span>
            <span class="n">transformer_bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">,</span>
            <span class="n">transformer_oid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_oid</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">time_generated</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">save_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">,</span>
            <span class="n">hyperparam_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hyperparam_uuid</span><span class="p">,</span>
            <span class="n">ampl_version</span><span class="o">=</span><span class="n">mu</span><span class="o">.</span><span class="n">get_ampl_version</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">splitting_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_split_metadata</span><span class="p">()</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">model_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">,</span>
            <span class="n">time_built</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">model_parameters</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
            <span class="n">training_dataset</span><span class="o">=</span><span class="n">train_dset_data</span><span class="p">,</span>
            <span class="n">splitting_parameters</span><span class="o">=</span><span class="n">splitting_metadata</span>
        <span class="p">)</span>

        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">get_model_specific_metadata</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">model_spec_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">feature_specific_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">featurization</span><span class="o">.</span><span class="n">get_feature_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">feature_specific_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">trans</span><span class="o">.</span><span class="n">get_transformer_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span> <span class="o">=</span> <span class="n">model_metadata</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.save_model_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.save_model_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">save_model_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sleep_sec</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the data needed to reload the model in the model tracker DB or in a local tarball file.</span>

<span class="sd">        Inserts the model metadata into the model tracker DB, if self.params.save_results is True.</span>
<span class="sd">        Otherwise, saves the model metadata to a local .json file. Generates a gzipped tar archive</span>
<span class="sd">        containing the metadata file, the transformer parameters and the model checkpoint files, and</span>
<span class="sd">        saves it in the datastore or the filesystem according to the value of save_results.</span>

<span class="sd">        Args:</span>
<span class="sd">            retries (int): Number of times to retry saving to model tracker DB.</span>

<span class="sd">            sleep_sec (int): Number of seconds to sleep between retries, if saving to model tracker DB.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Saves the model metadata and parameters into the model tracker DB or a local tarball file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Dump the model parameters and metadata to a JSON file</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">:</span>
            <span class="c1"># Model tracker saves the model state and metadata in the datastore as well as saving the metadata</span>
            <span class="c1"># in the model zoo.</span>
            <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="c1"># TODO: Try to distinguish unrecoverable exceptions (e.g., model tracker is down) from ones for</span>
                    <span class="c1"># which retrying is worthwhile.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">trkr</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
                        <span class="c1"># Best model needs to be reloaded for predictions, so does not work to remove best_model_dir</span>
                        <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span>
                        <span class="c1">#self.log.warning(&quot;Need to sleep and retry saving model&quot;)</span>
                        <span class="c1">#time.sleep(sleep_sec)</span>
                        <span class="c1">#i += 1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If not using the model tracker, save the model state and metadata in a tarball in the filesystem</span>
            <span class="n">trkr</span><span class="o">.</span><span class="n">save_model_tarball</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_tarball_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.create_prediction_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.create_prediction_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">create_prediction_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a data structure to hold performance metrics from a model run on a new dataset,</span>
<span class="sd">        to be stored in the model tracker DB. Note that this isn&#39;t used</span>
<span class="sd">        for the training run metadata; the training_metrics section is created by the train_model() function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            prediction_metadata (dict): A dictionary of the metadata for a model run on a new dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
            <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">get_keyval</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prediction_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">metrics_type</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span>
            <span class="n">model_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">,</span>
            <span class="n">time_run</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">dataset_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span>
            <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
            <span class="n">dataset_oid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset_oid</span><span class="p">,</span>
            <span class="n">id_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span>
            <span class="n">smiles_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
            <span class="n">response_cols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">,</span>
            <span class="n">prediction_results</span><span class="o">=</span><span class="n">prediction_results</span><span class="p">,</span>
            <span class="n">dataset_metadata</span><span class="o">=</span><span class="n">dataset_metadata</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">prediction_metadata</span></div>

    <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline.get_metrics"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.get_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the model performance metrics from any previous training and prediction runs</span>
<span class="sd">        from the model tracker</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">trkr</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">))</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlmt_client</span><span class="o">.</span><span class="n">get_model_metrics</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
                                                         <span class="n">model_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">metrics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Eventually, may want to allow reading metrics from the JSON files saved by</span>
            <span class="c1"># save_metrics(), in order to support installations without the model tracker.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ModelPipeline.get_metrics() requires params.save_results = True&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline.save_metrics"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.save_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">save_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_metrics</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sleep_sec</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the given model_metrics dictionary to a JSON file on disk, and also to the model tracker </span>
<span class="sd">        database if we&#39;re using it.</span>

<span class="sd">        If writing to disk, outputs to a JSON file &lt;prefix&gt;_model_metrics.json in the current output directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_metrics (dict or list): Either a dictionary containing the model performance metrics, or a</span>
<span class="sd">            list of dictionaries with metrics for each training label and subset.</span>

<span class="sd">            prefix (str): An optional prefix to include in the JSON filename</span>

<span class="sd">            retries (int): Number of retries to save to model tracker DB, if save_results is True.</span>

<span class="sd">            sleep_sec (int): Number of seconds to sleep between retries.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Saves the model_metrics dictionary to the model tracker database, or writes out a .json file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First save the metrics to disk</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;model_metrics.json&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_model_metrics.json&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">model_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_metrics</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">model_metrics</span><span class="p">:</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mlmt_client</span><span class="o">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
                                                        <span class="n">model_uuid</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                                                        <span class="n">model_metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
                            <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">raise</span>
                            <span class="c1"># TODO: uncomment when debugged</span>
                            <span class="c1"># TODO: Need to distinguish between &quot;temporary&quot; exceptions that justify</span>
                            <span class="c1"># retries and longer-term exceptions indicating that the model tracker server</span>
                            <span class="c1"># is down.</span>
                            <span class="c1">#self.log.warning(&quot;Need to sleep and retry saving metrics&quot;)</span>
                            <span class="c1">#time.sleep(sleep_sec)</span>
                            <span class="c1">#i += 1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline.split_dataset"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.split_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">split_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load, featurize and split the dataset according to the current model parameter settings,</span>
<span class="sd">        but don&#39;t actually train a model. Returns the split_uuid for the dataset split.</span>

<span class="sd">        Args:</span>
<span class="sd">            featurization (Featurization object): An optional featurization object.</span>

<span class="sd">        Return:</span>
<span class="sd">            split_uuid (str): The unique identifier for the dataset split.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">previously_split</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="n">featurization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_featurize_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split_uuid</span></div>


    <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelPipeline.train_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.train_model">[docs]</a>    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build model described by self.params on the training dataset described by self.params.</span>

<span class="sd">        Generate predictions for the training, validation, and test datasets, and save the predictions and</span>
<span class="sd">        performance metrics in the model results DB or in a JSON file.</span>

<span class="sd">        Args:</span>
<span class="sd">            featurization (Featurization object): An optional featurization object for creating models on a</span>
<span class="sd">            prefeaturized dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of the ModelPipeline object</span>
<span class="sd">                run_mode (str): The mode to run the pipeline, set to training</span>

<span class="sd">                featurization (Featurization object): The featurization argument or the featurization created from the</span>
<span class="sd">                input parameters</span>

<span class="sd">                model_wrapper (ModelWrapper objct): A model wrapper created from the parameters and featurization object.</span>

<span class="sd">                model_metadata (dict): The model metadata dictionary that stores the model metrics and metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;graphconv&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Hybrid model doesn&#39;t support GraphConv featurizer now.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The dataset of a hybrid model should have two response columns, one for activities, one for concentrations.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="n">featurization</span>

        <span class="c1">## create model wrapper if not split_only</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="o">.</span><span class="n">create_model_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">setup_model_dirs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_featurize_data</span><span class="p">()</span>

        <span class="c1">## return if split only</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_only</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Create the metadata for the trained model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_model_metadata</span><span class="p">()</span>
        <span class="c1"># Save the performance metrics for each training data subset, for the best epoch</span>
        <span class="n">training_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]:</span>
                <span class="n">training_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">metrics_type</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
                <span class="n">training_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">get_pred_results</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="n">training_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">training_dict</span><span class="p">)</span>

        <span class="c1"># Save the model metrics separately</span>
        <span class="k">for</span> <span class="n">training_dict</span> <span class="ow">in</span> <span class="n">training_metrics</span><span class="p">:</span>
            <span class="n">training_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span>
            <span class="n">training_dict</span><span class="p">[</span><span class="s1">&#39;time_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">training_dict</span><span class="p">[</span><span class="s1">&#39;input_dataset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="n">training_metrics</span><span class="p">)</span>

        <span class="c1"># Save the model metadata in the model tracker or the filesystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">training_metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_model_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.run_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.run_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">run_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a previously trained model, and use it to run predictions on a new dataset.</span>

<span class="sd">        Generate predictions for a specified dataset, and save the predictions and performance</span>
<span class="sd">        metrics in the model results DB or in a JSON file.</span>

<span class="sd">        Args:</span>
<span class="sd">            featurization (Featurization Object): An optional featurization object for creating the model wrappr</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of ModelPipeline:</span>
<span class="sd">                run_mode (str): The mode to run the pipeline, set to prediction</span>

<span class="sd">                featurization (Featurization object): The featurization argument or the featurization created from the</span>
<span class="sd">                input parameters</span>

<span class="sd">                model_wrapper (ModelWrapper object): A model wrapper created from the parameters and featurization object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span>
        <span class="k">if</span> <span class="n">featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="n">featurization</span>
        <span class="c1"># Load the dataset to run predictions on and featurize it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_featurize_data</span><span class="p">()</span>

        <span class="c1"># Run predictions on the full dataset</span>
        <span class="n">pred_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Map the predictions, and metrics if requested, to the dictionary format used by</span>
        <span class="c1"># the model tracker</span>
        <span class="n">prediction_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_prediction_metadata</span><span class="p">(</span><span class="n">pred_results</span><span class="p">)</span>

        <span class="c1"># Get the metrics from previous prediction runs, if any, and append the new results to them</span>
        <span class="c1"># in the model tracker DB</span>
        <span class="n">model_metrics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">model_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">,</span>
            <span class="n">metrics_type</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span>
        <span class="p">)</span>
        <span class="n">model_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prediction_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">,</span> <span class="s1">&#39;prediction_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.calc_train_dset_pair_dis"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.calc_train_dset_pair_dis">[docs]</a>    <span class="k">def</span> <span class="nf">calc_train_dset_pair_dis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the pairwise distance for training set compound feature vectors, needed for AD calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">featurization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_featurize_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># combine train and valid set for k-fold cv models</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis_metric</span> <span class="o">=</span> <span class="n">metric</span></div>
    
    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.predict_on_dataframe"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.predict_on_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">predict_on_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">is_featurized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">contains_responses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">AD_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED</span>
<span class="sd">        Call predict_full_dataset instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;predict_on_dataframe is deprecated. Please call predict_full_dataset instead.&quot;</span><span class="p">)</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_full_dataset</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">is_featurized</span><span class="o">=</span><span class="n">is_featurized</span><span class="p">,</span> 
                <span class="n">contains_responses</span><span class="o">=</span><span class="n">contains_responses</span><span class="p">,</span> <span class="n">AD_method</span><span class="o">=</span><span class="n">AD_method</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">dist_metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>

	    <span class="c1"># Inside predict_full_dataset, prediction columns are generated using something like:</span>
        <span class="c1"># for i, colname in enumerate(self.params.response_cols):</span>
        <span class="c1">#     result_df[&#39;%s_pred&#39;%colname] = preds[:,i,0]</span>
        <span class="c1"># predict_on_dataframe was only meant to handle single task models and so output</span>
        <span class="c1"># columns were not prefixed with the response_col. Thus we need to remove the prefix</span>
        <span class="c1"># for backwards compatibility</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># currently the only columns that could have a response_col prefix</span>
            <span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;actual&#39;</span><span class="p">,</span> <span class="s1">&#39;prob&#39;</span><span class="p">]</span>
            <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">suff</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">suff</span><span class="p">)):</span>
                        <span class="n">rename_map</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">colname</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">):]</span> <span class="c1"># chop off response_col_ prefix</span>

            <span class="c1"># rename columns for backwards compatibility</span>
            <span class="n">result_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_map</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_df</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.predict_on_smiles"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.predict_on_smiles">[docs]</a>    <span class="k">def</span> <span class="nf">predict_on_smiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">AD_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute predicted responses from a pretrained model on a set of compounds given as a list of SMILES strings.</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles (list): A list containting valid SMILES strings</span>

<span class="sd">            verbose (boolean): A switch for disabling informational messages</span>

<span class="sd">            AD_method (str or None): Method to use to compute applicability domain (AD) index; may be</span>
<span class="sd">            &#39;z_score&#39;, &#39;local_density&#39; or None (the default). With the default value, AD indices</span>
<span class="sd">            will not be calculated.</span>

<span class="sd">            k (int): Number of nearest neighbors of each training data point used to evaluate the AD index.</span>

<span class="sd">            dist_metric (str): Metric used to compute distances between feature vectors for AD index calculation. </span>
<span class="sd">            Valid values are &#39;cityblock&#39;, &#39;cosine&#39;, &#39;euclidean&#39;, &#39;jaccard&#39;, and &#39;manhattan&#39;. If binary</span>
<span class="sd">            features such as fingerprints are used in model, &#39;jaccard&#39; (equivalent to Tanimoto distance) may</span>
<span class="sd">            be a better choice than the other metrics which operate on continuous features.</span>

<span class="sd">        Returns:</span>
<span class="sd">            res (DataFrame): Data frame indexed by compound IDs containing a column of SMILES</span>
<span class="sd">            strings, with additional columns containing the predicted values for each response variable.</span>
<span class="sd">            If the model was trained to predict uncertainties, the returned data frame will also</span>
<span class="sd">            include standard deviation columns (named &lt;response_col&gt;_std) for each response variable.</span>
<span class="sd">            The result data frame may not include all the compounds in the input dataset, because</span>
<span class="sd">            the featurizer may not be able to featurize all of them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Currently only single task models supported&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;compound_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span>
                        <span class="n">task</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">))})</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_on_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">AD_method</span><span class="o">=</span><span class="n">AD_method</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.predict_full_dataset"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.predict_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">predict_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">is_featurized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">contains_responses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dset_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">AD_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">,</span>
                             <span class="n">max_train_records_for_AD</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute predicted responses from a pretrained model on a set of compounds listed in</span>
<span class="sd">        a data frame. The data frame should contain, at minimum, a column of compound IDs; if</span>
<span class="sd">        SMILES strings are needed to compute features, they should be provided as well. Feature</span>
<span class="sd">        columns may be provided as well. If response columns are included in the input, they will</span>
<span class="sd">        be included in the output as well to facilitate performance metric calculations.</span>

<span class="sd">        This function is similar to predict_on_dataframe, except that it supports multitask models,</span>
<span class="sd">        and includes class probabilities in the output for classifier models.</span>

<span class="sd">        Args:</span>
<span class="sd">            dset_df (DataFrame): A data frame containing compound IDs (if the compounds are to be</span>
<span class="sd">            featurized using descriptors) and/or SMILES strings (if the compounds are to be</span>
<span class="sd">            featurized using ECFP fingerprints or graph convolution) and/or precomputed features.</span>
<span class="sd">            The column names for the compound ID and SMILES columns should match id_col and smiles_col,</span>
<span class="sd">            respectively, in the model parameters.</span>

<span class="sd">            is_featurized (bool): True if dset_df contains precomputed feature columns. If so,</span>
<span class="sd">            dset_df must contain *all* of the feature columns defined by the featurizer that was</span>
<span class="sd">            used when the model was trained.</span>

<span class="sd">            contains_responses (bool): True if dataframe contains response values</span>

<span class="sd">            dset_params (Namespace):  Parameters used to interpret dataset, including id_col, smiles_col,</span>
<span class="sd">            and optionally, response_cols. If not provided, id_col, smiles_col and response_cols are</span>
<span class="sd">            assumed to be same as in the pretrained model.</span>

<span class="sd">            AD_method (str or None): Method to use to compute applicability domain (AD) index; may be</span>
<span class="sd">            &#39;z_score&#39;, &#39;local_density&#39; or None (the default). With the default value, AD indices</span>
<span class="sd">            will not be calculated.</span>

<span class="sd">            k (int): Number of nearest neighbors of each training data point used to evaluate the AD index.</span>

<span class="sd">            dist_metric (str): Metric used to compute distances between feature vectors for AD index calculation. </span>
<span class="sd">            Valid values are &#39;cityblock&#39;, &#39;cosine&#39;, &#39;euclidean&#39;, &#39;jaccard&#39;, and &#39;manhattan&#39;. If binary</span>
<span class="sd">            features such as fingerprints are used in model, &#39;jaccard&#39; (equivalent to Tanimoto distance) may</span>
<span class="sd">            be a better choice than the other metrics which operate on continuous features.</span>

<span class="sd">            max_train_records_for_AD (int): Maximum number of training data rows to use for AD calculation. </span>
<span class="sd">            Note that the AD calculation time scales as the square of the number of training records used.</span>
<span class="sd">            If the training dataset is larger than `max_train_records_for_AD`, a random sample of rows with</span>
<span class="sd">            this size is used instead for the AD calculations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result_df (DataFrame): Data frame indexed by compound IDs containing a column of SMILES</span>
<span class="sd">            strings, with additional columns containing the predicted values for each response variable.</span>
<span class="sd">            If the model was trained to predict uncertainties, the returned data frame will also</span>
<span class="sd">            include standard deviation columns (named &lt;response_col&gt;_std) for each response variable.</span>
<span class="sd">            The result data frame may not include all the compounds in the input dataset, because</span>
<span class="sd">            the featurizer may not be able to featurize all of them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">featurization</span>

        <span class="c1"># Change the dataset ID, SMILES and response columns to match the ones in the current model</span>
        <span class="n">dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dset_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coldict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">dset_params</span><span class="o">.</span><span class="n">id_col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span>
                        <span class="n">dset_params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">contains_responses</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dset_params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dset_params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">):</span>
                    <span class="n">coldict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">coldict</span><span class="p">)</span>

        <span class="c1"># assign unique ids to each row</span>
        <span class="n">old_ids</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">new_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset_df</span><span class="p">)))</span>
        <span class="n">id_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_ids</span><span class="p">,</span> <span class="n">old_ids</span><span class="p">)])</span>
        <span class="n">dset_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ids</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_minimal_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="p">,</span> <span class="n">contains_responses</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_dataset_tasks</span><span class="p">(</span><span class="n">dset_df</span><span class="p">):</span>
            <span class="c1"># Shouldn&#39;t happen</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;response_cols missing from model params&quot;</span><span class="p">)</span>
        <span class="c1"># Get features for each compound and construct a DeepChem Dataset from them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">is_featurized</span><span class="p">)</span>
        <span class="c1"># Transform the features and responses if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">transform_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Note that at this point, the dataset may contain fewer rows than the input. Typically this happens because</span>
        <span class="c1"># of invalid SMILES strings. Remove any rows from the input dataframe corresponding to SMILES strings that were</span>
        <span class="c1"># dropped.</span>
        <span class="n">dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">dset_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>

        <span class="c1"># Get the predictions and standard deviations, if calculated, as numpy arrays</span>
        <span class="n">preds</span><span class="p">,</span> <span class="n">stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contains_responses</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">):</span>
                    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_actual&quot;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vals</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_pred&quot;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">class_probs</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">nclass</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nclass</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_prob&quot;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_probs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nclass</span><span class="p">):</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_prob_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">class_probs</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_pred&quot;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">class_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">):</span>
                    <span class="n">std_colname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span> <span class="n">colname</span>
                    <span class="n">result_df</span><span class="p">[</span><span class="n">std_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">stds</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># hybrid model should handled differently</span>
            <span class="k">if</span> <span class="n">contains_responses</span><span class="p">:</span>
                <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;actual_activity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vals</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">AD_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Calculate applicability domain index</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s2">&quot;graphconv&quot;</span><span class="p">:</span>
                <span class="c1"># For graphconv models, compute embeddings and treat them as features</span>
                <span class="n">pred_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_embedding</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">dset_params</span><span class="o">=</span><span class="n">dset_params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;featurized_train_data&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Featurizing training data for AD calculation.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span>
                    <span class="c1"># If training data is too big to compute distances in a reasonable time, use a sample of the data</span>
                    <span class="n">train_data_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_params</span><span class="p">)</span>
                    <span class="n">train_data_params</span><span class="o">.</span><span class="n">max_dataset_rows</span> <span class="o">=</span> <span class="n">max_train_records_for_AD</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">load_featurize_data</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">train_data_params</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># combine train and valid set for k-fold CV models</span>
                        <span class="n">train_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">train_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="o">.</span><span class="n">feat_type</span> <span class="o">==</span> <span class="s2">&quot;graphconv&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing training data embeddings for AD calculation.&quot;</span><span class="p">)</span>
                        <span class="n">train_dset</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">NumpyDataset</span><span class="p">(</span><span class="n">train_X</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">featurized_train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">generate_embeddings</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">featurized_train_data</span> <span class="o">=</span> <span class="n">train_X</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;train_pair_dis&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;train_pair_dis_metric&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis_metric</span> <span class="o">!=</span> <span class="n">dist_metric</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featurized_train_data</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis_metric</span> <span class="o">=</span> <span class="n">dist_metric</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating AD index.&quot;</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">AD_method</span> <span class="o">==</span> <span class="s2">&quot;local_density&quot;</span><span class="p">:</span>
                    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;AD_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_AD_kmean_local_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurized_train_data</span><span class="p">,</span> <span class="n">pred_data</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">train_dset_pair_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;AD_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_AD_kmean_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurized_train_data</span><span class="p">,</span> <span class="n">pred_data</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">train_dset_pair_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_pair_dis</span><span class="p">,</span> <span class="n">dist_metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AD index calculation failed&quot;</span><span class="p">)</span>
                <span class="c1"># xxx re-raise for debugging</span>
                <span class="k">raise</span>

        <span class="c1"># insert any missing ids</span>
        <span class="n">missing_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_ids</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">missing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">:</span> <span class="n">missing_ids</span><span class="p">})</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">result_df</span><span class="p">,</span> <span class="n">missing_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># sort in ascending order, recovering the original order</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># map back to original id values</span>
        <span class="n">result_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">id_map</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_df</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelPipeline.predict_embedding"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ModelPipeline.predict_embedding">[docs]</a>    <span class="k">def</span> <span class="nf">predict_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">dset_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute embeddings from a pretrained model on a set of compounds listed in a data frame. The data </span>
<span class="sd">        frame should contain, at minimum, a column of compound IDs and a column of SMILES strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">featurization</span>

        <span class="c1"># Change the dataset ID, SMILES and response columns to match the ones in the current model</span>
        <span class="n">dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dset_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coldict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">dset_params</span><span class="o">.</span><span class="n">id_col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span>
                        <span class="n">dset_params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">}</span>
            <span class="n">dset_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">coldict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_minimal_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">is_featurized</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Not sure the following is necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">transform_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Get the embeddings as a numpy array</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">generate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="c1"># Truncate the embeddings array to the length of the input dataset. The array returned by the DeepChem </span>
        <span class="c1"># predict_embedding function is padded to multiples of the batch size.</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dset_df</span><span class="p">),:]</span>

        <span class="k">return</span> <span class="n">embeddings</span></div></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="run_models"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.run_models">[docs]</a><span class="k">def</span> <span class="nf">run_models</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">shared_featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query the model tracker for models matching the criteria in params.model_filter. Run</span>
<span class="sd">    predictions with each model using the dataset specified by the remaining parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (Namespace): Parsed parameters</span>

<span class="sd">        shared_featurization (Featurization): Object to map compounds to features, shared across models.</span>
<span class="sd">        User is responsible for ensuring that shared_featurization is compatible with all matching models.</span>

<span class="sd">        generator (bool): True if run as a generator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">ds_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">config_client</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>

    <span class="n">exclude_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;training_metrics&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time_built&quot;</span><span class="p">,</span>
        <span class="s2">&quot;training_dataset.dataset_metadata&quot;</span>
    <span class="p">]</span>

    <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;match_metadata&#39;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">model_filter</span>
    <span class="p">}</span>

    <span class="n">metadata_iter</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
        <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
        <span class="n">exclude_fields</span><span class="o">=</span><span class="n">exclude_fields</span><span class="p">,</span>
        <span class="n">count</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">model_count</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">metadata_iter</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_count</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No matching models returned&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">metadata_dict</span> <span class="ow">in</span> <span class="n">metadata_iter</span><span class="p">:</span>
        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for model UUID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>

        <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>

        <span class="c1"># Override selected model training data parameters with parameters for current dataset</span>

        <span class="n">model_params</span><span class="o">.</span><span class="n">model_uuid</span> <span class="o">=</span> <span class="n">model_uuid</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">collection_name</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">dataset_key</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">bucket</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">dataset_oid</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dataset_oid</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">system</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">id_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">id_col</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">smiles_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">result_dir</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">model_filter</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">model_filter</span>

        <span class="c1"># Create a separate output_dir under model_params.result_dir for each model. For lack of a better idea, use the model UUID</span>
        <span class="c1"># to name the output dir, to ensure uniqueness.</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">)</span>

        <span class="c1"># Allow descriptor featurizer to use a different descriptor table than was used for the training data.</span>
        <span class="c1"># This could be needed e.g. when a model was trained with GSK compounds and tested with ChEMBL data.</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_key</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_bucket</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_oid</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_oid</span>

        <span class="c1"># If there is no shared featurization object, create one for this model</span>
        <span class="k">if</span> <span class="n">shared_featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">featurization</span> <span class="o">=</span> <span class="n">shared_featurization</span>


        <span class="c1"># Create a ModelPipeline object</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">,</span> <span class="n">mlmt_client</span><span class="p">)</span>

        <span class="c1"># Create the ModelWrapper object.</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="o">.</span><span class="n">create_model_wrapper</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">,</span>
                                                                    <span class="n">pipeline</span><span class="o">.</span><span class="n">ds_client</span><span class="p">)</span>

        <span class="c1"># Get the tarball containing the saved model from the datastore, and extract it into model_dir.</span>
        <span class="n">model_dataset_oid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;model_dataset_oid&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: Should we catch exceptions from retrieve_dataset_by_dataset_oid, or let them propagate?</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_dataset_oid</span><span class="p">(</span><span class="n">model_dataset_oid</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">ds_client</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">tarpath</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracted model tarball to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_dir</span><span class="p">)</span>

        <span class="c1"># If that worked, reload the saved model training state</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">reload_model</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>

        <span class="c1"># Run predictions on the specified dataset</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">run_predictions</span><span class="p">(</span><span class="n">featurization</span><span class="p">)</span>

        <span class="c1"># Return the pipeline to the calling function, if run as a generator</span>
        <span class="k">if</span> <span class="n">generator</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">pipeline</span></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="regenerate_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.regenerate_results">[docs]</a><span class="k">def</span> <span class="nf">regenerate_results</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shared_featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="s1">&#39;twintron-blue&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query the model tracker for models matching the criteria in params.model_filter. Run</span>
<span class="sd">    predictions with each model using the dataset specified by the remaining parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        result_dir (str): Parent of directory where result files will be written</span>

<span class="sd">        params (Namespace): Parsed parameters</span>

<span class="sd">        metadata_dict (dict): Model metadata</span>

<span class="sd">        shared_featurization (Featurization): Object to map compounds to features, shared across models.</span>
<span class="sd">        User is responsible for ensuring that shared_featurization is compatible with all matching models.</span>

<span class="sd">        system (str): System name</span>

<span class="sd">    Returns:</span>
<span class="sd">        result_dict (dict): Results from predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">ds_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">config_client</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metadata_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Must either provide params or metadata_dict&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_metadata_by_uuid</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="p">,</span>
                                                  <span class="n">collection_name</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No matching models returned&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">dset_df</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_split_dataset_from_metadata</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">dset_df</span><span class="o">.</span><span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

    <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_uuid</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for model UUID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>

    <span class="n">model_params</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">result_dir</span>

    <span class="c1"># Create a separate output_dir under model_params.result_dir for each model. For lack of a better idea, use the model UUID</span>
    <span class="c1"># to name the output dir, to ensure uniqueness.</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">)</span>

    <span class="c1"># Allow descriptor featurizer to use a different descriptor table than was used for the training data.</span>
    <span class="c1"># This could be needed e.g. when a model was trained with GSK compounds and tested with ChEMBL data, or</span>
    <span class="c1"># when running a model that was trained on LC on a non-LC system.</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>

    <span class="c1"># Create a ModelPipeline object</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">,</span> <span class="n">mlmt_client</span><span class="p">)</span>

    <span class="c1"># If there is no shared featurization object, create one for this model</span>
    <span class="k">if</span> <span class="n">shared_featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">shared_featurization</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Featurization = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">featurization</span><span class="p">))</span>
    <span class="c1"># Create the ModelWrapper object.</span>

    <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="o">.</span><span class="n">create_model_wrapper</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">,</span>
                                                                <span class="n">pipeline</span><span class="o">.</span><span class="n">ds_client</span><span class="p">)</span>
    <span class="c1"># Get the tarball containing the saved model from the datastore, and extract it into model_dir (old format)</span>
    <span class="c1"># or output_dir (new format) according to the format of the tarball contents.</span>

    <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">extract_datastore_model_tarball</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_bucket</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> 
                                         <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="c1"># If that worked, reload the saved model training state</span>

    <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">reload_model</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="c1"># Run predictions on the specified dataset</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_on_dataframe</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">contains_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_type</span>
    <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span>
    <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">splitter</span>
    <span class="k">if</span> <span class="s1">&#39;descriptor_type&#39;</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">:</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_type</span>

    <span class="k">return</span> <span class="n">result_dict</span></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="create_prediction_pipeline"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.create_prediction_pipeline">[docs]</a><span class="k">def</span> <span class="nf">create_prediction_pipeline</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_bucket</span><span class="o">=</span><span class="s1">&#39;CRADA&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a ModelPipeline object to be used for running blind predictions on datasets</span>
<span class="sd">    where the ground truth is not known, given a pretrained model in the model tracker database.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (Namespace or dict): A parsed parameters namespace, containing parameters describing how input</span>
<span class="sd">        datasets should be processed. If a dictionary is passed, it will be parsed to fill in default values</span>
<span class="sd">        and convert it to a Namespace object.</span>

<span class="sd">        model_uuid (str): The UUID of a trained model.</span>

<span class="sd">        collection_name (str): The collection where the model is stored in the model tracker DB.</span>

<span class="sd">        featurization (Featurization): An optional featurization object to be used for featurizing the input data.</span>
<span class="sd">        If none is provided, one will be created based on the stored model parameters.</span>

<span class="sd">        alt_bucket (str): Alternative bucket to search for model tarball and transformer files, if</span>
<span class="sd">        original bucket no longer exists.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pipeline (ModelPipeline): A pipeline object to be used for making predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">ds_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">collection_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_model_collection_by_uuid</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">mlmt_client</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_metadata_by_uuid</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No model found with UUID </span><span class="si">%s</span><span class="s2"> in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got metadata for model UUID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>

    <span class="n">model_ampl_version</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">]</span>
    <span class="c1"># check the model version to make sure it&#39;s compatible with the running ampl version</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">check_version_compatible</span><span class="p">(</span><span class="n">model_ampl_version</span><span class="p">)</span>
    <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
    <span class="n">orig_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="c1"># Override selected model training data parameters with parameters for current dataset</span>

    <span class="n">model_params</span><span class="o">.</span><span class="n">model_uuid</span> <span class="o">=</span> <span class="n">model_uuid</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">id_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">id_col</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">smiles_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">result_dir</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">system</span>


    <span class="c1"># Check that buckets where model tarball and transformers were saved still exist. If not, try alt_bucket.</span>
    <span class="n">model_bucket_meta</span> <span class="o">=</span> <span class="n">ds_client</span><span class="o">.</span><span class="n">ds_buckets</span><span class="o">.</span><span class="n">get_buckets</span><span class="p">(</span><span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="n">model_params</span><span class="o">.</span><span class="n">model_bucket</span><span class="p">])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_bucket_meta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">model_bucket</span> <span class="o">=</span> <span class="n">alt_bucket</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">transformer_bucket</span> <span class="o">!=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_bucket</span><span class="p">):</span>
        <span class="n">trans_bucket_meta</span> <span class="o">=</span> <span class="n">ds_client</span><span class="o">.</span><span class="n">ds_buckets</span><span class="o">.</span><span class="n">get_buckets</span><span class="p">(</span><span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="n">model_params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trans_bucket_meta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_params</span><span class="o">.</span><span class="n">transformer_bucket</span> <span class="o">=</span> <span class="n">alt_bucket</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_bucket_meta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_params</span><span class="o">.</span><span class="n">transformer_bucket</span> <span class="o">=</span> <span class="n">alt_bucket</span>

    <span class="c1"># Create a separate output_dir under model_params.result_dir for each model. For lack of a better idea, use the model UUID</span>
    <span class="c1"># to name the output dir, to ensure uniqueness.</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">)</span>

    <span class="c1"># Allow using computed_descriptors featurizer for a model trained with the descriptors featurizer, and vice versa</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;descriptors&#39;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;descriptors&#39;</span><span class="p">):</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span>

    <span class="c1"># Allow descriptor featurizer to use a different descriptor table than was used for the training data.</span>
    <span class="c1"># This could be needed e.g. when a model was trained with GSK compounds and tested with ChEMBL data.</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_key</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_bucket</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_oid</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_oid</span>

    <span class="c1"># If the caller didn&#39;t provide a featurization object, create one for this model</span>
    <span class="k">if</span> <span class="n">featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="c1"># Create a ModelPipeline object</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">,</span> <span class="n">mlmt_client</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">orig_params</span> <span class="o">=</span> <span class="n">orig_params</span>

    <span class="c1"># Create the ModelWrapper object.</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="o">.</span><span class="n">create_model_wrapper</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">,</span>
                                                                <span class="n">pipeline</span><span class="o">.</span><span class="n">ds_client</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

    <span class="c1"># Get the tarball containing the saved model from the datastore, and extract it into model_dir or output_dir,</span>
    <span class="c1"># depending on what style of tarball it is (old or new respectively)</span>
    <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">extract_datastore_model_tarball</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_bucket</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> 
                                         <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extract_dir</span> <span class="o">==</span> <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
        <span class="c1"># Model came from new style tarball</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">)</span>

    <span class="c1"># Reload the saved model training state</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">reload_model</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pipeline</span></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="create_prediction_pipeline_from_file"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.create_prediction_pipeline_from_file">[docs]</a><span class="k">def</span> <span class="nf">create_prediction_pipeline_from_file</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;best_model&#39;</span><span class="p">,</span> <span class="n">featurization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a ModelPipeline object to be used for running blind predictions on datasets, given a pretrained model stored</span>
<span class="sd">    in the filesystem. The model may be stored either as a gzipped tar archive or as a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (Namespace): A parsed parameters namespace, containing parameters describing how input</span>
<span class="sd">        datasets should be processed.</span>

<span class="sd">        reload_dir (str): The path to the parent directory containing the various model subdirectories</span>
<span class="sd">          (e.g.: &#39;/home/cdsw/model/delaney-processed/delaney-processed/pxc50_NN_graphconv_scaffold_regression/&#39;).</span>
<span class="sd">        If reload_dir is None, then model_path must be specified. If both are specified, then the tar archive given</span>
<span class="sd">        by model_path will be unpacked into reload_dir, possibly overwriting existing files in that directory.</span>

<span class="sd">        model_path (str): Path to a gzipped tar archive containing the saved model metadata and parameters. If specified,</span>
<span class="sd">        the tar archive is unpacked into reload_dir if that directory is given, or to a temporary directory otherwise.</span>

<span class="sd">        model_type (str): Name of the subdirectory in reload_dir or in the tar archive where the trained model state parameters</span>
<span class="sd">        should be loaded from.</span>

<span class="sd">        featurization (Featurization): An optional featurization object to be used for featurizing the input data.</span>
<span class="sd">        If none is provided, one will be created based on the stored model parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pipeline (ModelPipeline): A pipeline object to be used for making predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>

    <span class="c1"># Unpack the model tar archive if one is specified</span>
    <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if mismatch, it will raise an exception</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">check_version_compatible</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reload_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a temporary directory</span>
            <span class="n">reload_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">futils</span><span class="o">.</span><span class="n">safe_extract</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">reload_dir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">reload_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either reload_dir or model_path must be specified.&quot;</span><span class="p">)</span>

    <span class="c1"># Opens the model_metadata.json file containing the reloaded model parameters</span>
    <span class="n">config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="c1"># Set the transformer_key parameter to point to the transformer pickle file we just extracted</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">has_transformers</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;transformers&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">has_transformers</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;transformer_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/transformers.pkl&quot;</span> <span class="o">%</span> <span class="n">reload_dir</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">orig_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="c1"># Override selected model training data parameters with parameters for current dataset</span>

    <span class="n">model_params</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">reload_dir</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">id_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">id_col</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">smiles_col</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">result_dir</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">system</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">verbose</span>

        <span class="c1"># Allow using computed_descriptors featurizer for a model trained with the descriptors featurizer, and vice versa</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;descriptors&#39;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;descriptors&#39;</span><span class="p">):</span>
            <span class="n">model_params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span>

        <span class="c1"># Allow descriptor featurizer to use a different descriptor table than was used for the training data.</span>
        <span class="c1"># This could be needed e.g. when a model was trained with GSK compounds and tested with ChEMBL data.</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_key</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_bucket</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">descriptor_oid</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">descriptor_oid</span>

    <span class="c1"># If the caller didn&#39;t provide a featurization object, create one for this model</span>
    <span class="k">if</span> <span class="n">featurization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Featurization = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">featurization</span><span class="p">))</span>
    <span class="c1"># Create a ModelPipeline object</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">orig_params</span> <span class="o">=</span> <span class="n">orig_params</span>

    <span class="c1"># Create the ModelWrapper object.</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="o">.</span><span class="n">create_model_wrapper</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

    <span class="c1"># Reload the saved model training state</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>

    <span class="c1"># If that worked, reload the saved model training state</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">reload_model</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pipeline</span></div>


<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="load_from_tracker"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.load_from_tracker">[docs]</a><span class="k">def</span> <span class="nf">load_from_tracker</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alt_bucket</span><span class="o">=</span><span class="s1">&#39;CRADA&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRECATED. Use the function create_prediction_pipeline() directly, or use the higher-level function</span>
<span class="sd">    predict_from_model.predict_from_tracker_model().</span>

<span class="sd">    Create a ModelPipeline object using the metadata in the  model tracker.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_uuid (str): The UUID of a trained model.</span>

<span class="sd">        collection_name (str): The collection where the model is stored in the model tracker DB.</span>

<span class="sd">        client : Ignored, for backward compatibility only</span>

<span class="sd">        verbose (bool): A switch for disabling informational messages</span>

<span class="sd">        alt_bucket (str): Alternative bucket to search for model tarball and transformer files, if</span>
<span class="sd">        original bucket no longer exists.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple of:</span>
<span class="sd">            pipeline (ModelPipeline): A pipeline object to be used for making predictions.</span>

<span class="sd">            pparams (Namespace): Parsed parameter namespace from the requested model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">collection_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_model_collection_by_uuid</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>

    <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_metadata_by_uuid</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No model found with UUID </span><span class="si">%s</span><span class="s2"> in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for model UUID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>

    <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
    <span class="n">pparams</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
    <span class="c1"># pparams.uncertainty   = False</span>
    <span class="n">pparams</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="n">pparams</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>  <span class="c1"># Redirect the untaring of the model to a temporary directory</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">create_prediction_pipeline</span><span class="p">(</span><span class="n">pparams</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">alt_bucket</span><span class="o">=</span><span class="n">alt_bucket</span><span class="p">)</span>
    <span class="c1"># model.params.uncertainty = False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pparams</span><span class="p">)</span></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ensemble_predict"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.ensemble_predict">[docs]</a><span class="k">def</span> <span class="nf">ensemble_predict</span><span class="p">(</span><span class="n">model_uuids</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span> <span class="n">dset_df</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dset_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">splitters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">mt_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">contains_responses</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a series of pretrained models and predict responses with each model; then aggregate</span>
<span class="sd">    the predicted responses into one prediction per compound.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_uuids (iterable of str): Sequence of UUIDs of trained models.</span>

<span class="sd">        collections (str or iterable of str): The collection(s) where the models are stored in the</span>
<span class="sd">        model tracker DB. If a single string, the same collection is assumed to contain all the models.</span>
<span class="sd">        Otherwise, collections should be of the same length as model_uuids.</span>

<span class="sd">        dset_df (DataFrame): Dataset to perform predictions on. Should contain compound IDs and</span>
<span class="sd">        SMILES strings. May contain features.</span>

<span class="sd">        labels (iterable of str): Optional suffixes for model-specific prediction column names.</span>
<span class="sd">        If not provided, the columns are labeled &#39;pred_&lt;uuid&gt;&#39; where &lt;uuid&gt; is the model UUID.</span>

<span class="sd">        dset_params (Namespace): Parameters used to interpret dataset, including id_col and smiles_col.</span>
<span class="sd">        If not provided, id_col and smiles_col are assumed to be same as in the pretrained model and</span>
<span class="sd">        the same for all models.</span>

<span class="sd">        mt_client: Ignored, for backward compatibility only.</span>

<span class="sd">        aggregate (str): Method to be used to combine predictions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pred_df (DataFrame): Table with predicted responses from each model, plus the ensemble prediction.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the singleton MLMTClient instance</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>

    <span class="n">pred_df</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">collections</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="p">[</span><span class="n">collections</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_uuids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">model_uuids</span>

    <span class="n">ok_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">model_uuids</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading model </span><span class="si">%s</span><span class="s2"> from collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">))</span>
        <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_metadata_by_uuid</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No model found with UUID </span><span class="si">%s</span><span class="s2"> in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for model UUID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>

        <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
        <span class="n">model_pparams</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>

        <span class="c1"># Override selected parameters</span>
        <span class="n">model_pparams</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">splitters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_pparams</span><span class="o">.</span><span class="n">splitter</span> <span class="o">!=</span> <span class="n">splitters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Replacing </span><span class="si">%s</span><span class="s2"> splitter in stored model with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_pparams</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="n">splitters</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">model_pparams</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">splitters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dset_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_pparams</span><span class="o">.</span><span class="n">id_col</span> <span class="o">=</span> <span class="n">dset_params</span><span class="o">.</span><span class="n">id_col</span>
            <span class="n">model_pparams</span><span class="o">.</span><span class="n">smiles_col</span> <span class="o">=</span> <span class="n">dset_params</span><span class="o">.</span><span class="n">smiles_col</span>
            <span class="k">if</span> <span class="n">contains_responses</span><span class="p">:</span>
                <span class="n">model_pparams</span><span class="o">.</span><span class="n">response_cols</span> <span class="o">=</span> <span class="n">dset_params</span><span class="o">.</span><span class="n">response_cols</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="n">create_prediction_pipeline</span><span class="p">(</span><span class="n">model_pparams</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pred_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initial_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_pparams</span><span class="o">.</span><span class="n">id_col</span><span class="p">,</span> <span class="n">model_pparams</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">contains_responses</span><span class="p">:</span>
                <span class="n">initial_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">model_pparams</span><span class="o">.</span><span class="n">response_cols</span><span class="p">)</span>
            <span class="n">pred_df</span> <span class="o">=</span> <span class="n">dset_df</span><span class="p">[</span><span class="n">initial_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">contains_responses</span><span class="p">:</span>
                <span class="c1"># Assume singletask model for now</span>
                <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">model_pparams</span><span class="o">.</span><span class="n">response_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;actual&#39;</span><span class="p">})</span>

        <span class="n">pipe</span><span class="o">.</span><span class="n">run_mode</span> <span class="o">=</span> <span class="s1">&#39;prediction&#39;</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">featurization</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_minimal_dataset</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">featurization</span><span class="p">,</span> <span class="n">contains_responses</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_dataset_tasks</span><span class="p">(</span><span class="n">dset_df</span><span class="p">):</span>
            <span class="c1"># Shouldn&#39;t happen - response_cols should already be set in saved model parameters</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;response_cols missing from model params&quot;</span><span class="p">)</span>
        <span class="n">is_featurized</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">featurization</span><span class="o">.</span><span class="n">get_feature_columns</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dset_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">(</span><span class="n">dset_df</span><span class="p">,</span> <span class="n">is_featurized</span><span class="p">)</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">transform_dataset</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Create a temporary data frame to hold the compound IDs and predictions. The model may not</span>
        <span class="c1"># return predictions for all the requested compounds, so we have to outer join the predictions</span>
        <span class="c1"># to the existing data frame.</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">model_pparams</span><span class="o">.</span><span class="n">id_col</span><span class="p">:</span> <span class="n">pipe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>

        <span class="c1"># Get the predictions and standard deviations, if calculated, as numpy arrays</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">preds</span><span class="p">,</span> <span class="n">stds</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">***** Prediction failed for model </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">pipe</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;pred_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume binary classifier for now. We&#39;re going to aggregate the probabilities for class 1.</span>
            <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;pred_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pipe</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">and</span> <span class="n">pipe</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">std_colname</span> <span class="o">=</span> <span class="s1">&#39;std_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span>
            <span class="n">result_df</span><span class="p">[</span><span class="n">std_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">stds</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">model_pparams</span><span class="o">.</span><span class="n">id_col</span><span class="p">)</span>
        <span class="n">ok_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="c1"># Aggregate the ensemble of predictions</span>
    <span class="n">pred_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pred_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ok_labels</span><span class="p">]</span>
    <span class="n">pred_vals</span> <span class="o">=</span> <span class="n">pred_df</span><span class="p">[</span><span class="n">pred_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">aggregate</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">agg_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">pred_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aggregate</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">agg_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">pred_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aggregate</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">agg_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">pred_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aggregate</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
        <span class="n">agg_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">pred_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aggregate</span> <span class="o">==</span> <span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
        <span class="n">std_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;std_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ok_labels</span><span class="p">]</span>
        <span class="n">std_vals</span> <span class="o">=</span> <span class="n">pred_df</span><span class="p">[</span><span class="n">std_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">std_cols</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Weighted ensemble needs uncertainties for all component models.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">std_vals</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can&#39;t compute weighted ensemble because some standard deviations are zero&quot;</span><span class="p">)</span>
        <span class="n">agg_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">pred_vals</span> <span class="o">/</span> <span class="n">std_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">std_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown aggregate value </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aggregate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pipe</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">pred_df</span><span class="p">[</span><span class="s2">&quot;ensemble_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_pred</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pred_df</span><span class="p">[</span><span class="s2">&quot;ensemble_class_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_pred</span>
        <span class="n">pred_df</span><span class="p">[</span><span class="s2">&quot;ensemble_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">agg_pred</span><span class="p">]</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done with ensemble prediction&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pred_df</span></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="retrain_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.retrain_model">[docs]</a><span class="k">def</span> <span class="nf">retrain_model</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mt_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtain model parameters from the metadata in the model tracker, given the model_uuid,</span>
<span class="sd">    and train a new model using exactly the same parameters (except for result_dir). Returns</span>
<span class="sd">    the resulting ModelPipeline object. The pipeline object can then be used as input for</span>
<span class="sd">    performance plots and other analyses that can&#39;t be done using just the metrics stored</span>
<span class="sd">    in the model tracker; or to make predictions on new data.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_uuid (str): The UUID of a trained model.</span>

<span class="sd">        collection_name (str): The collection where the model is stored in the model tracker DB.</span>

<span class="sd">        result_dir (str): The directory of model results when the model tracker is not available.</span>

<span class="sd">        mt_client : Ignored</span>

<span class="sd">        verbose (bool): A switch for disabling informational messages</span>

<span class="sd">    Returns:</span>
<span class="sd">        pipeline (ModelPipeline): A pipeline object containing data from the model training.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading model </span><span class="si">%s</span><span class="s2"> from collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">))</span>
        <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_metadata_by_uuid</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No model found with UUID </span><span class="si">%s</span><span class="s2"> in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">model_uuid</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
                <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for model UUID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>

    <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
    <span class="n">model_pparams</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>

    <span class="n">model_pparams</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="c1"># TODO: This is a hack; possibly the datastore parameter isn&#39;t being stored in the metadata?</span>
    <span class="n">model_pparams</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result_dir</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">model_pparams</span><span class="p">)</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">train_model</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pipe</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_pipeline.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entry point when script is run from a shell&quot;&quot;&quot;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># model_filter parameter determines whether you are loading pretrained models and running</span>
    <span class="c1"># predictions on them, or training a new model</span>
    <span class="k">if</span> <span class="s1">&#39;model_filter&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">model_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># DEPRECATED: This feature isn&#39;t used by anyone as far as I know; it will be removed in</span>
        <span class="c1"># the near future.</span>
        <span class="n">run_models</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">split_only</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">split_uuid</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">split_uuid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running model pipeline&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">ModelPipeline</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">train_model</span><span class="p">()</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dataset size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ATOM DDM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>