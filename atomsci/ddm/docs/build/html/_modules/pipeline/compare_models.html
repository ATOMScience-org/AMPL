<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.compare_models &mdash; ATOM Data-Driven Modeling Pipeline 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ATOM Data-Driven Modeling Pipeline
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/running_ampl.html">Running AMPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_ampl_usage.html">Advanced AMPL Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_testing.html">Advanced Testing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">atomsci</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pipeline.compare_models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.compare_models</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for comparing and visualizing model performance. Most of these functions rely on ATOM&#39;s model tracker and</span>
<span class="sd">datastore services, which are not part of the standard AMPL installation, but a few functions will work on collections of</span>
<span class="sd">models saved as local files.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.utils</span> <span class="kn">import</span> <span class="n">datastore_functions</span> <span class="k">as</span> <span class="n">dsf</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_tracker</span> <span class="k">as</span> <span class="n">trkr</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.pipeline.model_pipeline</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.pipeline.parameter_parser</span> <span class="k">as</span> <span class="nn">parse</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.pipeline.model_wrapper</span> <span class="k">as</span> <span class="nn">mw</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.pipeline.featurization</span> <span class="k">as</span> <span class="nn">feat</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.utils</span> <span class="kn">import</span> <span class="n">file_utils</span> <span class="k">as</span> <span class="n">futils</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
<span class="n">mlmt_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="kn">import</span> <span class="n">MLMTClient</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Model tracker client not supported in your environment; can look at models in filesystem only.&quot;</span><span class="p">)</span>
    <span class="n">mlmt_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="del_ignored_params"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.del_ignored_params">[docs]</a><span class="k">def</span> <span class="nf">del_ignored_params</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">ignored_params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes ignored parameters from the dictionary if they exist</span>

<span class="sd">    Args:</span>
<span class="sd">        dictionary (dict): A dictionary with parameters</span>

<span class="sd">        ignored_parameters (list(str)): A list of keys potentially in the dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ignored_params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_collection_datasets"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_collection_datasets">[docs]</a><span class="k">def</span> <span class="nf">get_collection_datasets</span><span class="p">(</span><span class="n">collection_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of unique training datasets used for all models in a given collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_name (str): Name of model tracker collection to search for models.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of model training (dataset_key, bucket) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">dataset_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">dset_dicts</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_datasets</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">metrics_type</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="c1"># Convert to a list of (dataset_key, bucket) tuples</span>
    <span class="k">for</span> <span class="n">dset_dict</span> <span class="ow">in</span> <span class="n">dset_dicts</span><span class="p">:</span>
        <span class="n">dataset_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dset_dict</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">],</span> <span class="n">dset_dict</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dataset_set</span><span class="p">)</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="extract_collection_perf_metrics"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.extract_collection_perf_metrics">[docs]</a><span class="k">def</span> <span class="nf">extract_collection_perf_metrics</span><span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain list of training datasets with models in the given collection. Get performance metrics for</span>
<span class="sd">    models on each dataset and save them as CSV files in the given output directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_name (str): Name of model tracker collection to search for models.</span>

<span class="sd">        output_dir (str): Directory where tables of performance metrics will be written.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">get_collection_datasets</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dset_key</span><span class="p">,</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="n">dset_perf_df</span> <span class="o">=</span> <span class="n">get_training_perf_table</span><span class="p">(</span><span class="n">dset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="n">pred_type</span><span class="p">)</span>
        <span class="n">dset_perf_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_model_perf_metrics.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dset_key</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">collection_name</span><span class="p">)</span>
        <span class="n">dset_perf_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dset_perf_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dset_perf_file</span><span class="p">)</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_training_perf_table"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_training_perf_table">[docs]</a><span class="k">def</span> <span class="nf">get_training_perf_table</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span> <span class="n">other_filters</span> <span class="o">=</span> <span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load performance metrics from model tracker for all models saved in the model tracker DB under</span>
<span class="sd">    a given collection that were trained against a particular dataset. Identify training parameters</span>
<span class="sd">    that vary between models, and generate plots of performance vs particular combinations of</span>
<span class="sd">    parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_key (str): Training dataset key.</span>

<span class="sd">        bucket (str): Training dataset bucket.</span>

<span class="sd">        collection_name (str): Name of model tracker collection to search for models.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to query.</span>

<span class="sd">        other_filters (dict): Other filter criteria to use in querying models.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of models and performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding models trained on </span><span class="si">%s</span><span class="s2"> dataset </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">))</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;match_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;training_dataset.bucket&quot;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span>
            <span class="s2">&quot;training_dataset.dataset_key&quot;</span><span class="p">:</span> <span class="n">dataset_key</span><span class="p">,</span>
        <span class="p">},</span>

        <span class="s2">&quot;match_metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;metrics_type&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span>  <span class="c1"># match only training metrics</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;match_metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_filters</span><span class="p">)</span>

    <span class="n">metadata_list</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_model_metadata</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
        <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">metadata_list</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No matching models returned&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matching models&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">))</span>

    <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_epochs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">learning_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dropouts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layer_sizes_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">featurizer_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">splitter_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rf_estimators_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rf_max_features_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rf_max_depth_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xgb_learning_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xgb_gamma_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_epoch_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_epochs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;r2_score&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;roc_auc_score&#39;</span>

    <span class="k">for</span> <span class="n">metadata_dict</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
        <span class="c1">#print(&quot;Got metadata for model UUID %s&quot; % model_uuid)</span>

        <span class="c1"># Get model metrics for this model</span>
        <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">]</span>
        <span class="c1">#print(&quot;Got %d metrics dicts for model %s&quot; % (len(metrics_dicts), model_uuid))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got no or incomplete metrics for model </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">subset_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
            <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span>

        <span class="n">model_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
        <span class="n">model_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
        <span class="n">featurizer</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>
        <span class="n">featurizer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featurizer</span><span class="p">)</span>
        <span class="n">split_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">]</span>
        <span class="n">splitter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_params</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">])</span>
        <span class="n">dataset_key</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
            <span class="n">nn_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
            <span class="n">max_epochs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">])</span>
            <span class="n">best_epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">])</span>
            <span class="n">learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span>
            <span class="n">layer_sizes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]]))</span>
            <span class="n">dropouts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">]]))</span>
            <span class="n">rf_estimators_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">rf_max_features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">rf_max_depth_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">xgb_learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">xgb_gamma_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
            <span class="n">rf_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;rf_specific&#39;</span><span class="p">]</span>
            <span class="n">rf_estimators_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">])</span>
            <span class="n">rf_max_features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_features&#39;</span><span class="p">])</span>
            <span class="n">rf_max_depth_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">])</span>
            <span class="n">max_epochs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">best_epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">layer_sizes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dropouts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">xgb_learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">xgb_gamma_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
            <span class="n">xgb_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;xgb_specific&#39;</span><span class="p">]</span>
            <span class="n">rf_estimators_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">rf_max_features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">rf_max_depth_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">max_epochs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">best_epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">layer_sizes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dropouts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">xgb_learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xgb_params</span><span class="p">[</span><span class="s2">&quot;xgb_learning_rate&quot;</span><span class="p">])</span>
            <span class="n">xgb_gamma_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xgb_params</span><span class="p">[</span><span class="s2">&quot;xgb_gamma&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric_type</span><span class="p">])</span>

    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">model_uuid</span><span class="o">=</span><span class="n">model_uuid_list</span><span class="p">,</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="n">model_type_list</span><span class="p">,</span>
                    <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span>
                    <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer_list</span><span class="p">,</span>
                    <span class="n">splitter</span><span class="o">=</span><span class="n">splitter_list</span><span class="p">,</span>
                    <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs_list</span><span class="p">,</span>
                    <span class="n">best_epoch</span><span class="o">=</span><span class="n">best_epoch_list</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate_list</span><span class="p">,</span>
                    <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes_list</span><span class="p">,</span>
                    <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts_list</span><span class="p">,</span>
                    <span class="n">rf_estimators</span><span class="o">=</span><span class="n">rf_estimators_list</span><span class="p">,</span>
                    <span class="n">rf_max_features</span><span class="o">=</span><span class="n">rf_max_features_list</span><span class="p">,</span>
                    <span class="n">rf_max_depth</span><span class="o">=</span><span class="n">rf_max_depth_list</span><span class="p">,</span>
                    <span class="n">xgb_learning_rate</span> <span class="o">=</span> <span class="n">xgb_learning_rate_list</span><span class="p">,</span>
                    <span class="n">xgb_gamma</span> <span class="o">=</span> <span class="n">xgb_gamma_list</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>
        <span class="n">perf_df</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
    <span class="n">sort_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_valid&#39;</span> <span class="o">%</span> <span class="n">metric_type</span>

    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">perf_df</span></div>

<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="extract_model_and_feature_parameters"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.extract_model_and_feature_parameters">[docs]</a><span class="k">def</span> <span class="nf">extract_model_and_feature_parameters</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a config file, extract model and featuer parameters. Looks for parameter names</span>
<span class="sd">    that end in *_specific. e.g. nn_specific, auto_featurizer_specific</span>

<span class="sd">    Args:</span>
<span class="sd">        model_metadict (dict): Dictionary containing NON-FLATTENED metadata for an AMPL model</span>

<span class="sd">    Returns:</span>
<span class="sd">        dictionary containing featurizer and model parameters. Most contain the following</span>
<span class="sd">        keys. [&#39;max_epochs&#39;, &#39;best_epoch&#39;, &#39;learning_rate&#39;, &#39;layer_sizes&#39;, &#39;drop_outs&#39;, </span>
<span class="sd">        &#39;rf_estimators&#39;, &#39;rf_max_features&#39;, &#39;rf_max_depth&#39;, &#39;xgb_gamma&#39;, &#39;xgb_learning_rate&#39;,</span>
<span class="sd">        &#39;featurizer_parameters_dict&#39;, &#39;model_parameters_dict&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;best_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;dropouts&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;rf_estimators&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_features&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">]</span>

    <span class="n">model_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
        <span class="n">nn_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]])</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
        <span class="n">rf_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;rf_specific&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;rf_max_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_features&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
        <span class="n">xgb_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;xgb_specific&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;xgb_gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xgb_params</span><span class="p">[</span><span class="s1">&#39;xgb_gamma&#39;</span><span class="p">]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xgb_params</span><span class="p">[</span><span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_info</span><span class="p">:</span>
            <span class="c1"># all fields must be filled in</span>
            <span class="n">model_info</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">nan</span>

    <span class="c1"># the new way of extracting model parameters is to simply save them in json</span>
    <span class="k">if</span> <span class="s1">&#39;nn_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
        <span class="c1"># include learning rate, max_epochs, and best_epoch for convenience </span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">learning_rate_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">learning_rate_col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="p">[</span><span class="n">learning_rate_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># delete several parameters that aren&#39;t normally saved</span>
        <span class="n">ignored_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span><span class="s1">&#39;bias_init_consts&#39;</span><span class="p">,</span><span class="s1">&#39;optimizer_type&#39;</span><span class="p">,</span>
            <span class="s1">&#39;weight_decay_penalty&#39;</span><span class="p">,</span><span class="s1">&#39;weight_decay_penalty_type&#39;</span><span class="p">,</span><span class="s1">&#39;weight_init_stddevs&#39;</span><span class="p">]</span>
        <span class="n">del_ignored_params</span><span class="p">(</span><span class="n">model_metadata</span><span class="p">,</span> <span class="n">ignored_params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;rf_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;rf_specific&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;xgb_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;xgb_specific&#39;</span><span class="p">]</span>
        <span class="c1"># delete several parameters that aren&#39;t normally saved</span>
        <span class="n">ignored_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xgb_colsample_bytree&#39;</span><span class="p">,</span><span class="s1">&#39;xgb_max_depth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;xgb_min_child_weight&#39;</span><span class="p">,</span><span class="s1">&#39;xgb_n_estimators&#39;</span><span class="p">,</span><span class="s1">&#39;xgb_subsample&#39;</span><span class="p">]</span>
        <span class="n">del_ignored_params</span><span class="p">(</span><span class="n">model_metadata</span><span class="p">,</span> <span class="n">ignored_params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no model parameters found</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;model_parameters_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model_metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;ecfp_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="n">feat_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;ecfp_specific&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;auto_featurizer_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="n">feat_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;auto_featurizer_specific&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;autoencoder_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
        <span class="n">feat_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;autoencoder_specific&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no model parameters found</span>
        <span class="n">feat_metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;feat_parameters_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">feat_metadata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model_info</span></div>

<span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_best_perf_table"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_best_perf_table">[docs]</a><span class="k">def</span> <span class="nf">get_best_perf_table</span><span class="p">(</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PK_pipe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract parameters and training run performance metrics for a single model. The model may be</span>
<span class="sd">    specified either by a metadata dictionary, a model_uuid or a result directory; in the model_uuid case, the function</span>
<span class="sd">    queries the model tracker DB for the model metadata. For models saved in the filesystem, can query the performance</span>
<span class="sd">    data from the original result directory, but not from a saved tarball.</span>

<span class="sd">    Args:</span>
<span class="sd">        metric_type (str): Performance metric to include in result dictionary.</span>

<span class="sd">        col_name (str): Collection name containing model, if model is specified by model_uuid.</span>

<span class="sd">        result_dir (str): result directory of the model, if Model tracker is not supported and metadata_dict not provided.</span>

<span class="sd">        model_uuid (str): UUID of model to query, if metadata_dict is not provided.</span>

<span class="sd">        metadata_dict (dict): Full metadata dictionary for a model, including training metrics and</span>
<span class="sd">        dataset metadata.</span>

<span class="sd">        PK_pipe (bool): If True, include some additional parameters in the result dictionary specific to PK models.</span>

<span class="sd">    Returns:</span>
<span class="sd">        model_info (dict): Dictionary of parameter or metric name - value pairs.</span>

<span class="sd">    Todo:</span>
<span class="sd">        Add support for models saved as local tarball files.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only, &#39;result_dir&#39; needs to be provided.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">mlmt_supported</span> <span class="ow">and</span> <span class="n">col_name</span><span class="p">:</span>
        <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metadata_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Have to specify either metadata_dict or model_uuid&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;match_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;model_uuid&quot;</span><span class="p">:</span> <span class="n">model_uuid</span><span class="p">,</span>
                <span class="p">},</span>

                <span class="s2">&quot;match_metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;metrics_type&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span>  <span class="c1"># match only training metrics</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="n">metadata_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_model_metadata</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
                <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span>
            <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No matching models returned&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">model_uuid</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
                <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">model_dir</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_uuid (</span><span class="si">{</span><span class="n">model_uuid</span><span class="si">}</span><span class="s2">) not exist in </span><span class="si">{</span><span class="n">result_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">model_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;collection_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_name</span>

    <span class="c1"># Get model metrics for this model</span>
    <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got no or incomplete metrics for model </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>
    <span class="n">split_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">]</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_params</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;split_uuid&#39;</span> <span class="ow">in</span> <span class="n">split_params</span><span class="p">:</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;split_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_params</span><span class="p">[</span><span class="s1">&#39;split_uuid&#39;</span><span class="p">]</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span>
    <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span>
    <span class="n">dset_meta</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">PK_pipe</span><span class="p">:</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;assay_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assay_category&#39;</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">)</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;response_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_cols&#39;</span><span class="p">,</span> <span class="n">dset_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_col&#39;</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;descriptor_specific&#39;</span><span class="p">][</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_meta</span><span class="p">[</span><span class="s1">&#39;num_row&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># KSM: Commented out because original dataset may no longer be accessible.</span>
        <span class="c1">#tmp_df = dsf.retrieve_dataset_by_datasetkey(model_info[&#39;dataset_key&#39;], model_info[&#39;bucket&#39;])</span>
        <span class="c1">#model_info[&#39;num_samples&#39;] = tmp_df.shape[0]</span>
        <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nan</span>

    <span class="c1"># add model and feature params</span>
    <span class="c1"># model_uuid appears in model_feature_params and will overwrite the one in model_info</span>
    <span class="c1"># it&#39;s the same uuid, so it should be ok</span>
    <span class="n">model_feature_params</span> <span class="o">=</span> <span class="n">extract_model_and_feature_parameters</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
    <span class="n">model_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_feature_params</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
        <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>
        <span class="n">model_info</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">][</span><span class="n">metric_type</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;prediction_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metric_type</span> <span class="o">!=</span> <span class="s1">&#39;rms_score&#39;</span><span class="p">):</span>
            <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;rms_score_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subset</span>
            <span class="n">model_info</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">][</span><span class="s1">&#39;rms_score&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">model_info</span></div>


<span class="c1"># ---------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_best_models_info"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_best_models_info">[docs]</a><span class="k">def</span> <span class="nf">get_best_models_info</span><span class="p">(</span><span class="n">col_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span> <span class="n">result_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PK_pipeline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;/usr/local/data&#39;</span><span class="p">,</span>
                         <span class="n">shortlist_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dset_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span>
                         <span class="n">metric_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">other_filters</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tabulate parameters and performance metrics for the best models, according to a given metric, trained against</span>
<span class="sd">    each specified dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        col_names (list of str): List of model tracker collections to search.</span>

<span class="sd">        bucket (str): Datastore bucket for training datasets.</span>

<span class="sd">        pred_type (str): Type of models (regression or classification).</span>

<span class="sd">        result_dir (list of str): Result directories of the models, if model tracker is not supported.</span>

<span class="sd">        PK_pipeline (bool): Are we being called from PK pipeline?</span>

<span class="sd">        output_dir (str): Directory to write output table to.</span>

<span class="sd">        shortlist_key (str): Datastore key for table of datasets to query models for.</span>

<span class="sd">        input_dset_keys (str or list of str): List of datastore keys for datasets to query models for. Either shortlist_key</span>
<span class="sd">        or input_dset_keys must be specified, but not both.</span>

<span class="sd">        save_results (bool): If True, write the table of results to a CSV file.</span>

<span class="sd">        subset (str): Input dataset subset (&#39;train&#39;, &#39;valid&#39;, or &#39;test&#39;) for which metrics are used to select best models.</span>

<span class="sd">        metric_type (str): Type of performance metric (r2_score, roc_auc_score, etc.) to use to select best models.</span>

<span class="sd">        selection_type (str): Score criterion (&#39;max&#39; or &#39;min&#39;) to use to select best models.</span>

<span class="sd">        other_filters (dict): Additional selection criteria to include in model query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        top_models_df (DataFrame): Table of parameters and metrics for best models for each dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only, &#39;result_dir&#39; needs to be provided.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">top_models_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sort_order</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">sort_ascending</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">metric_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;r2_score&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;roc_auc_score&#39;</span>
    <span class="k">if</span> <span class="n">other_filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">other_filters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># define dset_keys</span>
    <span class="k">if</span> <span class="n">input_dset_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shortlist_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You can specify either shortlist_key or input_dset_keys but not both.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">input_dset_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shortlist_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_dset_keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">dset_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dset_keys</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dset_keys</span> <span class="o">=</span> <span class="n">input_dset_keys</span>
    <span class="k">elif</span> <span class="n">input_dset_keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shortlist_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify either input_dset_keys or shortlist_key&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dset_keys</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dset_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># define dset_keys, col_names and buckets from shortlist file</span>
            <span class="n">shortlist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">shortlist_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;dataset_key&#39;</span> <span class="ow">in</span> <span class="n">shortlist</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">dset_keys</span> <span class="o">=</span> <span class="n">shortlist</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s1">&#39;task_name&#39;</span> <span class="ow">in</span> <span class="n">shortlist</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">dset_keys</span> <span class="o">=</span> <span class="n">shortlist</span><span class="p">[</span><span class="s1">&#39;task_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dset_keys</span> <span class="o">=</span> <span class="n">shortlist</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="s1">&#39;collection&#39;</span> <span class="ow">in</span> <span class="n">shortlist</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">col_names</span> <span class="o">=</span> <span class="n">shortlist</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;bucket&#39;</span> <span class="ow">in</span> <span class="n">shortlist</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">shortlist</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">mlmt_supported</span> <span class="ow">and</span> <span class="n">col_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">bucket</span><span class="o">=</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span>
        <span class="c1"># Get the best model over all collections for each dataset</span>
        <span class="k">for</span> <span class="n">dset_key</span> <span class="ow">in</span> <span class="n">dset_keys</span><span class="p">:</span>
            <span class="n">dset_key</span> <span class="o">=</span> <span class="n">dset_key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">dset_model_info</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">buck</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;match_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;training_dataset.dataset_key&quot;</span><span class="p">:</span> <span class="n">dset_key</span><span class="p">,</span>
                                <span class="s2">&quot;training_dataset.bucket&quot;</span><span class="p">:</span> <span class="n">buck</span><span class="p">,</span>
                            <span class="p">},</span>

                            <span class="s2">&quot;match_metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;metrics_type&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span>  <span class="c1"># match only training metrics</span>
                                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;subset&quot;</span><span class="p">:</span> <span class="n">subset</span><span class="p">,</span>
                                <span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;prediction_results.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metric_type</span> <span class="p">:</span> <span class="n">sort_order</span><span class="p">[</span><span class="n">selection_type</span><span class="p">]}]</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;match_metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_filters</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Querying collection </span><span class="si">%s</span><span class="s1"> for models trained on dataset </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">buck</span><span class="p">,</span> <span class="n">dset_key</span><span class="p">))</span>
                            <span class="n">metadata_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_model_metadata</span><span class="p">(</span>
                                <span class="n">collection_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
                                <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
                                <span class="n">limit</span><span class="o">=</span><span class="mi">1</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error returned when querying the best model for dataset </span><span class="si">%s</span><span class="s2"> in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dset_key</span><span class="p">,</span> <span class="n">col_name</span><span class="p">))</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No models returned for dataset </span><span class="si">%s</span><span class="s2"> in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dset_key</span><span class="p">,</span> <span class="n">col_name</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Query returned </span><span class="si">%d</span><span class="s1"> models&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">))</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">metadata_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">model_info</span> <span class="o">=</span> <span class="n">get_best_perf_table</span><span class="p">(</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">metadata_dict</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">PK_pipe</span><span class="o">=</span><span class="n">PK_pipeline</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">model_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">model_info</span><span class="p">])</span>
                            <span class="n">dset_model_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_df</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">continue</span>
            <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset_model_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dset_model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dset_model_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                                <span class="n">by</span><span class="o">=</span><span class="n">metric_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">sort_ascending</span><span class="p">[</span><span class="n">selection_type</span><span class="p">])</span>
                <span class="n">top_models_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dset_model_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding data for bucket </span><span class="si">%s</span><span class="s1">, dset_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dset_model_df</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dset_model_df</span><span class="o">.</span><span class="n">dataset_key</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">result_dir</span><span class="p">:</span>
            <span class="n">temp_perf_df</span> <span class="o">=</span> <span class="n">get_filesystem_perf_results</span><span class="p">(</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">rd</span><span class="p">,</span> <span class="n">pred_type</span> <span class="o">=</span> <span class="n">pred_type</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                                <span class="n">by</span><span class="o">=</span><span class="n">metric_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">sort_ascending</span><span class="p">[</span><span class="n">selection_type</span><span class="p">])</span>
            <span class="n">top_models_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_perf_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding data from &#39;</span><span class="si">{</span><span class="n">rd</span><span class="si">}</span><span class="s2">&#39; &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_models_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No metadata found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">top_models_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">top_models_info</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_results</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shortlist_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Not including shortlist key right now because some are weirdly formed and have .csv in the middle</span>
            <span class="n">top_models_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_models_metadata.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dset_key</span> <span class="ow">in</span> <span class="n">input_dset_keys</span><span class="p">:</span>
                <span class="c1"># TODO: This doesn&#39;t make sense; why output multiple copies of the same table?</span>
                <span class="n">shortened_key</span> <span class="o">=</span> <span class="n">dset_key</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
                <span class="n">top_models_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_models_metadata_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="n">shortened_key</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_models_df</span></div>


<span class="c1"># TODO: This function looks like work in progress, should we delete it?</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">#---------------------------------------------------------------------------------------------------------</span>
<span class="sd">def _get_best_grouped_models_info(collection=&#39;pilot_fixed&#39;, pred_type=&#39;regression&#39;, top_n=1, subset=&#39;test&#39;):</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="sd">    Get results for models in the given collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="sd">    if not mlmt_supported:</span>
<span class="sd">        print(&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;)</span>
<span class="sd">        return</span>

<span class="sd">    res_dir = &#39;/usr/local/data/%s_perf&#39; % collection</span>
<span class="sd">    plt_dir = &#39;%s/Plots&#39; % res_dir</span>
<span class="sd">    os.makedirs(plt_dir, exist_ok=True)</span>
<span class="sd">    res_files = os.listdir(res_dir)</span>
<span class="sd">    suffix = &#39;_%s_model_perf_metrics.csv&#39; % collection</span>

<span class="sd">    if pred_type == &#39;regression&#39;:</span>
<span class="sd">        metric_type = &#39;r2_score&#39;</span>
<span class="sd">    else:</span>
<span class="sd">        metric_type = &#39;roc_auc_score&#39;</span>
<span class="sd">    for res_file in res_files:</span>
<span class="sd">        try:</span>
<span class="sd">            if not res_file.endswith(suffix):</span>
<span class="sd">                continue</span>
<span class="sd">            res_path = os.path.join(res_dir, res_file)</span>

<span class="sd">            res_df = pd.read_csv(res_path, index_col=False)</span>
<span class="sd">            res_df[&#39;combo&#39;] = [&#39;%s/%s&#39; % (m,f) for m, f in zip(res_df.model_type.values, res_df.featurizer.values)]</span>
<span class="sd">            dset_name = res_file.replace(suffix, &#39;&#39;)</span>
<span class="sd">            datasets.append(dset_name)</span>
<span class="sd">            res_df[&#39;dataset&#39;] = dset_name</span>
<span class="sd">            print(dset_name)</span>
<span class="sd">            res_df = res_df.sort_values(&#39;{0}_{1}&#39;.format(metric_type, subset), ascending=False)</span>
<span class="sd">            res_df[&#39;model_type/feat&#39;] = [&#39;%s/%s&#39; % (m,f) for m, f in zip(res_df.model_type.values, res_df.featurizer.values)]</span>
<span class="sd">            res_df = res_df.sort_values(&#39;{0}_{1}&#39;.format(metric_type, subset), ascending=False)</span>
<span class="sd">            grouped_df = res_df.groupby(&#39;model_type/feat&#39;).apply(</span>
<span class="sd">                lambda t: t.head(top_n)</span>
<span class="sd">            ).reset_index(drop=True)</span>
<span class="sd">            top_grouped_models.append(grouped_df)</span>
<span class="sd">            top_combo = res_df[&#39;model_type/feat&#39;].values[0]</span>
<span class="sd">            top_combo_dsets.append(top_combo + dset_name.lstrip(&#39;ATOM_GSK_dskey&#39;))</span>
<span class="sd">            top_score = res_df[&#39;{0}_{1}&#39;.format(metric_type, subset)].values[0]</span>
<span class="sd">            top_model_feat.append(top_combo)</span>
<span class="sd">            top_scores.append(top_score)</span>
<span class="sd">            num_samples.append(res_df[&#39;Dataset Size&#39;][0])</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_umap_nn_model_perf_table"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_umap_nn_model_perf_table">[docs]</a><span class="k">def</span> <span class="nf">get_umap_nn_model_perf_table</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load performance metrics from model tracker for all NN models with the given prediction_type saved in</span>
<span class="sd">    the model tracker DB under a given collection that were trained against a particular dataset. Show</span>
<span class="sd">    parameter settings for UMAP transformer for models where they are available.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_key (str): Dataset key for training dataset.</span>

<span class="sd">        bucket (str): Dataset bucket for training dataset.</span>

<span class="sd">        collection_name (str): Name of model tracker collection to search for models.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of model performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;match_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;training_dataset.bucket&quot;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span>
            <span class="s2">&quot;training_dataset.dataset_key&quot;</span><span class="p">:</span> <span class="n">dataset_key</span><span class="p">,</span>
            <span class="s2">&quot;model_parameters.model_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;NN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_parameters.prediction_type&quot;</span> <span class="p">:</span> <span class="n">pred_type</span>
        <span class="p">},</span>

        <span class="s2">&quot;match_metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;metrics_type&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span>  <span class="c1"># match only training metrics</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;match_metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_filters</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding models trained on </span><span class="si">%s</span><span class="s2"> dataset </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">))</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="n">metadata_list</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_model_metadata</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
        <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">metadata_list</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No matching models returned&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matching models&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">))</span>

    <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">learning_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dropouts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layer_sizes_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">featurizer_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_epoch_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_epochs_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">feature_transform_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_dim_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_targ_wt_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_neighbors_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_min_dist_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">sort_metric</span> <span class="o">=</span> <span class="s1">&#39;r2_score&#39;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">,</span> <span class="s1">&#39;rms_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mae_score&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sort_metric</span> <span class="o">=</span> <span class="s1">&#39;roc_auc_score&#39;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;prc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;matthews_cc&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">metadata_dict</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
        <span class="c1">#print(&quot;Got metadata for model UUID %s&quot; % model_uuid)</span>

        <span class="c1"># Get model metrics for this model</span>
        <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">]</span>
        <span class="c1">#print(&quot;Got %d metrics dicts for model %s&quot; % (len(metrics_dicts), model_uuid))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got no or incomplete metrics for model </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Got more than one set of best epoch metrics for model </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">subset_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
            <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span>

        <span class="n">model_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">!=</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">featurizer</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>
        <span class="n">featurizer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featurizer</span><span class="p">)</span>
        <span class="n">feature_transform_type</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;feature_transform_type&#39;</span><span class="p">]</span>
        <span class="n">feature_transform_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_transform_type</span><span class="p">)</span>
        <span class="n">nn_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
        <span class="n">max_epochs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">])</span>
        <span class="n">best_epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">])</span>
        <span class="n">learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span>
        <span class="n">layer_sizes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]]))</span>
        <span class="n">dropouts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">]]))</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;umap_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
            <span class="n">umap_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;umap_specific&#39;</span><span class="p">]</span>
            <span class="n">umap_dim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_dim&#39;</span><span class="p">])</span>
            <span class="n">umap_targ_wt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_targ_wt&#39;</span><span class="p">])</span>
            <span class="n">umap_neighbors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_neighbors&#39;</span><span class="p">])</span>
            <span class="n">umap_min_dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_min_dist&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">umap_dim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">umap_targ_wt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">umap_neighbors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">umap_min_dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>


    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">model_uuid</span><span class="o">=</span><span class="n">model_uuid_list</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate_list</span><span class="p">,</span>
                    <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts_list</span><span class="p">,</span>
                    <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes_list</span><span class="p">,</span>
                    <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer_list</span><span class="p">,</span>
                    <span class="n">best_epoch</span><span class="o">=</span><span class="n">best_epoch_list</span><span class="p">,</span>
                    <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs_list</span><span class="p">,</span>
                    <span class="n">feature_transform_type</span><span class="o">=</span><span class="n">feature_transform_type_list</span><span class="p">,</span>
                    <span class="n">umap_dim</span><span class="o">=</span><span class="n">umap_dim_list</span><span class="p">,</span>
                    <span class="n">umap_targ_wt</span><span class="o">=</span><span class="n">umap_targ_wt_list</span><span class="p">,</span>
                    <span class="n">umap_neighbors</span><span class="o">=</span><span class="n">umap_neighbors_list</span><span class="p">,</span>
                    <span class="n">umap_min_dist</span><span class="o">=</span><span class="n">umap_min_dist_list</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>
            <span class="n">perf_df</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>
    <span class="n">sort_by</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_valid&#39;</span> <span class="o">%</span> <span class="n">sort_metric</span>

    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">perf_df</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_tarball_perf_table"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_tarball_perf_table">[docs]</a><span class="k">def</span> <span class="nf">get_tarball_perf_table</span><span class="p">(</span><span class="n">model_tarball</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve model metadata and performance metrics for a model saved as a tarball (.tar.gz) file.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_tarball (str): Path of model tarball file, named as model.tar.gz.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple (pd.DataFrame, dict): Table of performance metrics and a dictionary of model metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tarf_content</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model_tarball</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">metadata_file</span> <span class="o">=</span> <span class="n">tarf_content</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="s2">&quot;./model_metadata.json&quot;</span><span class="p">)</span>
    <span class="n">ext_metadata</span> <span class="o">=</span> <span class="n">tarf_content</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">metadata_file</span><span class="p">)</span>

    <span class="n">meta_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ext_metadata</span><span class="p">)</span>
    <span class="n">ext_metadata</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">,</span> <span class="s1">&#39;rms_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mae_score&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;prc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_score&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;accuracy_score&#39;</span><span class="p">,</span> <span class="s1">&#39;npv&#39;</span><span class="p">,</span> <span class="s1">&#39;matthews_cc&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;cross_entropy&#39;</span><span class="p">,</span> <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">emet</span> <span class="ow">in</span> <span class="n">meta_json</span><span class="p">[</span><span class="s2">&quot;training_metrics&quot;</span><span class="p">]:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">emet</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">score_ix</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">emet</span><span class="p">[</span><span class="s2">&quot;subset&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">][</span><span class="n">score_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">emet</span><span class="p">[</span><span class="s2">&quot;prediction_results&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>

    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="n">perf_df</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">perf_df</span><span class="p">,</span> <span class="n">meta_json</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_filesystem_perf_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_filesystem_perf_results">[docs]</a><span class="k">def</span> <span class="nf">get_filesystem_perf_results</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve metadata and performance metrics for models stored in the filesystem from a hyperparameter search run.</span>

<span class="sd">    Args:</span>
<span class="sd">        result_dir (str): Root directory for results from a hyperparameter search training run.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of metadata fields and performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ampl_version_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">featurizer_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dataset_key_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">splitter_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_score_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">feature_transform_type_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># model type specific lists</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">,</span> <span class="s1">&#39;rms_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mae_score&#39;</span><span class="p">,</span> <span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;prc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_score&#39;</span><span class="p">,</span> <span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;accuracy_score&#39;</span><span class="p">,</span> <span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;npv&#39;</span><span class="p">,</span> <span class="s1">&#39;matthews_cc&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;cross_entropy&#39;</span><span class="p">,</span> <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="s1">&#39;model_choice_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
       
    <span class="c1"># Navigate the results directory tree</span>
    <span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tar_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
        <span class="c1"># collect all tars for later</span>
        <span class="n">tar_list</span> <span class="o">=</span> <span class="n">tar_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar.gz&#39;</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;model_metadata.json&#39;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;model_metrics.json&#39;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">):</span>
<span class="c1">#             print(dirpath)</span>
            <span class="n">meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_fp</span><span class="p">:</span>
                    <span class="n">meta_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_fp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">meta_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">pred_type</span><span class="p">:</span>
                    <span class="n">model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">)</span>
                    <span class="n">metrics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metrics.json&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metrics_fp</span><span class="p">:</span>
                        <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">metrics_fp</span><span class="p">)</span>
                    <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t access model </span><span class="si">{</span><span class="n">dirpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found data for </span><span class="si">%d</span><span class="s2"> models under </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">),</span> <span class="n">result_dir</span><span class="p">))</span>

    <span class="c1"># build dictonary of tarball names</span>
    <span class="n">tar_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tf</span><span class="p">):</span><span class="n">tf</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">tar_list</span><span class="p">}</span>
    <span class="n">path_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">metadata_dict</span><span class="p">,</span> <span class="n">metrics_dicts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">):</span>
        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
        <span class="n">dataset_key</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">build_tarball_name</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">build_dataset_name</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">),</span> <span class="n">model_uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset_name</span> <span class="ow">in</span> <span class="n">tar_dict</span><span class="p">:</span>
            <span class="n">path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tar_dict</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># unable to find saved tar file</span>
            <span class="n">path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Get list of training run metrics for this model</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got no or incomplete metrics for model </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">subset_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
                <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span>
        
        <span class="n">model_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
        <span class="n">ampl_version</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">]</span>
        <span class="n">ampl_version_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ampl_version</span><span class="p">)</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
        <span class="n">model_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
        <span class="n">model_score_type</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_choice_score_type&#39;</span><span class="p">]</span>
        <span class="n">model_score_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_score_type</span><span class="p">)</span>
        <span class="n">featurizer</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>
        <span class="c1">#mix ecfp, graphconv, moe, mordred, rdkit for concise representation</span>
        <span class="k">if</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;computed_descriptors&quot;</span><span class="p">,</span> <span class="s2">&quot;descriptors&quot;</span><span class="p">]:</span>
            <span class="n">featurizer</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s2">&quot;descriptor_specific&quot;</span><span class="p">][</span><span class="s2">&quot;descriptor_type&quot;</span><span class="p">]</span>
        <span class="n">featurizer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featurizer</span><span class="p">)</span>
        <span class="n">split_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">]</span>
        <span class="n">splitter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_params</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">])</span>
        <span class="n">dataset_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">])</span>
        <span class="n">feature_transform_type</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;feature_transform_type&#39;</span><span class="p">]</span>
        <span class="n">feature_transform_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_transform_type</span><span class="p">)</span>

        <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extract_model_and_feature_parameters</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="s1">&#39;model_choice_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_metrics</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="s1">&#39;model_choice_score&#39;</span><span class="p">])</span>

    <span class="n">param_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">model_uuid</span><span class="o">=</span><span class="n">model_uuid_list</span><span class="p">,</span>
                    <span class="n">model_path</span> <span class="o">=</span> <span class="n">path_list</span><span class="p">,</span>
                    <span class="n">ampl_version</span><span class="o">=</span><span class="n">ampl_version_list</span><span class="p">,</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="n">model_type_list</span><span class="p">,</span>
                    <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key_list</span><span class="p">,</span>
                    <span class="n">features</span><span class="o">=</span><span class="n">featurizer_list</span><span class="p">,</span>
                    <span class="n">splitter</span><span class="o">=</span><span class="n">splitter_list</span><span class="p">,</span>
                    <span class="n">model_score_type</span><span class="o">=</span><span class="n">model_score_type_list</span><span class="p">,</span>
                    <span class="n">feature_transform_type</span><span class="o">=</span><span class="n">feature_transform_type_list</span><span class="p">))</span>

    <span class="n">perf_df</span><span class="p">[</span><span class="s1">&#39;model_choice_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="s1">&#39;model_choice_score&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;best_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="n">perf_df</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">param_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="n">sort_by</span> <span class="o">=</span> <span class="s1">&#39;model_choice_score&#39;</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: column names have been changed to align with get_multitask_perf_from_tracker(): featurizer is now features and &lt;subset&gt;_&lt;metric&gt; has been changed to best_&lt;subset&gt;_&lt;metric&gt;.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">perf_df</span></div>

<div class="viewcode-block" id="get_filesystem_models"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_filesystem_models">[docs]</a><span class="k">def</span> <span class="nf">get_filesystem_models</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify all models in result_dir and create perf_result table with &#39;tarball_path&#39; column containing a path</span>
<span class="sd">    to each tarball.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">get_filesystem_perf_results</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;valid_r2_score&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;valid_roc_auc_score&#39;</span>
    <span class="c1">#best_df = perf_df.sort_values(by=metric, ascending=False).drop_duplicates(subset=&#39;dataset_key&#39;).copy()</span>
    <span class="n">perf_df</span><span class="p">[</span><span class="s1">&#39;dataset_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perf_df</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">perf_df</span><span class="p">[</span><span class="s1">&#39;tarball_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_model_</span><span class="si">%s</span><span class="s1">.tar.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;dataset_names&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tarball_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">perf_df</span><span class="p">[</span><span class="s1">&#39;tarball_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">all_filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">tarball_names</span><span class="p">:</span>
                <span class="n">all_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fn</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fn</span><span class="p">)))</span>

    <span class="n">found_files_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;tarball_names&#39;</span><span class="p">:[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_filenames</span><span class="p">],</span>
                                    <span class="s1">&#39;tarball_paths&#39;</span><span class="p">:[</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_filenames</span><span class="p">]})</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">found_files_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;tarball_names&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">perf_df</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="copy_best_filesystem_models"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.copy_best_filesystem_models">[docs]</a><span class="k">def</span> <span class="nf">copy_best_filesystem_models</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify the best models for each dataset within a result directory tree (e.g. from a hyperparameter search).</span>
<span class="sd">    Copy the associated model tarballs to a destination directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        result_dir (str): Path to model training result directory.</span>

<span class="sd">        dest_dir (str): Path of directory wherre model tarballs will be copied to.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to copy</span>

<span class="sd">        force_update (bool): If true, overwrite tarball files that already exist in dest_dir.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of performance metrics for best models.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">get_filesystem_perf_results</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;valid_r2_score&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;valid_roc_auc_score&#39;</span>
    <span class="n">best_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dataset_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">best_df</span><span class="o">.</span><span class="n">dataset_key</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">model_uuids</span> <span class="o">=</span> <span class="n">best_df</span><span class="o">.</span><span class="n">model_uuid</span><span class="o">.</span><span class="n">values</span>
    <span class="n">tarball_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_model_</span><span class="si">%s</span><span class="s1">.tar.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dset_name</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">dset_name</span><span class="p">,</span> <span class="n">model_uuid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dataset_names</span><span class="p">,</span> <span class="n">model_uuids</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="ow">in</span> <span class="n">tarball_names</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">force_update</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">))):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">dest_dir</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copied </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_df</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_summary_perf_tables"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_summary_perf_tables">[docs]</a><span class="k">def</span> <span class="nf">get_summary_perf_tables</span><span class="p">(</span><span class="n">collection_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">result_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prediction_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load model parameters and performance metrics from model tracker for all models saved in the model tracker DB under</span>
<span class="sd">    the given collection names (or result directory if Model tracker is not available) with the given prediction type.</span>
<span class="sd">    Tabulate the parameters and metrics including:</span>
<span class="sd">        dataset (assay name, target, parameter, key, bucket)</span>
<span class="sd">        dataset size (train/valid/test/total)</span>
<span class="sd">        number of training folds</span>
<span class="sd">        model type (NN or RF)</span>
<span class="sd">        featurizer</span>
<span class="sd">        transformation type</span>
<span class="sd">        metrics: r2_score, mae_score and rms_score for regression, or ROC AUC for classification</span>


<span class="sd">    Args:</span>
<span class="sd">        collection_names (list): Names of model tracker collections to search for models.</span>

<span class="sd">        filter_dict (dict): Additional filter criteria to use in model query.</span>

<span class="sd">        result_dir (str or list): Directories to search for models; must be provided if the model tracker DB is not available.</span>

<span class="sd">        prediction_type (str): Type of models (classification or regression) to query.</span>

<span class="sd">        verbose (bool): If true, print status messages as collections are processed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of model metadata fields and performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only, &#39;result_dir&#39; is needed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">collection_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ampl_version_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_built_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dataset_key_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bucket_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">featurizer_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">desc_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transform_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dset_size_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">splitter_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">split_strategy_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">split_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_dim_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_targ_wt_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_neighbors_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">umap_min_dist_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">split_uuid_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">model_feat_param_list</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">score_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mae_score&#39;</span><span class="p">,</span> <span class="s1">&#39;rms_score&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: add more classification metrics later</span>
        <span class="n">score_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;prc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy_score&#39;</span><span class="p">,</span> <span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_score&#39;</span><span class="p">,</span> <span class="s1">&#39;npv&#39;</span><span class="p">,</span> <span class="s1">&#39;matthews_cc&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">]</span>

    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ncmpd_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">score_types</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">score_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ncmpd_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">metadata_list_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">mlmt_supported</span> <span class="ow">and</span> <span class="n">collection_names</span><span class="p">:</span>
        <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters.prediction_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction_type</span>
        <span class="k">for</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collection_names</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding models in collection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">collection_name</span><span class="p">)</span>
            <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;match_metadata&quot;</span><span class="p">:</span> <span class="n">filter_dict</span><span class="p">,</span>

                <span class="s2">&quot;match_metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;metrics_type&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span>  <span class="c1"># match only training metrics</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="n">metadata_list</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_model_metadata</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
                <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">metadata_list_dict</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_list</span>
    <span class="k">elif</span> <span class="n">result_dir</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result_dir</span> <span class="o">=</span> <span class="p">[</span><span class="n">result_dir</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">result_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_list_dict</span><span class="p">:</span>
                <span class="n">metadata_list_dict</span><span class="p">[</span><span class="n">rd</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">rd</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;model_metadata.json&quot;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">metadata_list_dict</span><span class="p">[</span><span class="n">rd</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">metadata_list_dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metadata_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metadata_list_dict</span><span class="p">[</span><span class="n">ss</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing collection </span><span class="si">%s</span><span class="s1"> model </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="c1"># Check that model has metrics before we go on</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;training_metrics&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">collection_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
            <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
            <span class="n">model_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
            <span class="n">time_built</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;time_built&#39;</span><span class="p">]</span>
            <span class="n">time_built_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_built</span><span class="p">)</span>

            <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
            <span class="n">ampl_version</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">)</span>
            <span class="n">ampl_version_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ampl_version</span><span class="p">)</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
            <span class="n">model_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
            <span class="n">featurizer</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>
            <span class="n">featurizer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featurizer</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;descriptor_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
                <span class="n">desc_type</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;descriptor_specific&#39;</span><span class="p">][</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;graphconv&#39;</span><span class="p">,</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">]:</span>
                <span class="n">desc_type</span> <span class="o">=</span> <span class="n">featurizer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">desc_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">desc_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc_type</span><span class="p">)</span>
            <span class="n">dataset_key</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span>
            <span class="n">dataset_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">)</span>
            <span class="n">bucket_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
            <span class="n">dset_metadata</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;response_cols&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">transform_type</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">][</span><span class="s1">&#39;feature_transform_type&#39;</span><span class="p">]</span>
            <span class="n">transform_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform_type</span><span class="p">)</span>
            <span class="n">split_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">]</span>
            <span class="n">splitter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_params</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">])</span>
            <span class="n">split_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">split_strategy</span> <span class="o">=</span> <span class="n">split_params</span><span class="p">[</span><span class="s1">&#39;split_strategy&#39;</span><span class="p">]</span>
            <span class="n">split_strategy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_strategy</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;umap_specific&#39;</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
                <span class="n">umap_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;umap_specific&#39;</span><span class="p">]</span>
                <span class="n">umap_dim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_dim&#39;</span><span class="p">])</span>
                <span class="n">umap_targ_wt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_targ_wt&#39;</span><span class="p">])</span>
                <span class="n">umap_neighbors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_neighbors&#39;</span><span class="p">])</span>
                <span class="n">umap_min_dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">umap_params</span><span class="p">[</span><span class="s1">&#39;umap_min_dist&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">umap_dim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">umap_targ_wt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">umap_neighbors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">umap_min_dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">model_feat_param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extract_model_and_feature_parameters</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">))</span>

            <span class="c1"># Get model metrics for this model</span>
            <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">]</span>
            <span class="c1">#print(&quot;Got %d metrics dicts for model %s&quot; % (len(metrics_dicts), model_uuid))</span>
            <span class="n">subset_metrics</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
                    <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s1">&#39;k_fold_cv&#39;</span><span class="p">:</span>
                <span class="n">dset_size</span> <span class="o">=</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dset_size</span> <span class="o">=</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
                <span class="n">subset_size</span> <span class="o">=</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">score_types</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">score_type</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                    <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">score_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">ncmpd_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_size</span><span class="p">)</span>
            <span class="n">dset_size_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dset_size</span><span class="p">)</span>

    <span class="n">col_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">collection</span><span class="o">=</span><span class="n">collection_list</span><span class="p">,</span>
                    <span class="n">ampl_version</span><span class="o">=</span><span class="n">ampl_version_list</span><span class="p">,</span>
                    <span class="n">model_uuid</span><span class="o">=</span><span class="n">model_uuid_list</span><span class="p">,</span>
                    <span class="n">time_built</span><span class="o">=</span><span class="n">time_built_list</span><span class="p">,</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="n">model_type_list</span><span class="p">,</span>
                    <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer_list</span><span class="p">,</span>
                    <span class="n">features</span><span class="o">=</span><span class="n">desc_type_list</span><span class="p">,</span>
                    <span class="n">transformer</span><span class="o">=</span><span class="n">transform_list</span><span class="p">,</span>
                    <span class="n">splitter</span><span class="o">=</span><span class="n">splitter_list</span><span class="p">,</span>
                    <span class="n">split_strategy</span><span class="o">=</span><span class="n">split_strategy_list</span><span class="p">,</span>
                    <span class="n">split_uuid</span><span class="o">=</span><span class="n">split_uuid_list</span><span class="p">,</span>
                    <span class="n">umap_dim</span><span class="o">=</span><span class="n">umap_dim_list</span><span class="p">,</span>
                    <span class="n">umap_targ_wt</span><span class="o">=</span><span class="n">umap_targ_wt_list</span><span class="p">,</span>
                    <span class="n">umap_neighbors</span><span class="o">=</span><span class="n">umap_neighbors_list</span><span class="p">,</span>
                    <span class="n">umap_min_dist</span><span class="o">=</span><span class="n">umap_min_dist_list</span><span class="p">,</span>
                    <span class="n">dataset_bucket</span><span class="o">=</span><span class="n">bucket_list</span><span class="p">,</span>
                    <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key_list</span><span class="p">,</span>
                    <span class="n">dataset_size</span><span class="o">=</span><span class="n">dset_size_list</span><span class="p">,</span>
                    <span class="n">parameter</span><span class="o">=</span><span class="n">param_list</span>
                    <span class="p">)</span>


    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">col_dict</span><span class="p">)</span>

    <span class="n">param_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model_feat_param_list</span><span class="p">)</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">perf_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">param_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">ncmpds_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_size&#39;</span> <span class="o">%</span> <span class="n">subset</span>
        <span class="n">perf_df</span><span class="p">[</span><span class="n">ncmpds_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncmpd_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">score_types</span><span class="p">:</span>
            <span class="n">metric_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">score_type</span><span class="p">)</span>
            <span class="n">perf_df</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">score_type</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">perf_df</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_summary_metadata_table"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_summary_metadata_table">[docs]</a><span class="k">def</span> <span class="nf">get_summary_metadata_table</span><span class="p">(</span><span class="n">uuids</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tabulate metadata fields and performance metrics for a set of models identified by specific model_uuids.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuids (list): List of model UUIDs to query.</span>

<span class="sd">        collections (list or str): Names of collections in model tracker DB to get models from. If collections is</span>
<span class="sd">            a string, it must identify one collection to search for all models. If a list, it must be of the same</span>
<span class="sd">            length as `uuids`. If not provided, all collections will be searched.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of metadata fields and performance metrics for models.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uuids</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">uuids</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collections</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">collections</span> <span class="o">=</span> <span class="p">[</span><span class="n">collections</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuids</span><span class="p">)</span>

    <span class="n">mlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">uuid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uuids</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collections</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">collection_name</span> <span class="o">=</span> <span class="n">collections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">collection_name</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_model_collection_by_uuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">model_meta</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_full_metadata_by_uuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span>

        <span class="n">mdl_params</span>  <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
        <span class="n">data_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">]</span>
        <span class="c1"># Get model metrics for this model</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">])</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;best&#39;</span><span class="p">]</span>
        <span class="n">train_metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid_metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">test_metrics</span>  <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;test&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Try to name the model something intelligible in the table</span>
        <span class="n">name</span>  <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">in</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NA&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;assay_endpoint&#39;</span> <span class="ow">in</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;assay_endpoint&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NA&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;response_col&#39;</span> <span class="ow">in</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;response_col&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span>  <span class="o">!=</span> <span class="s1">&#39;NA&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>


        <span class="n">transform</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;transformation&#39;</span> <span class="ow">in</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;transformation&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">:</span>
            <span class="n">featurizer</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;descriptor_specific&#39;</span><span class="p">][</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">featurizer</span> <span class="o">=</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">split_uuid</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;split_uuid&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">split_uuid</span> <span class="o">=</span> <span class="s1">&#39;Not Available&#39;</span>

        <span class="k">if</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;prediction_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
                <span class="n">nn_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
                <span class="n">minfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;Transformation&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                         <span class="s1">&#39;AMPL version used:&#39;</span><span class="p">:</span> <span class="n">mdl_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;Model Type (Featurizer)&#39;</span><span class="p">:</span>    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span><span class="n">featurizer</span><span class="p">),</span>
                         <span class="s1">&#39;r^2 (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;MAE (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;RMSE(Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Data Size (Train/Valid/Test)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">test_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">]),</span>
                         <span class="s1">&#39;Splitter&#39;</span><span class="p">:</span>      <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;splitter&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Layer Sizes&#39;</span><span class="p">:</span>   <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Optimizer&#39;</span><span class="p">:</span>     <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;optimizer_type&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Learning Rate&#39;</span><span class="p">:</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Dropouts&#39;</span><span class="p">:</span>      <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Best Epoch (Max)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">],</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>    <span class="n">collection_name</span><span class="p">,</span>
                         <span class="s1">&#39;UUID&#39;</span><span class="p">:</span>          <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Split UUID&#39;</span><span class="p">:</span>    <span class="n">split_uuid</span><span class="p">,</span>
                         <span class="s1">&#39;Dataset Key&#39;</span><span class="p">:</span>   <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
                <span class="n">rf_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;rf_specific&#39;</span><span class="p">]</span>
                <span class="n">minfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;Transformation&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                         <span class="s1">&#39;AMPL version used:&#39;</span><span class="p">:</span> <span class="n">mdl_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;Model Type (Featurizer)&#39;</span><span class="p">:</span>    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span><span class="n">featurizer</span><span class="p">),</span>
                         <span class="s1">&#39;Max Depth&#39;</span><span class="p">:</span>    <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Max Features&#39;</span><span class="p">:</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;RF Estimators&#39;</span><span class="p">:</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;r^2 (Train/Valid/Test)&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;MAE (Train/Valid/Test)&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;RMSE(Train/Valid/Test)&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Data Size (Train/Valid/Test)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">test_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">]),</span>
                         <span class="s1">&#39;Splitter&#39;</span><span class="p">:</span>      <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;splitter&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>    <span class="n">collection_name</span><span class="p">,</span>
                         <span class="s1">&#39;UUID&#39;</span><span class="p">:</span>          <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Split UUID&#39;</span><span class="p">:</span>    <span class="n">split_uuid</span><span class="p">,</span>
                         <span class="s1">&#39;Dataset Key&#39;</span><span class="p">:</span>   <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
                <span class="n">xgb_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;xgb_specific&#39;</span><span class="p">]</span>
                <span class="n">minfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;Transformation&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                         <span class="s1">&#39;AMPL version used:&#39;</span><span class="p">:</span> <span class="n">mdl_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;Model Type (Featurizer)&#39;</span><span class="p">:</span>    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span><span class="n">featurizer</span><span class="p">),</span>
                         <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span>    <span class="n">xgb_params</span><span class="p">[</span><span class="s1">&#39;xgb_gamma&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Learning rate&#39;</span><span class="p">:</span> <span class="n">xgb_params</span><span class="p">[</span><span class="s1">&#39;xgb_max_depth&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;r^2 (Train/Valid/Test)&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;MAE (Train/Valid/Test)&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;mae_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;RMSE(Train/Valid/Test)&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Data Size (Train/Valid/Test)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">test_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">]),</span>
                         <span class="s1">&#39;Splitter&#39;</span><span class="p">:</span>      <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;splitter&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>    <span class="n">collection_name</span><span class="p">,</span>
                         <span class="s1">&#39;UUID&#39;</span><span class="p">:</span>          <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Split UUID&#39;</span><span class="p">:</span>    <span class="n">split_uuid</span><span class="p">,</span>
                         <span class="s1">&#39;Dataset Key&#39;</span><span class="p">:</span>   <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">elif</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;prediction_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
                <span class="n">nn_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
                <span class="n">minfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;Transformation&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                         <span class="s1">&#39;AMPL version used:&#39;</span><span class="p">:</span> <span class="n">mdl_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;Model Type (Featurizer)&#39;</span><span class="p">:</span>    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span><span class="n">featurizer</span><span class="p">),</span>
                         <span class="s1">&#39;ROC AUC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;PRC AUC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Balanced accuracy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">valid_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">test_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
                         <span class="s1">&#39;Accuracy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Precision (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Recall (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;NPV (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Kappa (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Matthews CC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Cross entropy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Confusion matrices (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="s1">&#39;Data Size (Train/Valid/Test)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">test_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">]),</span>
                         <span class="s1">&#39;Splitter&#39;</span><span class="p">:</span>      <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;splitter&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Layer Sizes&#39;</span><span class="p">:</span>   <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Optimizer&#39;</span><span class="p">:</span>     <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;optimizer_type&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Learning Rate&#39;</span><span class="p">:</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Dropouts&#39;</span><span class="p">:</span>      <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Best Epoch (Max)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">],</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>    <span class="n">collection_name</span><span class="p">,</span>
                         <span class="s1">&#39;UUID&#39;</span><span class="p">:</span>          <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Split UUID&#39;</span><span class="p">:</span>    <span class="n">split_uuid</span><span class="p">,</span>
                         <span class="s1">&#39;Dataset Key&#39;</span><span class="p">:</span>   <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
                <span class="n">rf_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;rf_specific&#39;</span><span class="p">]</span>
                <span class="n">minfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;Transformation&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                         <span class="s1">&#39;AMPL version used:&#39;</span><span class="p">:</span> <span class="n">mdl_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;Model Type (Featurizer)&#39;</span><span class="p">:</span>    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span><span class="n">featurizer</span><span class="p">),</span>
                         <span class="s1">&#39;Max Depth&#39;</span><span class="p">:</span>    <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Max Features&#39;</span><span class="p">:</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_max_depth&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;RF Estimators&#39;</span><span class="p">:</span> <span class="n">rf_params</span><span class="p">[</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;ROC AUC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;PRC AUC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Balanced accuracy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">valid_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">test_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
                         <span class="s1">&#39;Accuracy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Precision (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Recall (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;NPV (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Kappa (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Matthews CC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Cross entropy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Confusion matrices (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="s1">&#39;Data Size (Train/Valid/Test)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">test_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">]),</span>
                         <span class="s1">&#39;Splitter&#39;</span><span class="p">:</span>      <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;splitter&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>    <span class="n">collection_name</span><span class="p">,</span>
                         <span class="s1">&#39;UUID&#39;</span><span class="p">:</span>          <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Split UUID&#39;</span><span class="p">:</span>    <span class="n">split_uuid</span><span class="p">,</span>
                         <span class="s1">&#39;Dataset Key&#39;</span><span class="p">:</span>   <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
                <span class="n">xgb_params</span> <span class="o">=</span> <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;xgb_specific&#39;</span><span class="p">]</span>
                <span class="n">minfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;Transformation&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                         <span class="s1">&#39;AMPL version used:&#39;</span><span class="p">:</span> <span class="n">mdl_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span> <span class="s1">&#39;probably 1.0.0&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;Model Type (Featurizer)&#39;</span><span class="p">:</span>    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdl_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span><span class="n">featurizer</span><span class="p">),</span>
                         <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span>    <span class="n">xgb_params</span><span class="p">[</span><span class="s1">&#39;xgb_gamma&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;XGB Learning rate&#39;</span><span class="p">:</span> <span class="n">xgb_params</span><span class="p">[</span><span class="s1">&#39;xgb_max_depth&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;ROC AUC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;PRC AUC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;prc_auc_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Balanced accuracy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">valid_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">test_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
                         <span class="s1">&#39;Accuracy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Precision (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Recall (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;recall_score&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;NPV (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;npv&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Kappa (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Matthews CC (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;matthews_cc&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Cross entropy (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">/</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">],</span> <span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;cross_entropy&#39;</span><span class="p">]),</span>
                         <span class="s1">&#39;Confusion matrices (Train/Valid/Test)&#39;</span><span class="p">:</span>     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">train_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="s1">&#39;Data Size (Train/Valid/Test)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">valid_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">],</span><span class="n">test_metrics</span><span class="p">[</span><span class="s2">&quot;num_compounds&quot;</span><span class="p">]),</span>
                         <span class="s1">&#39;Splitter&#39;</span><span class="p">:</span>      <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;splitting_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;splitter&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>    <span class="n">collection_name</span><span class="p">,</span>
                         <span class="s1">&#39;UUID&#39;</span><span class="p">:</span>          <span class="n">model_meta</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;Split UUID&#39;</span><span class="p">:</span>    <span class="n">split_uuid</span><span class="p">,</span>
                         <span class="s1">&#39;Dataset Key&#39;</span><span class="p">:</span>   <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>

        <span class="n">mlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">minfo</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_training_datasets"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_training_datasets">[docs]</a><span class="k">def</span> <span class="nf">get_training_datasets</span><span class="p">(</span><span class="n">collection_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query the model tracker DB for all the unique dataset keys and buckets used to train models in the given</span>
<span class="sd">    collections.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_names (list): List of names of model tracker collections to search for models.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary mapping collection names to lists of (dataset_key, bucket) tuples for training sets.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collection_names</span><span class="p">:</span>
        <span class="n">dset_list</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_training_datasets</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_list</span>

    <span class="k">return</span> <span class="n">result_dict</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_dataset_models"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_dataset_models">[docs]</a><span class="k">def</span> <span class="nf">get_dataset_models</span><span class="p">(</span><span class="n">collection_names</span><span class="p">,</span> <span class="n">filter_dict</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query the model tracker for all models saved in the model tracker DB under the given collection names. Returns a dictionary</span>
<span class="sd">    mapping (dataset_key,bucket) pairs to the list of (collection,model_uuid) pairs trained on the corresponding datasets.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_names (list): List of names of model tracker collections to search for models.</span>

<span class="sd">        filter_dict (dict): Additional filter criteria to use in model query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary mapping training set (dataset_key, bucket) tuples to (collection, model_uuid) pairs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="n">coll_dset_dict</span> <span class="o">=</span> <span class="n">get_training_dict</span><span class="p">(</span><span class="n">collection_names</span><span class="p">)</span>

    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collection_names</span><span class="p">:</span>
        <span class="n">dset_list</span> <span class="o">=</span> <span class="n">coll_dset_dict</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dset_dict</span> <span class="ow">in</span> <span class="n">dset_list</span><span class="p">:</span>
            <span class="n">query_filter</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;training_dataset.bucket&#39;</span><span class="p">:</span> <span class="n">dset_dict</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">],</span>
                <span class="s1">&#39;training_dataset.dataset_key&#39;</span><span class="p">:</span> <span class="n">dset_dict</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">query_filter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
            <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;match_metadata&quot;</span><span class="p">:</span> <span class="n">query_filter</span>
            <span class="p">}</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Querying models in collection </span><span class="si">%s</span><span class="s1"> for dataset </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">dset_key</span><span class="p">))</span>
            <span class="n">metadata_list</span> <span class="o">=</span> <span class="n">mlmt_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query_model_metadata</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
                <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">,</span>
                <span class="n">include_fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metadata_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing collection </span><span class="si">%s</span><span class="s1"> model </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
                <span class="n">result_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">dset_key</span><span class="p">,</span><span class="n">bucket</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result_dict</span></div>

<span class="c1">#-------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_multitask_perf_from_files"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_multitask_perf_from_files">[docs]</a><span class="k">def</span> <span class="nf">get_multitask_perf_from_files</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve model metadata and performance metrics stored in the filesystem from a multitask hyperparameter search.</span>
<span class="sd">    Format the per-task performance metrics in a table with a row for each task and columns for each model/subset</span>
<span class="sd">    combination.</span>

<span class="sd">    Args:</span>
<span class="sd">        result_dir (str): Path to root result directory containing output from a hyperparameter search run.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of model metadata fields and performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">learning_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dropouts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layer_sizes_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_epoch_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_epochs_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;r2_score&#39;</span><span class="p">,</span> <span class="s1">&#39;task_r2_scores&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;task_roc_auc_scores&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="c1"># Navigate the results directory tree</span>
    <span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;model_metadata.json&#39;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;model_metrics.json&#39;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">):</span>
            <span class="n">meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_fp</span><span class="p">:</span>
                <span class="n">meta_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_fp</span><span class="p">)</span>
            <span class="n">model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">)</span>
            <span class="n">metrics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metrics.json&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metrics_fp</span><span class="p">:</span>
                <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">metrics_fp</span><span class="p">)</span>
            <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found data for </span><span class="si">%d</span><span class="s2"> models under </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">),</span> <span class="n">result_dir</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">metadata_dict</span><span class="p">,</span> <span class="n">metrics_dicts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">):</span>
        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
        <span class="c1">#print(&quot;Got metadata for model UUID %s&quot; % model_uuid)</span>

        <span class="c1"># Get list of training run metrics for this model</span>
        <span class="c1">#print(&quot;Got %d metrics dicts for model %s&quot; % (len(metrics_dicts), model_uuid))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Got no or incomplete metrics for model </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
            <span class="c1">#print(&quot;Got no or incomplete metrics for model %s, skipping...&quot; % model_uuid)</span>
            <span class="c1">#continue</span>
        <span class="n">subset_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
                <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span>

        <span class="n">model_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
        <span class="n">dset_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">]</span>
        <span class="n">response_cols</span> <span class="o">=</span> <span class="n">dset_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span>
        <span class="n">nn_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
        <span class="n">max_epochs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">])</span>
        <span class="n">best_epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">])</span>
        <span class="n">learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span>
        <span class="n">layer_sizes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]]))</span>
        <span class="n">dropouts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">]]))</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>


    <span class="c1"># Format the data as a table with groups of 3 columns for each model</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_uuid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;dropouts&#39;</span><span class="p">,</span> <span class="s1">&#39;max_epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;best_epoch&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;subset&#39;</span><span class="p">,</span> <span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_r2_score&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;dropouts&#39;</span><span class="p">,</span> <span class="s1">&#39;max_epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;best_epoch&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;subset&#39;</span><span class="p">,</span> <span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_roc_auc_score&#39;</span><span class="p">]</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="n">model_params</span> <span class="o">+</span> <span class="n">response_cols</span>
    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">col_0</span><span class="o">=</span><span class="n">param_list</span><span class="p">))</span>
    <span class="n">colnum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">learning_rate_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_sizes_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dropouts_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">max_epochs_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">best_epoch_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s1">&#39;r2_score&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s1">&#39;task_r2_scores&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s1">&#39;roc_auc_score&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s1">&#39;task_roc_auc_scores&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">colnum</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="s1">&#39;col_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">colnum</span>
            <span class="n">perf_df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

    <span class="k">return</span> <span class="n">perf_df</span></div>


<span class="c1">#-------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_multitask_perf_from_files_new"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_multitask_perf_from_files_new">[docs]</a><span class="k">def</span> <span class="nf">get_multitask_perf_from_files_new</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve model metadata and performance metrics stored in the filesystem from a multitask hyperparameter search.</span>
<span class="sd">    Format the per-task performance metrics in a table with a row for each task and columns for each model/subset</span>
<span class="sd">    combination.</span>

<span class="sd">    Args:</span>
<span class="sd">        result_dir (str): Path to root result directory containing output from a hyperparameter search run.</span>

<span class="sd">        pred_type (str): Prediction type (&#39;classification&#39; or &#39;regression&#39;) of models to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of model metadata fields and performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">learning_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dropouts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layer_sizes_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_epoch_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_epochs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">featurizer_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;r2_score&#39;</span><span class="p">,</span> <span class="s1">&#39;task_r2_scores&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;task_rms_scores&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num_compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span> <span class="s1">&#39;task_roc_auc_scores&#39;</span><span class="p">]</span>
    <span class="n">score_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="c1"># Navigate the results directory tree</span>
    <span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;model_metadata.json&#39;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;model_metrics.json&#39;</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_fp</span><span class="p">:</span>
                    <span class="n">meta_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_fp</span><span class="p">)</span>
                <span class="n">model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">)</span>
                <span class="n">metrics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;model_metrics.json&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metrics_fp</span><span class="p">:</span>
                    <span class="n">metrics_dicts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">metrics_fp</span><span class="p">)</span>
                <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot access model </span><span class="si">{</span><span class="n">dirpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found data for </span><span class="si">%d</span><span class="s2"> models under </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">),</span> <span class="n">result_dir</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">metadata_dict</span><span class="p">,</span> <span class="n">metrics_dicts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">):</span>
        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span>
        <span class="c1">#print(&quot;Got metadata for model UUID %s&quot; % model_uuid)</span>

        <span class="c1"># Get list of training run metrics for this model</span>
        <span class="c1">#print(&quot;Got %d metrics dicts for model %s&quot; % (len(metrics_dicts), model_uuid))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dicts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Got no or incomplete metrics for model </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">model_uuid</span><span class="p">)</span>
            <span class="c1">#print(&quot;Got no or incomplete metrics for model %s, skipping...&quot; % model_uuid)</span>
            <span class="c1">#continue</span>
        <span class="n">subset_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metrics_dict</span> <span class="ow">in</span> <span class="n">metrics_dicts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;subset&#39;</span><span class="p">]</span>
                <span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span>

        <span class="n">model_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span>
        <span class="n">dset_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;training_dataset&#39;</span><span class="p">]</span>
        <span class="n">response_cols</span> <span class="o">=</span> <span class="n">dset_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span>
        <span class="n">nn_params</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span>
        <span class="n">max_epochs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">])</span>
        <span class="n">best_epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">])</span>
        <span class="n">learning_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span>
        <span class="n">layer_sizes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]]))</span>
        <span class="n">dropouts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nn_params</span><span class="p">[</span><span class="s1">&#39;dropouts&#39;</span><span class="p">]]))</span>
        <span class="n">featurizer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;featurizer&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_metrics</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>


    <span class="c1"># Format the data as a table with groups of 3 columns for each model</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_uuid_list</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_uuid&quot;</span><span class="p">:</span> <span class="n">model_uuid_list</span><span class="p">,</span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">learning_rate_list</span><span class="p">,</span>
        <span class="s2">&quot;layer_sizes&quot;</span><span class="p">:</span> <span class="n">layer_sizes_list</span><span class="p">,</span>
        <span class="s2">&quot;dropouts&quot;</span><span class="p">:</span> <span class="n">dropouts_list</span><span class="p">,</span>
        <span class="s2">&quot;featurizer&quot;</span><span class="p">:</span> <span class="n">featurizer_list</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response_cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                    <span class="n">colr2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">_r2&quot;</span>
                    <span class="n">colrms</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">_rms&quot;</span>
                    <span class="k">if</span> <span class="n">colr2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">colr2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">colrms</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">colr2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;task_r2_scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">ix</span><span class="p">])</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">colrms</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;task_rms_scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">ix</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colauc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">_roc_auc&quot;</span>
                    <span class="k">if</span> <span class="n">colauc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">colauc</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">colauc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;task_roc_auc_scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">ix</span><span class="p">])</span>

    <span class="n">perf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">perf_df</span></div>


<span class="c1">#-------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_multitask_perf_from_tracker"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.get_multitask_perf_from_tracker">[docs]</a><span class="k">def</span> <span class="nf">get_multitask_perf_from_tracker</span><span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">response_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expand_responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expand_subsets</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                    <span class="n">exhaustive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve full metadata and metrics from model tracker for all models in a collection and format them</span>
<span class="sd">    into a table, including per-task performance metrics for multitask models.</span>

<span class="sd">    Meant for multitask NN models, but works for single task models as well.</span>

<span class="sd">    By AKP. Works for model tracker as of 10/2020</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_name (str): Name of model tracker collection to search for models.</span>

<span class="sd">        response_cols (list, str or None): Names of tasks (response columns) to query performance results for.</span>
<span class="sd">            If None, checks to see if the entire collection has the same response cols.</span>
<span class="sd">            Otherwise, should be list of strings or a comma-separated string.</span>
<span class="sd">            asks for clarification. Note: make sure response cols are listed in same order as in metadata.</span>
<span class="sd">            Recommended: None first, then clarify.</span>

<span class="sd">        expand_responses (list, str or None): Names of tasks / response columns you want to include results for in</span>
<span class="sd">            the final dataframe. Useful if you have a lot of tasks and only want to look at the performance of a</span>
<span class="sd">            few of them. Must also be a list or comma separated string, and must be a subset of response_cols.</span>
<span class="sd">            If None, will expand all responses.</span>

<span class="sd">        expand_subsets (list, str or None): Dataset subsets (&#39;train&#39;, &#39;valid&#39; and/or &#39;test&#39;) to show metrics for.</span>
<span class="sd">            Again, must be list or comma separated string, or None to expand all.</span>

<span class="sd">        exhaustive (bool): If True, return large dataframe with all model tracker metadata minus any columns not</span>
<span class="sd">            in expand_responses. If False, return trimmed dataframe with most relevant columns.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Table of model metadata fields and performance metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># check inputs are correct</span>
    <span class="k">if</span> <span class="n">collection_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;old_&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This function is not implemented for the old format of metadata.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">response_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">response_cols</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">response_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please input response cols as None, list or comma separated string.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_responses</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">expand_responses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_responses</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">expand_responses</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expand_responses</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please input expand response col(s) as list or comma separated string.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_subsets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">expand_subsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_subsets</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">expand_subsets</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expand_subsets</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please input subset(s) as list or comma separated string.&quot;</span><span class="p">)</span>

    <span class="c1"># get metadata</span>
    <span class="k">if</span> <span class="n">response_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;training_dataset.response_cols&#39;</span><span class="p">:</span> <span class="n">response_cols</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_dict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">trkr</span><span class="o">.</span><span class="n">get_full_metadata</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No models found with these response cols in this collection. To get a list of possible response cols, pass response_cols=None.&quot;</span><span class="p">)</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

    <span class="c1"># expand model metadata - deal with NA descriptors / NA other fields</span>
    <span class="n">alldat</span><span class="o">=</span><span class="n">models</span><span class="p">[[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;time_built&#39;</span><span class="p">]]</span>
    <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;time_built&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;training_metrics&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">nai</span><span class="o">=</span><span class="n">models</span><span class="p">[</span><span class="n">models</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">nonas</span><span class="o">=</span><span class="n">models</span><span class="p">[</span><span class="o">~</span><span class="n">models</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">nonas</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tempdf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nai</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tempdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
        <span class="n">alldat</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdf</span><span class="p">)</span>

    <span class="c1"># assign response cols</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alldat</span><span class="o">.</span><span class="n">response_cols</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">response_cols</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">response_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Response cols:&quot;</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There is more than one set of response cols in this collection. Please choose from these lists: </span><span class="si">{</span><span class="n">alldat</span><span class="o">.</span><span class="n">response_cols</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># expand training metrics - deal with NA&#39;s in columns</span>
    <span class="n">metrics</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;training_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">allmet</span><span class="o">=</span><span class="n">alldat</span><span class="p">[[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">nai</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">nonas</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="o">~</span><span class="n">metrics</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">nonas</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tempdf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nai</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tempdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
        <span class="n">label</span><span class="o">=</span><span class="n">tempdf</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">metrics_type</span><span class="o">=</span><span class="n">tempdf</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;metrics_type&#39;</span><span class="p">][</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">subset</span><span class="o">=</span><span class="n">tempdf</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;subset&#39;</span><span class="p">][</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">nai</span><span class="o">=</span><span class="n">tempdf</span><span class="p">[</span><span class="n">tempdf</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">nonas</span><span class="o">=</span><span class="n">tempdf</span><span class="p">[</span><span class="o">~</span><span class="n">tempdf</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">nonas</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;prediction_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tempdf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nai</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tempdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
        <span class="n">tempdf</span><span class="o">=</span><span class="n">tempdf</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s1">_&#39;</span><span class="p">)</span>
        <span class="n">allmet</span><span class="o">=</span><span class="n">allmet</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdf</span><span class="p">,</span> <span class="n">lsuffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;_2&quot;</span><span class="p">)</span>
    <span class="n">alldat</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">allmet</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">)</span>

    <span class="c1"># expand task level training metrics for subset(s) of interest - deal w/ NA values</span>
    <span class="k">if</span> <span class="n">expand_subsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expand_subsets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">expand_subsets</span><span class="p">:</span>
        <span class="n">listcols</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sub</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">listcols</span><span class="p">:</span>
            <span class="n">colnameslist</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">response_cols</span><span class="p">:</span>
                <span class="n">colnameslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">nai</span><span class="o">=</span><span class="n">alldat</span><span class="p">[</span><span class="n">alldat</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">nonas</span><span class="o">=</span><span class="n">alldat</span><span class="p">[</span><span class="o">~</span><span class="n">alldat</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nonas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">column</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">nonas</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span> <span class="n">nonas</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">colnameslist</span><span class="p">)</span>
                <span class="n">tempdf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tempdf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nai</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tempdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
                <span class="n">alldat</span> <span class="o">=</span> <span class="n">alldat</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdf</span><span class="p">)</span>
                <span class="n">alldat</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: task-level metadata for </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> not in metadata.&quot;</span><span class="p">)</span>

    <span class="c1"># make features column</span>
    <span class="n">alldat</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alldat</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;descriptor_type&#39;</span> <span class="ow">in</span> <span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">alldat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alldat</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alldat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alldat</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">,</span> <span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span>

    <span class="c1"># prune to only include expand_responses</span>
    <span class="k">if</span> <span class="n">expand_responses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">removecols</span><span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">response_cols</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expand_responses</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">removecols</span><span class="p">:</span>
            <span class="n">alldat</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">col</span><span class="p">)])</span>

    <span class="c1"># return or prune further and then return</span>
    <span class="k">if</span> <span class="n">exhaustive</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alldat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alldat</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;baseline&#39;</span><span class="p">)])</span>
        <span class="n">keepcols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ampl_version&#39;</span><span class="p">,</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction_type&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;transformers&#39;</span><span class="p">,</span> <span class="s1">&#39;uncertainty&#39;</span><span class="p">,</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="s1">&#39;bias_init_consts&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dropouts&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;max_epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;optimizer_type&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;weight_decay_penalty&#39;</span><span class="p">,</span> <span class="s1">&#39;weight_decay_penalty_type&#39;</span><span class="p">,</span> <span class="s1">&#39;weight_init_stddevs&#39;</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;split_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;split_test_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;split_valid_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;smiles_col&#39;</span><span class="p">,</span> <span class="s1">&#39;id_col&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;feature_transform_type&#39;</span><span class="p">,</span> <span class="s1">&#39;response_cols&#39;</span><span class="p">,</span> <span class="s1">&#39;response_transform_type&#39;</span><span class="p">,</span> <span class="s1">&#39;num_model_tasks&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;rf_estimators&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_features&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">]</span>
        <span class="n">keepcols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;best&#39;</span><span class="p">)])</span>
        <span class="n">keepcols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">keepcols</span><span class="p">))</span>
        <span class="n">keepcols</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">alldat</span><span class="o">=</span><span class="n">alldat</span><span class="p">[</span><span class="n">keepcols</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">alldat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;_2&#39;</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: One or more of your models has metadata for &gt;1 best / &gt;1 baseline epochs.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">alldat</span></div>



<span class="c1">#-------------------------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_aggregate_predictions</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">result_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run predictions for best dataset/model_type/split_type/featurizer (max r2 score) and save csv&#39;s in /usr/local/data/</span>

<span class="sd">    DEPRECATED: Will not work in current software environment. Needs to be updated</span>

<span class="sd">    Args:</span>
<span class="sd">        datasets (list): List of (dataset_key, bucket) tuples to query models for.</span>

<span class="sd">        bucket (str): Ignored.</span>

<span class="sd">       col_names (list): List of names of model tracker collections to search for models.</span>

<span class="sd">       result_dir (str): Ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    Todo:</span>
<span class="sd">        Update for current software environment, or delete function if it&#39;s not useful.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlmt_supported</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model tracker not supported in your environment; can examine models saved in filesystem only.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">initialize_model_tracker</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">dset_key</span><span class="p">,</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="s1">&#39;RF&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">split_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scaffold&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">descriptor_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mordred_filtered&#39;</span><span class="p">,</span> <span class="s1">&#39;moe&#39;</span><span class="p">,</span> <span class="s1">&#39;rdkit_raw&#39;</span><span class="p">]:</span>
                    <span class="n">model_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;training_dataset.dataset_key&quot;</span> <span class="p">:</span> <span class="n">dset_key</span><span class="p">,</span>
                                    <span class="s2">&quot;training_dataset.bucket&quot;</span> <span class="p">:</span> <span class="n">bucket</span><span class="p">,</span>
                                    <span class="s2">&quot;ModelMetrics.TrainingRun.label&quot;</span> <span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
                                    <span class="s1">&#39;ModelMetrics.TrainingRun.subset&#39;</span><span class="p">:</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;ModelMetrics.TrainingRun.PredictionResults.r2_score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                                    <span class="s1">&#39;model_parameters.model_type&#39;</span><span class="p">:</span> <span class="n">model_type</span><span class="p">,</span>
                                    <span class="s1">&#39;model_parameters.featurizer&#39;</span><span class="p">:</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;descriptor_specific.descriptor_type&#39;</span><span class="p">:</span> <span class="n">descriptor_type</span><span class="p">,</span>
                                    <span class="s1">&#39;splitting_parameters.splitter&#39;</span><span class="p">:</span> <span class="n">split_type</span>
                                   <span class="p">}</span>
                    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trkr</span><span class="o">.</span><span class="n">get_full_metadata</span><span class="p">(</span><span class="n">model_filter</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">result_dir</span> <span class="o">=</span> <span class="s1">&#39;/usr/local/data/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">dset_key</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">))</span>
                            <span class="n">result_df</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">regenerate_results</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">metadata_dict</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;dset_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_key</span>
                            <span class="n">actual_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;actual&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">pred_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;pred&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="n">actual_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="n">pred_col</span><span class="p">])</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;cind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;dset_key&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">labels</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
                    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="s1">&#39;predictions_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dset_key</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">split_type</span><span class="p">,</span> <span class="n">descriptor_type</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;graphconv&#39;</span><span class="p">,</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">]:</span>
                    <span class="n">model_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;training_dataset.dataset_key&quot;</span> <span class="p">:</span> <span class="n">dset_key</span><span class="p">,</span>
                                    <span class="s2">&quot;training_dataset.bucket&quot;</span> <span class="p">:</span> <span class="n">bucket</span><span class="p">,</span>
                                    <span class="s2">&quot;ModelMetrics.TrainingRun.label&quot;</span> <span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
                                    <span class="s1">&#39;ModelMetrics.TrainingRun.subset&#39;</span><span class="p">:</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;ModelMetrics.TrainingRun.PredictionResults.r2_score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                                    <span class="s1">&#39;model_parameters.model_type&#39;</span><span class="p">:</span> <span class="n">model_type</span><span class="p">,</span>
                                    <span class="s1">&#39;model_parameters.featurizer&#39;</span><span class="p">:</span> <span class="n">featurizer</span><span class="p">,</span>
                                    <span class="s1">&#39;splitting_parameters.splitter&#39;</span><span class="p">:</span> <span class="n">split_type</span>
                                   <span class="p">}</span>
                    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trkr</span><span class="o">.</span><span class="n">get_full_metadata</span><span class="p">(</span><span class="n">model_filter</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">col_name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">result_dir</span> <span class="o">=</span> <span class="s1">&#39;/usr/local/data/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">dset_key</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">))</span>
                            <span class="n">result_df</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">regenerate_results</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="n">metadata_dict</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;dset_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_key</span>
                            <span class="n">actual_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;actual&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">pred_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;pred&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="n">actual_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="n">pred_col</span><span class="p">])</span>
                            <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;cind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;dset_key&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">labels</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
                    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="s1">&#39;predictions_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dset_key</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">split_type</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="num_trainable_parameters_from_file"><a class="viewcode-back" href="../../pipeline.html#pipeline.compare_models.num_trainable_parameters_from_file">[docs]</a><span class="k">def</span> <span class="nf">num_trainable_parameters_from_file</span><span class="p">(</span><span class="n">tar_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return number of trainable paramters from tarfile</span>

<span class="sd">    Given a tar file for a DeepChem model this will return the number of trainable parameters</span>

<span class="sd">    Args:</span>
<span class="sd">        tar_path (str): Path to a DeepChem model</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of trainable parameters.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the model is not a DeepChem neural network model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reload_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="n">futils</span><span class="o">.</span><span class="n">safe_extract</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">reload_dir</span><span class="p">)</span>

    <span class="n">config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">,</span> <span class="s1">&#39;model_metadata.json&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># Parse the saved model metadata to obtain the parameters used to train the model</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Is this an NN model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span> <span class="ow">or</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="n">parse</span><span class="o">.</span><span class="n">model_wl</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Saved model is not a neural network. Recieved </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">model_params</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span>

    <span class="n">model_params</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model_params</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">reload_dir</span>

    <span class="c1"># some models need to be &#39;built&#39; (graphconv models for one) </span>
    <span class="c1"># before you can count the paramters</span>
    <span class="c1"># The only sure way to do this with DeepChem is to make some predictions.</span>
    <span class="c1"># This code is adapted from predict_from_model</span>
    <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">model_params</span><span class="o">.</span><span class="n">id_col</span><span class="p">:[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span>
        <span class="n">model_params</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">:[</span><span class="s1">&#39;OC(CCN1CCCCC1)(c1ccccc1)C1CC2C=CC1C2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;COC(=O)CC1CCCCCC1N1CCN(C(=O)C(C)Cc2ccc(Cl)cc2Cl)CC1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;O=C(O)c1ccc2cccnc2c1N1CCN(CCc2ccc(OCCCN3CCCCCC3)cc2)CC1&#39;</span><span class="p">]})</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">create_prediction_pipeline_from_file</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> 
        <span class="n">reload_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="n">tar_path</span><span class="p">)</span>
    <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_full_dataset</span><span class="p">(</span><span class="n">pred_df</span><span class="p">,</span> <span class="n">contains_responses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                        <span class="n">is_featurized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">dset_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pipe</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">count_params</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ATOM DDM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>