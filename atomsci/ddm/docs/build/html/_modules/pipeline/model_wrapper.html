

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pipeline.model_wrapper &mdash; ATOM Data-Driven Modeling Pipeline 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ATOM Data-Driven Modeling Pipeline
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pipeline.model_wrapper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pipeline.model_wrapper</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains class ModelWrapper and its subclasses, which are wrappers for DeepChem and scikit-learn model classes.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">import</span> <span class="nn">deepchem</span> <span class="k">as</span> <span class="nn">dc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">deepchem.models.tensorgraph</span> <span class="k">import</span> <span class="n">fcnet</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestRegressor</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
    <span class="n">xgboost_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">xgboost_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="k">import</span> <span class="n">datastore_functions</span> <span class="k">as</span> <span class="n">dsf</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="k">import</span> <span class="n">transformations</span> <span class="k">as</span> <span class="n">trans</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="k">import</span> <span class="n">perf_data</span> <span class="k">as</span> <span class="n">perf</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="create_model_wrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.create_model_wrapper">[docs]</a><span class="k">def</span> <span class="nf">create_model_wrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Factory function for creating Model objects of the correct subclass for params.model_type.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (Namespace) : Parameters passed to the model pipeline</span>
<span class="sd">        featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">        ds_client (DatastoreClient): Interface to the file datastore</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (pipeline.Model): Wrapper for DeepChem, sklearn or other model.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Only params.model_type = &#39;NN&#39;, &#39;RF&#39; or &#39;xgboost&#39; is supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DCNNModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DCRFModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xgboost_supported</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;xgboost package needs to be installed to use xgboost model.&quot;</span><span class="p">)</span>
<span class="c1">#         elif float(xgb.__version__) &lt; 0.9:</span>
<span class="c1">#             raise Exception(&quot;Need to update the xgboost to 0.9 for GPU support: pip3 install xgboost \</span>
<span class="c1">#                             livermore compute: /usr/mic/bio/anaconda3/bin/pip install --upgrade xgboost --user \</span>
<span class="c1">#                             TTB:/opt/conda/bin/pip install --upgrade xgboost --user/&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DCxgboostModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown model_type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span></div>

<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">ModelWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for DeepChem and sklearn model objects. Provides methods to train and test a model,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">        Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>

<span class="sd">        set in setup_model_dirs:</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            baseline_model_dir (str): The subdirectory under output_dir that contains the baseline epoch model. Created in setup_model_dirs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes ModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>
<span class="sd">            featurizer (Featurization object): initialized outside of model_wrapper</span>
<span class="sd">            ds_client (DatastoreClient): Interface to the file datastore</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of ModelWrapper:</span>
<span class="sd">                params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">                featurziation (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">                log (log): The logger</span>
<span class="sd">                output_dir (str): The parent path of the model directory</span>
<span class="sd">                transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">                transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="n">featurizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="o">=</span> <span class="n">ds_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.setup_model_dirs"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.setup_model_dirs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_model_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up paths and directories for persisting models at particular training epochs, used by</span>
<span class="sd">        the DeepChem model classes.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of ModelWrapper:</span>
<span class="sd">                best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">                baseline_model_dir (str): The subdirectory under output_dir that contains the baseline epoch model.</span>
<span class="sd">                    Created in setup_model_dirs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;baseline_epoch_model&#39;</span><span class="p">)</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trains a model (for multiple epochs if applicable), and saves the tuned model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: The method is implemented by subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to the model type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: The method is implemented by subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.create_transformers"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.create_transformers">[docs]</a>    <span class="k">def</span> <span class="nf">create_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize transformers for responses and/or features, and persist them for later.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset: The ModelDataset object that handles the current dataset</span>

<span class="sd">        Side effects</span>
<span class="sd">            Overwrites the attributes:</span>
<span class="sd">                transformers: A list of deepchem transformation objects on response_col, only if conditions are met</span>
<span class="sd">                transformers_x: A list of deepchem trasformation objects on featurizers, only if conditions are met.</span>
<span class="sd">                params.transformer_key: A string pointing to the dataset key containing the transformer in the datastore, or the path to the transformer</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Just a warning, we may have response transformers for classification datasets in the future</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="o">==</span><span class="s1">&#39;regression&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformer</span><span class="p">(</span><span class="n">transform_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="p">)]</span>

        <span class="c1"># Set up transformers for features, if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">create_feature_transformers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
                <span class="c1"># Save tuple of response and feature transformer lists in datastore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span> <span class="o">=</span> <span class="s1">&#39;transformers_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fileupload</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">upload_pickle_to_DS</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">),</span>
                                    <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">,</span>
                                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">),</span>
                                    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Saved transformers for dataset </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                                    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Saved transformers for dataset </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                                    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;transformers&#39;</span><span class="p">,</span> <span class="s1">&#39;pickled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">],</span>
                                    <span class="n">key_values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_category&#39;</span><span class="p">:</span> <span class="s1">&#39;transformers&#39;</span><span class="p">},</span>
                                    <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span><span class="p">,</span>
                                    <span class="n">dataset_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span>
                                    <span class="n">override_check</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_oid</span> <span class="o">=</span> <span class="n">fileupload</span><span class="p">[</span><span class="s1">&#39;dataset_oid&#39;</span><span class="p">]</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error when trying to save transformers to datastore:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;transformers.pkl&#39;</span><span class="p">)</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote transformers to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.transform_dataset"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.transform_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">transform_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the responses and/or features in the given DeepChem dataset using the current transformers.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: The DeepChem DiskDataset that contains a dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            transformed_dataset: The trasformed DeepChem DiskDataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming response data&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
                <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming feature data&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">:</span>
                <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transformed_dataset</span></div>
        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.get_num_features"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_num_features">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of dimensions of the feature space, taking both featurization method</span>
<span class="sd">        and transformers into account.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">feature_transform_type</span> <span class="o">==</span> <span class="s1">&#39;umap&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">umap_dim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="o">.</span><span class="n">get_feature_count</span><span class="p">()</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.get_train_valid_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_train_valid_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics for the current training or validation set,</span>
<span class="sd">        based on the information stored in perf_data, which is a model_wrapper.PerfData object.</span>
<span class="sd">        The intent is preserve the predictions and metrics from the initial training and</span>
<span class="sd">        validation model fitting cycle; these will differ in the k-fold cross-validation</span>
<span class="sd">        case from the predictions of the model that is retrained on the combined training &amp;</span>
<span class="sd">        validation set. Results are returned as a dictionary of parameter, value pairs in</span>
<span class="sd">        the format expected by the model tracker.</span>

<span class="sd">        Args:</span>
<span class="sd">            perf_data: A PerfData object that stores the predicted values and metrics</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of the prediction results</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_test_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_test_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_test_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the predicted values and metrics for the current test dataset against</span>
<span class="sd">        the version of the model stored in model_dir, as a PerfData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where the saved model is stored</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            perf_data: PerfData object containing the predicted values and metrics for the current test dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the saved model from model_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_model</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

        <span class="c1"># Create a PerfData object, which knows how to format the prediction results in the structure</span>
        <span class="c1"># expected by the model tracker.</span>

        <span class="c1"># We pass transformed=False to indicate that the preds and uncertainties we get from</span>
        <span class="c1"># generate_predictions are already untransformed, so that perf_data.get_prediction_results()</span>
        <span class="c1"># doesn&#39;t untransform them again.</span>
        <span class="n">perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">test_dset</span>
        <span class="n">test_preds</span><span class="p">,</span> <span class="n">test_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="n">test_dset</span><span class="p">)</span>
        <span class="n">perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">test_stds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_test_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_test_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_test_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics for the current test dataset against the version</span>
<span class="sd">        of the model stored in model_dir, as a dictionary in the format expected by the model tracker.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where the saved model is stored</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the prediction values and metrics for the current dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">perf_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_perf_data</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_full_dataset_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_full_dataset_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the predicted values and metrics from the current model for the full current dataset,</span>
<span class="sd">        as a PerfData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            perf_data: PerfData object containing the predicted values and metrics for the current full dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a PerfData object, which knows how to format the prediction results in the structure</span>
        <span class="c1"># expected by the model tracker.</span>

        <span class="c1"># We pass transformed=False to indicate that the preds and uncertainties we get from</span>
        <span class="c1"># generate_predictions are already untransformed, so that perf_data.get_prediction_results()</span>
        <span class="c1"># doesn&#39;t untransform them again.</span>
        <span class="n">perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">full_preds</span><span class="p">,</span> <span class="n">full_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">full_preds</span><span class="p">,</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">full_stds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_full_dataset_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_full_dataset_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from the current model for the full current dataset,</span>
<span class="sd">        as a dictionary in the format expected by the model tracker.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing predicted values and metrics for the current full dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_dataset</span>
        <span class="n">perf_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="n">model_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">DCNNModelWrapper</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>
<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            baseline_model_dir (str): The subdirectory under output_dir that contains the baseline epoch model.</span>
<span class="sd">            g: The tensorflow graph object</span>
<span class="sd">            sess: The tensor flow graph session</span>
<span class="sd">            model: The dc.models.GraphConvModel, fcnet.MultitaskRegressor, or fcnet.MultitaskClassifier object, as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>
<span class="sd">            train_perf_data (np.array of PerfData): Initialized as an empty array, </span>
<span class="sd">                contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (np.array of PerfData): Initialized as an empty array,</span>
<span class="sd">                contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes DCNNModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>
<span class="sd">            featurizer (Featurizer object): initialized outside of model_wrapper</span>

<span class="sd">        Side effects:</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>
<span class="sd">            g: The tensorflow graph object</span>
<span class="sd">            sess: The tensor flow graph session</span>
<span class="sd">            model: The dc.models.GraphConvModel, fcnet.MultitaskRegressor, or fcnet.MultitaskClassifier object, as specified by the params attribute</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
        <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_features</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>

            <span class="c1"># Set defaults for layer sizes and dropouts, if not specified by caller. Note that</span>
            <span class="c1"># these depend on the featurizer used.</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>

            <span class="c1"># TODO: Need to check that GraphConvModel params are actually being used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GraphConvModel</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">optimizer_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
                <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
                <span class="n">graph_conv_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">dense_layer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                <span class="n">penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                <span class="n">penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set defaults for layer sizes and dropouts, if not specified by caller. Note that</span>
            <span class="c1"># default layer sizes depend on the featurizer used.</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;descriptors&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Shouldn&#39;t happen</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You need to define default layer sizes for featurizer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>

                <span class="c1"># TODO: Need to check that MultitaskRegressor params are actually being used</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">MultitaskRegressor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                    <span class="n">n_features</span><span class="p">,</span>
                    <span class="n">layer_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
                    <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                    <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>
                    <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span>
                    <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                    <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: Need to check that MultitaskClassifier params are actually being used</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">MultitaskClassifier</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                    <span class="n">n_features</span><span class="p">,</span>
                    <span class="n">layer_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
                    <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                    <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>
                    <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span>
                    <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">beta1</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span>
                    <span class="n">beta2</span><span class="o">=.</span><span class="mi">999</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                    <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">n_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_number</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.recreate_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.recreate_model">[docs]</a>    <span class="k">def</span> <span class="nf">recreate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replaces the current self.model object with a new DeepChem Model object of the correct type for the</span>
<span class="sd">        requested featurizer and prediction type &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GraphConvModel</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">optimizer_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
                <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
                <span class="n">graph_conv_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">dense_layer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                <span class="n">penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                <span class="n">penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_features</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">MultitaskRegressor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                    <span class="n">n_features</span><span class="p">,</span>
                    <span class="n">layer_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
                    <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                    <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>
                    <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span>
                    <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                    <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">MultitaskClassifier</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                    <span class="n">n_features</span><span class="p">,</span>
                    <span class="n">layer_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
                    <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                    <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>
                    <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span>
                    <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">beta1</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span>
                    <span class="n">beta2</span><span class="o">=.</span><span class="mi">999</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                    <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">n_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_number</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trains a neural net model for multiple epochs, choose the epoch with the best validation</span>
<span class="sd">        set performance, refits the model for that number of epochs, and saves the tuned model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes for DCNNModelWrapper:</span>
<span class="sd">                data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">                best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>
<span class="sd">                train_perf_data (list of PerfData): Initialized as an empty array, </span>
<span class="sd">                    contains the predictions and performance of the training dataset</span>
<span class="sd">                valid_perf_data (list of PerfData): Initialized as an empty array,</span>
<span class="sd">                    contains the predictions and performance of the validation dataset</span>
<span class="sd">                train_epoch_perfs (np.array): Initialized as an empty array,</span>
<span class="sd">                    contains a list of dictionaries of predicted values and metrics on the training dataset</span>
<span class="sd">                valid_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                    contains a list of dictionaries of predicted values and metrics on the validation dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Fix docstrings above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch_perfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_epoch_perfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_epoch_perfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch_perf_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_epoch_perf_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_epoch_perf_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_choice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="n">baseline_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">baseline_epoch</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span>


        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>

        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">restore_hold</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Replace self.model with a completely new one</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new model&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">()</span>
            <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">):</span>
                <span class="c1"># Check if we are on the LC machines and have been running for more than 18 hours.</span>
                <span class="c1"># If so, set over_time to True and break out of epoch iteration loop.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="s1">&#39;LC&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">64800</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This code has run for 18 hours, exiting training loop&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">ei</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="n">restore_hold</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
                    <span class="n">train_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
                    <span class="n">valid_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
                    <span class="n">test_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">train_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
                    <span class="n">valid_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
                    <span class="n">test_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">%d</span><span class="s2">, epoch </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                              <span class="n">k</span><span class="p">,</span> <span class="n">ei</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                              <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

                <span class="n">train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">valid_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">train_pred</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">valid_pred</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                <span class="n">restore_hold</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Compute performance metrics for each epoch across validation sets for all folds, and find the</span>
        <span class="c1"># epoch that had the best validation set performance. Also compute the training set metrics at</span>
        <span class="c1"># each epoch, for later visualization.</span>
        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch_perfs</span><span class="p">[</span><span class="n">ei</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch_perf_stds</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_epoch_perfs</span><span class="p">[</span><span class="n">ei</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_epoch_perf_stds</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_epoch_perfs</span><span class="p">[</span><span class="n">ei</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_epoch_perf_stds</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_choice_scores</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">.</span><span class="n">model_choice_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_choice_score_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_choice_scores</span><span class="p">))</span>

        <span class="c1"># Train a new model for max(best_epoch, baseline_epoch) epochs. Save the model weights at both of</span>
        <span class="c1"># these epochs.</span>
        <span class="n">min_epoch</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">baseline_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">)</span>
        <span class="n">max_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">baseline_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">&lt;=</span> <span class="n">baseline_epoch</span><span class="p">:</span>
            <span class="n">min_epoch_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
            <span class="n">max_epoch_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_epoch_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span>
            <span class="n">max_epoch_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>

        <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For k-fold CV, retrain on the combined training and validation sets</span>
            <span class="n">fit_dataset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">combined_training_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_dataset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="n">min_epoch</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Only copy the model files we need, not the entire directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_model</span><span class="p">(</span><span class="n">min_epoch_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_epoch</span> <span class="o">&gt;</span> <span class="n">min_epoch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="n">max_epoch</span><span class="o">-</span><span class="n">min_epoch</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_model</span><span class="p">(</span><span class="n">max_epoch_dir</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_copy_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copies the files needed to recreate a DeepChem NN model from the current model</span>
<span class="sd">        directory to a destination directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            dest_dir (str): The destination directory for the model files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chkpt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">chkpt_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">chkpt_in</span><span class="p">:</span>
            <span class="n">chkpt_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">chkpt_in</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">chkpt_prefix</span> <span class="o">=</span> <span class="n">chkpt_dict</span><span class="p">[</span><span class="s1">&#39;model_checkpoint_path&#39;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">chkpt_file</span><span class="p">]</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model.pickle&#39;</span><span class="p">))</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.index&#39;</span> <span class="o">%</span> <span class="n">chkpt_prefix</span><span class="p">))</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.meta&#39;</span> <span class="o">%</span> <span class="n">chkpt_prefix</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.data-*&#39;</span> <span class="o">%</span> <span class="n">chkpt_prefix</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up_excess_files</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved model files to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">dest_dir</span><span class="p">)</span>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads a saved neural net model from the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>
<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, and transformers_x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GraphConvModel</span><span class="o">.</span><span class="n">load_from_dir</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">MultitaskRegressor</span><span class="o">.</span><span class="n">load_from_dir</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">MultitaskClassifier</span><span class="o">.</span><span class="n">load_from_dir</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reloading transformers from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span>
                    <span class="n">dataset_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span>
                    <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">,</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span> <span class="p">))</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.get_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.get_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset. subset may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39;</span>
<span class="sd">        accordingly.  epoch_label indicates the training epoch we want results for, and may be</span>
<span class="sd">        &#39;best&#39; or &#39;baseline&#39;. Results are returned as a dictionary of parameter, value pairs.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): Label for the current subset of the dataset (choices [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;])</span>
<span class="sd">            epoch_label (str): Label for the training epoch we want results for (choices [&#39;best&#39;,&#39;baseline&#39;])</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of parameter/ value pairs of the prediction values and results of the dataset subset</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if epoch_label not in [&#39;best&#39;,&#39;baseline&#39;]</span>
<span class="sd">            ValueError: If subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch_label</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="k">elif</span> <span class="n">epoch_label</span> <span class="o">==</span> <span class="s1">&#39;baseline&#39;</span><span class="p">:</span>
            <span class="c1">#TODO: This check should probably go somewhere else</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">baseline_epoch</span><span class="p">:</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">baseline_epoch</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown epoch_label &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">epoch_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.get_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.get_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset. subset may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39;,</span>
<span class="sd">        epoch_label indicates the training epoch we want results for, and may be &#39;best&#39; or</span>
<span class="sd">        &#39;baseline&#39;. Results are returned as a PerfData object of the appropriate class for the model&#39;s</span>
<span class="sd">        split strategy and prediction type.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): Label for the current subset of the dataset (choices [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;])</span>
<span class="sd">            epoch_label (str): Label for the training epoch we want results for (choices [&#39;best&#39;,&#39;baseline&#39;])</span>

<span class="sd">        Returns:</span>
<span class="sd">            PerfData object: Performance object pulled from the appropriate subset</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if epoch_label not in [&#39;best&#39;,&#39;baseline&#39;]</span>
<span class="sd">            ValueError: If subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch_label</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="k">elif</span> <span class="n">epoch_label</span> <span class="o">==</span> <span class="s1">&#39;baseline&#39;</span><span class="p">:</span>
            <span class="c1">#TODO: This check should probably go somewhere else</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">baseline_epoch</span><span class="p">:</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">baseline_epoch</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown epoch_label &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">epoch_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="c1">#return self.get_test_perf_data(model_dir, self.data)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>



    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset with current model, as well as standard deviations</span>
<span class="sd">        if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): tuple of predictions for compounds and standard deviation estimates, if requested.</span>
<span class="sd">            Each element of tuple is a numpy array of shape (ncmpds, ntasks, nclasses), where nclasses = 1 for regression</span>
<span class="sd">            models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Predicting values for current model&quot;</span><span class="p">)</span>

        <span class="c1"># For deepchem&#39;s predict_uncertainty function, you are not allowed to specify transformers. That means that the</span>
        <span class="c1"># predictions are being made in the transformed space, not the original space. We call undo_transforms() to generate</span>
        <span class="c1"># the transformed predictions. To transform the standard deviations, we rely on the fact that at present we only use</span>
        <span class="c1"># dc.trans.NormalizationTransformer (which centers and scales the data).</span>

        <span class="c1"># Uncertainty is now supported by DeepChem&#39;s GraphConv, at least for regression models.</span>
        <span class="c1"># if self.params.uncertainty and self.params.prediction_type == &#39;regression&#39; and self.params.featurizer != &#39;graphconv&#39;:</span>

        <span class="c1"># Current (2.1) DeepChem neural net classification models don&#39;t support uncertainties.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: DeepChem neural net models support uncertainty for regression only.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="c1"># For multitask, predict_uncertainty returns a list of (pred, std) tuples, one for each task.</span>
            <span class="c1"># For singletask, it returns one tuple. Convert the result into a pair of ndarrays of shape (ncmpds, ntasks, nclasses).</span>
            <span class="n">pred_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_uncertainty</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pred_std</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">pred_std</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_std</span><span class="p">)</span>
                <span class="n">pred0</span><span class="p">,</span> <span class="n">std0</span> <span class="o">=</span> <span class="n">pred_std</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ncmpds</span> <span class="o">=</span> <span class="n">pred0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nclasses</span> <span class="o">=</span> <span class="n">pred0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nclasses</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pred_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nclasses</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pred_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                  <span class="c1"># Transform the standard deviations, if we can. This is a bit of a hack, but it works for</span>
                <span class="c1"># NormalizationTransformer, since the standard deviations used to scale the data are</span>
                <span class="c1"># stored in the transformer object.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformer</span><span class="p">):</span>
                    <span class="n">y_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_stds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">ntasks</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">std</span> <span class="o">/</span> <span class="n">y_stds</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">undo_transforms</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCNNModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCNNModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to neural network models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metdata (dict): A dictionary of the parameter sets for the DCNNModelWrapper object.</span>
<span class="sd">                Parameters are saved under the key &#39;NNSpecific&#39; as a subdictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nn_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">,</span>
                    <span class="n">max_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">optimizer_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">layer_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">baseline_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">baseline_epoch</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span>
        <span class="p">)</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">NNSpecific</span> <span class="o">=</span> <span class="n">nn_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to clean up extra model files left behind in the training process.</span>
<span class="sd">        Only removes self.model_dir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span></div>
        
<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">DCRFModelWrapper</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurization (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>
<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            baseline_model_dir (str): The subdirectory under output_dir that contains the baseline epoch model.</span>
<span class="sd">            model: The dc.models.sklearn_models.SklearnModel as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem random forest models</span>
<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes DCRFModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>
<span class="sd">            featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">            ds_client: datastore client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
                                             <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
                                             <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="p">,</span>
                                             <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
                                              <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
                                              <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="p">,</span>
                                              <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">sklearn_models</span><span class="o">.</span><span class="n">SklearnModel</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trains a random forest model and saves the trained model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem random forest models</span>
<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting random forest model&quot;</span><span class="p">)</span>

        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>

        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span>

            <span class="n">train_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
            <span class="n">valid_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
            <span class="n">test_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">k</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                             <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

            <span class="n">train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">train_pred</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">valid_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">valid_pred</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

        <span class="c1"># Compute mean and SD of performance metrics across validation sets for all folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>

        <span class="c1"># Compute score to be used for ranking model hyperparameter sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_choice_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">model_choice_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_choice_score_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For k-fold CV, retrain on the combined training and validation sets</span>
            <span class="n">fit_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">combined_training_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># The best model is just the single RF training run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads a saved random forest model from the specified directory. Also loads any transformers that</span>
<span class="sd">        were saved with it.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>
<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, and transformers_x</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
                                             <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
                                             <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="p">,</span>
                                             <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reloading transformers from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">dataset_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span>
                                   <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">,</span>
                                   <span class="n">client</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span> <span class="p">))</span>
                <span class="c1"># TODO: We shouldn&#39;t be reloading the transformers here - that should only happen when we load</span>
                <span class="c1"># TODO: a previously trained model to run predictions on a new dataset.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
                                              <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
                                              <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="p">,</span>
                                              <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">sklearn_models</span><span class="o">.</span><span class="n">SklearnModel</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">reload_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.get_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.get_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset: &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39; accordingly.</span>
<span class="sd">            epoch_label: ignored; this function always returns the results for the current model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary of parameter, value pairs, in the format expected by the</span>
<span class="sd">            PredictionResults element of the ModelMetrics data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.get_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.get_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39;</span>
<span class="sd">            epoch_label (not used in random forest, but kept as part of the method structure)</span>

<span class="sd">        Results:</span>
<span class="sd">            PerfData object: Subclass of perfdata object associated with the appropriate subset&#39;s split strategy and prediction type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset, as well as uncertainty values if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): numpy arrays containing predictions for compounds and the standard error estimates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evaluating current model&quot;</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="n">ncmpds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="n">rf_model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="s1">&#39;model.joblib&#39;</span><span class="p">))</span>
                <span class="c1">## s.d. from forest</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">RF_per_tree_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">undo_transforms</span><span class="p">(</span>
                        <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">RF_per_tree_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>

                <span class="c1"># Don&#39;t need to &quot;untransform&quot; standard deviations here, since they&#39;re calculated from</span>
                <span class="c1"># the untransformed per-tree predictions.</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">RF_per_tree_pred</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We can estimate uncertainty for binary classifiers, but not multiclass (yet)</span>
                <span class="n">nclasses</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nclasses</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ntrees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span>
                    <span class="c1"># Use normal approximation to binomial sampling error. Later we can do Jeffrey&#39;s interval if we</span>
                    <span class="c1"># want to get fancy.</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pred</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">ntrees</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: Random forest only supports uncertainties for binary classifiers.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to random forest models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metadata (dict): Returns random forest specific metadata as a subdict under the key &#39;RFSpecific&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rf_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rf_estimators&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
            <span class="s1">&#39;rf_max_features&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
            <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span>
        <span class="p">}</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">RFSpecific</span> <span class="o">=</span> <span class="n">rf_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div>
    
    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to clean up extra model files left behind in the training process.</span>
<span class="sd">        Does not apply to Random Forest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">DCxgboostModelWrapper</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurization (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>
<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            baseline_model_dir (str): The subdirectory under output_dir that contains the baseline epoch model.</span>
<span class="sd">            model: The dc.models.sklearn_models.SklearnModel as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable</span>
<span class="sd">            train_perf_data (PerfObjects): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfObjects): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes RunModel object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>
<span class="sd">            featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">            ds_client: datastore client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                         <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;reg:squarederror&#39;</span><span class="p">,</span>
                                         <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                         <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                         <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                         <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                         <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                         <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                         <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">gpu_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">n_gpus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="c1">#                                          tree_method = &#39;gpu_hist&#39;</span>
                                         <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                          <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
                                          <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                          <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                          <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                          <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                          <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                          <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                          <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                          <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">gpu_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>                                          
                                          <span class="n">n_gpus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="c1">#                                           tree_method = &#39;gpu_hist&#39;</span>
                                         <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">xgboost_models</span><span class="o">.</span><span class="n">XGBoostModel</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trains a xgboost model and saves the trained model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem xgboost models</span>
<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting xgboost model&quot;</span><span class="p">)</span>

        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>

        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span>

            <span class="n">train_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
            <span class="n">valid_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
            <span class="n">test_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric</span><span class="p">])[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">k</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                             <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

            <span class="n">train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">train_pred</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">valid_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">valid_pred</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

        <span class="c1"># Compute mean and SD of performance metrics across validation sets for all folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>

        <span class="c1"># Compute score to be used for ranking model hyperparameter sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_choice_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">model_choice_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_choice_score_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For k-fold CV, retrain on the combined training and validation sets</span>
            <span class="n">fit_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">combined_training_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># The best model is just the single xgb training run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Loads a saved xgboost model from the specified directory. Also loads any transformers that</span>
<span class="sd">        were saved with it.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>
<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, and transformers_x</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                         <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;reg:squarederror&#39;</span><span class="p">,</span>
                                         <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                         <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                         <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                         <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                         <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                         <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                         <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">gpu_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">n_gpus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="c1">#                                          tree_method = &#39;gpu_hist&#39;</span>
                                         <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Reloading transformers from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span>
                        <span class="n">dataset_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span>
                        <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">,</span>
                        <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
                <span class="c1"># TODO: We shouldn&#39;t be reloading the transformers here - that should only happen when we load</span>
                <span class="c1"># TODO: a previously trained model to run predictions on a new dataset.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                          <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
                                          <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                          <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                          <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                          <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                          <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                          <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                          <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                          <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">gpu_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>                                          
                                          <span class="n">n_gpus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="c1">#                                           tree_method = &#39;gpu_hist&#39;,</span>
                                         <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">xgboost_models</span><span class="o">.</span><span class="n">XGBoostModel</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.get_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.get_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset: &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39; accordingly.</span>
<span class="sd">            epoch_label: ignored; this function always returns the results for the current model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary of parameter, value pairs, in the format expected by the</span>
<span class="sd">            PredictionResults element of the ModelMetrics data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.get_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.get_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39;</span>
<span class="sd">            epoch_label (not used in random forest, but kept as part of the method structure)</span>

<span class="sd">        Results:</span>
<span class="sd">            PerfData object: Subclass of perfdata object associated with the appropriate subset&#39;s split strategy and prediction type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset, as well as uncertainty values if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): numpy arrays containing predictions for compounds and the standard error estimates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Evaluating current model&quot;</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="n">ncmpds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;uncertainty not supported by xgboost models&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to xgboost models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metadata (dict): Returns xgboost specific metadata as a subdict under the key &#39;xgbSpecific&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xgb_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xgb_max_depth&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_learning_rate&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_n_estimators&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_gamma&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_min_child_weight&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_subsample&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_colsample_bytree&quot;</span>  <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span>
                        <span class="p">}</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xgbSpecific</span><span class="o">=</span><span class="n">xgb_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to clean up extra model files left behind in the training process.</span>
<span class="sd">        Does not apply to xgboost</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ATOM DDM Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>