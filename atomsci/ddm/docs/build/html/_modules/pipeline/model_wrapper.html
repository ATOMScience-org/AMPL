<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.model_wrapper &mdash; ATOM Data-Driven Modeling Pipeline 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ATOM Data-Driven Modeling Pipeline
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/running_ampl.html">Running AMPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_ampl_usage.html">Advanced AMPL Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_testing.html">Advanced Testing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">atomsci</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pipeline.model_wrapper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.model_wrapper</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains class ModelWrapper and its subclasses, which are wrappers for DeepChem and scikit-learn model classes.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">deepchem</span> <span class="k">as</span> <span class="nn">dc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="k">if</span> <span class="n">dc</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;2.1&#39;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">deepchem.models.tensorgraph.fcnet</span> <span class="kn">import</span> <span class="n">MultitaskRegressor</span><span class="p">,</span> <span class="n">MultitaskClassifier</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">deepchem.models.fcnet</span> <span class="kn">import</span> <span class="n">MultitaskRegressor</span><span class="p">,</span> <span class="n">MultitaskClassifier</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dgl</span>
    <span class="kn">import</span> <span class="nn">dgllife</span>
    <span class="kn">import</span> <span class="nn">deepchem.models</span> <span class="k">as</span> <span class="nn">dcm</span>
    <span class="kn">from</span> <span class="nn">deepchem.models</span> <span class="kn">import</span> <span class="n">AttentiveFPModel</span>
    <span class="n">afp_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
    <span class="n">afp_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
    <span class="n">xgboost_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">xgboost_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>

<span class="kn">from</span> <span class="nn">atomsci.ddm.utils</span> <span class="kn">import</span> <span class="n">datastore_functions</span> <span class="k">as</span> <span class="n">dsf</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.utils</span> <span class="kn">import</span> <span class="n">llnl_utils</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">transformations</span> <span class="k">as</span> <span class="n">trans</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">perf_data</span> <span class="k">as</span> <span class="n">perf</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.pipeline.parameter_parser</span> <span class="k">as</span> <span class="nn">pp</span>

<span class="kn">from</span> <span class="nn">tensorflow.python.keras.utils.layer_utils</span> <span class="kn">import</span> <span class="n">count_params</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="get_latest_pytorch_checkpoint"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.get_latest_pytorch_checkpoint">[docs]</a><span class="k">def</span> <span class="nf">get_latest_pytorch_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets the latest torch model</span>

<span class="sd">    Calls get_checkpoints(), sorts them, and returns the</span>
<span class="sd">    latest model (the one with the biggets number)</span>

<span class="sd">    Args:</span>
<span class="sd">        model: A model that inherits DeepChem TorchModel</span>
<span class="sd">        model_dir: Optional argument that directs the model</span>
<span class="sd">            to a specific folder</span>

<span class="sd">    Returns:</span>
<span class="sd">        path relative to model_dir, if provided, to the latest</span>
<span class="sd">        checkpoint</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chkpts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_checkpoints</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">chkpts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chkpts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No &#39;best&#39; checkpoint found. deepchem.Model.get_checkpoints() is empty&quot;</span><span class="p">)</span>
    <span class="c1"># checkpoint with the highest number is the best one</span>
    <span class="n">latest_chkpt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">chkpts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">latest_chkpt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">latest_chkpt</span></div>
 

<div class="viewcode-block" id="dc_restore"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.dc_restore">[docs]</a><span class="k">def</span> <span class="nf">dc_restore</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reload the values of all variables from a checkpoint file.</span>

<span class="sd">    copied from DeepChem 2.3 keras_model.py to silence warnings caused</span>
<span class="sd">    when a model is loaded in inference mode.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (DeepChem.KerasModel: keras model to restore</span>

<span class="sd">        checkpoint (str): the path to the checkpoint file to load.  If this is None, the most recent</span>
<span class="sd">            checkpoint will be chosen automatically.  Call get_checkpoints() to get a</span>
<span class="sd">            list of all available checkpoints.</span>

<span class="sd">        model_dir (str): default None</span>
<span class="sd">            Directory to restore checkpoint from. If None, use model.model_dir.</span>

<span class="sd">        session (tf.Session()) default None</span>
<span class="sd">            Session to run restore ops under. If None, model.session is used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ensure_built</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_dir</span>
    <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No checkpoint found&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">executing_eagerly</span><span class="p">():</span>
        <span class="c1"># expect_partial() silences warnings when this model is restored for</span>
        <span class="c1"># inference only.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_checkpoint</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">expect_partial</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">session</span>
        <span class="c1"># expect_partial() silences warnings when this model is restored for</span>
        <span class="c1"># inference only.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_checkpoint</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">expect_partial</span><span class="p">()</span><span class="o">.</span><span class="n">run_restore_ops</span><span class="p">(</span><span class="n">session</span><span class="p">)</span></div>

<div class="viewcode-block" id="dc_torch_restore"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.dc_torch_restore">[docs]</a><span class="k">def</span> <span class="nf">dc_torch_restore</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reload the values of all variables from a checkpoint file. </span>

<span class="sd">    This is copied from deepchem 2.6.1 to explicitly set the torch loading device to </span>
<span class="sd">    &#39;cpu&#39; if cuda devices aren&#39;t available when reloading the model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: the torch model to restore</span>
<span class="sd">    checkpoint: str</span>
<span class="sd">      the path to the checkpoint file to load.  If this is None, the most recent</span>
<span class="sd">      checkpoint will be chosen automatically.  Call get_checkpoints() to get a</span>
<span class="sd">      list of all available checkpoints.</span>
<span class="sd">    model_dir: str, default None</span>
<span class="sd">      Directory to restore checkpoint from. If None, use self.model_dir.  If</span>
<span class="sd">      checkpoint is not None, this is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ensure_built</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="c1"># set torch device</span>
    <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">checkpoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_checkpoints</span><span class="p">(</span><span class="n">model_dir</span><span class="p">))</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No checkpoint found&#39;</span><span class="p">)</span>
      <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="c1"># include map_location to transfer a gpu model to cpu</span>
    <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_pytorch_optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_global_step</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="all_bases"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.all_bases">[docs]</a><span class="k">def</span> <span class="nf">all_bases</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a model, return all bases</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
    <span class="n">current_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_funcs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">current_func</span> <span class="o">=</span> <span class="n">current_funcs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">current_funcs</span> <span class="o">=</span> <span class="n">current_funcs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_func</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_func</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="create_model_wrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.create_model_wrapper">[docs]</a><span class="k">def</span> <span class="nf">create_model_wrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory function for creating Model objects of the correct subclass for params.model_type.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (Namespace): Parameters passed to the model pipeline</span>

<span class="sd">        featurizer (Featurization): Object managing the featurization of compounds</span>

<span class="sd">        ds_client (DatastoreClient): Interface to the file datastore</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (pipeline.Model): Wrapper for DeepChem, sklearn or other model.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Only params.model_type = &#39;NN&#39;, &#39;RF&#39; or &#39;xgboost&#39; is supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GraphConvDCModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MultitaskDCModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DCRFModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xgboost_supported</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to import xgboost. </span><span class="se">\</span>
<span class="s2">                             xgboost package needs to be installed to use xgboost model. </span><span class="se">\</span>
<span class="s2">                             Installatin: </span><span class="se">\</span>
<span class="s2">                             from pip: pip3 install xgboost==0.90.</span><span class="se">\</span>
<span class="s2">                             livermore compute (lc): /usr/mic/bio/anaconda3/bin/pip install xgboost==0.90 --user </span><span class="se">\</span>
<span class="s2">                             twintron-blue (TTB): /opt/conda/bin/pip install xgboost==0.90 --user &quot;</span>
                            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xgb</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;0.9&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xgboost required to be = 0.9 for GPU support. </span><span class="se">\</span>
<span class="s2">                             current version = xgb.__version__ </span><span class="se">\</span>
<span class="s2">                             installation: </span><span class="se">\</span>
<span class="s2">                             from pip: pip install xgboost==0.90&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DCxgboostModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;hybrid&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HybridModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="n">pp</span><span class="o">.</span><span class="n">model_wl</span><span class="p">:</span>
        <span class="n">requested_model</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">model_wl</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">]</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="n">all_bases</span><span class="p">(</span><span class="n">requested_model</span><span class="p">)</span>
        <span class="c1"># keras and torch models have slightly different interfaces. They also save their models</span>
        <span class="c1"># differently. These two wrappers implement the same interface.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;TorchModel&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">afp_supported</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;dgl and dgllife packages must be installed to use attentive_fp model.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">PytorchDeepChemModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;KerasModel&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">KerasDeepChemModelWrapper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown model_type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span></div>

<span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">ModelWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for DeepChem and sklearn model objects. Provides methods to train and test a model,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">        Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>

<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response cols</span>

<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the features</span>

<span class="sd">            transformers_w (list): Initialized as an empty list, stores the transformers on the weights</span>

<span class="sd">        set in setup_model_dirs:</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes ModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurization object): initialized outside of model_wrapper</span>

<span class="sd">            ds_client (DatastoreClient): Interface to the file datastore</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of ModelWrapper:</span>
<span class="sd">                params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>

<span class="sd">                featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">                log (log): The logger</span>

<span class="sd">                output_dir (str): The parent path of the model directory</span>

<span class="sd">                transformers (list): Initialized as an empty list, stores the transformers on the response cols</span>

<span class="sd">                transformers_x (list): Initialized as an empty list, stores the transformers on the features</span>

<span class="sd">                transformers_w (list): Initialized as an empty list, stores the transformers on the weights</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span> <span class="o">=</span> <span class="n">featurizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="o">=</span> <span class="n">ds_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.setup_model_dirs"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.setup_model_dirs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_model_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up paths and directories for persisting models at particular training epochs, used by</span>
<span class="sd">        the DeepChem model classes.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes of ModelWrapper:</span>
<span class="sd">                best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">)</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a model (for multiple epochs if applicable), and saves the tuned model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: The method is implemented by subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to the model type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: The method is implemented by subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

        <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_create_output_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize transformers for responses and persist them for later.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset: The ModelDataset object that handles the current dataset</span>

<span class="sd">        Side effects</span>
<span class="sd">            Overwrites the attributes:</span>
<span class="sd">                transformers: A list of deepchem transformation objects on response_col, only if conditions are met</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Just a warning, we may have response transformers for classification datasets in the future</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="o">==</span><span class="s1">&#39;regression&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="o">=</span> <span class="p">[</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformerMissingData</span><span class="p">(</span><span class="n">transform_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="p">)]</span>

        <span class="c1"># ****************************************************************************************</span>

    <span class="k">def</span> <span class="nf">_create_feature_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize transformers for features, and persist them for later.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset: The ModelDataset object that handles the current dataset</span>

<span class="sd">        Side effects</span>
<span class="sd">            Overwrites the attributes:</span>
<span class="sd">                transformers_x: A list of deepchem transformation objects on featurizers, only if conditions are met.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set up transformers for features, if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">create_feature_transformers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">)</span>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.create_transformers"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.create_transformers">[docs]</a>    <span class="k">def</span> <span class="nf">create_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize transformers for responses, features and weights, and persist them for later.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset: The ModelDataset object that handles the current dataset</span>

<span class="sd">        Side effects</span>
<span class="sd">            Overwrites the attributes:</span>
<span class="sd">                transformers: A list of deepchem transformation objects on responses, only if conditions are met</span>

<span class="sd">                transformers_x: A list of deepchem transformation objects on features, only if conditions are met.</span>

<span class="sd">                transformers_w: A list of deepchem transformation objects on weights, only if conditions are met.</span>

<span class="sd">                params.transformer_key: A string pointing to the dataset key containing the transformer in the datastore, or the path to the transformer</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_output_transformers</span><span class="p">(</span><span class="n">model_dataset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_feature_transformers</span><span class="p">(</span><span class="n">model_dataset</span><span class="p">)</span>

        <span class="c1"># Set up transformers for weights, if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">create_weight_transformers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Transformers are no longer saved as separate datastore objects; they are included in the model tarball</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;transformers.pkl&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">txfmrpkl</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span><span class="p">),</span> <span class="n">txfmrpkl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote transformers to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_oid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.reload_transformers"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.reload_transformers">[docs]</a>    <span class="k">def</span> <span class="nf">reload_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load response, feature and weight transformers from datastore objects or files. Before AMPL v1.2 these</span>
<span class="sd">        were persisted as separate datastore objects when the model tracker was used; subsequently they</span>
<span class="sd">        are included in model tarballs, which should have been unpacked before this function gets called.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Try local path first to check for transformers unpacked from model tarball</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trans</span><span class="o">.</span><span class="n">transformers_needed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/transformers.pkl&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reloading transformers from model tarball </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">txfmr</span><span class="p">:</span>
                <span class="n">transformers_tuple</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">txfmr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reloading transformers from datastore key </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">transformers_tuple</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span>
                        <span class="n">dataset_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span>
                        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_bucket</span><span class="p">,</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_client</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reloading transformers from file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformer_key</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">txfmr</span><span class="p">:</span>
                        <span class="n">transformers_tuple</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">txfmr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Shouldn&#39;t happen</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Transformers needed to reload model, but no transformer_key specified.&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transformers_tuple</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span> <span class="o">=</span> <span class="n">transformers_tuple</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span> <span class="o">=</span> <span class="n">transformers_tuple</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span> <span class="o">=</span> <span class="p">[]</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.transform_dataset"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.transform_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">transform_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the responses and/or features in the given DeepChem dataset using the current transformers.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: The DeepChem DiskDataset that contains a dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            transformed_dataset: The transformed DeepChem DiskDataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming response data&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span>
                <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming feature data&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_x</span><span class="p">:</span>
                <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transforming weights&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers_w</span><span class="p">:</span>
                <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transformed_dataset</span></div>
        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.get_num_features"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_num_features">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of dimensions of the feature space, taking both featurization method</span>
<span class="sd">        and transformers into account.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">feature_transform_type</span> <span class="o">==</span> <span class="s1">&#39;umap&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">umap_dim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurization</span><span class="o">.</span><span class="n">get_feature_count</span><span class="p">()</span></div>

        <span class="c1"># ****************************************************************************************</span>

<div class="viewcode-block" id="ModelWrapper.get_train_valid_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_train_valid_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics for the training, validation or test set</span>
<span class="sd">        associated with the PerfData object perf_data. Results are returned as a dictionary </span>
<span class="sd">        of parameter, value pairs in the format expected by the model tracker.</span>

<span class="sd">        Args:</span>
<span class="sd">            perf_data: A PerfData object that stores the predicted values and metrics</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of the prediction results</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_test_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_test_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_test_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the predicted values and metrics for the current test dataset against</span>
<span class="sd">        the version of the model stored in model_dir, as a PerfData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where the saved model is stored</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            perf_data: PerfData object containing the predicted values and metrics for the current test dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the saved model from model_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_model</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

        <span class="c1"># Create a PerfData object, which knows how to format the prediction results in the structure</span>
        <span class="c1"># expected by the model tracker.</span>

        <span class="c1"># We pass transformed=False to indicate that the preds and uncertainties we get from</span>
        <span class="c1"># generate_predictions are already untransformed, so that perf_data.get_prediction_results()</span>
        <span class="c1"># doesn&#39;t untransform them again.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ishybrid&quot;</span><span class="p">):</span>
            <span class="c1"># indicate that we are training a hybrid model</span>
            <span class="n">perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">is_ki</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_ki</span><span class="p">,</span> <span class="n">ki_convert_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ki_convert_ratio</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">test_dset</span>
        <span class="n">test_preds</span><span class="p">,</span> <span class="n">test_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="n">test_dset</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">test_stds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_test_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_test_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_test_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics for the current test dataset against the version</span>
<span class="sd">        of the model stored in model_dir, as a dictionary in the format expected by the model tracker.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where the saved model is stored</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the prediction values and metrics for the current dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">perf_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_perf_data</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_full_dataset_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_full_dataset_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the predicted values and metrics from the current model for the full current dataset,</span>
<span class="sd">        as a PerfData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            perf_data: PerfData object containing the predicted values and metrics for the current full dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a PerfData object, which knows how to format the prediction results in the structure</span>
        <span class="c1"># expected by the model tracker.</span>

        <span class="c1"># We pass transformed=False to indicate that the preds and uncertainties we get from</span>
        <span class="c1"># generate_predictions are already untransformed, so that perf_data.get_prediction_results()</span>
        <span class="c1"># doesn&#39;t untransform them again.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ishybrid&quot;</span><span class="p">):</span>
            <span class="c1"># indicate that we are training a hybrid model</span>
            <span class="n">perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">is_ki</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_ki</span><span class="p">,</span> <span class="n">ki_convert_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ki_convert_ratio</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">full_preds</span><span class="p">,</span> <span class="n">full_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">full_preds</span><span class="p">,</span> <span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">full_stds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span></div>

        <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.get_full_dataset_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.get_full_dataset_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from the current model for the full current dataset,</span>
<span class="sd">        as a dictionary in the format expected by the model tracker.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset (DiskDataset): Stores the current dataset and related methods</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing predicted values and metrics for the current full dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_dataset</span>
        <span class="n">perf_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="n">model_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ModelWrapper.generate_embeddings"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.generate_embeddings">[docs]</a>    <span class="k">def</span> <span class="nf">generate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ModelWrapper.model_save"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ModelWrapper.model_save">[docs]</a>    <span class="k">def</span> <span class="nf">model_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A wrapper function to save a model  due to the `DeepChem model.save()` has inconsistent implementation.</span>

<span class="sd">        The `SKlearnModel()` class and xgboost model in DeepChem use `model.save()`,</span>
<span class="sd">        while the `MultitaskRegressor` class uses `model.save_checkpoint()`. The</span>
<span class="sd">        workaround is to try `model.save()` first. If failed, then try `model.save_checkpoint()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">()</span>
          <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error when saving model:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="LCTimerIterator"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.LCTimerIterator">[docs]</a><span class="k">class</span> <span class="nc">LCTimerIterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This creates an iterator that keeps track of time limits</span>

<span class="sd">    Side Effects:</span>
<span class="sd">        Sets the following attributes in input argument params: </span>
<span class="sd">            max_epochs (int): The max_epochs attribute will be updated to the current epoch </span>
<span class="sd">                index if it is projected that training will exceed the time limit</span>
<span class="sd">                given.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all </span>
<span class="sd">               parameter information</span>

<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">            log (log): The logger used in the ModelWrapper</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_time_limit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ei</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns epoch index or stops when the have been enough iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">elif</span> <span class="n">llnl_utils</span><span class="o">.</span><span class="n">is_lc_system</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ei</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># If we&#39;re running on an LC system, check that we have enough time to complete another epoch</span>
            <span class="c1"># before the current job finishes, by extrapolating from the time elapsed so far.</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
            <span class="n">training_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_start</span>
            <span class="n">time_remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">elapsed_time</span>
            <span class="n">time_needed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_needed</span><span class="p">(</span><span class="n">training_time</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">time_needed</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">time_remaining</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Projected time to finish one more epoch exceeds time left in job; cutting training to </span><span class="si">%d</span><span class="s2"> epochs&quot;</span> <span class="o">%</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_time_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">training_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the time needed to complete another epoch given the training time</span>

<span class="sd">        Args:</span>
<span class="sd">            training_time (int): Time the model has spent training so far</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Amount of time needed to complete another epoch</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">training_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ei</span></div>

<div class="viewcode-block" id="LCTimerKFoldIterator"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.LCTimerKFoldIterator">[docs]</a><span class="k">class</span> <span class="nc">LCTimerKFoldIterator</span><span class="p">(</span><span class="n">LCTimerIterator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This creates an iterator that keeps track of time limits for kfold training</span>

<span class="sd">    Side Effects:</span>
<span class="sd">        Sets the following attributes in input argument params: </span>
<span class="sd">            max_epochs (int): The max_epochs attribute will be updated to the current epoch </span>
<span class="sd">                index if it is projected that training will exceed the time limit</span>
<span class="sd">                given.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_time_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">training_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the time needed to complete another epoch given the training time.</span>

<span class="sd">        epochs_remaining is how many epochs we have to run if we do one more across all folds,</span>
<span class="sd">        then do self.best_epoch+1 epochs on the combined training &amp; validation set, </span>
<span class="sd">        allowing for the possibility that the next epoch may be the best one.</span>

<span class="sd">        Args:</span>
<span class="sd">            training_time (int): Time the model has spent training so far</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Amount of time needed to complete another epoch</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">epochs_remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">time_per_epoch</span> <span class="o">=</span> <span class="n">training_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ei</span>
        <span class="n">time_needed</span> <span class="o">=</span> <span class="n">epochs_remaining</span> <span class="o">*</span> <span class="n">time_per_epoch</span>

        <span class="k">return</span> <span class="n">time_needed</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">NNModelWrapper</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wrapper for NN models.</span>

<span class="sd">    Many NN models share similar functions. This class aggregates those similar functions</span>
<span class="sd">    to reduce copied code</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper.get_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.get_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset. subset may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39;,</span>
<span class="sd">        epoch_label indicates the training epoch we want results for; currently the</span>
<span class="sd">        only option for this is &#39;best&#39;. Results are returned as a PerfData object of the appropriate class </span>
<span class="sd">        for the model&#39;s split strategy and prediction type.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): Label for the current subset of the dataset (choices [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;])</span>

<span class="sd">            epoch_label (str): Label for the training epoch we want results for (choices [&#39;best&#39;])</span>

<span class="sd">        Returns:</span>
<span class="sd">            PerfData object: Performance object pulled from the appropriate subset</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if epoch_label not in [&#39;best&#39;]</span>

<span class="sd">            ValueError: If subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch_label</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown epoch_label &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">epoch_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="c1">#return self.get_test_perf_data(model_dir, self.data)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper.get_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.get_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset. subset may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39;</span>
<span class="sd">        accordingly.  epoch_label indicates the training epoch we want results for; currently the</span>
<span class="sd">        only option for this is &#39;best&#39;.  Results are returned as a dictionary of parameter, value pairs.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): Label for the current subset of the dataset (choices [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;])</span>

<span class="sd">            epoch_label (str): Label for the training epoch we want results for (choices [&#39;best&#39;])</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of parameter/ value pairs of the prediction values and results of the dataset subset</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if epoch_label not in [&#39;best&#39;]</span>

<span class="sd">            ValueError: If subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch_label</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown epoch_label &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">epoch_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to clean up extra model files left behind in the training process.</span>
<span class="sd">        Only removes self.model_dir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a neural net model for multiple epochs, choose the epoch with the best validation</span>
<span class="sd">        set performance, refits the model for that number of epochs, and saves the tuned model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes for NNModelWrapper:</span>
<span class="sd">                data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">                best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>

<span class="sd">                train_perf_data (list of PerfData): Initialized as an empty array, </span>
<span class="sd">                    contains the predictions and performance of the training dataset</span>

<span class="sd">                valid_perf_data (list of PerfData): Initialized as an empty array,</span>
<span class="sd">                    contains the predictions and performance of the validation dataset</span>

<span class="sd">                train_epoch_perfs (np.array): Initialized as an empty array,</span>
<span class="sd">                    contains a list of dictionaries of predicted values and metrics on the training dataset</span>

<span class="sd">                valid_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                    contains a list of dictionaries of predicted values and metrics on the validation dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Fix docstrings above</span>
        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_kfold_cv</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_with_early_stopping</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper.train_kfold_cv"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.train_kfold_cv">[docs]</a>    <span class="k">def</span> <span class="nf">train_kfold_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a neural net model with K-fold cross-validation for a specified number of epochs.</span>
<span class="sd">        Finds the epoch with the best validation set performance averaged over folds, then refits </span>
<span class="sd">        a model for the same number of epochs to the combined training and validation data.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes for NNModelWrapper:</span>
<span class="sd">                data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">                best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>

<span class="sd">                train_perf_data (list of PerfData): Initialized as an empty array, </span>
<span class="sd">                    contains the predictions and performance of the training dataset</span>

<span class="sd">                valid_perf_data (list of PerfData): Initialized as an empty array,</span>
<span class="sd">                    contains the predictions and performance of the validation dataset</span>

<span class="sd">                train_epoch_perfs (np.array): Contains a standard training set performance metric (r2_score or roc_auc), averaged over folds,</span>
<span class="sd">                    at the end of each epoch.</span>

<span class="sd">                valid_epoch_perfs (np.array): Contains a standard validation set performance metric (r2_score or roc_auc), averaged over folds,</span>
<span class="sd">                    at the end of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Fix docstrings above</span>
        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Create PerfData structures for computing cross-validation metrics</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">EpochManagerKFold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">subsets</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span><span class="s1">&#39;train_valid&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span><span class="s1">&#39;test&#39;</span><span class="p">},</span>
                                <span class="n">prediction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> 
                                <span class="n">model_dataset</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                <span class="n">transformers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="n">em</span><span class="o">.</span><span class="n">set_make_pred</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">em</span><span class="o">.</span><span class="n">on_new_best_valid</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># does not need to take any action</span>

        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>

        <span class="c1"># Train a separate model for each fold</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">LCTimerKFoldIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
            <span class="c1"># Create PerfData structures that are only used within loop to compute metrics during initial training</span>
            <span class="n">train_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
            <span class="n">test_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="c1"># We turn off automatic checkpointing - we only want to save a checkpoints for the final model.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[])</span>

                <span class="n">train_perf</span> <span class="o">=</span> <span class="n">train_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">train_pred</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                <span class="n">test_perf</span> <span class="o">=</span> <span class="n">test_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

                <span class="n">valid_perf</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">valid_dset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">%d</span><span class="s2">, epoch </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                              <span class="n">k</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                              <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

            <span class="c1"># Compute performance metrics for current epoch across validation sets for all folds, and update</span>
            <span class="c1"># the best_epoch and best score if the new score exceeds the previous best score by a specified</span>
            <span class="c1"># threshold.</span>
            <span class="n">em</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
            <span class="n">em</span><span class="o">.</span><span class="n">update_valid</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">em</span><span class="o">.</span><span class="n">should_stop</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_trained</span> <span class="o">=</span> <span class="n">ei</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Train a new model for best_epoch epochs on the combined training/validation set. Compute the training and test</span>
        <span class="c1"># set metrics at each epoch.</span>
        <span class="n">fit_dataset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">combined_training_data</span><span class="p">()</span>
        <span class="n">retrain_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best epoch was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="si">}</span><span class="s2">, retraining with combined training/validation set&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">train_perf</span><span class="p">,</span> <span class="n">test_perf</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">update_epoch</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">=</span><span class="n">fit_dataset</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">=</span><span class="n">test_dset</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined folds: Epoch </span><span class="si">{</span><span class="n">ei</span><span class="si">}</span><span class="s2">, training </span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">train_perf</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">,&quot;</span>
                         <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;test </span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">test_perf</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save</span><span class="p">()</span>

        <span class="c1"># Only copy the model files we need, not the entire directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>
        <span class="n">retrain_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">retrain_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time to retrain model for </span><span class="si">%d</span><span class="s2"> epochs: </span><span class="si">%.1f</span><span class="s2"> seconds, </span><span class="si">%.1f</span><span class="s2"> sec/epoch&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">,</span> <span class="n">retrain_time</span><span class="p">,</span> 
                       <span class="n">retrain_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">))</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper.train_with_early_stopping"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.train_with_early_stopping">[docs]</a>    <span class="k">def</span> <span class="nf">train_with_early_stopping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a neural net model for up to self.params.max_epochs epochs, while tracking the validation</span>
<span class="sd">        set metric given by params.model_choice_score_type. Saves a model checkpoint each time the metric</span>
<span class="sd">        is improved over its previous saved value by more than a threshold percentage. If the metric fails to</span>
<span class="sd">        improve for more than a specified &#39;patience&#39; number of epochs, stop training and revert the model state</span>
<span class="sd">        to the last saved checkpoint. </span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Sets the following attributes for NNModelWrapper:</span>
<span class="sd">                data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">                best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>

<span class="sd">                best_validation_score (float): The best validation model choice score attained during training.</span>

<span class="sd">                train_perf_data (list of PerfData): Initialized as an empty array, </span>
<span class="sd">                    contains the predictions and performance of the training dataset</span>

<span class="sd">                valid_perf_data (list of PerfData): Initialized as an empty array,</span>
<span class="sd">                    contains the predictions and performance of the validation dataset</span>

<span class="sd">                train_epoch_perfs (np.array): A standard training set performance metric (r2_score or roc_auc), at the end of each epoch.</span>

<span class="sd">                valid_epoch_perfs (np.array): A standard validation set performance metric (r2_score or roc_auc), at the end of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>

        <span class="n">em</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">EpochManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">prediction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> 
                                <span class="n">model_dataset</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                <span class="n">transformers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="n">em</span><span class="o">.</span><span class="n">set_make_pred</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">em</span><span class="o">.</span><span class="n">on_new_best_valid</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">())</span>

        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>
        <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">LCTimerIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
            <span class="c1"># Train the model for one epoch. We turn off automatic checkpointing, so the last checkpoint</span>
            <span class="c1"># saved will be the one we created intentionally when we reached a new best validation score.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">train_perf</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span> <span class="n">test_perf</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">update_epoch</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span>
                                <span class="n">train_dset</span><span class="o">=</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">=</span><span class="n">valid_dset</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">=</span><span class="n">test_dset</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">ei</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                          <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_trained</span> <span class="o">=</span> <span class="n">ei</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># Compute performance metrics for each subset, and check if we&#39;ve reached a new best validation set score</span>
            <span class="k">if</span> <span class="n">em</span><span class="o">.</span><span class="n">should_stop</span><span class="p">():</span>
                <span class="k">break</span>

        <span class="c1"># Revert to last checkpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save</span><span class="p">()</span>

        <span class="c1"># Only copy the model files we need, not the entire directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best model from epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNModelWrapper.restore"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Restores this model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dc_torch_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_copy_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copies the files needed to recreate a DeepChem NN model from the current model</span>
<span class="sd">        directory to a destination directory.</span>

<span class="sd">        Looks at self.model.get_checkpoints() and assumes the last checkpoint saved is the best</span>

<span class="sd">        Args:</span>
<span class="sd">            dest_dir (str): The destination directory for the model files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chkpt_file</span> <span class="o">=</span> <span class="n">get_latest_pytorch_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up_excess_files</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">chkpt_file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved model files to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">dest_dir</span><span class="p">)</span>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="NNModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.NNModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset with current model, as well as standard deviations</span>
<span class="sd">        if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): tuple of predictions for compounds and standard deviation estimates, if requested.</span>
<span class="sd">            Each element of tuple is a numpy array of shape (ncmpds, ntasks, nclasses), where nclasses = 1 for regression</span>
<span class="sd">            models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Predicting values for current model&quot;</span><span class="p">)</span>

        <span class="c1"># For deepchem&#39;s predict_uncertainty function, you are not allowed to specify transformers. That means that the</span>
        <span class="c1"># predictions are being made in the transformed space, not the original space. We call undo_transforms() to generate</span>
        <span class="c1"># the transformed predictions. To transform the standard deviations, we rely on the fact that at present we only use</span>
        <span class="c1"># dc.trans.NormalizationTransformer (which centers and scales the data).</span>

        <span class="c1"># Uncertainty is now supported by DeepChem&#39;s GraphConv, at least for regression models.</span>
        <span class="c1"># if self.params.uncertainty and self.params.prediction_type == &#39;regression&#39; and self.params.featurizer != &#39;graphconv&#39;:</span>

        <span class="c1"># Current (2.1) DeepChem neural net classification models don&#39;t support uncertainties.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: DeepChem neural net models support uncertainty for regression only.&quot;</span><span class="p">)</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="c1"># For multitask, predict_uncertainty returns a list of (pred, std) tuples, one for each task.</span>
            <span class="c1"># For singletask, it returns one tuple. Convert the result into a pair of ndarrays of shape (ncmpds, ntasks, nclasses).</span>
            <span class="n">pred_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_uncertainty</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pred_std</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="c1">#JEA</span>
                <span class="c1">#ntasks = 1</span>
                <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_std</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">pred_std</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_std</span><span class="p">)</span>
                <span class="n">pred0</span><span class="p">,</span> <span class="n">std0</span> <span class="o">=</span> <span class="n">pred_std</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ncmpds</span> <span class="o">=</span> <span class="n">pred0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nclasses</span> <span class="o">=</span> <span class="n">pred0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nclasses</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pred_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nclasses</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pred_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                  <span class="c1"># Transform the standard deviations, if we can. This is a bit of a hack, but it works for</span>
                <span class="c1"># NormalizationTransformer, since the standard deviations used to scale the data are</span>
                <span class="c1"># stored in the transformer object.</span>

                <span class="c1"># =-=ksm: The second &#39;isinstance&#39; shouldn&#39;t be necessary since NormalizationTransformerMissingData</span>
                <span class="c1"># is a subclass of dc.trans.NormalizationTransformer.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformer</span><span class="p">)</span> 
                                                 <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformerMissingData</span><span class="p">)):</span>
                    <span class="n">y_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_stds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">ntasks</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">std</span> <span class="o">/</span> <span class="n">y_stds</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">undo_transforms</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">txform</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">txform</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># DeepChem models return empty list if no valid predictions</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="HybridModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">HybridModelWrapper</span><span class="p">(</span><span class="n">NNModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A wrapper for hybrid models, contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response cols</span>

<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the features</span>

<span class="sd">            transformers_w (list): Initialized as an empty list, stores the transformers on the weights</span>

<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>

<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>

<span class="sd">            model: The PyTorch NN sequential model.</span>
<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">            best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>

<span class="sd">            train_perf_data (np.array of PerfData): Initialized as an empty array, </span>
<span class="sd">                contains the predictions and performance of the training dataset</span>

<span class="sd">            valid_perf_data (np.array of PerfData): Initialized as an empty array,</span>
<span class="sd">                contains the predictions and performance of the validation dataset</span>

<span class="sd">            train_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the training dataset</span>

<span class="sd">            valid_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes HybridModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurizer object): initialized outside of model_wrapper</span>

<span class="sd">        Side effects:</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>

<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            transforsamers (list): Initialized as an empty list, stores the transformers on the response cols</span>

<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the features</span>

<span class="sd">            transformers_w (list): Initialized as an empty list, stores the transformers on the weights</span>

<span class="sd">            model: dc.models.TorchModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">,</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Shouldn&#39;t happen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You need to define default layer sizes for featurizer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>

        <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_features</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">model_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
                <span class="p">(</span><span class="s2">&quot;layer1&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;dp1&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;relu1&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">))</span>
            <span class="p">])</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)):</span>
                    <span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;layer</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                    <span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;dp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                    <span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;relu</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
            
            <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;last_layer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span> <span class="o">=</span> <span class="n">model_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">model_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Hybrid model only support regression prediction.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activity</span><span class="p">,</span> <span class="n">conc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict measurements of fractional binding/inhibition of target receptors by a compound with the given activity,</span>
<span class="sd">        in -Log scale, at the specified concentration in nM. If the given activity is pKi, a ratio to convert Ki into IC50</span>
<span class="sd">        is needed. It can be the ratio of concentration and Kd of the radioligand in a competitive binding assay, or the concentration</span>
<span class="sd">        of the substrate and Michaelis constant (Km) of enzymatic inhibition assay.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_ki</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ki_convert_ratio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Ki converting ratio is missing. Cannot convert Ki into IC50&quot;</span><span class="p">)</span>
            <span class="n">Ki</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">activity</span><span class="p">)</span>
            <span class="n">IC50</span> <span class="o">=</span> <span class="n">Ki</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ki_convert_ratio</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IC50</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">activity</span><span class="p">)</span>
        <span class="n">pred_frac</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">IC50</span><span class="o">/</span><span class="n">conc</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pred_frac</span>

    <span class="k">def</span> <span class="nf">_l2_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">yr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Da&#39;s loss function, based on L2 terms for both pKi and percent binding values</span>
<span class="sd">        This function is not appropriate for model fitting, but can be used for R^2 calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yreal</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">pos_ki</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yreal</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_bind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yreal</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">loss_ki</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yp</span><span class="p">[</span><span class="n">pos_ki</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yr</span><span class="p">[</span><span class="n">pos_ki</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_bind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loss_ki</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># convert Ki to % binding</span>
        <span class="n">y_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_stds</span>
        <span class="n">y_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_means</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_ki</span><span class="p">:</span>
            <span class="n">bind_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_binding</span><span class="p">(</span><span class="n">y_means</span> <span class="o">+</span> <span class="n">y_stds</span> <span class="o">*</span> <span class="n">yp</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">conc</span><span class="o">=</span><span class="n">yr</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bind_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_binding</span><span class="p">(</span><span class="n">y_means</span> <span class="o">+</span> <span class="n">y_stds</span> <span class="o">*</span> <span class="n">yp</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">conc</span><span class="o">=</span><span class="n">yr</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># calculate the loss_bind</span>
        <span class="n">loss_bind</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">bind_pred</span> <span class="o">-</span> <span class="n">yr</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_ki</span><span class="p">,</span> <span class="n">loss_bind</span>

    <span class="k">def</span> <span class="nf">_poisson_hybrid_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">yr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hybrid loss function based on L2 losses for deviations of predicted and measured pKi values</span>
<span class="sd">        and Poisson losses for predicted vs measured binding values. The idea is to choose loss terms</span>
<span class="sd">        that when minimized maximize the likelihood.</span>

<span class="sd">        Note that we compute both pKi and binding loss terms for compounds that have both kinds of data, since they are</span>
<span class="sd">        independent measurements. Therefore, pos_ki and pos_bind index sets may overlap.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get indices of non-missing pKi values</span>
        <span class="n">yreal</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">pos_ki</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yreal</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Get indices of non-missing binding values</span>
        <span class="n">pos_bind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yreal</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute L2 loss for pKi predictions</span>
        <span class="n">loss_ki</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yp</span><span class="p">[</span><span class="n">pos_ki</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yr</span><span class="p">[</span><span class="n">pos_ki</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#convert the ki prediction back to Ki scale</span>
        <span class="n">y_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_stds</span>
        <span class="n">y_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_means</span>
        <span class="c1"># Compute fraction bound to *radioligand* (not drug) from predicted pKi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_ki</span><span class="p">:</span>
            <span class="n">rl_bind_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_binding</span><span class="p">(</span><span class="n">y_means</span> <span class="o">+</span> <span class="n">y_stds</span> <span class="o">*</span> <span class="n">yp</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">conc</span><span class="o">=</span><span class="n">yr</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rl_bind_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_binding</span><span class="p">(</span><span class="n">y_means</span> <span class="o">+</span> <span class="n">y_stds</span> <span class="o">*</span> <span class="n">yp</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">conc</span><span class="o">=</span><span class="n">yr</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">rl_bind_real</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">yr</span><span class="p">[</span><span class="n">pos_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Compute Poisson loss for radioligand binding</span>
        <span class="n">loss_bind</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rl_bind_pred</span> <span class="o">-</span> <span class="n">rl_bind_real</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rl_bind_pred</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss_ki</span><span class="o">.</span><span class="n">item</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Ki loss is NaN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss_bind</span><span class="o">.</span><span class="n">item</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Binding loss is NaN&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_ki</span><span class="p">,</span> <span class="n">loss_bind</span>

    <span class="k">def</span> <span class="nf">_loss_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute loss_func for the batch xb, yb. If opt is provided, perform a training</span>
<span class="sd">        step on the model weights.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loss_ki</span><span class="p">,</span> <span class="n">loss_bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">),</span> <span class="n">yb</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_ki</span> <span class="o">+</span> <span class="n">loss_bind</span>
        
        <span class="k">if</span> <span class="n">opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>   
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">loss_ki</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">loss_bind</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

<div class="viewcode-block" id="HybridModelWrapper.SubsetData"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper.SubsetData">[docs]</a>    <span class="k">class</span> <span class="nc">SubsetData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Container for DataLoader object and attributes of a dataset subset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">n_ki</span><span class="p">,</span> <span class="n">n_bind</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="n">dl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_ki</span> <span class="o">=</span> <span class="n">n_ki</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_bind</span> <span class="o">=</span> <span class="n">n_bind</span></div>
    
    <span class="k">def</span> <span class="nf">_tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_hybrid_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the DeepChem dataset into the SubsetData for hybrid model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_valid_dsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>
        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c1"># datasets were normalized in previous steps</span>
            <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tensorize</span><span class="p">,</span> <span class="p">(</span><span class="n">train_dset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># train</span>
            <span class="n">train_ki_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">train_bind_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># valid</span>
            <span class="n">valid_ki_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_valid</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">valid_bind_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_valid</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">train_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">train_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubsetData</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> 
                                        <span class="n">train_dl</span><span class="p">,</span> 
                                        <span class="nb">len</span><span class="p">(</span><span class="n">train_ki_pos</span><span class="p">),</span> 
                                        <span class="nb">len</span><span class="p">(</span><span class="n">train_bind_pos</span><span class="p">))</span>

            <span class="n">valid_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
            <span class="n">valid_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">valid_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubsetData</span><span class="p">(</span><span class="n">valid_ds</span><span class="p">,</span> 
                                        <span class="n">valid_dl</span><span class="p">,</span> 
                                        <span class="nb">len</span><span class="p">(</span><span class="n">valid_ki_pos</span><span class="p">),</span> 
                                        <span class="nb">len</span><span class="p">(</span><span class="n">valid_bind_pos</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_data</span><span class="p">,</span> <span class="n">valid_data</span><span class="p">))</span>

        <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tensorize</span><span class="p">,</span> <span class="p">(</span><span class="n">test_dset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">test_ki_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">test_bind_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">test_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="n">test_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubsetData</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> 
                                    <span class="n">test_dl</span><span class="p">,</span> 
                                    <span class="nb">len</span><span class="p">(</span><span class="n">test_ki_pos</span><span class="p">),</span> 
                                    <span class="nb">len</span><span class="p">(</span><span class="n">test_bind_pos</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span>
    
<div class="viewcode-block" id="HybridModelWrapper.save_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_file</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a model to a checkpoint file.</span>
<span class="sd">        Include epoch, model_dict in checkpoint dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
            <span class="n">model_state_dict</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="n">opt_state_dict</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="n">model_dict</span><span class="o">=</span><span class="n">model_dict</span>
            <span class="p">)</span>
        
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">checkpoint_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="HybridModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;poisson&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poisson_hybrid_loss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l2_loss</span>

        <span class="c1"># load hybrid data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_hybrid_data</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> 
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_model_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

        <span class="n">em</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">EpochManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">prediction_type</span><span class="o">=</span><span class="s2">&quot;hybrid&quot;</span><span class="p">,</span>
                                <span class="n">model_dataset</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">transformers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span>
                                <span class="n">is_ki</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_ki</span><span class="p">,</span>
                                <span class="n">ki_convert_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ki_convert_ratio</span><span class="p">)</span>

        <span class="n">em</span><span class="o">.</span><span class="n">set_make_pred</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_predictions</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># initialize ei here so we can use it in the closure</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">em</span><span class="o">.</span><span class="n">on_new_best_valid</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
            <span class="n">opt</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">))</span>

        <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Currently the hybrid model  doesn&#39;t support K-fold cross validation splitting.&quot;</span><span class="p">)</span>
        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>
        <span class="n">train_data</span><span class="p">,</span> <span class="n">valid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">LCTimerIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">):</span>
            <span class="c1"># Train the model for one epoch. We turn off automatic checkpointing, so the last checkpoint</span>
            <span class="c1"># saved will be the one we created intentionally when we reached a new best validation score.</span>
            <span class="n">train_loss_ep</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">dl</span><span class="p">):</span>
                <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                <span class="n">yb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                <span class="n">train_loss_ki</span><span class="p">,</span> <span class="n">train_loss_bind</span><span class="p">,</span> <span class="n">train_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
                <span class="n">train_loss_ep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">train_loss_ki</span> <span class="o">+</span> <span class="n">train_loss_bind</span><span class="p">)</span>
            <span class="n">train_loss_ep</span> <span class="o">/=</span> <span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">n_ki</span> <span class="o">+</span> <span class="n">train_data</span><span class="o">.</span><span class="n">n_bind</span><span class="p">)</span>

            <span class="c1"># validation set</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">valid_loss_ep</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">dl</span><span class="p">:</span>
                    <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                    <span class="n">yb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                    <span class="n">valid_loss_ki</span><span class="p">,</span> <span class="n">valid_loss_bind</span><span class="p">,</span> <span class="n">valid_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
                    <span class="n">valid_loss_ep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">valid_loss_ki</span> <span class="o">+</span> <span class="n">valid_loss_bind</span><span class="p">)</span>
                <span class="n">valid_loss_ep</span> <span class="o">/=</span> <span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">n_ki</span> <span class="o">+</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">n_bind</span><span class="p">)</span>

            <span class="n">train_perf</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span> <span class="n">test_perf</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">update_epoch</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span>
                                <span class="n">train_dset</span><span class="o">=</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">=</span><span class="n">valid_dset</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">=</span><span class="n">test_dset</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, training loss = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation loss = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">ei</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">train_loss_ep</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span> <span class="n">valid_loss_ep</span><span class="p">,</span>
                          <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

            <span class="c1"># Compute performance metrics for each subset, and check if we&#39;ve reached a new best validation set score</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_trained</span> <span class="o">=</span> <span class="n">ei</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">em</span><span class="o">.</span><span class="n">should_stop</span><span class="p">():</span>
                <span class="k">break</span>
 
        <span class="c1"># Revert to last checkpoint</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;opt_state_dict&#39;</span><span class="p">])</span>

        <span class="c1"># copy the best model checkpoint file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best model from epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="HybridModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a saved neural net model from the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>
<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, and transformers_x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_model_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_uuid</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">):</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_dict&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint file doesn&#39;t exist in the reload_dir </span><span class="si">{</span><span class="n">reload_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Restore the transformers from the datastore or filesystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_transformers</span><span class="p">()</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="HybridModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset with current model, as well as standard deviations</span>
<span class="sd">        if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): tuple of predictions for compounds and standard deviation estimates, if requested.</span>
<span class="sd">            Each element of tuple is a numpy array of shape (ncmpds, ntasks, nclasses), where nclasses = 1 for regression</span>
<span class="sd">            models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Predicting values for current model&quot;</span><span class="p">)</span>

        <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tensorize</span><span class="p">,</span> <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">has_conc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">y_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">data_ki_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_conc</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_bind_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_conc</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">data_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
        <span class="n">data_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubsetData</span><span class="p">(</span><span class="n">data_ds</span><span class="p">,</span> 
                                    <span class="n">data_dl</span><span class="p">,</span> 
                                    <span class="nb">len</span><span class="p">(</span><span class="n">data_ki_pos</span><span class="p">),</span> 
                                    <span class="nb">len</span><span class="p">(</span><span class="n">data_bind_pos</span><span class="p">))</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">real</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">data_dl</span><span class="p">:</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
            <span class="n">yb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">)):</span>
                <span class="n">real</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yp</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">real</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_conc</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pred</span><span class="p">,</span> <span class="n">real</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">untransform</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">isreal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">pred_bind_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pred</span><span class="p">[</span><span class="n">pred_bind_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_binding</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">pred_bind_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="n">pred_bind_pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">untransform</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">isreal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_conc</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pred</span><span class="p">,</span> <span class="n">real</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="HybridModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.HybridModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to hybrid models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metdata (dict): A dictionary of the parameter sets for the HybridModelWrapper object.</span>
<span class="sd">                Parameters are saved under the key &#39;hybrid_specific&#39; as a subdictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nn_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">,</span>
                    <span class="n">max_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">layer_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">hybrid_specific</span> <span class="o">=</span> <span class="n">nn_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_create_output_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize transformers for responses and persist them for later.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dataset: The ModelDataset object that handles the current dataset</span>

<span class="sd">        Side effects</span>
<span class="sd">            Overwrites the attributes:</span>
<span class="sd">                transformers: A list of deepchem transformation objects on response_col, only if conditions are met</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Just a warning, we may have response transformers for classification datasets in the future</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="o">==</span><span class="s1">&#39;regression&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="o">=</span> <span class="p">[</span><span class="n">trans</span><span class="o">.</span><span class="n">NormalizationTransformerHybrid</span><span class="p">(</span><span class="n">transform_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">model_dataset</span><span class="o">.</span><span class="n">dataset</span><span class="p">)]</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ForestModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ForestModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">ForestModelWrapper</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class for DCRFModelWrapper and DCxgboostModelWrapper</span>

<span class="sd">    contains code that is similar between the two tree based classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes DCRFModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">            ds_client: datastore client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dc_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ForestModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ForestModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a forest model and saves the trained model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem random forest models</span>

<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>

<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>

<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>

<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>

        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span>

            <span class="n">train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">train_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">train_pred</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">valid_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">valid_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">valid_pred</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">test_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">k</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                             <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>


        <span class="c1"># Compute mean and SD of performance metrics across validation sets for all folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>

        <span class="c1"># Compute score to be used for ranking model hyperparameter sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_choice_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">model_choice_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_choice_score_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For k-fold CV, retrain on the combined training and validation sets</span>
            <span class="n">fit_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">combined_training_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save</span><span class="p">()</span>
        <span class="c1"># The best model is just the single RF training run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ForestModelWrapper.make_dc_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ForestModelWrapper.make_dc_model">[docs]</a>    <span class="k">def</span> <span class="nf">make_dc_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a DeepChem model.</span>

<span class="sd">        Builds a model, wraps it in DeepChem&#39;s wrapper and returns it</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where saved model is located.</span>

<span class="sd">        returns:</span>
<span class="sd">            A DeepChem model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ForestModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ForestModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a saved random forest model from the specified directory. Also loads any transformers that</span>
<span class="sd">        were saved with it.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>

<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, transformers_x and transformers_w</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restore the transformers from the datastore or filesystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_transformers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dc_model</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ForestModelWrapper.get_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ForestModelWrapper.get_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset: &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39; accordingly.</span>

<span class="sd">            epoch_label: ignored; this function always returns the results for the current model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary of parameter, value pairs, in the format expected by the</span>
<span class="sd">            prediction_results element of the ModelMetrics data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="ForestModelWrapper.get_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.ForestModelWrapper.get_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39;</span>

<span class="sd">            epoch_label (not used in random forest, but kept as part of the method structure)</span>

<span class="sd">        Results:</span>
<span class="sd">            PerfData object: Subclass of perfdata object associated with the appropriate subset&#39;s split strategy and prediction type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="c1">#return self.get_test_perf_data(self.best_model_dir, self.data)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to clean up extra model files left behind in the training process.</span>
<span class="sd">        Does not apply to Forest models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">DCRFModelWrapper</span><span class="p">(</span><span class="n">ForestModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurization (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>
<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            model: The dc.models.sklearn_models.SklearnModel as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem random forest models</span>
<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes DCRFModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">            ds_client: datastore client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.make_dc_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.make_dc_model">[docs]</a>    <span class="k">def</span> <span class="nf">make_dc_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a DeepChem model.</span>

<span class="sd">        Builds a model, wraps it in DeepChem&#39;s wrapper and returns it</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where saved model is located.</span>

<span class="sd">        returns:</span>
<span class="sd">            A DeepChem model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
                                             <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
                                             <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="p">,</span>
                                             <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
                                              <span class="n">max_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
                                              <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="p">,</span>
                                              <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">sklearn_models</span><span class="o">.</span><span class="n">SklearnModel</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a random forest model and saves the trained model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem random forest models</span>

<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>

<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>

<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>

<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting random forest model&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset, as well as uncertainty values if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): numpy arrays containing predictions for compounds and the standard error estimates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evaluating current model&quot;</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="n">ncmpds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="n">rf_model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">,</span> <span class="s1">&#39;model.joblib&#39;</span><span class="p">))</span>
                <span class="c1">## s.d. from forest</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">RF_per_tree_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">undo_transforms</span><span class="p">(</span>
                        <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">RF_per_tree_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>

                <span class="c1"># Don&#39;t need to &quot;untransform&quot; standard deviations here, since they&#39;re calculated from</span>
                <span class="c1"># the untransformed per-tree predictions.</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">RF_per_tree_pred</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We can estimate uncertainty for binary classifiers, but not multiclass (yet)</span>
                <span class="n">nclasses</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nclasses</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ntrees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span>
                    <span class="c1"># Use normal approximation to binomial sampling error. Later we can do Jeffrey&#39;s interval if we</span>
                    <span class="c1"># want to get fancy.</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pred</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">ntrees</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: Random forest only supports uncertainties for binary classifiers.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCRFModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCRFModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to random forest models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metadata (dict): Returns random forest specific metadata as a subdict under the key &#39;rf_specific&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rf_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rf_estimators&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="p">,</span>
            <span class="s1">&#39;rf_max_features&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="p">,</span>
            <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span>
        <span class="p">}</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rf_specific</span> <span class="o">=</span> <span class="n">rf_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div></div>
    
<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">DCxgboostModelWrapper</span><span class="p">(</span><span class="n">ForestModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurization (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response cols</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the features</span>
<span class="sd">            transformers_w (list): Initialized as an empty list, stores the transformers on the weights</span>
<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            model: The dc.models.sklearn_models.SklearnModel as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable</span>
<span class="sd">            train_perf_data (PerfObjects): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfObjects): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes RunModel object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">            ds_client: datastore client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.make_dc_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.make_dc_model">[docs]</a>    <span class="k">def</span> <span class="nf">make_dc_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a DeepChem model.</span>

<span class="sd">        Builds a model, wraps it in DeepChem&#39;s wrapper and returns it</span>

<span class="sd">        Args:</span>
<span class="sd">            model_dir (str): Directory where saved model is located.</span>

<span class="sd">        returns:</span>
<span class="sd">            A DeepChem model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                         <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;reg:squarederror&#39;</span><span class="p">,</span>
                                         <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                         <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                         <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                         <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                         <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                         <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">missing</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                         <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                         <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">gpu_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                                         <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                          <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
                                          <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                          <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                          <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                          <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                          <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                          <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                          <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                          <span class="n">missing</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                          <span class="n">gpu_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>                                          
                                          <span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                                         <span class="p">)</span>

        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">sklearn_models</span><span class="o">.</span><span class="n">SklearnModel</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.train"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a xgboost model and saves the trained model.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline (ModelPipeline): The ModelPipeline instance for this model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">            best_epoch (int): Set to 0, not applicable to deepchem xgboost models</span>

<span class="sd">            train_perf_data (PerfData): Contains the predictions and performance of the training dataset</span>

<span class="sd">            valid_perf_data (PerfData): Contains the predictions and performance of the validation dataset</span>

<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>

<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting xgboost model&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">create_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="n">test_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_dset</span>

        <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="n">train_dset</span><span class="p">,</span> <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_valid_dsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span>

            <span class="n">train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">train_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">train_pred</span><span class="p">,</span> <span class="n">train_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">valid_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">valid_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">valid_pred</span><span class="p">,</span> <span class="n">valid_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

            <span class="n">test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">test_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">accumulate_preds</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_dset</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">%d</span><span class="s2">: training </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, validation </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">, test </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">k</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">train_perf</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">valid_perf</span><span class="p">,</span>
                             <span class="n">pipeline</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="n">test_perf</span><span class="p">))</span>

        <span class="c1"># Compute mean and SD of performance metrics across validation sets for all folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_perf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="o">.</span><span class="n">compute_perf_metrics</span><span class="p">()</span>

        <span class="c1"># Compute score to be used for ranking model hyperparameter sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_choice_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="o">.</span><span class="n">model_choice_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_choice_score_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For k-fold CV, retrain on the combined training and validation sets</span>
            <span class="n">fit_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">combined_training_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fit_dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save</span><span class="p">()</span>
        <span class="c1"># The best model is just the single xgb training run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a saved xgboost model from the specified directory. Also loads any transformers that</span>
<span class="sd">        were saved with it.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>

<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, transformers_x and transformers_w</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                         <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;reg:squarederror&#39;</span><span class="p">,</span>
                                         <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                         <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                         <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                         <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                         <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                         <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">missing</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                         <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                         <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">gpu_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                                         <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                                         <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                                         <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                                         <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
                                         <span class="n">booster</span><span class="o">=</span><span class="s1">&#39;gbtree&#39;</span><span class="p">,</span>
                                         <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                                         <span class="n">min_child_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                                         <span class="n">max_delta_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                                         <span class="n">colsample_bytree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span><span class="p">,</span>
                                         <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">reg_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">base_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                                         <span class="n">missing</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                         <span class="n">gpu_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>                                          
                                         <span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">max_bin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                                         <span class="p">)</span>

        <span class="c1"># Restore the transformers from the datastore or filesystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_transformers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GBDTModel</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.get_pred_results"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.get_pred_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset: &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39; accordingly.</span>

<span class="sd">            epoch_label: ignored; this function always returns the results for the current model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary of parameter, value pairs, in the format expected by the</span>
<span class="sd">            prediction_results element of the ModelMetrics data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_valid_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_pred_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.get_perf_data"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.get_perf_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns predicted values and metrics from a training, validation or test subset</span>
<span class="sd">        of the current dataset, or the full dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset (str): may be &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; or &#39;full&#39;</span>

<span class="sd">            epoch_label (not used in random forest, but kept as part of the method structure)</span>

<span class="sd">        Results:</span>
<span class="sd">            PerfData object: Subclass of perfdata object associated with the appropriate subset&#39;s split strategy and prediction type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if subset not in [&#39;train&#39;,&#39;valid&#39;,&#39;test&#39;,&#39;full&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="c1">#return self.get_test_perf_data(self.best_model_dir, self.data)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_perf_data</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_dataset_perf_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown dataset subset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">subset</span><span class="p">)</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.generate_predictions"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.generate_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates predictions for specified dataset, as well as uncertainty values if params.uncertainty=True</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: the deepchem DiskDataset to generate predictions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pred, std): numpy arrays containing predictions for compounds and the standard error estimates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pred</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Evaluating current model&quot;</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">)</span>
        <span class="n">ncmpds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncmpds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;uncertainty not supported by xgboost models&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">std</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="DCxgboostModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.DCxgboostModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to xgboost models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metadata (dict): Returns xgboost specific metadata as a subdict under the key &#39;xgb_specific&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xgb_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xgb_max_depth&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_max_depth</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_learning_rate&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_n_estimators&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_n_estimators</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_gamma&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_min_child_weight&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_min_child_weight</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_subsample&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_subsample</span><span class="p">,</span>
                       <span class="s2">&quot;xgb_colsample_bytree&quot;</span>  <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_colsample_bytree</span>
                        <span class="p">}</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xgb_specific</span><span class="o">=</span><span class="n">xgb_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div>

    <span class="c1"># ****************************************************************************************</span>
    <span class="k">def</span> <span class="nf">_clean_up_excess_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to clean up extra model files left behind in the training process.</span>
<span class="sd">        Does not apply to xgboost</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PytorchDeepChemModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.PytorchDeepChemModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">PytorchDeepChemModelWrapper</span><span class="p">(</span><span class="n">NNModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of AttentiveFP model from Xiong et al. [1]_. It uses a graph attention model</span>
<span class="sd">    to propagate information from bond and neighboring atom features across a molecule represented as</span>
<span class="sd">    a graph.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Xiong, Zhaoping et al. &quot;Pushing the Boundaries of Molecular Representation for Drug Discovery</span>
<span class="sd">    with the Graph Attention Mechanism.&quot; Journal of Medicinal Chemistry (2019) </span>
<span class="sd">    doi: 10.1021/acs.jmedchem.0b00959</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurization (Featurization object): The featurization object created outside of model_wrapper</span>
<span class="sd">            log (log): The logger</span>
<span class="sd">            output_dir (str): The parent path of the model directory</span>
<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>
<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>
<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>
<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>
<span class="sd">            model: The dc.models.sklearn_models.SklearnModel as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>
<span class="sd">            best_epoch (int): Set to 0, not applicable</span>
<span class="sd">            train_perf_data (PerfObjects): Contains the predictions and performance of the training dataset</span>
<span class="sd">            valid_perf_data (PerfObjects): Contains the predictions and performance of the validation dataset</span>
<span class="sd">            train_perfs (dict): A dictionary of predicted values and metrics on the training dataset</span>
<span class="sd">            valid_perfs (dict): A dictionary of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes AttentiveFPModelWrapper object. Creates the underlying DeepChem AttentiveFPModel instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurization): Object managing the featurization of compounds</span>
<span class="sd">            ds_client: datastore client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># use NNModelWrapper init. </span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_trained</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">()</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PytorchDeepChemModelWrapper.recreate_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.PytorchDeepChemModelWrapper.recreate_model">[docs]</a>    <span class="k">def</span> <span class="nf">recreate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new DeepChem Model object of the correct type for the requested featurizer and prediction type </span>
<span class="sd">        and returns it.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs: These arguments are used to overwrite parameters set in self.params and</span>
<span class="sd">                are passed to the underlying deepchem model object. e.g. model_dir is set in self.reload_model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># extract parameters specific to this model</span>
        <span class="n">extracted_features</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">extract_model_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># model_dir is set and handled by AMPL.</span>
        <span class="n">extracted_features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;model_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">})</span>

        <span class="c1"># parameters can be overwritten by passing them explicitly</span>
        <span class="n">extracted_features</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">chosen_model</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">model_wl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Args passed to </span><span class="si">{</span><span class="n">chosen_model</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">extracted_features</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># build the model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">chosen_model</span><span class="p">(</span>
                <span class="o">**</span><span class="n">extracted_features</span>
            <span class="p">)</span> 

        <span class="k">return</span> <span class="n">model</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PytorchDeepChemModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.PytorchDeepChemModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a saved neural net model from the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>
<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, and transformers_x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="n">reload_dir</span><span class="p">)</span>
        <span class="c1"># checkpoint with the highest number is the best one</span>
        <span class="n">best_chkpt</span> <span class="o">=</span> <span class="n">get_latest_pytorch_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">best_chkpt</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">)</span>

        <span class="c1"># Restore the transformers from the datastore or filesystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_transformers</span><span class="p">()</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="PytorchDeepChemModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.PytorchDeepChemModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to neural network models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metdata (dict): A dictionary of the parameter sets for the NNModelWrapper object.</span>
<span class="sd">                Parameters are saved under the key &#39;nn_specific&#39; as a subdictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nn_metadata</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">extract_model_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">strip_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nn_metadata</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span>
        <span class="n">nn_metadata</span><span class="p">[</span><span class="s1">&#39;best_epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nn_specific</span> <span class="o">=</span> <span class="n">nn_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div>

<div class="viewcode-block" id="PytorchDeepChemModelWrapper.restore"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.PytorchDeepChemModelWrapper.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Restores this model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dc_torch_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="PytorchDeepChemModelWrapper.count_params"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.PytorchDeepChemModelWrapper.count_params">[docs]</a>    <span class="k">def</span> <span class="nf">count_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the number of trainable parameters</span>

<span class="sd">        There&#39;s no function implemented in Pytorch that does this so I&#39;m using the</span>
<span class="sd">        solution found here:https://discuss.pytorch.org/t/how-do-i-check-the-number-of-parameters-of-a-model/4325/25</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns</span>
<span class="sd">            Int- the number of trainable parameters</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pytorch_total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pytorch_total_params</span></div></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="MultitaskDCModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.MultitaskDCModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">MultitaskDCModelWrapper</span><span class="p">(</span><span class="n">PytorchDeepChemModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>

<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>

<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>

<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>

<span class="sd">            g: The tensorflow graph object</span>

<span class="sd">            sess: The tensor flow graph session</span>

<span class="sd">            model: The dc.models.GraphConvModel, MultitaskRegressor, or MultitaskClassifier object, as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">            best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>

<span class="sd">            train_perf_data (np.array of PerfData): Initialized as an empty array, </span>
<span class="sd">                contains the predictions and performance of the training dataset</span>

<span class="sd">            valid_perf_data (np.array of PerfData): Initialized as an empty array,</span>
<span class="sd">                contains the predictions and performance of the validation dataset</span>

<span class="sd">            train_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the training dataset</span>

<span class="sd">            valid_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultitaskDCModelWrapper.recreate_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.MultitaskDCModelWrapper.recreate_model">[docs]</a>    <span class="k">def</span> <span class="nf">recreate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new DeepChem Model object of the correct type for the requested featurizer and prediction type </span>
<span class="sd">        and returns it.</span>

<span class="sd">        reload_dir (str): Directory where saved model is located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span>

        <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_features</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">,</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Shouldn&#39;t happen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You need to define default layer sizes for featurizer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>

            <span class="c1"># TODO: Need to check that MultitaskRegressor params are actually being used</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">MultitaskRegressor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                <span class="n">n_features</span><span class="p">,</span>
                <span class="n">layer_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                <span class="n">dropouts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                <span class="n">weight_init_stddevs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                <span class="n">bias_init_consts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="n">model_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
                <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Need to check that MultitaskClassifier params are actually being used</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">MultitaskClassifier</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
                <span class="n">n_features</span><span class="p">,</span>
                <span class="n">layer_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                <span class="n">dropouts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                <span class="n">weight_init_stddevs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                <span class="n">bias_init_consts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="n">model_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
                <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">beta1</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span>
                <span class="n">beta2</span><span class="o">=</span><span class="mf">.999</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
                <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">n_classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">class_number</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="MultitaskDCModelWrapper.generate_embeddings"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.MultitaskDCModelWrapper.generate_embeddings">[docs]</a>    <span class="k">def</span> <span class="nf">generate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the output of the final embedding layer of a fully connected NN model for the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset:</span>

<span class="sd">        Returns:</span>
<span class="sd">            embedding (np.ndarray): An array of outputs from the nodes in the embedding layer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_embedding</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="MultitaskDCModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.MultitaskDCModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to neural network models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metdata (dict): A dictionary of the parameter sets for the MultitaskDCModelWrapper object.</span>
<span class="sd">                Parameters are saved under the key &#39;nn_specific&#39; as a subdictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">nn_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">,</span>
                    <span class="n">max_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">optimizer_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">layer_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span>
        <span class="p">)</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nn_specific</span> <span class="o">=</span> <span class="n">nn_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="KerasDeepChemModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.KerasDeepChemModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">KerasDeepChemModelWrapper</span><span class="p">(</span><span class="n">PytorchDeepChemModelWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_copy_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copies the files needed to recreate a DeepChem NN model from the current model</span>
<span class="sd">        directory to a destination directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            dest_dir (str): The destination directory for the model files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chkpt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">chkpt_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">chkpt_in</span><span class="p">:</span>
            <span class="n">chkpt_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">chkpt_in</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">chkpt_prefix</span> <span class="o">=</span> <span class="n">chkpt_dict</span><span class="p">[</span><span class="s1">&#39;model_checkpoint_path&#39;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">chkpt_file</span><span class="p">]</span>
        <span class="c1"># files.append(os.path.join(self.model_dir, &#39;model.pickle&#39;))</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.index&#39;</span> <span class="o">%</span> <span class="n">chkpt_prefix</span><span class="p">))</span>
        <span class="c1"># files.append(os.path.join(self.model_dir, &#39;%s.meta&#39; % chkpt_prefix))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.data-*&#39;</span> <span class="o">%</span> <span class="n">chkpt_prefix</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up_excess_files</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved model files to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">dest_dir</span><span class="p">)</span>

<div class="viewcode-block" id="KerasDeepChemModelWrapper.reload_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.KerasDeepChemModelWrapper.reload_model">[docs]</a>    <span class="k">def</span> <span class="nf">reload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a saved neural net model from the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            reload_dir (str): Directory where saved model is located.</span>
<span class="sd">            model_dataset (ModelDataset Object): contains the current full dataset</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Resets the value of model, transformers, and transformers_x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="n">reload_dir</span><span class="p">)</span>

        <span class="c1"># Get latest checkpoint path transposed to current model dir</span>
        <span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">get_checkpoint_state</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckpt</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="si">}</span><span class="s2">.index&quot;</span><span class="p">):</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ckpt</span><span class="o">.</span><span class="n">model_checkpoint_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reload_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ckpt</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="c1"># Restore the transformers from the datastore or filesystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload_transformers</span><span class="p">()</span></div>

<div class="viewcode-block" id="KerasDeepChemModelWrapper.restore"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.KerasDeepChemModelWrapper.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Restores this model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dc_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></div>

<div class="viewcode-block" id="KerasDeepChemModelWrapper.count_params"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.KerasDeepChemModelWrapper.count_params">[docs]</a>    <span class="k">def</span> <span class="nf">count_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the number of trainable parameters using Keras&#39; count_params function</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns</span>
<span class="sd">            Int- the number of trainable parameters using Keras&#39; count_params function</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">count_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_weights</span><span class="p">)</span></div></div>

<span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="GraphConvDCModelWrapper"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.GraphConvDCModelWrapper">[docs]</a><span class="k">class</span> <span class="nc">GraphConvDCModelWrapper</span><span class="p">(</span><span class="n">KerasDeepChemModelWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains methods to load in a dataset, split and featurize the data, fit a model to the train dataset,</span>
<span class="sd">    generate predictions for an input dataset, and generate performance metrics for these predictions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Set in __init__</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>
<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>

<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>

<span class="sd">            model_dir (str): The subdirectory under output_dir that contains the model. Created in setup_model_dirs.</span>

<span class="sd">            best_model_dir (str): The subdirectory under output_dir that contains the best model. Created in setup_model_dirs</span>

<span class="sd">            g: The tensorflow graph object</span>

<span class="sd">            sess: The tensor flow graph session</span>

<span class="sd">            model: The dc.models.GraphConvModel, MultitaskRegressor, or MultitaskClassifier object, as specified by the params attribute</span>

<span class="sd">        Created in train:</span>
<span class="sd">            data (ModelDataset): contains the dataset, set in pipeline</span>

<span class="sd">            best_epoch (int): Initialized as None, keeps track of the epoch with the best validation score</span>

<span class="sd">            train_perf_data (np.array of PerfData): Initialized as an empty array, </span>
<span class="sd">                contains the predictions and performance of the training dataset</span>

<span class="sd">            valid_perf_data (np.array of PerfData): Initialized as an empty array,</span>
<span class="sd">                contains the predictions and performance of the validation dataset</span>

<span class="sd">            train_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the training dataset</span>

<span class="sd">            valid_epoch_perfs (np.array of dicts): Initialized as an empty array,</span>
<span class="sd">                contains a list of dictionaries of predicted values and metrics on the validation dataset</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes GraphConvDCModelWrapper object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Namespace object): contains all parameter information.</span>

<span class="sd">            featurizer (Featurizer object): initialized outside of model_wrapper</span>

<span class="sd">        Side effects:</span>
<span class="sd">            params (argparse.Namespace): The argparse.Namespace parameter object that contains all parameter information</span>

<span class="sd">            featurziation (Featurization object): The featurization object created outside of model_wrapper</span>

<span class="sd">            log (log): The logger</span>

<span class="sd">            output_dir (str): The parent path of the model directory</span>

<span class="sd">            transformers (list): Initialized as an empty list, stores the transformers on the response col</span>

<span class="sd">            transformers_x (list): Initialized as an empty list, stores the transformers on the featurizers</span>

<span class="sd">            g: The tensorflow graph object</span>

<span class="sd">            sess: The tensor flow graph session</span>

<span class="sd">            model: The dc.models.GraphConvModel, MultitaskRegressor, or MultitaskClassifier object, as specified by the params attribute</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">ds_client</span><span class="p">)</span>
        <span class="c1"># TODO (ksm): The next two attributes aren&#39;t used; suggest we drop them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs_trained</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recreate_model</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="GraphConvDCModelWrapper.recreate_model"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.GraphConvDCModelWrapper.recreate_model">[docs]</a>    <span class="k">def</span> <span class="nf">recreate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new DeepChem Model object of the correct type for the requested featurizer and prediction type </span>
<span class="sd">        and returns it.</span>

<span class="sd">        reload_dir (str): Directory where saved model is located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span>

        <span class="c1"># Set defaults for layer sizes and dropouts, if not specified by caller. Note that</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GraphConvModel</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_model_tasks</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">learning_rate_decay_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">optimizer_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
            <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
            <span class="n">model_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">graph_conv_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dense_layer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
            <span class="n">penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
            <span class="n">penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="GraphConvDCModelWrapper.generate_embeddings"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.GraphConvDCModelWrapper.generate_embeddings">[docs]</a>    <span class="k">def</span> <span class="nf">generate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the output of the final embedding layer of a GraphConv model for the given dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset:</span>

<span class="sd">        Returns:</span>
<span class="sd">            embedding (np.ndarray): An array of outputs from the nodes in the embedding layer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_embedding</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span></div>


    <span class="c1"># ****************************************************************************************</span>
<div class="viewcode-block" id="GraphConvDCModelWrapper.get_model_specific_metadata"><a class="viewcode-back" href="../../pipeline.html#pipeline.model_wrapper.GraphConvDCModelWrapper.get_model_specific_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_specific_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of parameter settings for this ModelWrapper object that are specific</span>
<span class="sd">        to neural network models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model_spec_metdata (dict): A dictionary of the parameter sets for the GraphConvDCModelWrapper object.</span>
<span class="sd">                Parameters are saved under the key &#39;nn_specific&#39; as a subdictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nn_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span><span class="p">,</span>
                    <span class="n">max_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">optimizer_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">optimizer_type</span><span class="p">,</span>
                    <span class="n">layer_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span>
                    <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                    <span class="n">weight_init_stddevs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_init_stddevs</span><span class="p">,</span>
                    <span class="n">bias_init_consts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bias_init_consts</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
                    <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weight_decay_penalty_type</span>
        <span class="p">)</span>
        <span class="n">model_spec_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nn_specific</span> <span class="o">=</span> <span class="n">nn_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_spec_metadata</span></div></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ATOM DDM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>