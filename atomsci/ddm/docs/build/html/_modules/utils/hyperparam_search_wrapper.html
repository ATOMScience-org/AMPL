<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>utils.hyperparam_search_wrapper &mdash; ATOM Data-Driven Modeling Pipeline 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ATOM Data-Driven Modeling Pipeline
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/running_ampl.html">Running AMPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_ampl_usage.html">Advanced AMPL Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_testing.html">Advanced Testing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">atomsci</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">utils.hyperparam_search_wrapper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for utils.hyperparam_search_wrapper</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># noinspection SpellCheckingInspection</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to generate hyperparameter combinations based on input params and send off jobs to a slurm system.</span>
<span class="sd">Author: Amanda Minnich</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># from __future__ import unicode_literals</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">numpy.core.numeric</span> <span class="kn">import</span> <span class="n">NaN</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">hyperopt</span> <span class="kn">import</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">tpe</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">Trials</span><span class="p">,</span> <span class="n">STATUS_OK</span>

<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">featurization</span> <span class="k">as</span> <span class="n">feat</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_pipeline</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">parameter_parser</span> <span class="k">as</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_datasets</span> <span class="k">as</span> <span class="n">model_datasets</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.utils</span> <span class="kn">import</span> <span class="n">datastore_functions</span> <span class="k">as</span> <span class="n">dsf</span>
<span class="kn">from</span> <span class="nn">atomsci.ddm.pipeline</span> <span class="kn">import</span> <span class="n">model_tracker</span> <span class="k">as</span> <span class="n">trkr</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)-15s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pdb</span>


<div class="viewcode-block" id="run_command"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.run_command">[docs]</a><span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">shell_script</span><span class="p">,</span> <span class="n">python_path</span><span class="p">,</span> <span class="n">script_dir</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to submit jobs on a slurm system</span>

<span class="sd">    Args:</span>
<span class="sd">        shell_script: Name of shell script to run</span>

<span class="sd">        python_path: Path to python version</span>

<span class="sd">        script_dir: Directory where script lives</span>

<span class="sd">        params: parameters in dictionary format</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dataset_hash sneaks into params.</span>
    <span class="n">new_params</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">parse</span><span class="o">.</span><span class="n">remove_unrecognized_arguments</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
    <span class="c1"># It&#39;s necessary to make this call here becausae it makes sense for </span>
    <span class="c1"># relative paths to be calucated relative to the .json file, not to </span>
    <span class="c1"># wherever maestro will eventually run the model_pipeline script</span>
    <span class="n">parse</span><span class="o">.</span><span class="n">make_dataset_key_absolute</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
    <span class="n">params_str</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
    <span class="n">slurm_command</span> <span class="o">=</span> <span class="s1">&#39;sbatch </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> &quot;</span><span class="si">{3}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shell_script</span><span class="p">,</span> <span class="n">python_path</span><span class="p">,</span> <span class="n">script_dir</span><span class="p">,</span> <span class="n">params_str</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">slurm_command</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">slurm_command</span><span class="p">)</span></div>

<div class="viewcode-block" id="gen_maestro_command"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.gen_maestro_command">[docs]</a><span class="k">def</span> <span class="nf">gen_maestro_command</span><span class="p">(</span><span class="n">python_path</span><span class="p">,</span> <span class="n">script_dir</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a string that can be fed into a command line.</span>

<span class="sd">    Side Effects:</span>
<span class="sd">        Dataset key will be converted to an absolute path before</span>
<span class="sd">            returned. It&#39;s difficult to predict the working directory</span>
<span class="sd">            used when maestro runs the script.</span>

<span class="sd">    Args:</span>
<span class="sd">        shell_script: Name of shell script to run</span>

<span class="sd">        python_path: Path to python version</span>

<span class="sd">        script_dir: Directory where script lives</span>

<span class="sd">        params: parameters in dictionary format</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Formatted command in the form of a string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Converts dataset_key to an aboslute path</span>
    <span class="n">new_params</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">parse</span><span class="o">.</span><span class="n">remove_unrecognized_arguments</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
    <span class="c1"># It&#39;s necessary to make this call here becausae it makes sense for </span>
    <span class="c1"># relative paths to be calucated relative to the .json file, not to </span>
    <span class="c1"># wherever maestro will eventually run the model_pipeline script</span>
    <span class="n">parse</span><span class="o">.</span><span class="n">make_dataset_key_absolute</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
    <span class="n">params_str</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
    <span class="n">slurm_command</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">/pipeline/model_pipeline.py </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">python_path</span><span class="p">,</span> <span class="n">script_dir</span><span class="p">,</span> <span class="n">params_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">slurm_command</span></div>

<div class="viewcode-block" id="run_cmd"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.run_cmd">[docs]</a><span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to submit a job using subprocess</span>

<span class="sd">    Args:</span>
<span class="sd">        cmd: Command to run</span>

<span class="sd">    Returns:</span>
<span class="sd">        output: Output of command</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="reformat_filter_dict"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.reformat_filter_dict">[docs]</a><span class="k">def</span> <span class="nf">reformat_filter_dict</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to reformat a filter dictionary to match the Model Tracker metadata structure. Updated 9/2020 by A. Paulson</span>
<span class="sd">    for new LC model tracker.</span>

<span class="sd">    Args:</span>
<span class="sd">        filter_dict: Dictionary containing metadata for model of interest</span>

<span class="sd">    Returns:</span>
<span class="sd">        new_filter_dict: Filter dict reformatted</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">:</span>
                       <span class="p">{</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="s1">&#39;featurizer&#39;</span><span class="p">,</span> <span class="s1">&#39;git_hash_code&#39;</span><span class="p">,</span><span class="s1">&#39;model_bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;model_choice_score_type&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;model_dataset_oid&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span> <span class="s1">&#39;num_model_tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction_type&#39;</span><span class="p">,</span> <span class="s1">&#39;save_results&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">,</span> <span class="s1">&#39;time_generated&#39;</span><span class="p">,</span> <span class="s1">&#39;transformer_bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;transformer_key&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;transformer_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;transformers&#39;</span><span class="p">,</span> <span class="s1">&#39;uncertainty&#39;</span><span class="p">},</span>
               <span class="s1">&#39;splitting_parameters&#39;</span><span class="p">:</span>
                       <span class="p">{</span><span class="s1">&#39;base_splitter&#39;</span><span class="p">,</span> <span class="s1">&#39;butina_cutoff&#39;</span><span class="p">,</span> <span class="s1">&#39;cutoff_date&#39;</span><span class="p">,</span> <span class="s1">&#39;date_col&#39;</span><span class="p">,</span><span class="s1">&#39;num_folds&#39;</span><span class="p">,</span> <span class="s1">&#39;split_strategy&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;split_test_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;split_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;split_valid_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">},</span>
               <span class="s1">&#39;training_dataset&#39;</span><span class="p">:</span>
                       <span class="p">{</span><span class="s1">&#39;bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_key&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;num_classes&#39;</span><span class="p">,</span><span class="s1">&#39;feature_transform_type&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;response_transform_type&#39;</span><span class="p">,</span> <span class="s1">&#39;id_col&#39;</span><span class="p">,</span> <span class="s1">&#39;smiles_col&#39;</span><span class="p">,</span> <span class="s1">&#39;response_cols&#39;</span><span class="p">},</span>
               <span class="s1">&#39;umap_specific&#39;</span><span class="p">:</span>
                       <span class="p">{</span><span class="s1">&#39;umap_dim&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_min_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_neighbors&#39;</span><span class="p">,</span><span class="s1">&#39;umap_targ_wt&#39;</span><span class="p">}</span>
              <span class="p">}</span>
    <span class="k">if</span> <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
        <span class="n">rename_dict</span><span class="p">[</span><span class="s1">&#39;nn_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;baseline_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="s1">&#39;best_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;bias_init_consts&#39;</span><span class="p">,</span><span class="s1">&#39;dropouts&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;max_epochs&#39;</span><span class="p">,</span><span class="s1">&#39;optimizer_type&#39;</span><span class="p">,</span> <span class="s1">&#39;weight_decay_penalty&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;weight_decay_penalty_type&#39;</span><span class="p">,</span> <span class="s1">&#39;weight_init_stddevs&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
        <span class="n">rename_dict</span><span class="p">[</span><span class="s1">&#39;rf_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_features&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
        <span class="n">rename_dict</span><span class="p">[</span><span class="s1">&#39;xgb_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xgb_colsample_bytree&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">,</span><span class="s1">&#39;xgb_max_depth&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;xgb_min_child_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_n_estimators&#39;</span><span class="p">,</span><span class="s1">&#39;xgb_subsample&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
        <span class="n">rename_dict</span><span class="p">[</span><span class="s1">&#39;ecfp_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ecfp_radius&#39;</span><span class="p">,</span> <span class="s1">&#39;ecfp_size&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;descriptor&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">):</span>
        <span class="n">rename_dict</span><span class="p">[</span><span class="s1">&#39;descriptor_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;descriptor_key&#39;</span><span class="p">,</span> <span class="s1">&#39;descriptor_bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;descriptor_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;descriptor_type&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;molvae&#39;</span><span class="p">:</span>
        <span class="n">rename_dict</span><span class="p">[</span><span class="s1">&#39;autoencoder_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;autoencoder_model_key&#39;</span><span class="p">,</span> <span class="s1">&#39;autoencoder_model_bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;autoencoder_model_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;autoencoder_type&#39;</span><span class="p">}</span>
    <span class="n">new_filter_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filter_dict</span><span class="p">:</span>
                <span class="n">filter_val</span> <span class="o">=</span> <span class="n">filter_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">filter_val</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
                    <span class="n">filter_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filter_val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">filter_val</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                    <span class="n">filter_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">filter_val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">filter_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_val</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
                            <span class="n">filter_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">filter_val</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                            <span class="n">filter_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">new_filter_dict</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">filter_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_filter_dict</span></div>


<div class="viewcode-block" id="permutate_NNlayer_combo_params"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.permutate_NNlayer_combo_params">[docs]</a><span class="k">def</span> <span class="nf">permutate_NNlayer_combo_params</span><span class="p">(</span><span class="n">layer_nums</span><span class="p">,</span> <span class="n">node_nums</span><span class="p">,</span> <span class="n">dropout_list</span><span class="p">,</span> <span class="n">max_final_layer_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    to generate combos of layer_sizes(str) and dropouts(str) params from the layer_nums (list), node_nums (list), dropout_list (list).</span>

<span class="sd">    The permutation will make the NN funnel shaped, so that the next layer can only be smaller or of the same size of the current layer.</span>

<span class="sd">    Example:</span>

<span class="sd">    permutate_NNlayer_combo_params([2], [4,8,16], [0], 16)</span>
<span class="sd">    returns [[16, 4], [16, 8], [8,4]] [[0,0],[0,0],[0,0]]</span>

<span class="sd">    If there are duplicates of the same size, it will create consecutive layers of the same size.</span>

<span class="sd">    Example:</span>

<span class="sd">    permutate_NNlayer_combo_params([2], [4,8,8], [0], 16)</span>
<span class="sd">    returns [[8, 8], [8, 4]] [[0,0],[0,0]]</span>

<span class="sd">    Args:</span>
<span class="sd">        layer_nums: specify numbers of layers.</span>

<span class="sd">        node_nums: specify numbers of nodes per layer.</span>

<span class="sd">        dropout_list: specify the dropouts.</span>

<span class="sd">        max_last_layer_size: sets the max size of the last layer. It will be set to the smallest node_num if needed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        layer_sizes, dropouts: the layer sizes and dropouts generated based on the input parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dropouts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_nums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node_nums</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">max_final_layer_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_final_layer_size</span><span class="p">)</span>
    <span class="c1"># set to the smallest node_num in the provided list, if necessary.</span>
    <span class="k">if</span> <span class="n">node_nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_final_layer_size</span><span class="p">:</span>
        <span class="n">max_final_layer_size</span> <span class="o">=</span> <span class="n">node_nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">dropout</span> <span class="ow">in</span> <span class="n">dropout_list</span><span class="p">:</span>
        <span class="n">_repeated_layers</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">layer_num</span> <span class="ow">in</span> <span class="n">layer_nums</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">node_nums</span><span class="p">,</span> <span class="n">layer_num</span><span class="p">):</span>
                <span class="n">layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_final_layer_size</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_repeated_layers</span><span class="p">):</span>
                    <span class="n">_repeated_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="n">layer_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="n">dropouts</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">dropout</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">layer_sizes</span><span class="p">,</span> <span class="n">dropouts</span></div>


<div class="viewcode-block" id="get_num_params"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.get_num_params">[docs]</a><span class="k">def</span> <span class="nf">get_num_params</span><span class="p">(</span><span class="n">combo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the number of parameters in a fully-connected neural networ</span>

<span class="sd">    Args:</span>
<span class="sd">        combo: Model parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        tmp_sum: Calculated number of parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">combo</span><span class="p">[</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">]</span>
    <span class="c1"># All layers multiplied by adjacent layers, summed, plus the final layer times the number of samples. Extra addition is for bias terms</span>
    <span class="n">tmp_sum</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">layers</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Add in first layer times the feature vector size. Estimate 300 for descriptors.</span>
    <span class="c1">#TODO: Update for moe vs mordred</span>
    <span class="k">if</span> <span class="n">combo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ecfp&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tmp_sum</span> <span class="o">+</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1024</span>
    <span class="k">if</span> <span class="n">combo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;descriptors&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">combo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;moe&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tmp_sum</span> <span class="o">+</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">306</span>
        <span class="k">if</span> <span class="n">combo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mordred_filtered&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tmp_sum</span> <span class="o">+</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1555</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tmp_sum</span></div>


<span class="c1"># Global variable with keys that should not be used to generate hyperparameters</span>
<span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shortlist_key&#39;</span><span class="p">,</span> <span class="s1">&#39;use_shortlist&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_key&#39;</span><span class="p">,</span> <span class="s1">&#39;object_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;script_dir&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;python_path&#39;</span><span class="p">,</span> <span class="s1">&#39;config_file&#39;</span><span class="p">,</span> <span class="s1">&#39;hyperparam&#39;</span><span class="p">,</span> <span class="s1">&#39;search_type&#39;</span><span class="p">,</span> <span class="s1">&#39;split_only&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_nums&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;node_nums&#39;</span><span class="p">,</span> <span class="s1">&#39;dropout_list&#39;</span><span class="p">,</span> <span class="s1">&#39;max_final_layer_size&#39;</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_size_scale_factor&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;rerun&#39;</span><span class="p">,</span> <span class="s1">&#39;max_jobs&#39;</span><span class="p">}</span>


<div class="viewcode-block" id="HyperparameterSearch"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch">[docs]</a><span class="k">class</span> <span class="nc">HyperparameterSearch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class for generating and running all hyperparameter combinations based on the input params given</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            params: The input hyperparameter parameters</span>

<span class="sd">            hyperparam_uuid: Optional, UUID for hyperparameter run if you want to group this run with a previous run.</span>
<span class="sd">            We ended up mainly doing this via collections, so not really used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_layers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;dropouts&#39;</span><span class="p">,</span> <span class="s1">&#39;weight_init_stddevs&#39;</span><span class="p">,</span> <span class="s1">&#39;bias_init_consts&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span> <span class="s1">&#39;featurizer&#39;</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;weight_decay_penalty&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;rf_estimators&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_features&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;umap_dim&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_targ_wt&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_neighbors&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_min_dist&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;xgb_gamma&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn_specific_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;layers&#39;</span><span class="p">,</span><span class="s1">&#39;weight_decay_penalty&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_specific_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rf_estimators&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_features&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xgboost_specific_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_gamma&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="n">excluded_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_float</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">convert_to_float_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_int</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">convert_to_int_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># simplify NN layer construction</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">layer_nums</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">node_nums</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">dropout_list</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="n">permutate_NNlayer_combo_params</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">layer_nums</span><span class="p">,</span>
                                                                                           <span class="n">params</span><span class="o">.</span><span class="n">node_nums</span><span class="p">,</span>
                                                                                           <span class="n">params</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">,</span>
                                                                                           <span class="n">params</span><span class="o">.</span><span class="n">max_final_layer_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">hyperparam_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_uuid</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">hyperparam_uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;hyperparam_search&quot;</span><span class="p">)</span>
        <span class="c1"># Create handlers</span>
        <span class="n">c_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
        <span class="n">f_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_uuid</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_uuid</span><span class="p">)),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">c_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">f_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="c1"># Create formatters and add it to handlers</span>
        <span class="n">c_format</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f_format</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">c_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">c_format</span><span class="p">)</span>
        <span class="n">f_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">f_format</span><span class="p">)</span>
        <span class="c1"># Add handlers to the logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">c_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">f_handler</span><span class="p">)</span>


        <span class="n">slurm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="s1">&#39;slurm_files&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">slurm_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">slurm_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell_script</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="p">,</span> <span class="s1">&#39;run.sh&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell_script</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -D </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_path</span><span class="p">))</span>

            <span class="c1"># If any of these properties == None, that property is not set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_account</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -A </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_account</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lc_account</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -A </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lc_account</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_export</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --export=</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_export</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_nodes</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -N </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_nodes</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_partition</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -p </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_partition</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_time_limit</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -t </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_time_limit</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_options</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">slurm_options</span><span class="p">))</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;start=`date +</span><span class="si">%s</span><span class="s1">`</span><span class="se">\n</span><span class="s1">echo $3</span><span class="se">\n</span><span class="s1">$1 $2/pipeline/model_pipeline.py $3</span><span class="se">\n</span><span class="s1">end=`date +</span><span class="si">%s</span><span class="s1">`</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;runtime=$((end-start))</span><span class="se">\n</span><span class="s1">echo &quot;runtime: &quot; $runtime&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="HyperparameterSearch.generate_param_combos"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_param_combos">[docs]</a>    <span class="k">def</span> <span class="nf">generate_param_combos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs additional parsing of parameters and generates all combinations</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_keys</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;result_dir&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_uuid</span><span class="p">)</span>
            <span class="c1"># Need to zip together layers in special way</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_layers</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c1"># Parses the hyperparameter keys depending on the size of the key list</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Adds layers to the parameter combos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_layers</span><span class="p">()</span>
        <span class="c1"># setting up the various hyperparameter combos for each model type.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span><span class="p">:</span>
                <span class="c1"># if the model type is NN, loops through the featurizer to check for GraphConv.</span>
                <span class="k">for</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">:</span>
                            <span class="n">subcombo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_specific_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgboost_specific_keys</span><span class="p">}</span>
                            <span class="c1"># could put in list</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">featurizer</span><span class="p">]</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_combos</span><span class="p">(</span><span class="n">subcombo</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subcombo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_specific_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgboost_specific_keys</span><span class="p">}</span>
                        <span class="c1"># could put in list</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">featurizer</span><span class="p">]</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;moe&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span><span class="p">):</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
                            
                        <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_combos</span><span class="p">(</span><span class="n">subcombo</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">:</span>
                            <span class="c1"># Adds the subcombo for RF</span>
                            <span class="n">subcombo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn_specific_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgboost_specific_keys</span><span class="p">}</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">featurizer</span><span class="p">]</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_combos</span><span class="p">(</span><span class="n">subcombo</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Adds the subcombo for RF</span>
                        <span class="n">subcombo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn_specific_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgboost_specific_keys</span><span class="p">}</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">featurizer</span><span class="p">]</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;moe&#39;</span><span class="p">]</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_combos</span><span class="p">(</span><span class="n">subcombo</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;computed_descriptors&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">:</span>
                            <span class="c1"># Adds the subcombo for xgboost</span>
                            <span class="n">subcombo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn_specific_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_specific_keys</span><span class="p">}</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">featurizer</span><span class="p">]</span>
                            <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_combos</span><span class="p">(</span><span class="n">subcombo</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Adds the subcombo for xgboost</span>
                        <span class="n">subcombo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn_specific_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_specific_keys</span><span class="p">}</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">featurizer</span><span class="p">]</span>
                        <span class="n">subcombo</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;moe&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_combos</span><span class="p">(</span><span class="n">subcombo</span><span class="p">))</span></div>

<div class="viewcode-block" id="HyperparameterSearch.generate_combos"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_combos">[docs]</a>    <span class="k">def</span> <span class="nf">generate_combos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls sub-function generate_combo and then uses itertools.product to generate all desired combinations</span>

<span class="sd">        Args:</span>
<span class="sd">            params_dict:</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_combo</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>
        <span class="n">hyperparam_combos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hyperparams</span> <span class="o">=</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">hyperparam_vals</span> <span class="o">=</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">hyperparameter_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">hyperparam_vals</span><span class="p">)):</span>
            <span class="n">model_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">hyperparam</span><span class="p">,</span> <span class="n">hyperparam_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hyperparams</span><span class="p">,</span> <span class="n">hyperparameter_tuple</span><span class="p">):</span>
                <span class="n">model_params</span><span class="p">[</span><span class="n">hyperparam</span><span class="p">]</span> <span class="o">=</span> <span class="n">hyperparam_val</span>
            <span class="n">hyperparam_combos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hyperparam_combos</span></div>

<div class="viewcode-block" id="HyperparameterSearch.assemble_layers"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.assemble_layers">[docs]</a>    <span class="k">def</span> <span class="nf">assemble_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reformats layer parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">values</span><span class="p">())])):</span>
            <span class="n">tmp_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tmp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">tmp_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tmp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;layers&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperparameterSearch.generate_assay_list"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_assay_list">[docs]</a>    <span class="k">def</span> <span class="nf">generate_assay_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the list of datasets to build models for, with their key, bucket, split, and split uuid</span>

<span class="sd">        Returns:</span>
<span class="sd">           None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Creates the assay list with additional options for use_shortlist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">use_shortlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">splitters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">splitters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assays</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">splitter</span> <span class="ow">in</span> <span class="n">splitters</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;previously_split&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;split_uuid&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">previously_split</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_uuid</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">split_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_split_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dataset_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">splitter</span><span class="p">,</span> <span class="n">split_uuid</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortlist_df</span><span class="p">(</span><span class="n">split_uuids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assays</span><span class="p">]</span></div>

<div class="viewcode-block" id="HyperparameterSearch.get_dataset_metadata"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.get_dataset_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataset_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gather the required metadata for a dataset</span>

<span class="sd">        Args:</span>
<span class="sd">            assay_params: dataset metadata</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">])</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#TODO: need to catch if dataset doesn&#39;t exist versus 500 failure</span>
        <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">get_keyval</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">],</span> <span class="n">bucket</span><span class="o">=</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">])</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not get metadata from datastore for dataset </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, sleeping...&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not get metadata from datastore for dataset </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, exiting&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;id_col&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;response_cols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assay_params</span> <span class="ow">or</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;response_col&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;response_col&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;response_cols&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;smiles_col&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;smiles_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;smiles_col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;class_name&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;class_number&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;class_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;class_number&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;num_row&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_rows</span><span class="p">[</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;num_row&#39;</span><span class="p">]</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;hyperparam_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparam_uuid</span></div>

<div class="viewcode-block" id="HyperparameterSearch.split_and_save_dataset"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.split_and_save_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">split_and_save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a given dataset, saves it, and sets the split_uuid in the metadata</span>

<span class="sd">        Args:</span>
<span class="sd">            assay_params: Dataset metadata</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset_metadata</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
        <span class="c1"># TODO: check usage with defaults</span>
        <span class="n">namespace_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
        <span class="c1"># TODO: Don&#39;t want to recreate each time</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">namespace_params</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_model_dataset</span><span class="p">(</span><span class="n">namespace_params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">save_split_dataset</span><span class="p">()</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;previously_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;split_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split_uuid</span></div>

<div class="viewcode-block" id="HyperparameterSearch.return_split_uuid"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.return_split_uuid">[docs]</a>    <span class="k">def</span> <span class="nf">return_split_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split_combo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a dataset, splits it, saves it, and returns the split_uuid</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_key: key for dataset to split</span>

<span class="sd">            bucket: datastore-specific user group bucket</span>

<span class="sd">            splitter: Type of splitter to use to split the dataset</span>

<span class="sd">            split_combo: tuple of form (split_valid_frac, split_test_frac)</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span>
        <span class="k">if</span> <span class="n">splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">splitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span>
        <span class="k">if</span> <span class="n">split_combo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">split_valid_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_valid_frac</span>
            <span class="n">split_test_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_test_frac</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_valid_frac</span> <span class="o">=</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">split_test_frac</span> <span class="o">=</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#TODO: need to catch if dataset doesn&#39;t exist versus 500 failure</span>
        <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">get_keyval</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not get metadata from datastore for dataset </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, sleeping...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not get metadata from datastore for dataset </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, exiting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="n">assay_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">:</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="s1">&#39;bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">:</span> <span class="n">splitter</span><span class="p">,</span>
                        <span class="s1">&#39;split_valid_frac&#39;</span><span class="p">:</span> <span class="n">split_valid_frac</span><span class="p">,</span> <span class="s1">&#39;split_test_frac&#39;</span><span class="p">:</span> <span class="n">split_test_frac</span><span class="p">}</span>
        <span class="c1">#Need a featurizer type to split dataset, but since we only care about getting the split_uuid, does not matter which featurizer you use</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span>
        <span class="k">if</span> <span class="s1">&#39;id_col&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;response_cols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assay_params</span> <span class="ow">or</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;response_col&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;response_col&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;response_cols&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;smiles_col&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;smiles_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;smiles_col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;class_name&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;class_number&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;class_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;class_number&#39;</span><span class="p">]</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;datastore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;previously_featurized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">previously_featurized</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;descriptor_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_key</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;descriptor_bucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_bucket</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1">#TODO: check usage with defaults</span>
        <span class="n">namespace_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
        <span class="c1"># TODO: Don&#39;t want to recreate each time</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">namespace_params</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_model_dataset</span><span class="p">(</span><span class="n">namespace_params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">)</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">()</span>
                <span class="n">data</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">()</span>
                <span class="n">data</span><span class="o">.</span><span class="n">save_split_dataset</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">split_uuid</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not get metadata from datastore for dataset </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, sleeping&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not save split dataset for dataset </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="HyperparameterSearch.return_split_uuid_file"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.return_split_uuid_file">[docs]</a>    <span class="k">def</span> <span class="nf">return_split_uuid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split_combo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a dataset, splits it, saves it, and returns the split_uuid.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_key: key for dataset to split</span>

<span class="sd">            bucket: datastore-specific user group bucket</span>

<span class="sd">            splitter: Type of splitter to use to split the dataset</span>

<span class="sd">            split_combo: tuple of form (split_valid_frac, split_test_frac)</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span>
        <span class="k">if</span> <span class="n">splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">splitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span>
        <span class="k">if</span> <span class="n">split_combo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">split_valid_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_valid_frac</span>
            <span class="n">split_test_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_test_frac</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_valid_frac</span> <span class="o">=</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">split_test_frac</span> <span class="o">=</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">assay_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">:</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="s1">&#39;bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">:</span> <span class="n">splitter</span><span class="p">,</span>
                        <span class="s1">&#39;split_valid_frac&#39;</span><span class="p">:</span> <span class="n">split_valid_frac</span><span class="p">,</span> <span class="s1">&#39;split_test_frac&#39;</span><span class="p">:</span> <span class="n">split_test_frac</span><span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;id_col&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">id_col</span>
        <span class="k">if</span> <span class="s1">&#39;smiles_col&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;smiles_col&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">smiles_col</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response_cols</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response_cols</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">response_cols</span>
            
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># rdkit_raw b/c it&#39;s the fastest and won&#39;t have to be redone every split </span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;computed_descriptors&#39;</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;descriptor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rdkit_raw&#39;</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;previously_featurized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;datastore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">namespace_params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
        <span class="c1"># TODO: Don&#39;t want to recreate each time</span>
        <span class="n">featurization</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">create_featurization</span><span class="p">(</span><span class="n">namespace_params</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">create_model_dataset</span><span class="p">(</span><span class="n">namespace_params</span><span class="p">,</span> <span class="n">featurization</span><span class="p">)</span>
        
        <span class="n">data</span><span class="o">.</span><span class="n">get_featurized_data</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">save_split_dataset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">split_uuid</span></div>
            
    
<div class="viewcode-block" id="HyperparameterSearch.generate_split_shortlist"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_split_shortlist">[docs]</a>    <span class="k">def</span> <span class="nf">generate_split_shortlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes a shortlist, generates splits for each dataset on the list, and uploads a new shortlist file with the</span>
<span class="sd">        split_uuids included. Generates splits for the split_combos [[0.1,0.1], [0.1,0.2],[0.2,0.2]], [random, scaffold]</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shortlist_metadata</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span>
                    <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not retrieve shortlist </span><span class="si">%s</span><span class="s2"> from datastore because of exception </span><span class="si">%s</span><span class="s2">, sleeping...&quot;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not retrieve shortlist </span><span class="si">%s</span><span class="s2"> from datastore because of exception </span><span class="si">%s</span><span class="s2">, exiting&quot;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortlist_df</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="n">split_uuids</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">:</span> <span class="n">assay</span><span class="p">,</span> <span class="s1">&#39;bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;response_cols&#39;</span><span class="p">:</span><span class="n">response_cols</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">:</span><span class="n">collection</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">splitter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;scaffold&#39;</span><span class="p">,</span> <span class="s1">&#39;fingerprint&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">split_combo</span> <span class="ow">in</span> <span class="p">[[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span><span class="mf">0.15</span><span class="p">],[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">],[</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]]:</span>
                    <span class="n">split_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">splitter</span><span class="p">,</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">split_uuids</span><span class="p">[</span><span class="n">split_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_split_uuid</span><span class="p">(</span><span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">splitter</span><span class="p">,</span> <span class="n">split_combo</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Splitting failed for dataset </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">assay</span><span class="p">)</span>
                        <span class="n">split_uuids</span><span class="p">[</span><span class="n">split_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">continue</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_uuids</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">new_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shortlist_metadata</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_with_uuids.csv&#39;</span>
        <span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;has_uuids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, with UUIDs&#39;</span> <span class="o">%</span> <span class="n">shortlist_metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dsf</span><span class="o">.</span><span class="n">upload_df_to_DS</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                    <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                                    <span class="n">filename</span><span class="o">=</span><span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">],</span>
                                    <span class="n">title</span><span class="o">=</span><span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span>
                                    <span class="n">description</span><span class="o">=</span><span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
                                    <span class="n">tags</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">key_values</span><span class="o">=</span><span class="p">{},</span>
                                    <span class="n">dataset_key</span><span class="o">=</span><span class="n">new_metadata</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">])</span>
                <span class="n">retry</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not save new shortlist because of exception </span><span class="si">%s</span><span class="s2">, sleeping...&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#TODO: Add save to disk.</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not save new shortlist because of exception </span><span class="si">%s</span><span class="s2">, exiting&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="HyperparameterSearch.generate_split_shortlist_file"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_split_shortlist_file">[docs]</a>    <span class="k">def</span> <span class="nf">generate_split_shortlist_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes a shortlist, generates splits for each dataset on the list, and uploads a new shortlist file with the</span>
<span class="sd">        split_uuids included. Generates splits for the split_combos [[0.1,0.1], [0.15,0.15], [0.1,0.2], [0.2,0.2]], [random, scaffold]</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shortlist_df</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="n">split_uuids</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">:</span> <span class="n">assay</span><span class="p">,</span> <span class="s1">&#39;bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;response_cols&#39;</span><span class="p">:</span><span class="n">response_cols</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">:</span><span class="n">collection</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">splitter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;scaffold&#39;</span><span class="p">,</span><span class="s1">&#39;fingerprint&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">split_combo</span> <span class="ow">in</span> <span class="p">[[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span><span class="mf">0.15</span><span class="p">],[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">],[</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]]:</span>
                    <span class="n">split_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">splitter</span><span class="p">,</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">split_combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">split_uuids</span><span class="p">[</span><span class="n">split_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_split_uuid_file</span><span class="p">(</span><span class="n">assay</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">splitter</span><span class="p">,</span> <span class="n">split_combo</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Splitting failed for dataset </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">assay</span><span class="p">)</span>
                        <span class="n">split_uuids</span><span class="p">[</span><span class="n">split_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">continue</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_uuids</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;_with_uuids.csv&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperparameterSearch.get_shortlist_df"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.get_shortlist_df">[docs]</a>    <span class="k">def</span> <span class="nf">get_shortlist_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_uuids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            split_uuids: Boolean value saying if you want just datasets returned or the split_uuids as well</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of dataset_keys, along with their accompanying bucket, split type, and split_uuid if split_uuids is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
            <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
                    <span class="n">retry</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not retrieve shortlist </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, sleeping...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not retrieve shortlist </span><span class="si">%s</span><span class="s2"> because of exception </span><span class="si">%s</span><span class="s2">, exiting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shortlist_key</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">assays</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;task_name&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;task_name&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;dataset_key&#39;</span>
            <span class="n">assays</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;bucket&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">buckets</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s1">&#39;bucket_name&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">buckets</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;response_cols&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">responses</span><span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">response_cols</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">responses</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">response_cols</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;collection&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">collections</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">datasets</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">assays</span><span class="p">,</span><span class="n">buckets</span><span class="p">,</span><span class="n">responses</span><span class="p">,</span><span class="n">collections</span><span class="p">))</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_uuids</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datasets</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">splitters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">splitter</span>
        <span class="n">assays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">splitter</span> <span class="ow">in</span> <span class="n">splitters</span><span class="p">:</span>
            <span class="n">split_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">splitter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_valid_frac</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">split_test_frac</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">split_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">assays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">splitter</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">split_name</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dataset_key, bucket, response_cols, &amp; collecion_name must be specified in shortlist or config file, not neither.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">split_name</span><span class="si">}</span><span class="s2"> not found in shortlist. Creating default split scaffold_10_10 now.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># do we want to move this into loop so we ignore ones it failed for?</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
                            <span class="n">split_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_split_uuid</span><span class="p">(</span><span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">split_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_split_uuid_file</span><span class="p">(</span><span class="n">assay</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
                        <span class="n">assays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">splitter</span><span class="p">,</span> <span class="n">split_uuid</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Splitting failed for dataset </span><span class="si">%s</span><span class="s2">, skipping...&quot;</span> <span class="o">%</span> <span class="n">assay</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
                        <span class="k">continue</span>
        <span class="k">return</span> <span class="n">assays</span></div>

<div class="viewcode-block" id="HyperparameterSearch.build_jobs"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.build_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">build_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds jobs.</span>
<span class="sd">        Reformats parameters as necessary</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_assay_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">assay</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">response_cols</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">splitter</span><span class="p">,</span> <span class="n">split_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assays</span><span class="p">:</span>
            <span class="c1"># Writes the series of command line arguments for scripts without a hyperparameter combo</span>
            <span class="n">assay_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_params</span><span class="p">)</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assay</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">assay</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;response_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_cols</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;collection_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;split_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_uuid</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;previously_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;splitter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitter</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prediction_type: </span><span class="si">{</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;prediction_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset_metadata</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
                <span class="k">continue</span>
            <span class="c1"># creates output directory</span>
            <span class="n">base_result_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;result_dir&#39;</span><span class="p">],</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="p">:</span>
                <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;result_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_result_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
                <span class="n">result_assay_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_combos</span><span class="p">:</span>
                    <span class="c1"># For a temporary parameter list, appends and modifies parameters for each hyperparameter combo.</span>
                    <span class="n">combo_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">combo_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">combo_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="n">combo_params</span><span class="p">[</span><span class="s1">&#39;result_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_result_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
                    <span class="n">result_assay_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combo_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_assay_params</span></div>

<div class="viewcode-block" id="HyperparameterSearch.filter_jobs"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.filter_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">filter_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes jobs that should not be run</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">assay_params</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NN&#39;</span> <span class="ow">and</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;featurizer&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;graphconv&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_rows</span><span class="p">:</span>
                    <span class="n">num_params</span> <span class="o">=</span> <span class="n">get_num_params</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_params</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">nn_size_scale_factor</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_rows</span><span class="p">[</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]]:</span>
                        <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rerun</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_run</span><span class="p">(</span><span class="n">assay_params</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_list</span></div>

<div class="viewcode-block" id="HyperparameterSearch.submit_jobs"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.submit_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">submit_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_list</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reformats parameters as necessary and then calls run_command in a loop to submit a job for each param combo</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">assay_params</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_jobs</span><span class="p">([</span><span class="n">assay_params</span><span class="p">]))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_cmd</span><span class="p">(</span><span class="s1">&#39;squeue | grep $(whoami) | wc -l&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_jobs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> jobs in queue, sleeping&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_cmd</span><span class="p">(</span><span class="s1">&#39;squeue | grep $(whoami) | wc -l&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">assay_params</span><span class="p">))</span>
                <span class="n">run_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell_script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">python_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">script_dir</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperparameterSearch.already_run"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.already_run">[docs]</a>    <span class="k">def</span> <span class="nf">already_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">,</span> <span class="n">retry_time</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks to see if a model with a given metadata combination has already been built</span>

<span class="sd">        Args:</span>
<span class="sd">            assay_params: model metadata information</span>

<span class="sd">        Returns:</span>
<span class="sd">            Boolean specifying if model has been previously built</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">filter_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;result_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;previously_featurized&#39;</span><span class="p">,</span> <span class="s1">&#39;collection_name&#39;</span><span class="p">,</span> <span class="s1">&#39;time_generated&#39;</span><span class="p">,</span> <span class="s1">&#39;hyperparam_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;model_uuid&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filter_dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">filter_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">filter_dict</span> <span class="o">=</span> <span class="n">reformat_filter_dict</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking model tracker DB for existing model with parameter combo in </span><span class="si">{</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;collection_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> collection.&quot;</span><span class="p">)</span>
                <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trkr</span><span class="o">.</span><span class="n">get_full_metadata</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">assay_params</span><span class="p">[</span><span class="s1">&#39;collection_name&#39;</span><span class="p">]))</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_time</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not check Model Tracker for existing model at this time because of exception </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">models</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already created model for this param combo&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No existing model found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HyperparameterSearch.generate_combo"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_combo">[docs]</a>    <span class="k">def</span> <span class="nf">generate_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is implemented in the specific sub-classes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="HyperparameterSearch.run_search"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.run_search">[docs]</a>    <span class="k">def</span> <span class="nf">run_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The driver code for generating hyperparameter combinations and submitting jobs</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_searches</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Submitting jobs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_jobs</span><span class="p">(</span><span class="n">job_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperparameterSearch.generate_searches"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_searches">[docs]</a>    <span class="k">def</span> <span class="nf">generate_searches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a list of training jobs</span>

<span class="sd">        Generates a list of model training jobs that spans</span>
<span class="sd">        the hyperparameter search space. This function</span>
<span class="sd">        filters out jobs that are redundant by calling filter_jobs</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            list(tuple): A list of tuples that contain assay parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating param combos&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_param_combos</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating assay list&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_assay_list</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;build_ jobs&quot;</span><span class="p">)</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_jobs</span><span class="p">()</span>
<span class="c1">#         print(&quot;filter redundant jobs&quot;)</span>
<span class="c1">#         job_list = self.filter_jobs(job_list)</span>

        <span class="k">return</span> <span class="n">job_list</span></div>

<div class="viewcode-block" id="HyperparameterSearch.generate_maestro_commands"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperparameterSearch.generate_maestro_commands">[docs]</a>    <span class="k">def</span> <span class="nf">generate_maestro_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates commands that can be used by maestro</span>

<span class="sd">        Generates a list of commands that can be put directly into</span>
<span class="sd">        the shell to run model training.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of shell commands</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_searches</span><span class="p">()</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">assay_params</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen_maestro_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">python_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">script_dir</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">commands</span></div></div>

<div class="viewcode-block" id="GridSearch"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GridSearch">[docs]</a><span class="k">class</span> <span class="nc">GridSearch</span><span class="p">(</span><span class="n">HyperparameterSearch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates fixed steps on a grid for a given hyperparameter range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="GridSearch.split_and_save_dataset"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GridSearch.split_and_save_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">split_and_save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_and_save_dataset</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="GridSearch.generate_param_combos"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GridSearch.generate_param_combos">[docs]</a>    <span class="k">def</span> <span class="nf">generate_param_combos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_param_combos</span><span class="p">()</span></div>

<div class="viewcode-block" id="GridSearch.generate_assay_list"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GridSearch.generate_assay_list">[docs]</a>    <span class="k">def</span> <span class="nf">generate_assay_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_assay_list</span><span class="p">()</span></div>

<div class="viewcode-block" id="GridSearch.generate_combo"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GridSearch.generate_combo">[docs]</a>    <span class="k">def</span> <span class="nf">generate_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to generate all combinations from a given set of key-value pairs</span>

<span class="sd">        Args:</span>
<span class="sd">            params_dict: Set of key-value pairs with the key being the param name and the value being the list of values</span>
<span class="sd">            you want to try for that param</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_dict: The list of all combinations of parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">tmp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_int</span><span class="p">:</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_dict</span></div></div>

<div class="viewcode-block" id="RandomSearch"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.RandomSearch">[docs]</a><span class="k">class</span> <span class="nc">RandomSearch</span><span class="p">(</span><span class="n">HyperparameterSearch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the specified number of random parameter values for within the specified range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="RandomSearch.split_and_save_dataset"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.RandomSearch.split_and_save_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">split_and_save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_and_save_dataset</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="RandomSearch.generate_param_combos"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.RandomSearch.generate_param_combos">[docs]</a>    <span class="k">def</span> <span class="nf">generate_param_combos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_param_combos</span><span class="p">()</span></div>

<div class="viewcode-block" id="RandomSearch.generate_assay_list"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.RandomSearch.generate_assay_list">[docs]</a>    <span class="k">def</span> <span class="nf">generate_assay_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_assay_list</span><span class="p">()</span></div>

<div class="viewcode-block" id="RandomSearch.generate_combo"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.RandomSearch.generate_combo">[docs]</a>    <span class="k">def</span> <span class="nf">generate_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to generate all combinations from a given set of key-value pairs</span>

<span class="sd">        Args:</span>
<span class="sd">            params_dict: Set of key-value pairs with the key being the param name and the value being the list of values</span>
<span class="sd">            you want to try for that param</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_dict: The list of all combinations of parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">tmp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_int</span><span class="p">:</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_dict</span></div></div>

<div class="viewcode-block" id="GeometricSearch"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GeometricSearch">[docs]</a><span class="k">class</span> <span class="nc">GeometricSearch</span><span class="p">(</span><span class="n">HyperparameterSearch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates parameter values in logistic steps, rather than linear like GridSearch does</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="GeometricSearch.split_and_save_dataset"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GeometricSearch.split_and_save_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">split_and_save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_and_save_dataset</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometricSearch.generate_param_combos"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GeometricSearch.generate_param_combos">[docs]</a>    <span class="k">def</span> <span class="nf">generate_param_combos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_param_combos</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometricSearch.generate_assay_list"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GeometricSearch.generate_assay_list">[docs]</a>    <span class="k">def</span> <span class="nf">generate_assay_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_assay_list</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometricSearch.generate_combo"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.GeometricSearch.generate_combo">[docs]</a>    <span class="k">def</span> <span class="nf">generate_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to generate all combinations from a given set of key-value pairs</span>

<span class="sd">        Args:</span>
<span class="sd">            params_dict: Set of key-value pairs with the key being the param name and the value being the list of values</span>
<span class="sd">            you want to try for that param</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_dict: The list of all combinations of parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">tmp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_int</span><span class="p">:</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_dict</span></div></div>

<div class="viewcode-block" id="UserSpecifiedSearch"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.UserSpecifiedSearch">[docs]</a><span class="k">class</span> <span class="nc">UserSpecifiedSearch</span><span class="p">(</span><span class="n">HyperparameterSearch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates combinations using the user-specified steps</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="UserSpecifiedSearch.split_and_save_dataset"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.UserSpecifiedSearch.split_and_save_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">split_and_save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assay_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_and_save_dataset</span><span class="p">(</span><span class="n">assay_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="UserSpecifiedSearch.generate_param_combos"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.UserSpecifiedSearch.generate_param_combos">[docs]</a>    <span class="k">def</span> <span class="nf">generate_param_combos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_param_combos</span><span class="p">()</span></div>

<div class="viewcode-block" id="UserSpecifiedSearch.generate_assay_list"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.UserSpecifiedSearch.generate_assay_list">[docs]</a>    <span class="k">def</span> <span class="nf">generate_assay_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_assay_list</span><span class="p">()</span></div>

<div class="viewcode-block" id="UserSpecifiedSearch.generate_combo"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.UserSpecifiedSearch.generate_combo">[docs]</a>    <span class="k">def</span> <span class="nf">generate_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to generate all combinations from a given set of key-value pairs</span>

<span class="sd">        Args:</span>
<span class="sd">            params_dict: Set of key-value pairs with the key being the param name and the value being the list of values</span>
<span class="sd">            you want to try for that param</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_dict: The list of all combinations of parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_int</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_float</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_dict</span></div></div>

<div class="viewcode-block" id="build_hyperopt_search_domain"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.build_hyperopt_search_domain">[docs]</a><span class="k">def</span> <span class="nf">build_hyperopt_search_domain</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">param_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate HyperOpt search domain object from method and parameters, layer_nums is only for NN models.</span>
<span class="sd">    This function is used by the HyperOptSearch class, not intended for standalone usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;choice&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hp</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">param_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hp</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;loguniform&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hp</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;uniformint&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hp</span><span class="o">.</span><span class="n">uniformint</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> is not supported, choose from &#39;choice, uniform, loguniform, uniformint&#39;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperOptSearch"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperOptSearch">[docs]</a><span class="k">class</span> <span class="nc">HyperOptSearch</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform hyperparameter search with Bayesian Optmization (Tree Parzen Estimator)</span>

<span class="sd">    To use HyperOptSearch, modify the config json file as follows:</span>

<span class="sd">        serach_type: use &quot;hyperopt&quot;</span>

<span class="sd">        result_dir: use two directories (recommended), separated by comma, 1st one will be used to save the best model tarball, 2nd one will be used to store all models during the process.  e.g. &quot;result_dir&quot;: &quot;/path/of/the/final/dir,/path/of/the/temp/dir&quot;</span>

<span class="sd">        model_type: RF or NN, also add max number of HyperOptSearch evaluations, e.g. &quot;model_type&quot;: &quot;RF|100&quot;.  If no max number provide, the default 100 will be used.  #For NN models only</span>

<span class="sd">        lr: specify learning rate searching method and related parameters as the following scheme.</span>
<span class="sd">            method|parameter1,parameter2...</span>

<span class="sd">            method: supported searching schemes in HyperOpt include: choice, uniform, loguniform, and uniformint, see https://github.com/hyperopt/hyperopt/wiki/FMin for details.</span>

<span class="sd">            parameters:</span>
<span class="sd">                choice: all values to search from, separated by comma, e.g. choice|0.0001,0.0005,0.0002,0.001</span>

<span class="sd">                uniform: low and high bound of the interval to serach, e.g. uniform|0.00001,0.001</span>

<span class="sd">                loguniform: low and high bound (in natural log) of the interval to serach, e.g. loguniform|-13.8,-6.9</span>

<span class="sd">                uniformint: low and high bound of the interval to serach, e.g. uniformint|8,256</span>

<span class="sd">        ls: similar as learning_rate, specify number of layers and size of each one.</span>

<span class="sd">            method|num_layers|parameter1,parameter2...</span>
<span class="sd">            e.g. choice|2|8,16,32,64,128,256,512  #this will generate a two-layer config, each layer takes size from the list &quot;8,16,32,64,128,256,512&quot;</span>
<span class="sd">            e.g. uniformint|3|8,512  #this will generate a three-layer config, each layer takes size from the uniform interval [8,512]</span>

<span class="sd">        dp: similar as layer_sizes, just make sure dropouts and layer_sizes should have the same number of layers.</span>

<span class="sd">            e.g. uniform|3|0,0.4   #this will generate a three-layer config, each layer takes size from the uniform interval [0,0.4]</span>

<span class="sd">        #For RF models only</span>
<span class="sd">        rfe: rf_estimator, same structure as the learning rate above, e.g. uniformint|64,512  #take integer values from a uniform interval [64,512]</span>

<span class="sd">        rfd: rf_max_depth, e.g. uniformint|8,256</span>

<span class="sd">        rff: rf_max_feature, e.g. uniformint|8,128</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1">#separate temp output dir and final output dir</span>
        <span class="n">result_dir_list</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">result_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dir_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">result_dir_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_dir</span> <span class="o">=</span> <span class="n">result_dir_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">result_dir</span> <span class="o">=</span> <span class="n">result_dir_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_dir</span> <span class="o">=</span> <span class="n">result_dir_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_eval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_eval</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1">#define the searching space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;featurizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;featurizer&quot;</span><span class="p">,</span> <span class="s2">&quot;choice&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;descriptor_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;descriptor_type&quot;</span><span class="p">,</span> <span class="s2">&quot;choice&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;RF&quot;</span><span class="p">:</span>
            <span class="c1">#build searching domain for RF parameters</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rfe</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rfe</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;rf_estimators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;rf_estimators&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rfd</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rfd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;rf_max_depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;rf_max_depth&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rff</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;rf_max_features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;rf_max_features&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;NN&quot;</span><span class="p">:</span>
            <span class="c1">#build searching domain for NN parameters</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>

            <span class="c1"># for layer sizes, use a different method if the ls_ratio is provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ls</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ls</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">num_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ls_ratio</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layer</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ls</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ls</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>
                    <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ls_ratio</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layer</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ratio</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dp</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">num_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layer</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;dp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;xgboost&quot;</span><span class="p">:</span>
            <span class="c1">#build searching domain for XGBoost parameters</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgbg</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgbg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;xgbg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;xgbg&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgbl</span><span class="p">:</span>
                <span class="n">domain_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgbl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">par_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">[</span><span class="s2">&quot;xgbl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_hyperopt_search_domain</span><span class="p">(</span><span class="s2">&quot;xgbl&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">par_list</span><span class="p">)</span>


<div class="viewcode-block" id="HyperOptSearch.run_search"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.HyperOptSearch.run_search">[docs]</a>    <span class="k">def</span> <span class="nf">run_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#name of the results</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span>
        <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">or</span> <span class="n">feat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;computed_descriptors&quot;</span><span class="p">,</span> <span class="s2">&quot;descriptors&quot;</span><span class="p">]:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">feat</span> <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;graphconv&quot;</span><span class="p">,</span> <span class="s2">&quot;ecfp&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">desc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">lossfn</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;featurizer&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;featurizer&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;descriptor_type&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;descriptor_type&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;RF&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rfe</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span> <span class="o">=</span>  <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rf_estimators&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rfd</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rf_max_depth&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rff</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;rf_max_features&quot;</span><span class="p">]</span>
                <span class="n">hp_params</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rf_estimators: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_estimators</span><span class="si">}</span><span class="s1">, rf_max_depth: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_depth</span><span class="si">}</span><span class="s1">, rf_max_feature: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rf_max_features</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;NN&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">if</span> <span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dp&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ls_ratio</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">if</span> <span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ls&quot;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">list_layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">if</span> <span class="n">e</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ratio&quot;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">list_layer_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">list_layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">list_layer_sizes</span><span class="p">])</span>
                <span class="n">hp_params</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;learning_rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="si">}</span><span class="s2">, layer_sizes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="si">}</span><span class="s2">, dropouts: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;xgboost&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgbg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;xgbg&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgbl</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;xgbl&quot;</span><span class="p">]</span>
                <span class="n">hp_params</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xgb_gamma: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_gamma</span><span class="si">}</span><span class="s2">, xgb_learing_rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xgb_learning_rate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># set hyperparam to False to make sure the layer_sizes and dropouts are not lists if not optimized.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hyperparam</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="p">])</span>
                <span class="n">hp_params</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="p">])</span>
                <span class="n">hp_params</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">learning_rate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">layer_sizes</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dropouts</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">tparam</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> model with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">featurizer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">descriptor_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># make sure classification model has uncertainty as False. </span>
            <span class="k">if</span> <span class="n">tparam</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">!=</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                <span class="n">tparam</span><span class="o">.</span><span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">ModelPipeline</span><span class="p">(</span><span class="n">tparam</span><span class="p">)</span>

            <span class="n">model_failed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">train_model</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">model_failed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
            <span class="n">pred_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">subsets</span><span class="p">,</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">model_failed</span><span class="p">:</span>
                    <span class="n">perf_data</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">get_perf_data</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">epoch_label</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
                    <span class="n">sub_pred_results</span> <span class="o">=</span> <span class="n">perf_data</span><span class="o">.</span><span class="n">get_prediction_results</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tparam</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                        <span class="n">sub_pred_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r2_score&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rms_score&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sub_pred_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;roc_auc_score&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;accuracy_score&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">tparam</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                    <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;r2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_pred_results</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">]</span>
                    <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_pred_results</span><span class="p">[</span><span class="s1">&#39;rms_score&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_pred_results</span><span class="p">[</span><span class="s2">&quot;roc_auc_score&quot;</span><span class="p">]</span>
                    <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_pred_results</span><span class="p">[</span><span class="s2">&quot;accuracy_score&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tparam</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="o">-</span><span class="n">pred_results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="s2">&quot;r2&quot;</span><span class="p">],</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">STATUS_OK</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">tparam</span><span class="o">.</span><span class="n">model_tarball_path</span><span class="p">,</span> <span class="s1">&#39;featurizer&#39;</span><span class="p">:</span> <span class="n">tparam</span><span class="o">.</span><span class="n">featurizer</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">tparam</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
                    <span class="n">res_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_r2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;r2&quot;</span><span class="p">]</span>
                    <span class="n">res_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="o">-</span><span class="n">pred_results</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">],</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">STATUS_OK</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">tparam</span><span class="o">.</span><span class="n">model_tarball_path</span><span class="p">,</span> <span class="s1">&#39;featurizer&#39;</span><span class="p">:</span> <span class="n">tparam</span><span class="o">.</span><span class="n">featurizer</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">tparam</span><span class="o">.</span><span class="n">descriptor_type</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
                    <span class="n">res_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_roc_auc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">]</span>
                    <span class="n">res_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_acc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_results</span><span class="p">[</span><span class="n">subset</span><span class="p">][</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
            <span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;hp_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp_params</span>

            <span class="c1"># print the model metrics as logs</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tparam</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_performance|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;train_r2&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;train_rms&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;valid_r2&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;valid_rms&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;test_r2&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;test_rms&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;hp_params&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_performance|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;train_roc_auc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;train_acc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;valid_roc_auc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;valid_acc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;test_roc_auc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;test_acc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;hp_params&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">res_dict</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">res_dict</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_performance|train_r2|train_rms|valid_r2|valid_rms|test_r2|test_rms|model_params|model</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_performance|train_roc_auc|train_acc|valid_roc_auc|valid_acc|test_roc_auc|test_acc|model_params|model</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_load</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_load</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load hpo trial object from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_load</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_load</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">trials</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trials</span> <span class="o">=</span> <span class="n">Trials</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hp_checkpoint_save provided, save a checkpoint file every 5 trials.&quot;</span><span class="p">)</span>
            <span class="n">max_evals</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_save</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load hpo trial object from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_save</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_save</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">trials</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">max_evals</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_eval</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_evals</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_evals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_eval</span><span class="p">)</span>

                <span class="n">best</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">lossfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="n">tpe</span><span class="o">.</span><span class="n">suggest</span><span class="p">,</span> <span class="n">max_evals</span><span class="o">=</span><span class="n">max_evals</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save HPO trial object to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_save</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hp_checkpoint_save</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">max_evals</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_eval</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">lossfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="n">tpe</span><span class="o">.</span><span class="n">suggest</span><span class="p">,</span> <span class="n">max_evals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_eval</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating the performance -- iteration table and Copy the best model tarball.&quot;</span><span class="p">)</span>

        <span class="n">feat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;featurizer&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
        <span class="n">desc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
        <span class="n">hp_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;hp_params&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
        <span class="n">trial_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;trial&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))),</span> <span class="s2">&quot;featurizer&quot;</span><span class="p">:</span> <span class="n">feat_list</span><span class="p">,</span> <span class="s2">&quot;descriptor&quot;</span><span class="p">:</span> <span class="n">desc_list</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">:</span> <span class="n">hp_params_list</span><span class="p">}</span>
        <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">subsets</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                <span class="n">trial_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_r2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_r2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
                <span class="n">trial_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_rms&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trial_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_roc_auc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_roc_auc&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
                <span class="n">trial_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_acc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">_acc&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">))]</span>
        <span class="n">perf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trial_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="n">best_trial</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;valid_r2&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">best_trial</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best model: </span><span class="si">{</span><span class="n">best_model</span><span class="si">}</span><span class="s1">, valid R2: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;valid_r2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;valid_r2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_trial</span> <span class="o">=</span> <span class="n">perf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;valid_roc_auc&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="n">best_trial</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best model: </span><span class="si">{</span><span class="n">best_model</span><span class="si">}</span><span class="s1">, valid ROC_AUC: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;valid_roc_auc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;valid_roc_auc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">bmodel_prefix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">best_model</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">bmodel_uuid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">best_model</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">perf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;performance_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bmodel_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fd</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bmodel_uuid</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">best_model</span><span class="p">):</span>
            <span class="c1"># if the model tracker is used, the model won&#39;t be saved to the result_dir</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_dir</span><span class="p">,</span>
                                              <span class="sa">f</span><span class="s2">&quot;best_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bmodel_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fd</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bmodel_uuid</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="parse_params"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.parse_params">[docs]</a><span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="n">param_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse paramters</span>

<span class="sd">    Parses parameters using parameter_parser.wrapper and </span>
<span class="sd">    filters out unnecessary parameters. Returns what an</span>
<span class="sd">    argparse.Namespace</span>

<span class="sd">    Args:</span>
<span class="sd">        *any_arg: any single input of a str, dict, argparse.Namespace, or list</span>

<span class="sd">    Returns:</span>
<span class="sd">        argparse.Namespace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
    <span class="n">keep_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prediction_type&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;model_type&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;featurizer&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;hyperparam_uuid&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;splitter&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;datastore&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;save_results&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;previously_featurized&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;previously_split&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;prediction_type&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;descriptor_key&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;descriptor_type&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;split_valid_frac&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;split_test_frac&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;split_uuid&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;bucket&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;lc_account&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;slurm_account&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;slurm_export&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;slurm_nodes&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;slurm_options&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;slurm_partition&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;slurm_time_limit&#39;</span><span class="p">}</span> <span class="o">|</span> <span class="n">excluded_keys</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">search_type</span> <span class="o">==</span> <span class="s1">&#39;hyperopt&#39;</span><span class="p">:</span>
        <span class="c1"># keep more parameters</span>
        <span class="n">keep_params</span> <span class="o">=</span> <span class="n">keep_params</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_sizes&#39;</span><span class="p">,</span><span class="s1">&#39;ls_ratio&#39;</span><span class="p">,</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;dropouts&#39;</span><span class="p">,</span><span class="s1">&#39;rfe&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_estimators&#39;</span><span class="p">,</span><span class="s1">&#39;rfd&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_depth&#39;</span><span class="p">,</span><span class="s1">&#39;rff&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_max_features&#39;</span><span class="p">,</span><span class="s1">&#39;xgbg&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_gamma&#39;</span><span class="p">,</span><span class="s1">&#39;xgbl&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;hp_checkpoint_load&#39;</span><span class="p">,</span> <span class="s1">&#39;hp_checkpoint_save&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">prune_defaults</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">keep_params</span><span class="o">=</span><span class="n">keep_params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="build_search"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.build_search">[docs]</a><span class="k">def</span> <span class="nf">build_search</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Builds HyperparamterSearch object</span>

<span class="sd">        Looks at params.search_type and builds a HyperparamSearch object</span>
<span class="sd">        of the correct flavor. Will exit if the search_type is not</span>
<span class="sd">        recognized.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (Namespace): Namespace returned by </span>
<span class="sd">            atomsci.ddm.pipeline.parameter_parser.wrapper()</span>

<span class="sd">    Returns:</span>
<span class="sd">        HyperparameterSearch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">search_type</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">GridSearch</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">search_type</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">RandomSearch</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">search_type</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">GeometricSearch</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">search_type</span> <span class="o">==</span> <span class="s1">&#39;user_specified&#39;</span><span class="p">:</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">UserSpecifiedSearch</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">search_type</span> <span class="o">==</span> <span class="s1">&#39;hyperopt&#39;</span><span class="p">:</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">HyperOptSearch</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Incorrect search type specified&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hs</span></div>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../utils.html#utils.hyperparam_search_wrapper.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entry point when script is run</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">hs</span> <span class="o">=</span> <span class="n">build_search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">split_only</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
        <span class="n">hs</span><span class="o">.</span><span class="n">generate_split_shortlist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">split_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">datastore</span><span class="p">:</span>
        <span class="n">hs</span><span class="o">.</span><span class="n">generate_split_shortlist_file</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hs</span><span class="o">.</span><span class="n">run_search</span><span class="p">()</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ATOM DDM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>