<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>utils.datastore_functions &mdash; ATOM Data-Driven Modeling Pipeline 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ATOM Data-Driven Modeling Pipeline
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/running_ampl.html">Running AMPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_ampl_usage.html">Advanced AMPL Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_installation.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/advanced_testing.html">Advanced Testing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">atomsci</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ATOM Data-Driven Modeling Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">utils.datastore_functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for utils.datastore_functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; This file contains functions to make it easier to browse and retrieve data from the datastore.</span>
<span class="sd">    Intended for general use. Add/modify functions as needed. Created 23Jul18 CHW&#39;&#39;&#39;</span>

<span class="c1"># -------------setup section-----------------</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib3</span><span class="o">,</span><span class="nn">bravado</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="kn">from</span> <span class="nn">atomsci.ddm.utils.llnl_utils</span> <span class="kn">import</span> <span class="n">is_lc_system</span>
<span class="kn">import</span> <span class="nn">atomsci.ddm.utils.file_utils</span> <span class="k">as</span> <span class="nn">futils</span>

<span class="n">feather_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyarrow.feather</span> <span class="k">as</span> <span class="nn">feather</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
    <span class="n">feather_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">clients_supported</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="kn">import</span> <span class="n">DatastoreClient</span>
    <span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="kn">import</span> <span class="n">DatastoreClientSingleton</span>
    <span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="kn">import</span> <span class="n">MLMTClient</span>
    <span class="kn">from</span> <span class="nn">atomsci.clients</span> <span class="kn">import</span> <span class="n">MLMTClientSingleton</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;atomsci.clients package missing, is currently unsupported for non-ATOM users.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ATOM users should run &#39;pip install clients --user&#39; to install.&quot;</span><span class="p">)</span>
    <span class="n">clients_supported</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">## You must load your token to get access to the appropriate bucket where data is to be placed (or retrieved)</span>
<span class="c1"># refer to documentation on Confluence for how to create your token</span>



<span class="c1">#===function definition section==========================================================================</span>

<div class="viewcode-block" id="config_client"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.config_client">[docs]</a><span class="k">def</span> <span class="nf">config_client</span><span class="p">(</span>
        <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://twintron-blue.llnl.gov/atom/datastore/api/v1.0/swagger.json&#39;</span><span class="p">,</span>
        <span class="n">new_instance</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configures client to access datastore service.</span>

<span class="sd">    Args:</span>
<span class="sd">        token (str): Path to file containing token for accessing datastore. Defaults to </span>
<span class="sd">        /usr/local/data/ds_token.txt on non-LC systems, or to $HOME/data/ds_token.txt on LC systems.</span>

<span class="sd">        url (str): URL for datastore REST service.</span>

<span class="sd">        new_instance (bool): True to force creation of a new client object. By default, a shared</span>
<span class="sd">        singleton object is returned.</span>

<span class="sd">    Returns:</span>
<span class="sd">        returns configured client</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">clients_supported</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Datastore client not supported in current environment.&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default token path depends on whether you&#39;re on LC or another LLNL system</span>
        <span class="k">if</span> <span class="n">is_lc_system</span><span class="p">():</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">],</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;ds_token.txt&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;/usr/local/data/ds_token.txt&#39;</span>
    <span class="n">token_str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;DATASTORE_API_TOKEN&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">token_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATASTORE_API_TOKEN&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">token_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATASTORE_API_TOKEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_str</span>

    <span class="k">if</span> <span class="n">new_instance</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">DatastoreClient</span><span class="p">(</span><span class="n">default_url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                                 <span class="n">default_api_token</span><span class="o">=</span><span class="n">token_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">DatastoreClientSingleton</span><span class="p">(</span><span class="n">default_url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                                          <span class="n">default_api_token</span><span class="o">=</span><span class="n">token_str</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">api_token</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;token file not found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
            
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;and none of </span><span class="si">{}</span><span class="s2"> token env vars set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">DatastoreClient</span><span class="o">.</span><span class="n">api_token_env_str</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">client</span></div>


<span class="c1">#--------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="initialize_model_tracker"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.initialize_model_tracker">[docs]</a><span class="k">def</span> <span class="nf">initialize_model_tracker</span><span class="p">(</span><span class="n">new_instance</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create or obtain a client object for the model tracker service..</span>

<span class="sd">    Returns:</span>
<span class="sd">        mlmt_client (MLMTClientSingleton): The client object for the model tracker service.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">clients_supported</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Model tracker client not supported in current environment.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;MLMT_REST_API_URL&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MLMT_REST_API_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://twintron-blue.llnl.gov/atom/mlmt/api/v1.0/swagger.json&#39;</span>

    <span class="c1"># MLMT service uses same API token as datastore. Make sure it gets set in the environment.</span>
    <span class="n">ds_client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">new_instance</span><span class="p">:</span>
        <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">MLMTClient</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mlmt_client</span> <span class="o">=</span> <span class="n">MLMTClientSingleton</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">mlmt_client</span></div>

<span class="c1">#--------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="retrieve_bucket_names"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.retrieve_bucket_names">[docs]</a><span class="k">def</span> <span class="nf">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a list of the bucket names in datastore</span>

<span class="sd">    Args:</span>
<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): list of bucket names that exist in the datastore which user has access to&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_buckets</span><span class="o">.</span><span class="n">get_buckets</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="n">buckets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
    <span class="n">buckets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">buckets</span><span class="p">[</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">buckets</span></div>


<span class="c1">#------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="retrieve_keys"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.retrieve_keys">[docs]</a><span class="k">def</span> <span class="nf">retrieve_keys</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of keys in bucket(s) specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str, optional): &#39;all&#39; by default. Specify bucket (as a str or list) to limit search</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        sort (bool, optional): if &#39;True&#39; (default), sort the keys alphabetically</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): returns a list of keys in bucket(s) specified&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">bucket</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;retrieving keys for all buckets...&#39;</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_metadef</span><span class="o">.</span><span class="n">get_metadata_keys</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">]</span>

        <span class="c1"># check if requested buckets are valid bucket names</span>
        <span class="n">all_buckets</span> <span class="o">=</span> <span class="n">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">valid_buckets</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_buckets</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">]</span> <span class="c1">#compares the list of &#39;valid&#39; buckets with the requested list</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_buckets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_buckets</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not all buckets requested all valid buckets. Keys will be retrieved for the following buckets:&quot;</span><span class="p">)</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">valid_buckets</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_buckets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Requested bucket(s) are not valid.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_metadef</span><span class="o">.</span><span class="n">get_metadata_keys</span><span class="p">(</span><span class="n">bucket_names</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">keys</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="key_exists"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.key_exists">[docs]</a><span class="k">def</span> <span class="nf">key_exists</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if key exists in bucket(s) specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): the key of interest</span>

<span class="sd">        bucket (str or list, optional): &#39;all&#39; by default. Specify bucket (as a str or list) to limit search</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">    Returns:</span>
<span class="sd">        (bool): Returns True if key exists in bucket(s) specified&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;key&#39; must be a string&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bucket</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="c1"># generate list of valid keys for all buckets</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_metadef</span><span class="o">.</span><span class="n">get_metadata_keys</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">]</span>

         <span class="c1"># check if requested buckets are valid bucket names</span>
        <span class="n">all_buckets</span> <span class="o">=</span> <span class="n">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">valid_buckets</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_buckets</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">]</span> <span class="c1">#compares the list of &#39;valid&#39; buckets with the requested list</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_buckets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_buckets</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not all buckets requested all valid buckets. Keys will be retrieved for the following buckets:&quot;</span><span class="p">)</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">valid_buckets</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_buckets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Requested bucket(s) are not valid.&quot;</span><span class="p">)</span>

        <span class="c1"># generate list of valid keys for bucket(s) specified</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_metadef</span><span class="o">.</span><span class="n">get_metadata_keys</span><span class="p">(</span><span class="n">bucket_names</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="c1">#check if key specified is in &#39;valid key&#39; list</span>
    <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span></div>


<span class="c1">#------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="retrieve_values_for_key"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.retrieve_values_for_key">[docs]</a><span class="k">def</span> <span class="nf">retrieve_values_for_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of values associated with a specified key.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): the key of interest</span>

<span class="sd">        bucket (str or list, optional): &#39;all&#39; by default. Specify bucket (as a str or list) to limit search</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): Returns a list of values (str) associated with a specified key&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key must be a string&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bucket</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="c1"># evaluate if key is valid</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="n">retrieve_keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;specified key does not exist&#39;</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_metadef</span><span class="o">.</span><span class="n">get_metadata_key_values</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;value_types&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">]</span>

        <span class="c1"># evaluate if bucket name is valid</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">:</span>
            <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">all_buckets</span> <span class="o">=</span> <span class="n">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket_name</span> <span class="ow">in</span> <span class="n">all_buckets</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bucket does not exist&#39;</span><span class="p">)</span>

        <span class="c1"># evaluate if key is valid</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="n">retrieve_keys</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;specified key does not exist in bucket(s) specified&#39;</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_metadef</span><span class="o">.</span><span class="n">get_metadata_key_values</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket_names</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;value_types&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">value_type</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value_type</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">]:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">values</span></div>


<span class="c1">#------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="dataset_key_exists"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.dataset_key_exists">[docs]</a><span class="k">def</span> <span class="nf">dataset_key_exists</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a boolean indicating whether the given dataset_key is already present in the bucket specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_key (str): the dataset_key for the dataset you want (unique in each bucket)</span>

<span class="sd">        bucket (str): the bucket the dataset you want resides in</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">    Returns:</span>
<span class="sd">        (bool): returns &#39;True&#39; if dataset_key is present in bucket specified&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># check that bucket exists</span>
    <span class="n">all_buckets</span> <span class="o">=</span> <span class="n">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">all_buckets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bucket does not exist&#39;</span><span class="p">)</span>

    <span class="c1"># check that dataset_key exists in bucket</span>
    <span class="n">all_dataset_keys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_dataset_distinct_dataset_keys</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dataset_key</span> <span class="ow">in</span> <span class="n">all_dataset_keys</span><span class="p">)</span></div>


<span class="c1">#------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="retrieve_dataset_by_datasetkey"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.retrieve_dataset_by_datasetkey">[docs]</a><span class="k">def</span> <span class="nf">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tarpath</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the dataset and returns as a pandas dataframe (or other format as needed depending on file type).</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_key (str): the dataset_key for the dataset you want (unique in each bucket)</span>

<span class="sd">        bucket (str): the bucket the dataset you want resides in</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        return_metadata (bool, optional): if set to True, return a dictionary of the metadata INSTEAD of a dataframe of the data</span>

<span class="sd">        nrows (num, optional): used to limit the number of rows returned</span>

<span class="sd">        print_metadata (bool, optional): if set to True, displays the document metadata/properties</span>

<span class="sd">        sep (str, optional): separator used for csv file</span>

<span class="sd">        tarpath (str, optional): path to use for tarball files</span>

<span class="sd">        index_col (int, optional): For csv files, column to use as the row labels of the DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        (DataFrame, OrderedDict, str, dict): filetype determines what type of object is returned.</span>
<span class="sd">        xls and xlsx files returns an OrderedDict.</span>
<span class="sd">        tarball (gz and tgz) files returns the location of the files as a string</span>
<span class="sd">        csv returns a DataFrame</span>

<span class="sd">        optionally, return a dictionary of the metadata only if &#39;return_metadata&#39; is set to TRUE.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># check that bucket exists</span>
    <span class="n">all_buckets</span> <span class="o">=</span> <span class="n">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">all_buckets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bucket does not exist&#39;</span><span class="p">)</span>

    <span class="c1"># check that dataset_key exists in bucket</span>
    <span class="c1"># JEA comment:</span>
    <span class="c1"># this is not going to scale well to millions of keys</span>
    <span class="c1"># and an exception will already be thrown if the dataset key is not found</span>
    <span class="c1"># I think this should be removed</span>
    <span class="c1">#all_dataset_keys = client.ds_datasets.get_dataset_distinct_dataset_keys(bucket_name=bucket).result()</span>
    <span class="c1">#if not dataset_key in all_dataset_keys:</span>
    <span class="c1">#    raise ValueError(&#39;dataset_key {0} does not exist in bucket {1}&#39;.format(dataset_key, bucket))</span>

    <span class="k">try</span> <span class="p">:</span>
        <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_bucket_dataset</span> <span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">bravado</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">file_type</span> <span class="o">=</span> <span class="n">all_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">print_metadata</span><span class="p">:</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">all_metadata</span>

    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;bz2&#39;</span><span class="p">:</span>
        <span class="c1"># bz2.  Read bz2 file in binary mode, then decompress to text. Return as dataframe.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_bucket_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span>
        <span class="n">dict_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i_row</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dict_reader</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i_row</span> <span class="o">&gt;=</span> <span class="n">nrows</span><span class="p">:</span>
                    <span class="c1">#i_row += 1</span>
                    <span class="k">break</span>
            <span class="n">i_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;pkl&#39;</span><span class="p">:</span>
        <span class="c1"># pickle file. Open in binary.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_bucket_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">==</span><span class="nb">bytes</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
        <span class="c1"># csv file.  Open in text mode for csv reader. Return as dataframe.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_bucket_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>\

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;feather&#39;</span><span class="p">:</span>
        <span class="c1"># feather file. Return as dataframe.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feather_supported</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;feather-format not installed in your current environment&quot;</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_bucket_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="c1"># Have to save the feather file to disk first, because feather.read_dataframe needs to seek</span>
        <span class="n">tmp_fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">tmp_fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">tmp_fd</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%d</span><span class="s2"> bytes of data from datastore&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">tmp_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote data to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tmp_path</span><span class="p">)</span>
        <span class="n">tmp_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading data into data frame&quot;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">feather</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;xls&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">:</span>
        <span class="c1"># xls or xlsx file. Return as a ordered dictionary</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_bucket_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">num_sheets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">sheet_names</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Excel workbook has </span><span class="si">%s</span><span class="s1"> sheets&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">num_sheets</span><span class="p">),</span> <span class="s1">&#39;Sheet names = &#39;</span><span class="p">,</span> <span class="n">sheet_names</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tip: use OrderedDict.get(sheet_name) to extract a specific sheet&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;tgz&#39;</span><span class="p">:</span>
        <span class="c1"># tar.gz (tarball) file. Extract to path specified and return path.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_bucket_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">futils</span><span class="o">.</span><span class="n">safe_extract</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">tarpath</span><span class="p">)</span>

        <span class="c1">#get new folder name and return full path</span>
        <span class="n">extracted_dir</span> <span class="o">=</span> <span class="n">all_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span>
        <span class="n">extracted_dir</span> <span class="o">=</span> <span class="n">extracted_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># TODO: This is misleading; the original filename is not necessarily preserved in the tar file.</span>
        <span class="c1"># TODO: Just return tarpath.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tarpath</span><span class="p">,</span> <span class="n">extracted_dir</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="s1">&#39;file type not recognized</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="s2">&quot;all_metadata[&#39;distribution&#39;][&#39;dataType&#39;]:&quot;</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">])</span>


    <span class="k">return</span> <span class="n">dataset</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="retrieve_dataset_by_dataset_oid"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.retrieve_dataset_by_dataset_oid">[docs]</a><span class="k">def</span> <span class="nf">retrieve_dataset_by_dataset_oid</span><span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tarpath</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; retrieves the dataset and returns as a pandas dataframe (or other format as needed depending on file type).</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_oid (str): unique identifier for the dataset you want</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        return_metadata (bool, optional): if set to True, return a dictionary of the metadata INSTEAD of a dataframe of the data</span>

<span class="sd">        nrows (num, optional): used to limit the number of rows returned</span>

<span class="sd">        print_metadata (bool, optional): if set to True, displays the document metadata/properties</span>

<span class="sd">        sep (str, optional): separator used for csv file</span>

<span class="sd">        tarpath (str, optional): path to use for tarball files</span>

<span class="sd">        index_col (int, optional): For csv files, column to use as the row labels of the DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        (DataFrame, OrderedDict, str, dict): filetype determines what type of object is returned.</span>
<span class="sd">        xls and xlsx files returns an OrderedDict.</span>
<span class="sd">        tarball (gz and tgz) files returns the location of the files as a string</span>
<span class="sd">        csv returns a DataFrame</span>

<span class="sd">        optionally, return a dictionary of the metadata only if &#39;return_metadata&#39; is set to TRUE.&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;caution: dataset_oid is version specific. Newer versions of this file might be available.&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">dataset_oid</span> <span class="o">=</span> <span class="n">dataset_oid</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">print_metadata</span><span class="p">:</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">all_metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">all_metadata</span>

    <span class="n">file_type</span> <span class="o">=</span> <span class="n">all_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;bz2&#39;</span><span class="p">:</span>
        <span class="c1"># bz2.  Read bz2 file in binary mode, then decompress to text.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span>
        <span class="n">dict_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i_row</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dict_reader</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i_row</span> <span class="o">&gt;=</span> <span class="n">nrows</span><span class="p">:</span>
                    <span class="c1">#i_row += 1</span>
                    <span class="k">break</span>
            <span class="n">i_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;pkl&#39;</span><span class="p">:</span>
        <span class="c1"># pickle file. Open in binary</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">==</span><span class="nb">bytes</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
        <span class="c1"># csv file.  Open in text mode for csv reader.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;xls&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">:</span>
        <span class="c1"># xls or xlsx file. Return as a ordered dictionary</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">num_sheets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">sheet_names</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Excel workbook has </span><span class="si">%s</span><span class="s1"> sheets&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">num_sheets</span><span class="p">),</span> <span class="s1">&#39;Sheet names = &#39;</span><span class="p">,</span> <span class="n">sheet_names</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tip: use OrderedDict.get(sheet_name) to extract a specific sheet&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;tgz&#39;</span><span class="p">:</span>
        <span class="c1"># tar.gz (tarball) file. Extract to path specified and return path.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">futils</span><span class="o">.</span><span class="n">safe_extract</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">tarpath</span><span class="p">)</span>

        <span class="c1">#get new folder name and return full path</span>
        <span class="n">extracted_dir</span> <span class="o">=</span> <span class="n">all_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span>
        <span class="n">extracted_dir</span> <span class="o">=</span> <span class="n">extracted_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tarpath</span><span class="p">,</span> <span class="n">extracted_dir</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s1">&#39;file type not recognized </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="s2">&quot;all_metadata[&#39;distribution&#39;][&#39;dataType&#39;]:&quot;</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">dataset</span></div>

<span class="c1">#------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="search_datasets_by_key_value"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.search_datasets_by_key_value">[docs]</a><span class="k">def</span> <span class="nf">search_datasets_by_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">display_all_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find datasets by key:value pairs and returns a DataFrame of datasets and associated properties.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): the key of interest</span>

<span class="sd">        value (str): the value of interest</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        operator (str, optional): &#39;in&#39; by default, but can be changed to any of the following:</span>
<span class="sd">                       =, !=, &lt;, &lt;=, &gt;, &gt;=, all, in, not in</span>

<span class="sd">        bucket (str or list, optional): &#39;all&#39; by default. Specify bucket (as a str or list) to limit search</span>

<span class="sd">        display_all_columns (bool, optional): If &#39;False&#39; (default), then show only a selected subset of the columns</span>

<span class="sd">    Returns:</span>
<span class="sd">        (DataFrame): summary table of the files and relevant metadata matching the criteria specified&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key must be a string&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="p">}</span> <span class="p">])</span>

    <span class="k">if</span> <span class="n">bucket</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="c1"># evaluate if key is valid</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="n">retrieve_keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;specified key does not exist&#39;</span><span class="p">)</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">]</span>

        <span class="c1"># evaluate if bucket name is valid</span>
        <span class="n">all_buckets</span> <span class="o">=</span> <span class="n">retrieve_bucket_names</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">:</span>
            <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket_name</span> <span class="ow">in</span> <span class="n">all_buckets</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bucket does not exist&#39;</span><span class="p">)</span>

        <span class="c1"># evaluate if key is valid</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="n">retrieve_keys</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;specified key does not exist in bucket(s) specified&#39;</span><span class="p">)</span>


        <span class="n">datasets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">bucket_names</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No datasets found matching criteria specified&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">display_all_columns</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_key&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;user_perm&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">]</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">datasets</span></div>


<span class="c1">#-------------------------------------------------------------------------------------------------------</span>
   <span class="c1"># extracted this function (with small modifications) from join.ipynb</span>
<div class="viewcode-block" id="retrieve_columns_from_dataset"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.retrieve_columns_from_dataset">[docs]</a><span class="k">def</span> <span class="nf">retrieve_columns_from_dataset</span> <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">return_names</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve column(s) from csv file (may be bz2 compressed) in datastore.</span>
<span class="sd">       &#39;NA&#39; returned if column not in file (as well as warning message).</span>

<span class="sd">    Args:</span>
<span class="sd">        return_names (bool): If true, just return column headers from file</span>

<span class="sd">        max_rows (int): default=0 which will return all rows</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">    Returns:</span>
<span class="sd">       (dict): dictionary corresponding to selected columns</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># Check column_names input.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span> <span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span> <span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span> <span class="p">(</span><span class="s1">&#39;get_columns_csv: Second argument should be column name or list of column names&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_names</span><span class="p">]</span>


    <span class="n">dataset_result</span> \
            <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span> \
                    <span class="o">.</span><span class="n">get_bucket_dataset</span> <span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
                                         <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">)</span><span class="o">.</span><span class="n">result</span> <span class="p">()</span>
    <span class="n">dataset_oid</span> <span class="o">=</span> <span class="n">dataset_result</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s1">&#39;dataset_oid&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset_result</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bz2&#39;</span><span class="p">:</span>

        <span class="c1"># bz2.  Read bz2 file in binary mode, then decompress to text.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">dataset_result</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>

        <span class="c1"># csv file.  Open in text mode for csv reader.</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_dataset</span> <span class="p">(</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="s1">&#39;does not appear to be either a csv or bz2 file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="s2">&quot;dataset_result[&#39;distribution&#39;][&#39;dataType&#39;]:&quot;</span><span class="p">,</span> <span class="n">dataset_result</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;dataType&#39;</span><span class="p">])</span>

    <span class="n">dict_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>

    <span class="c1"># Set up dict to be returned.</span>
    <span class="n">selected_columns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
        <span class="n">selected_columns</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check which columns in this file.</span>
    <span class="n">header_names</span> <span class="o">=</span> <span class="n">dict_reader</span><span class="o">.</span><span class="n">fieldnames</span>

    <span class="k">if</span> <span class="n">return_names</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">header_names</span>


    <span class="n">column_names_valid_b</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
        <span class="n">column_name_valid_b</span> <span class="o">=</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">header_names</span>
        <span class="n">column_names_valid_b</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">column_name_valid_b</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_name_valid_b</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Note: column&#39;</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Reading &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;... &#39;</span><span class="p">)</span>
    <span class="n">i_row</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dict_reader</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span> <span class="p">(</span><span class="n">column_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">column_names_valid_b</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">selected_columns</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_columns</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i_row</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">i_row</span><span class="p">,</span> <span class="s1">&#39;rows                    &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i_row</span> <span class="o">&gt;=</span> <span class="n">max_rows</span><span class="p">:</span>
                <span class="n">i_row</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>

        <span class="n">i_row</span> <span class="o">+=</span> <span class="mi">1</span>


    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Done.  Read </span><span class="si">%d</span><span class="s1"> rows&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i_row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">selected_columns</span></div>


<span class="c1">#------------------------------------</span>

<div class="viewcode-block" id="filter_datasets_interactive"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.filter_datasets_interactive">[docs]</a><span class="k">def</span> <span class="nf">filter_datasets_interactive</span> <span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">restrict_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">restrict_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dataset_oid_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_all_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1">#TODO: This function has been replaced by &#39;search_files_interactive&#39;.</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is an old way of searching for files. Not based on the current format. Only use</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str or list, optional): buckets to search (defaults to searching all buckets you have access to in the datastore)</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        restrict_key (bool, optional): if set to True, restricts the search to keys that are on the approved list (see file in bucket with dataset_key: accepted_key_values)</span>

<span class="sd">        restrict_key (bool, optional): if set to True, restricts the search to values that are on the approved list (see file in bucket with dataset_key: accepted_key_values)</span>

<span class="sd">        dataset_oid_only (bool, optional): if True, return a list of dataset_oids meeting the criteria;   if False, returns a dataframe of all the metadata for the files meeting search criteria</span>

<span class="sd">        display_all_columns (bool, optional): If &#39;False&#39; (default), then show only a selected subset of the columns</span>

<span class="sd">        max_rows (int, optional): maximum rows to display during interactive search</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAUTION: Use of filter_datasets_interactive is not recommended. This function has been replaced with &#39;search_files_interactive&#39;. Please use &#39;search_files_interactive&#39; instead&quot;</span><span class="p">)</span>
    <span class="c1">#configure client</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># retrieve file with accepted keys and values if available (if user wants to restrict search to &#39;approved&#39; keys:values)</span>
    <span class="k">if</span> <span class="n">restrict_key</span> <span class="ow">or</span> <span class="n">restrict_value</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kv_lookup</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="s1">&#39;accepted_key_values&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted_keys_values not defined for bucket(s) chosen. restrict_key and restrict_value will be set to False.&#39;</span><span class="p">)</span>
            <span class="n">restrict_key</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">restrict_value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">search_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">]</span>
    <span class="c1"># provide list of keys and have user select option</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select a key from the following list:&#39;</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">retrieve_keys</span><span class="p">(</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">restrict_key</span><span class="p">:</span>
        <span class="n">approved_keys</span> <span class="o">=</span> <span class="n">kv_lookup</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_keys</span><span class="p">))</span> <span class="c1">#display only keys that are both Approved and In use</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

        <span class="c1">#provides examples of types of values associated with the key to help users pick the key they want</span>
    <span class="n">example_val_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">example_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">example_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_val</span><span class="p">)</span>

        <span class="n">temp_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_examples&#39;</span><span class="p">:</span> <span class="n">example_val_list</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">:</span> <span class="n">keys</span><span class="p">,</span> <span class="p">}</span>
    <span class="n">display</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a key: &#39;</span><span class="p">)</span>

    <span class="c1"># provide list of values and have user select option</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select value(s) for key=&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;from the following list: &#39;</span><span class="p">)</span>
    <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">retrieve_values_for_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">restrict_value</span><span class="p">:</span>
        <span class="n">approved_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">values_for_key</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values_for_key</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_values</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter value(s) (comma separated for multiple values):  &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="c1">#save key and value(s) searched</span>
    <span class="n">search_criteria</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">})</span>

    <span class="c1"># return dataframe of datasets meeting user specified criteria</span>
    <span class="n">dataset_list</span> <span class="o">=</span> <span class="n">search_datasets_by_key_value</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">display_all_columns</span><span class="o">=</span><span class="n">display_all_columns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of datasets found meeting criteria =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_rows</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Displaying first </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">max_rows</span><span class="p">))</span>
    <span class="n">display</span><span class="p">(</span><span class="n">dataset_list</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_rows</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset_list</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">repeat</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Apply additional filter? (y/n)&#39;</span><span class="p">)</span>

 <span class="c1">#   if repeat == &#39;n&#39;:</span>
  <span class="c1">#      return dataset_list</span>

    <span class="k">while</span> <span class="n">repeat</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="n">key_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">new</span><span class="o">=</span> <span class="n">key_values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">key_val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_val</span> <span class="o">=</span> <span class="n">key_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;key_val size&#39;</span><span class="p">,</span><span class="n">key_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[:])</span>

        <span class="n">unique_keys</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select a key from the following list:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restrict_key</span><span class="p">:</span>
            <span class="n">unique_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_keys</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;keys&#39;</span><span class="p">)]</span>
        <span class="n">unique_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_keys</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

        <span class="n">example_val_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">unique_keys</span><span class="p">:</span>
            <span class="n">example_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">example_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_val</span><span class="p">)</span>

        <span class="n">temp_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_examples&#39;</span><span class="p">:</span> <span class="n">example_val_list</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">:</span> <span class="n">unique_keys</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">display</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">))</span>

        <span class="n">new_key</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a key: &#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select value(s) for key=&#39;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;from the following list: &#39;</span><span class="p">)</span>

        <span class="n">new_value</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="n">key_val</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_key</span><span class="p">]</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">restrict_value</span><span class="p">:</span>
            <span class="n">approved_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">new_value</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_values</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;if statement true&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter value(s) (comma separated for multiple values):  &#39;</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_value</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;values selected =&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_value</span><span class="p">))</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#extract the values associated with the key</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">dataset_list</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>  <span class="c1">#extracts keys from a</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;key_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col</span>

        <span class="n">dataset_list2</span> <span class="o">=</span> <span class="n">dataset_list</span><span class="p">[</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;key_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_value</span><span class="p">))</span> <span class="p">]</span>
        <span class="c1">#save key and value(s) searched</span>
        <span class="n">search_criteria</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">new_value</span><span class="p">,</span> <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">})</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of datasets found meeting criteria =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_rows</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Displaying first </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">max_rows</span><span class="p">))</span>
        <span class="n">display</span><span class="p">(</span><span class="n">dataset_list2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_rows</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">dataset_list</span> <span class="o">=</span> <span class="n">dataset_list2</span><span class="p">[:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--dataset_list length = &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span>

        <span class="n">repeat</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Apply additional filter? (y/n)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dataset_oid_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;dataset_oid&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">save_search</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;search_criteria =&#39;</span><span class="p">,</span> <span class="n">search_criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">search_criteria</span>

    <span class="k">return</span> <span class="n">dataset_list</span></div>


<span class="c1">#---------------------------------------------------</span>
<div class="viewcode-block" id="summarize_datasets"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.summarize_datasets">[docs]</a><span class="k">def</span> <span class="nf">summarize_datasets</span><span class="p">(</span><span class="n">dataset_keys</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_ht</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate summary statistics such as min/max/median/mean on files specified (all files must be in same bucket).</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_keys (list): dataset_keys corresponding to the files to summarize</span>

<span class="sd">        bucket (str): bucket the files reside in</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        column (str, optional): column to summarize (will be prompted to specify if not pre-specified or if column does not exist in file)</span>

<span class="sd">        save_as (str, optional): filename to save image of box plot(s) to</span>

<span class="sd">        plot_ht (int, optional): height of box plots (default = 10)</span>

<span class="sd">        labels (&#39;str&#39;, optional):</span>

<span class="sd">        last (bool optional): If True (default=False), then summarize values from last column instead of specifying column heading</span>

<span class="sd">    Returns</span>
<span class="sd">        (DataFrame): returns table summarizing the stats for the file(s) specified</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset_keys</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">dataset_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_keys</span><span class="p">]</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">check_col</span> <span class="o">=</span> <span class="n">column</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dataset_keys</span><span class="p">:</span>
        <span class="c1">#retrieve the dataset as a pandas dataframe</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>

        <span class="c1"># use the values in the last column</span>
        <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># provide a list of column names if column is not already specified</span>
        <span class="k">if</span> <span class="n">check_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                    <span class="n">column</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Pick a column from list to analyze: &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                <span class="n">column</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Pick a column from list to analyze: &quot;</span><span class="p">)</span>


        <span class="c1"># calculate stats for the column indicated</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">median</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">col_mode</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

        <span class="c1"># combine stats into a summary table (pandas dataframe)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="p">[</span><span class="n">col_mode</span><span class="p">]]</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">])</span>
        <span class="n">summary_temp</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">summary_table</span> <span class="o">=</span> <span class="n">summary_temp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">})</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary_table</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_temp</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
            <span class="n">data_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">display</span><span class="p">(</span><span class="n">summary_table</span><span class="p">)</span>

    <span class="c1"># generate box and whisker plot</span>

        <span class="c1"># Create a figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset_keys</span><span class="p">),</span> <span class="n">plot_ht</span><span class="p">))</span>

        <span class="c1"># Create an axes instance</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="c1"># Create the boxplot</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="c1"># Set x-labels for boxplot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_as</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_as</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">summary_table</span></div>

<span class="c1">#----------------------------------------</span>


<div class="viewcode-block" id="check_key_val"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.check_key_val">[docs]</a><span class="k">def</span> <span class="nf">check_key_val</span><span class="p">(</span><span class="n">key_values</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enforced</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Checks to ensure the keys and values specified are &#39;approved&#39; and that (optionally) all required keys are filled out.</span>

<span class="sd">    Args:</span>
<span class="sd">        key_values (dict): keys and values specified by user for a file</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        df (DataFrame): dataframe to be uploaded</span>

<span class="sd">        enforced (bool, optional): If True (default) checks that all required keys are filled out</span>

<span class="sd">    Returns:</span>
<span class="sd">        (bool): returns True if all keys and values are &#39;approved&#39; AND enforcement criteria are met&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;file_category&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;file_category must be specified.&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1">#check if file_category is valid</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">(</span><span class="n">dataset_key_regex</span><span class="o">=</span><span class="s1">&#39;kv_lookup*&#39;</span><span class="p">,</span> <span class="n">bucket_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">kv_lookup_dataset_keys</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]</span>
    <span class="n">valid_file_category</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="n">valid_file_category</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kv_lookup_dataset_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;kv_lookup_&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">key_values</span><span class="p">[</span><span class="s1">&#39;file_category&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_file_category</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid file_category. Must be one of the following: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">valid_file_category</span><span class="p">)</span>

    <span class="c1"># generate dataset_key to retrieve the appropriate key:value lookup table</span>
    <span class="n">file_cat</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="s1">&#39;file_category&#39;</span><span class="p">]</span>
    <span class="n">kv_lookup_dskey</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;kv_lookup_&#39;</span><span class="p">,</span><span class="n">file_cat</span><span class="p">])</span>  <span class="c1">#will need to enable to switch to auto-look up by category in default</span>
    <span class="n">kv_lookup</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">kv_lookup_dskey</span><span class="p">)</span>
    <span class="c1">#kv_lookup = pd.read_csv(kv_lookup_dskey+&#39;.csv&#39;)</span>

    <span class="c1"># check that all keys are valid</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kv_lookup</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key=</span><span class="si">%s</span><span class="s1"> invalid&#39;</span> <span class="o">%</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39; Valid options include:&#39;</span><span class="p">,</span> <span class="n">kv_lookup</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># check that specified values are valid for given key</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">key_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;value=</span><span class="si">%s</span><span class="s1"> invalid&#39;</span> <span class="o">%</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;valid values for key=</span><span class="si">%s</span><span class="s1"> include:&#39;</span> <span class="o">%</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>

        <span class="c1"># when applicable, check that the values input for id_col, smiles_col, and response_col are all headings that exist</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">col_heading_req</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">,</span> <span class="s1">&#39;smiles_col&#39;</span><span class="p">,</span><span class="s1">&#39;response_col&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_smiles_col&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_heading_req</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">avail_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">col_head_value</span> <span class="o">=</span> <span class="n">key_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col_head_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avail_headings</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;value for key=</span><span class="si">%s</span><span class="s1"> invalid. Pick from these column headings:&#39;</span> <span class="o">%</span><span class="n">col</span><span class="p">,</span> <span class="n">avail_headings</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">enforced</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; This section checks to make sure all relevent keys have been filled in based on other selections made</span>
<span class="sd">             for example: if user includes &#39;curation_level&#39;:&#39;ml_ready&#39; as a key:value pair, then additional keys such as &#39;units&#39; are also required</span>
<span class="sd">             1) this section requires the following 3 columns in the kv_lookup file: &#39;enforced_on_key&#39;, &#39;enforced_on_value&#39;, and &#39;required_keys&#39;.</span>
<span class="sd">             2) if the &#39;enforced_on&#39; key:value matches one input, then it checks to make sure all of the keys listed in the corresponding row in the</span>
<span class="sd">                &#39;required_keys&#39; column have been filled out &#39;&#39;&#39;</span>

        <span class="n">num_enforced_key</span> <span class="o">=</span> <span class="n">kv_lookup</span><span class="p">[</span><span class="s1">&#39;enforced_on_key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_enforced_key</span><span class="p">:</span>
            <span class="n">enforced_key</span> <span class="o">=</span> <span class="n">kv_lookup</span><span class="p">[</span><span class="s1">&#39;enforced_on_key&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">enforced_value</span> <span class="o">=</span> <span class="n">kv_lookup</span><span class="p">[</span><span class="s1">&#39;enforced_on_value&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">enforced_key</span> <span class="ow">in</span> <span class="n">key_values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">enforced_value</span> <span class="ow">in</span> <span class="n">key_values</span><span class="p">[</span><span class="n">enforced_key</span><span class="p">]:</span>
                    <span class="n">required</span> <span class="o">=</span> <span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="s1">&#39;required_keys&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_values</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Required key missing: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">key</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>

<span class="c1">#------------------------------------------------</span>
<div class="viewcode-block" id="upload_file_to_DS"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.upload_file_to_DS">[docs]</a><span class="k">def</span> <span class="nf">upload_file_to_DS</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">key_values</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">file_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function will upload a file to the Datastore along with the associated metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): bucket the file will be put in</span>

<span class="sd">        title (str): title of the file in (human friendly format)</span>

<span class="sd">        description (str): long text box to describe file (background/use notes)</span>

<span class="sd">        tags (list): must be a list.</span>

<span class="sd">        key_values (dict): key:value pairs to enable future users to find the file. Must be a dictionary.</span>

<span class="sd">        filepath (str): current location of the file</span>

<span class="sd">        filename (str): current filename of the file</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        dataset_key (str, optional): If updating a file already in the datastore enter the corresponding dataset_key.  If not, leave as &#39;none&#39; and the dataset_key will be automatically generated.</span>

<span class="sd">        override_check (bool, optional): If &#39;True&#39; then do NOT perform a check of the keys/values against approved list and enforcement criteria</span>

<span class="sd">        return_metadata (bool, optional): If &#39;True&#39; (default=False), then return the metadata from the uploaded file</span>

<span class="sd">        file_ref (bool, optional): If &#39;True&#39; (default=False), links file to the datastore instead of creating a copy to managed by the datastore.</span>

<span class="sd">        data_type (str,optional): Specify dataType (e.g. csv,bz, etc) if not specified attempt to use file extension</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dict): optionally returns the metadata from the uploaded file (if return_metadata=True)&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key_values must be a dictionary&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">override_check</span><span class="p">:</span>
        <span class="c1">## JEA when pd is big, this will cause problems</span>
        <span class="n">check_key_val</span><span class="p">(</span><span class="n">key_values</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">key_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>

    <span class="n">key_values</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">key_values</span><span class="p">])</span>

    <span class="c1">#fileObj is what the datastore uploads</span>
    <span class="c1">#check file type</span>
    <span class="n">split_file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">split_file_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#only open file if not creating a link</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_ref</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">:</span>
            <span class="n">fileObj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileObj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dataset_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset_key</span> <span class="o">=</span> <span class="n">filepath</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_ref</span> <span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">upload_dataset</span><span class="p">(</span>
           <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
           <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
           <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
           <span class="n">metadata_obj</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span>
           <span class="n">fileObj</span><span class="o">=</span><span class="n">fileObj</span><span class="p">,</span>
           <span class="n">dataType</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
           <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span>
           <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">reference_dataset</span><span class="p">(</span>
           <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
           <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
           <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
           <span class="n">metadata_obj</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span>
           <span class="n">fileURL</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
           <span class="n">dataType</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
           <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span>
           <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span></div>

<span class="c1">#------------------------------------------------</span>
<div class="viewcode-block" id="upload_df_to_DS"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.upload_df_to_DS">[docs]</a><span class="k">def</span> <span class="nf">upload_df_to_DS</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">key_values</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function will upload a file to the Datastore along with the associated metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): dataframe to be uploaded</span>

<span class="sd">        bucket (str): bucket the file will be put in</span>

<span class="sd">        filename (str): the filename to save the dataframe as in the datastore. Include the extension</span>

<span class="sd">        title (str): title of the file in (human friendly format)</span>

<span class="sd">        description (str): long text box to describe file (background/use notes)</span>

<span class="sd">        tags (list): must be a list.</span>

<span class="sd">        key_values (dict): key-value pairs to enable future users to find the file. Must be a dictionary.</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        dataset_key (str): If updating a file already in the datastore enter the corresponding dataset_key.  If not, leave as &#39;none&#39; and the dataset_key will be automatically generated.</span>

<span class="sd">        data_type (str,optional): Specify dataType (e.g. csv,bz, etc) if not specified attempt to use file extension</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dict): if return_metadata=True, then function returns a dictionary of the metadata for the uploaded dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key_values must be a dictionary&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">override_check</span><span class="p">:</span>
        <span class="n">check_key_val</span><span class="p">(</span><span class="n">key_values</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>


    <span class="n">df_shape</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[:]</span>
    <span class="n">num_row</span> <span class="o">=</span> <span class="n">df_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_col</span> <span class="o">=</span> <span class="n">df_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">key_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;num_row&#39;</span><span class="p">:</span><span class="n">num_row</span><span class="p">,</span> <span class="s1">&#39;num_col&#39;</span><span class="p">:</span><span class="n">num_col</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>


    <span class="n">key_values</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">key_values</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span>
    <span class="k">elif</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;filename extension must be .csv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>

    <span class="k">if</span> <span class="n">dataset_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset_key</span> <span class="o">=</span> <span class="n">bucket</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">filename</span>

    <span class="n">fileObj</span><span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="n">req</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">upload_dataset</span><span class="p">(</span>
       <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
       <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
       <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
       <span class="n">metadata_obj</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span>
       <span class="n">fileObj</span><span class="o">=</span><span class="n">fileObj</span><span class="p">,</span>
       <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span>
       <span class="n">dataType</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> 
       <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span></div>

<span class="c1">#-----------------------------------------------</span>
<div class="viewcode-block" id="update_kv"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.update_kv">[docs]</a><span class="k">def</span> <span class="nf">update_kv</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kv_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kv_del</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#TODO: function currently performs 2 separate uploads if adding and deleting, needs to be fixed to just 1 upload</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;update the key:values for specified file. No change to file.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): Specify bucket where the file exists</span>

<span class="sd">        dataset_key (str): dataset_key for the file to update metadata for</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        kv_add (dict, optional): key-value pairs to add to the metadata for the file specified</span>

<span class="sd">        kv_del (str or list, optional): keys to delete from the metadata for the file specified</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#configure client if needed</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1">#check that bucket and dataset_key are valid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_key_exists</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dataset_key does not exist in bucket specified&#39;</span><span class="p">)</span>

    <span class="c1"># if kv_add is specified check to make sure format is right, then upload new keys:values</span>
    <span class="k">if</span> <span class="n">kv_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_add</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kv_add must be a dictionary&#39;</span><span class="p">)</span>

        <span class="n">modified_dataset</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">kv_add</span><span class="p">,</span>
                        <span class="p">}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">update_dataset</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">modified_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="c1"># if kv_del is specified check to make sure format is right, then upload deletion of the keys specified</span>
    <span class="k">if</span> <span class="n">kv_del</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kv_del must be a string or list&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">kv_del</span> <span class="o">=</span> <span class="p">[</span><span class="n">kv_del</span><span class="p">]</span>

        <span class="n">del_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kv_del</span><span class="p">:</span>
            <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

        <span class="n">modified_dataset</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">del_list</span>
    <span class="p">}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">update_dataset</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">modified_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span></div>
<span class="c1">#----------------------------------------------</span>

<span class="c1">#-----------------------------------------------</span>
<div class="viewcode-block" id="update_distribution_kv"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.update_distribution_kv">[docs]</a><span class="k">def</span> <span class="nf">update_distribution_kv</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kv_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kv_del</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#TODO: function currently performs 2 separate uploads if adding and deleting, needs to be fixed to just 1 upload</span>
    <span class="c1">#TODO: This should be merged with update_kv()</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;update the key:values for specified file. No change to file.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): Specify bucket where the file exists</span>

<span class="sd">        dataset_key (str): dataset_key for the file to update metadata for</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        kv_add (dict, optional): key-value pairs to add to the metadata for the file specified</span>

<span class="sd">        kv_del (str or list, optional): keys to delete from the metadata for the file specified</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#configure client if needed</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1">#check that bucket and dataset_key are valid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_key_exists</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dataset_key does not exist in bucket specified&#39;</span><span class="p">)</span>

    <span class="c1"># if kv_add is specified check to make sure format is right, then upload new keys:values</span>
    <span class="k">if</span> <span class="n">kv_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_add</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kv_add must be a dictionary&#39;</span><span class="p">)</span>

        <span class="n">modified_dataset</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">kv_add</span><span class="p">,</span>
                        <span class="p">}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">update_dataset</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">modified_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="c1"># if kv_del is specified check to make sure format is right, then upload deletion of the keys specified</span>
    <span class="k">if</span> <span class="n">kv_del</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kv_del must be a string or list&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">kv_del</span> <span class="o">=</span> <span class="p">[</span><span class="n">kv_del</span><span class="p">]</span>

        <span class="n">del_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kv_del</span><span class="p">:</span>
            <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>

        <span class="n">modified_dataset</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">del_list</span>
    <span class="p">}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">update_dataset</span><span class="p">(</span><span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">modified_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span></div>
<span class="c1">#----------------------------------------------</span>

<div class="viewcode-block" id="repeat_defined_search"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.repeat_defined_search">[docs]</a><span class="k">def</span> <span class="nf">repeat_defined_search</span><span class="p">(</span><span class="n">defined_search</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="n">display_all_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves a DataFrame of files (and associated metadata) meeting the search criteria.</span>
<span class="sd">    This is designed to work well with the output from the filter_datasets_interactive function with defined_search=True</span>

<span class="sd">    Args:</span>
<span class="sd">        defined_search (list): a list with position 0 = string/list of buckets, and remaining positions dictionaries of search criteria</span>
<span class="sd">                              example: defined_search = [&#39;gsk_ml&#39;,</span>
<span class="sd">                                 {&#39;key&#39;: &#39;species&#39;, &#39;value&#39;: [&#39;rat&#39;], &#39;operator&#39;: &#39;in&#39;},</span>
<span class="sd">                                 {&#39;key&#39;: &#39;assay_category&#39;,&#39;value&#39;: [&#39;solubility&#39;, &#39;volume_of_distribution&#39;], &#39;operator&#39;: &#39;in&#39;}]</span>

<span class="sd">        client (optional): set client if not using the default</span>
<span class="sd">        to_return (str, optional): (default=df)</span>
<span class="sd">                    &#39;df&#39; (df_results)  = return a pandas dataframe summarizing metadata of files meeting criteria</span>
<span class="sd">                    &#39;oid&#39; (dataset_oid) = return a list of dataset_oids meeting criteria</span>
<span class="sd">                    &#39;ds_key&#39; (dataset_key) = return a list of dataset_key + bucket tuples</span>

<span class="sd">        display_all_column (bool, optional): default False. If True, displays all associated metadata instead of just a selected subset</span>

<span class="sd">    Returns:</span>
<span class="sd">        One of the following will be returned (based on selection for &#39;to_return&#39;)</span>
<span class="sd">        (DataFrame): dataframe of metadata for the files matching the criteria specified in the search</span>
<span class="sd">        (list): list of dataset_oids meeting the criteria specified in the search</span>
<span class="sd">        (list): list of bucket and dataset_key meeting the criteria specified in the search</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="s1">&#39;oid&#39;</span><span class="p">,</span><span class="s1">&#39;ds_key&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;to_return entry invalid&#39;</span><span class="p">)</span>

    <span class="n">bucket</span> <span class="o">=</span> <span class="n">defined_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">key_val_criteria</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">defined_search</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1">#search for files meeting criteria</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">key_val_criteria</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No files found matching criteria specified&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">display_all_columns</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_oid&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_key&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;user_perm&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">]</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="c1">#(df_results)</span>
        <span class="k">return</span> <span class="n">files</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;oid&#39;</span><span class="p">:</span> <span class="c1">#(dataset_oid)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;dataset_oid&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;ds_key&#39;</span><span class="p">:</span> <span class="c1">#(dataset_key)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]))</span></div>


<span class="c1">#----------------------------------------------------------------</span>
<div class="viewcode-block" id="get_keyval"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.get_keyval">[docs]</a><span class="k">def</span> <span class="nf">get_keyval</span><span class="p">(</span><span class="n">dataset_oid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Requires either dataset_oid *or* dataset_key+bucket.</span>
<span class="sd">       Function extracts the key:value pairs and converts from the &#39;datastore format&#39; (list of dictionaries) into &#39;model tracker format&#39; (a single dictionary).&quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># check that dataset_oid *or* dataset_key+bucket was entered</span>
    <span class="k">if</span> <span class="n">dataset_oid</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Both dataset_oid and dataset_key are specified.&#39;</span><span class="p">)</span>
        <span class="n">ds_metadata</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_dataset_oid</span><span class="p">(</span><span class="n">dataset_oid</span><span class="o">=</span><span class="n">dataset_oid</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset_key</span><span class="p">:</span>
        <span class="n">ds_metadata</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_oid</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dataset_oid or dataset_key + bucket required&#39;</span><span class="p">)</span>

    <span class="c1"># convert</span>
    <span class="n">ds_metadata</span> <span class="o">=</span> <span class="n">ds_metadata</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
    <span class="n">kv_pairs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_metadata</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kv_pairs</span><span class="p">:</span>
        <span class="n">kv</span> <span class="o">=</span> <span class="n">ds_metadata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="n">new_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">new_dict</span></div>

<span class="c1">#------------</span>
<div class="viewcode-block" id="upload_pickle_to_DS"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.upload_pickle_to_DS">[docs]</a><span class="k">def</span> <span class="nf">upload_pickle_to_DS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">key_values</span><span class="p">,</span><span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function will upload a file to the Datastore along with the associated metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (DataFrame, str, list, tuple, pickle): data to be pickled and uploaded</span>

<span class="sd">        bucket (str): bucket the file will be put in</span>

<span class="sd">        filename (str): the filename to save the dataframe as in the datastore. Include the extension</span>

<span class="sd">        title (str): title of the file in (human friendly format)</span>

<span class="sd">        description (str): long text box to describe file (background/use notes)</span>

<span class="sd">        tags (list): must be a list.</span>

<span class="sd">        key_values (dict): key:value pairs to enable future users to find the file. Must be a dictionary.</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        dataset_key (str, optional): If updating a file already in the datastore enter the corresponding dataset_key.</span>
<span class="sd">                          If not, leave as &#39;none&#39; and the dataset_key will be automatically generated.</span>

<span class="sd">        override_check (bool, optional): If True, overrides checking the metadata for the file when uploaded.</span>

<span class="sd">        return_metadata (bool, optional): If True, returns metadata for the file after it is uploaded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key_values must be a dictionary&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">override_check</span><span class="p">:</span>
        <span class="n">check_key_val</span><span class="p">(</span><span class="n">key_values</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">key_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>


    <span class="n">key_values</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">key_values</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">dataset_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset_key</span> <span class="o">=</span> <span class="n">bucket</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">filename</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">fileObj</span><span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fileObj</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">req</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">upload_dataset</span><span class="p">(</span>
       <span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
       <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
       <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
       <span class="n">metadata_obj</span><span class="o">=</span><span class="n">key_values</span><span class="p">,</span>
       <span class="n">fileObj</span><span class="o">=</span><span class="n">fileObj</span><span class="p">,</span>
       <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span>
       <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span></div>

    <span class="c1">#------------------------------------</span>
<div class="viewcode-block" id="list_key_values"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.list_key_values">[docs]</a><span class="k">def</span> <span class="nf">list_key_values</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;experimental&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1">#TODO:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List the values for input key.  Requires that the input key be in the &#39;approved&#39; list</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str or list, optional): buckets to search (defaults to searching all buckets you have access to in the datastore)</span>

<span class="sd">        input_key: user specified key to query</span>

<span class="sd">        category: &#39;experimental&#39; or &#39;pdb_bind&#39;</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="n">values_for_key</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">key_exists</span><span class="p">(</span><span class="n">input_key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span> <span class="p">:</span>

        <span class="c1">#retrieve lookup table</span>
        <span class="n">dataset_key</span> <span class="o">=</span> <span class="s1">&#39;kv_lookup_&#39;</span><span class="o">+</span> <span class="n">category</span>
        <span class="n">kv_lookup</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_key</span> <span class="ow">in</span> <span class="n">kv_lookup</span> <span class="p">:</span>

            <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">retrieve_values_for_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">input_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error Key not on approved list&quot;</span><span class="p">,</span><span class="n">input_key</span><span class="p">,</span><span class="n">kv_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values_for_key</span></div>

    <span class="c1">#------------------------------------</span>
<div class="viewcode-block" id="search_files_interactive"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.search_files_interactive">[docs]</a><span class="k">def</span> <span class="nf">search_files_interactive</span> <span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="n">display_all_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1">#TODO: This will replace filter_datasets_interactive eventually. This function uses the new key:value lookup tables</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This tool helps you find the files you need via an interactive/guided interface.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str or list, optional): buckets to search (defaults to searching all buckets you have access to in the datastore)</span>

<span class="sd">        client (optional): set client if not using the default</span>

<span class="sd">        to_return (str): &#39;df&#39; (df_results)  = return a pandas dataframe summarizing metadata of files meeting criteria</span>
<span class="sd">                         &#39;search&#39; (search_criteria) = return a list containing search criteria where position 0 = string/list of buckets, and remaining positions are dictionaries of search criteria.</span>
<span class="sd">                                                      Designed to work with &#39;repeat_defined_search&#39; function.</span>
<span class="sd">                         &#39;oid&#39; (dataset_oid) = return a list of dataset_oids meeting criteria</span>
<span class="sd">                         &#39;ds_key&#39; (dataset_key) = return a list of dataset_key + bucket tuples</span>

<span class="sd">        display_all_columns (bool, optional): If &#39;False&#39; (default), then show only a selected subset of the columns</span>

<span class="sd">        max_rows (int, optional): maximum rows to display during interactive search</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">,</span><span class="s1">&#39;search&#39;</span><span class="p">,</span><span class="s1">&#39;oid&#39;</span><span class="p">,</span><span class="s1">&#39;ds_key&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;to_return entry invalid&#39;</span><span class="p">)</span>

    <span class="c1">#configure client</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># determine file category</span>
    <span class="n">file_categories</span> <span class="o">=</span> <span class="n">retrieve_values_for_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;kv_lookup&#39;</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
    <span class="n">category</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_categories</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">file_categories</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_categories</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select file category. Options: &#39;</span><span class="p">,</span> <span class="n">file_categories</span><span class="p">)</span>
        <span class="n">category</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a selection: &#39;</span><span class="p">)</span>

    <span class="c1">#retrieve lookup table</span>
    <span class="n">dataset_key</span> <span class="o">=</span> <span class="s1">&#39;kv_lookup_&#39;</span><span class="o">+</span> <span class="n">category</span>
    <span class="n">kv_lookup</span> <span class="o">=</span> <span class="n">retrieve_dataset_by_datasetkey</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">)</span>

    <span class="n">search_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="s1">&#39;file_category&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:[</span><span class="n">category</span><span class="p">],</span> <span class="s1">&#39;operator&#39;</span><span class="p">:</span><span class="s1">&#39;in&#39;</span><span class="p">}]</span>  <span class="c1"># used for saving the search for easy retrieval, updated as selections are made</span>
    <span class="n">used_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;file_category&#39;</span><span class="p">]</span>

    <span class="c1"># provide list of keys and have user select option</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select a key from the following list:&#39;</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">retrieve_keys</span><span class="p">(</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">)</span>
    <span class="n">approved_keys</span> <span class="o">=</span> <span class="n">kv_lookup</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1">#display only keys that 1) exist, 2) are approved (in kv_lookup table), and 3) not already used. Then sort (ascending).</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_keys</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

    <span class="c1">#provides examples of types of values associated with the key to help users pick the key they want</span>
    <span class="n">example_val_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">example_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">example_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_val</span><span class="p">)</span>
        <span class="n">temp_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_examples&#39;</span><span class="p">:</span> <span class="n">example_val_list</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">:</span> <span class="n">keys</span><span class="p">,</span> <span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">))</span>
    <span class="n">input_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="n">input_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">input_key</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a key: &#39;</span><span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_key</span><span class="p">)</span>

    <span class="c1"># provide list of values and have user select option</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select value(s) for key=&#39;</span><span class="p">,</span> <span class="n">input_key</span><span class="p">,</span> <span class="s1">&#39;from the following list: &#39;</span><span class="p">)</span>
    <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">retrieve_values_for_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">input_key</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">values_valid</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;in&#39;</span>
    <span class="k">while</span> <span class="n">values_valid</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">invalid_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter value(s) (comma separated for multiple values):  &#39;</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;currently value=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1">#delete?</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;&gt;=&#39;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values_for_key</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values_for_key</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>
            <span class="k">elif</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;&lt;=&#39;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values_for_key</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values_for_key</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>
            <span class="k">elif</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values_for_key</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values_for_key</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>
            <span class="k">elif</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values_for_key</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values_for_key</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values_for_key</span><span class="p">:</span>
                <span class="n">invalid_value</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;value </span><span class="si">%s</span><span class="s1"> is not valid &#39;</span> <span class="o">%</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_value</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">values_valid</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#save key and value(s) searched</span>
    <span class="n">search_criteria</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">input_key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">})</span>

    <span class="c1"># return dataframe of datasets meeting user specified criteria</span>
    <span class="n">dataset_list</span> <span class="o">=</span> <span class="n">search_datasets_by_key_value</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">input_key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">display_all_columns</span><span class="o">=</span><span class="n">display_all_columns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of datasets found meeting criteria =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_rows</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Displaying first </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">max_rows</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dataset_list</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_rows</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset_list</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">repeat</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="n">repeat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">]:</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Apply additional filter? (y/n)&#39;</span><span class="p">)</span>

    <span class="c1">#-----refine search section ----</span>
    <span class="k">while</span> <span class="n">repeat</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="n">key_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">new</span><span class="o">=</span> <span class="n">key_values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">key_val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_val</span> <span class="o">=</span> <span class="n">key_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">unique_keys</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select a key from the following list:&#39;</span><span class="p">)</span>
        <span class="n">unique_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_keys</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span>
            <span class="n">unique_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">unique_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_keys</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
        <span class="n">example_val_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">unique_keys</span><span class="p">:</span>
            <span class="n">example_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">example_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_val</span><span class="p">)</span>
        <span class="n">temp_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_examples&#39;</span><span class="p">:</span> <span class="n">example_val_list</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">:</span> <span class="n">unique_keys</span><span class="p">,</span> <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">))</span>

        <span class="n">new_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">new_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">approved_keys</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a key: &#39;</span><span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select value(s) for key=&#39;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;from the following list: &#39;</span><span class="p">)</span>

        <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="n">key_val</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_key</span><span class="p">]</span>
        <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">values_for_key</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">approved_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">values_for_key</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_values</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1">##</span>
        <span class="n">values_valid</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">while</span> <span class="n">values_valid</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">invalid_value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter value(s) (comma separated for multiple values) or Enter &#39;change key&#39; to change the key&#39;:  &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="s2">&quot;change key&quot;</span><span class="p">:</span>
                    <span class="n">used_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select a key from the following list:&#39;</span><span class="p">)</span>
                    <span class="n">unique_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_keys</span><span class="p">))</span>
                    <span class="n">unique_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_keys</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
                    <span class="n">example_val_list</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">unique_keys</span><span class="p">:</span>
                        <span class="n">example_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                        <span class="n">example_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_val</span><span class="p">)</span>
                    <span class="n">temp_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value_examples&#39;</span><span class="p">:</span> <span class="n">example_val_list</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">:</span> <span class="n">unique_keys</span><span class="p">,</span> <span class="p">}</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">))</span>

                    <span class="n">new_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                    <span class="k">while</span> <span class="n">new_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">approved_keys</span><span class="p">:</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a key: &#39;</span><span class="p">)</span>
                    <span class="n">used_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select value(s) for key=&#39;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;from the following list: &#39;</span><span class="p">)</span>

                    <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="n">key_val</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_key</span><span class="p">]</span>
                    <span class="n">values_for_key</span> <span class="o">=</span> <span class="n">values_for_key</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

                    <span class="n">approved_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kv_lookup</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                    <span class="n">values_for_key</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">approved_values</span><span class="p">))</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_value</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values_for_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_value</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_value</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values_for_key</span><span class="p">:</span>
                    <span class="n">invalid_value</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;value </span><span class="si">%s</span><span class="s1"> is not valid &#39;</span> <span class="o">%</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invalid_value</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">values_valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;values selected =&#39;</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_value</span><span class="p">))</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#extract the values associated with the key</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">dataset_list</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>  <span class="c1">#extracts keys from a</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;key_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col</span>

        <span class="n">dataset_list2</span> <span class="o">=</span> <span class="n">dataset_list</span><span class="p">[</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;key_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_value</span><span class="p">))</span> <span class="p">]</span>

        <span class="c1">#save key and value(s) searched</span>
        <span class="n">search_criteria</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">new_value</span><span class="p">,</span> <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">})</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of datasets found meeting criteria =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_rows</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Displaying first </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">max_rows</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dataset_list2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_rows</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">dataset_list</span> <span class="o">=</span> <span class="n">dataset_list2</span><span class="p">[:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--dataset_list length = &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span>

        <span class="n">repeat</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">repeat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">]:</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Apply additional filter? (y/n)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="c1">#(df_results)</span>
        <span class="k">return</span> <span class="n">dataset_list</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;search&#39;</span><span class="p">:</span> <span class="c1">#(search_criteria)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;search_criteria =&#39;</span><span class="p">,</span> <span class="n">search_criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">search_criteria</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;oid&#39;</span><span class="p">:</span> <span class="c1">#(dataset_oid)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;dataset_oid&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;ds_key&#39;</span><span class="p">:</span> <span class="c1">#(dataset_key)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span> <span class="n">dataset_list</span><span class="p">[</span><span class="s1">&#39;dataset_key&#39;</span><span class="p">]))</span></div>


<span class="c1">#--------------------------------------------------------------------</span>
<div class="viewcode-block" id="bulk_export_kv_for_files"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.bulk_export_kv_for_files">[docs]</a><span class="k">def</span> <span class="nf">bulk_export_kv_for_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">save_as</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1">#TODO: function is slow. look into speeding up.</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;exports a csv file with 3 columns: bucket, dataset_key, key/value pairs to make reviewing  metadata easier</span>

<span class="sd">    Args:</span>
<span class="sd">        files (list of tuples): format [(bucket1, dataset_key1), (bucket2, dataset_key2)]</span>

<span class="sd">        save_as (str): filename to use for new file</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#configure client</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; &#39;files&#39; must be a list&quot;</span><span class="p">)</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;each item in &#39;files&#39; must be a tuple formatted (bucket, dataset_key)&quot;</span><span class="p">)</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset_key</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_keyval</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">metadata</span><span class="p">]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_as</span><span class="p">)</span></div>

<span class="c1">#----------------------------------------------------------------------</span>
<span class="c1">#NOTE: Bulk update keys/values function uses this function</span>

<div class="viewcode-block" id="string_to_dict"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.string_to_dict">[docs]</a><span class="k">def</span> <span class="nf">string_to_dict</span><span class="p">(</span><span class="n">dict_string</span><span class="p">):</span>
    <span class="c1"># Convert to proper json format</span>
    <span class="n">dict_string</span> <span class="o">=</span> <span class="n">dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;u&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dict_string</span><span class="p">)</span></div>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1">#NOTE: Bulk update keys/values function uses this function</span>
<div class="viewcode-block" id="string_to_list"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.string_to_list">[docs]</a><span class="k">def</span> <span class="nf">string_to_list</span><span class="p">(</span><span class="n">list_string</span><span class="p">):</span>
    <span class="c1"># Convert to proper json format</span>
    <span class="n">list_string</span> <span class="o">=</span> <span class="n">list_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;u&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="n">list_string</span><span class="o">=</span><span class="n">list_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">list_string</span></div>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1">### upload info bor files to change</span>
<div class="viewcode-block" id="bulk_update_kv"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.bulk_update_kv">[docs]</a><span class="k">def</span> <span class="nf">bulk_update_kv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;this function allows you to upload a properly formatted csv file with 4 columns (order and spelling of headings must match): bucket, dataset_key, kv_add, kv_del</span>
<span class="sd">    the metadata for the files listed will then be updated in the Datastore</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#configure client</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="c1"># import file</span>
    <span class="n">edit_files</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1">#check headings</span>
    <span class="n">req_headings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_key&#39;</span><span class="p">,</span> <span class="s1">&#39;kv_add&#39;</span><span class="p">,</span> <span class="s1">&#39;kv_del&#39;</span><span class="p">]</span>
    <span class="n">cols_used</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edit_files</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cols_used</span> <span class="o">!=</span> <span class="n">req_headings</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;headings need to match approved format: bucket, dataset_key, kv_add, kv_del&#39;</span><span class="p">)</span>

     <span class="c1">#loop through files and update metadata for each</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">edit_files</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edit_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset_key</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">kv_add</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i =&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;dataset_key = &#39;</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_add</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">kv_add</span><span class="o">=</span><span class="n">string_to_dict</span><span class="p">(</span><span class="n">kv_add</span><span class="p">)</span>
            <span class="n">len_add</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv_add</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">len_add</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">kv_del</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">kv_del</span><span class="o">=</span><span class="n">string_to_list</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span>
            <span class="n">len_del</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv_del</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">len_del</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">len_add</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">len_del</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">update_kv</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">kv_add</span><span class="o">=</span><span class="n">kv_add</span><span class="p">,</span> <span class="n">kv_del</span><span class="o">=</span><span class="n">kv_del</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">len_add</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">len_del</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">update_kv</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">kv_add</span><span class="o">=</span><span class="n">kv_add</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">len_del</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">len_add</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">update_kv</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="p">,</span> <span class="n">kv_del</span><span class="o">=</span><span class="n">kv_del</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span></div>

<span class="c1">#---------------------------------------------------------------------</span>



<div class="viewcode-block" id="get_key_val"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.get_key_val">[docs]</a><span class="k">def</span> <span class="nf">get_key_val</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple utility to search through list of key value pairs and return values for query key</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata list of key,value pairs (list): a list with position 0 = string/list of buckets, and remaining positions dictionaries of search criteria</span>
<span class="sd">                              example:</span>
<span class="sd">                                 [{&#39;key&#39;: &#39;species&#39;, &#39;value&#39;: [&#39;rat&#39;] },</span>
<span class="sd">                                 {&#39;key&#39;: &#39;assay_category&#39;,&#39;value&#39;: [&#39;solubility&#39;, &#39;volume_of_distribution&#39;]}]</span>

<span class="sd">       key (str):  key to search for</span>

<span class="sd">     Returns:</span>
<span class="sd">        returns When key is provide, returns value for matching key if found, None otherwise</span>
<span class="sd">        returns dictionary for the list of key,value pairs when a query key is not provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">kv</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">])</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">ret_val</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">metadata</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span> <span class="p">:</span>
                <span class="n">ret_val</span><span class="o">=</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">ret_val</span></div>

<span class="c1">#---------------------------------------------------------------------</span>
<div class="viewcode-block" id="copy_datasets_to_bucket"><a class="viewcode-back" href="../../utils.html#utils.datastore_functions.copy_datasets_to_bucket">[docs]</a><span class="k">def</span> <span class="nf">copy_datasets_to_bucket</span><span class="p">(</span><span class="n">dataset_keys</span><span class="p">,</span> <span class="n">from_bucket</span><span class="p">,</span> <span class="n">to_bucket</span><span class="p">,</span> <span class="n">ds_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy each named dataset from one bucket to another.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_keys (str or list of str): List of dataset_keys for datasets to move.</span>

<span class="sd">        from_bucket (str): Bucket where datasets are now.</span>

<span class="sd">        to_bucket (str): Bucket to move datasets to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ds_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds_client</span> <span class="o">=</span> <span class="n">config_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset_keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">dataset_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_keys</span><span class="p">]</span>

    <span class="c1"># Copy each dataset</span>
    <span class="k">for</span> <span class="n">dataset_key</span> <span class="ow">in</span> <span class="n">dataset_keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds_meta</span> <span class="o">=</span> <span class="n">ds_client</span><span class="o">.</span><span class="n">ds_datasets</span><span class="o">.</span><span class="n">copy_dataset</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">from_bucket</span><span class="p">,</span> <span class="n">dataset_key</span><span class="o">=</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">to_bucket_name</span><span class="o">=</span><span class="n">to_bucket</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error copying dataset </span><span class="si">%s</span><span class="se">\n</span><span class="s1">from bucket </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">from_bucket</span><span class="p">,</span> <span class="n">to_bucket</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copied dataset </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataset_key</span><span class="p">,</span> <span class="n">to_bucket</span><span class="p">))</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ATOM DDM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>